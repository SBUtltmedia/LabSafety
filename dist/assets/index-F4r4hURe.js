import{B as De,V,A as le,E as B,C as ce,a as m,b as He,c as b,M as Fe,O,W as F,H as we,d as re,e as P,f as Ge,g as We,P as _e,h as X,i as J,S as Ve,F as Ue,T as G,j as ze,k as je,l as q,m as Ye,_ as g,s as f,R as $,n as Q,o as pe,p as ve,D as de,q as j,r as Xe,G as me,t as be,u as qe,v as Re,w as Ke,x as Ze,y as $e,U as Je,z as ne,I as Qe}from"./vendor-lWRilmsc.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(r){if(r.ep)return;r.ep=!0;const n=t(r);fetch(r.href,n)}})();window.exports=window;class K extends De{SWIPE_SENSIBILITY=.5;JOYSTICK_COLOR="LightGray";JOYSTICK_TOUCH_AREA_HORIZONTAL_SCREEN_SHARE=.5;JOYSTICK_CIRCLE_SIZE_VERTICAL_SCREEN_SHARE=.1;JOYSTICK_PUCK_SIZE_VERTICAL_SCREEN_SHARE=.05;JOYSTICK_OUTER_CIRCLE_THICKNESS_RATIO=.01;JOYSTICK_INNER_CIRCLE_THICKNESS_RATIO=.04;JOYSTICK_PUCK_THICKNESS_RATIO=.01;camera;joystickDelta=V.Zero();screenSize;ui;joystickPointerId;joystickButtonDownPos;joystickButtonDownPosOffset;joystickContainer;joystickOuterCirce;joystickInnerCircle;joystickPuck;joystickCircleRadius;joystickPuckRadius;getClassName=()=>this.constructor.name;getSimpleName=()=>"joystick";attachControl(e){super.attachControl(e),this.screenSize=K.getScreenSize(),this.ui=le.CreateFullscreenUI("UI"),this.prepareImages(),B.LastCreatedEngine.onResizeObservable.add(this.resize)}prepareImages(){this.joystickCircleRadius=this.screenSize.y*this.JOYSTICK_CIRCLE_SIZE_VERTICAL_SCREEN_SHARE,this.joystickPuckRadius=this.screenSize.y*this.JOYSTICK_PUCK_SIZE_VERTICAL_SCREEN_SHARE,this.joystickContainer=new ce("virtual_joystick");let e=this.joystickCircleRadius*2+this.joystickPuckRadius*2+1;this.joystickContainer.widthInPixels=e,this.joystickContainer.heightInPixels=e,this.joystickContainer.horizontalAlignment=m.HORIZONTAL_ALIGNMENT_LEFT,this.joystickContainer.verticalAlignment=m.VERTICAL_ALIGNMENT_TOP,this.joystickOuterCirce=this.prepareJoystickCircle(this.joystickCircleRadius,e*this.JOYSTICK_OUTER_CIRCLE_THICKNESS_RATIO),this.joystickInnerCircle=this.prepareJoystickCircle(this.joystickPuckRadius,e*this.JOYSTICK_INNER_CIRCLE_THICKNESS_RATIO),this.joystickPuck=this.prepareJoystickCircle(this.joystickPuckRadius,e*this.JOYSTICK_PUCK_THICKNESS_RATIO),this.joystickContainer.addControl(this.joystickOuterCirce),this.joystickContainer.addControl(this.joystickInnerCircle),this.joystickContainer.addControl(this.joystickPuck),this.joystickContainer.isVisible=!1,this.ui.addControl(this.joystickContainer)}prepareJoystickCircle(e,t){let i=new He;return i.widthInPixels=e*2,i.heightInPixels=e*2,i.thickness=t,i.color=this.JOYSTICK_COLOR,i.horizontalAlignment=m.HORIZONTAL_ALIGNMENT_CENTER,i.verticalAlignment=m.VERTICAL_ALIGNMENT_CENTER,i}detachControl(){this.disposeImages(),this.ui.dispose(),B.LastCreatedEngine.onResizeObservable.removeCallback(this.resize),super.detachControl()}disposeImages(){this.joystickContainer.dispose(),this.joystickInnerCircle.dispose(),this.joystickOuterCirce.dispose(),this.joystickPuck.dispose()}resize=()=>{this.screenSize=K.getScreenSize(),this.disposeImages(),this.prepareImages()};static getScreenSize(){let e=B.LastCreatedEngine;return new V(e.getRenderWidth(),e.getRenderHeight())}checkInputs(){let e=new b(this.joystickDelta.x,0,-this.joystickDelta.y);e.scaleInPlace(B.LastCreatedEngine.getDeltaTime()/1e3),this.camera.cameraDirection.addInPlace(b.TransformCoordinates(e,Fe.RotationY(this.camera.rotation.y)))}onTouch(e,t,i){e.pointerId===this.joystickPointerId?this.onTouchJoystick(new V(e.x,e.y).subtractInPlace(this.joystickButtonDownPosOffset)):this.onTouchSwipe(new V(t,i))}onTouchJoystick(e){const t=e.subtract(this.joystickButtonDownPos);t.length()>this.joystickCircleRadius&&t.scaleInPlace(this.joystickCircleRadius/t.length()),this.joystickPuck.left=t.x,this.joystickPuck.top=t.y,this.joystickDelta=t.scaleInPlace(this.camera.speed/this.joystickCircleRadius)}onTouchSwipe(e){let t=1;this.camera.getScene().useRightHandedSystem&&(t*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(t*=-1),this.camera.cameraRotation.y+=t*e.x/this.screenSize.x*this.SWIPE_SENSIBILITY,this.camera.cameraRotation.x+=e.y/this.screenSize.x*this.SWIPE_SENSIBILITY}onButtonDown(e){e.offsetX<this.screenSize.x*this.JOYSTICK_TOUCH_AREA_HORIZONTAL_SCREEN_SHARE&&this.onButtonDownJoystick(e)}onButtonDownJoystick(e){let t=new V(e.offsetX,e.offsetY);this.joystickPointerId=e.pointerId,this.joystickButtonDownPos=t,this.joystickButtonDownPosOffset=new V(e.clientX-t.x,e.clientY-t.y),this.joystickContainer.left=t.x-this.joystickContainer.widthInPixels/2,this.joystickContainer.top=t.y-this.joystickContainer.heightInPixels/2,this.joystickContainer.isVisible=!0}onButtonUp(e){e.pointerId===this.joystickPointerId&&this.onButtonUpJoystick()}onButtonUpJoystick(){this.joystickPointerId=null,this.joystickDelta.scaleInPlace(0),this.joystickContainer.isVisible=!1}}const et=new b(0,1,-1.134),tt=new b(.4,.7,.4),it=.16;function st(s){s.ellipsoid=tt,s.applyGravity=!0,s.minZ=0,s.speed=it,s.checkCollisions=!0,s.needMoveForGravity=!1}function Z(...s){}var R=(s=>(s[s.DESKTOP=0]="DESKTOP",s[s.XR=1]="XR",s[s.MOBILE=2]="MOBILE",s[s.LOADING=3]="LOADING",s))(R||{}),v=(s=>(s[s.GRAB=0]="GRAB",s[s.DROP=1]="DROP",s))(v||{}),N=(s=>(s[s.ACTIVE=0]="ACTIVE",s[s.INACTIVE=1]="INACTIVE",s))(N||{});const rt=9,nt=.005;class ue{onGrabStateChangedObservable=new O;onActivationStateChangedObservable=new O;onModeChangeObservable=new O;#e;#t;modeSelectorMap={0:{},1:{},3:{}};hasDefaultSelector=!1;#n=[];interactionMode=3;interactableMeshes=[];xrExperience;constructor(e,t){this.#e=e,t?(this.xrExperience=t,this.xrExperience.input.controllers.forEach(this.#a),this.xrExperience.input.onControllerAddedObservable.add(this.#a),this.xrExperience.baseExperience.state===F.NOT_IN_XR?(this.#l(0),this.hasDefaultSelector||this.configureDesktopInteraction(this.#e.activeCamera)):this.xrExperience.baseExperience.state===F.IN_XR?this.interactionMode=1:this.interactionMode=3,this.xrExperience.baseExperience.onStateChangedObservable.add(i=>{i===F.NOT_IN_XR?(this.#l(0),this.hasDefaultSelector||this.configureDesktopInteraction(this.#e.activeCamera)):i===F.IN_XR?this.#l(1):this.#l(3)})):this.#l(0),this.#t=new we("interaction-highlight-layer"),this.#e.onBeforeRenderObservable.add(()=>{this.#n.splice(0,this.#n.length);const i=this.getActiveSelectors(),r=i.filter(({grabbedMesh:o})=>!!o).map(({grabbedMesh:o})=>o),n=i.filter(({grabbedMesh:o})=>!o),a=this.interactableMeshes.filter(o=>!r.includes(o)),h={};for(const o of n){const l=[];for(const c of a)o.grabber.intersectsMesh(c,!0)&&l.push(c);o.targetMesh=this.#c(o.grabber,l),o.targetMesh&&(h[o.targetMesh.uniqueId]=o.targetMesh)}this.#n.push(...Object.values(h)),this.#t.removeAllMeshes();for(const o of this.#n)o instanceof re&&this.#t.addMesh(o,P.Gray())})}#a=e=>{e.motionController&&this.#r(e.motionController,e.pointer.uniqueId),e.onMotionControllerInitObservable.add(t=>{this.#r(t,e.pointer.uniqueId)})};#r=(e,t)=>{const i=e.getComponentOfType("squeeze");i&&i.onButtonStateChangedObservable.add(()=>{i.changes.pressed&&this.#i(i.pressed,t)});const r=e.getMainComponent();r&&r.onButtonStateChangedObservable.add(()=>{r.changes.pressed&&this.#s(r.pressed,t)})};#i=(e,t)=>{const i=this.modeSelectorMap[this.interactionMode][t];e?i.targetMesh&&(i.grabbedMesh=i.targetMesh,i.targetMesh=null,this.#h(i.grabbedMesh,{anchor:i.anchor,grabber:i.grabber,state:0})):i.grabbedMesh&&(this.#h(i.grabbedMesh,{anchor:i.anchor,grabber:i.grabber,state:1}),i.grabbedMesh=null)};#s=(e,t)=>{const{anchor:i,grabber:r,grabbedMesh:n}=this.modeSelectorMap[this.interactionMode][t];n&&(e?this.#o(n,{anchor:i,grabber:r,state:0}):this.#o(n,{anchor:i,grabber:r,state:1}))};#h=(e,t)=>{if(e.isDisposed()){for(const r in this.modeSelectorMap)for(const n of Object.values(this.modeSelectorMap[r]))n.grabbedMesh===e&&(n.grabbedMesh=null);return}const i=e.getBehaviorByName("Interactable");if(!i)throw new Error("InteractionManager: grabbed mesh must have InteractableBehavior.");this.onGrabStateChangedObservable.notifyObserver(i.grabStateObserver,t)};#o=(e,t)=>{if(e.isDisposed())return;const i=e.getBehaviorByName("Interactable");if(!i)throw new Error("InteractionManager: activated mesh must have InteractableBehavior.");this.onActivationStateChangedObservable.notifyObserver(i.activationStateObserver,t,e.uniqueId)};#l=e=>{const t=this.getActiveSelectors();this.onModeChangeObservable.notifyObservers(e);for(const i of t)i.grabbedMesh&&(this.#h(i.grabbedMesh,{anchor:i.anchor,grabber:i.grabber,state:1}),i.grabbedMesh=null);this.interactionMode=e};addSelector=(e,t,i)=>{const r={anchor:e,grabber:t,grabbedMesh:null,targetMesh:null};for(const n of i)this.modeSelectorMap[n][e.uniqueId]=r};configureDesktopInteraction=e=>{const t=Ge("default-grabber",{height:rt,diameter:nt});t.isVisible=!1,t.isPickable=!1,t.setParent(e),t.position.setAll(0),t.rotation.copyFromFloats(Math.PI/2,0,0);const i=new We("default-anchor");i.isPickable=!1,i.setParent(e),i.position.copyFrom(b.Forward()),this.addSelector(i,t,[0]),this.hasDefaultSelector=!0,this.#e.onPointerObservable.add(r=>{this.interactionMode===0&&(r.event.inputIndex===_e.LeftClick?r.type===X.POINTERDOWN?this.#i(!0,i.uniqueId):r.type===X.POINTERUP&&this.#i(!1,i.uniqueId):r.event.inputIndex===_e.RightClick&&(r.type===X.POINTERDOWN?this.#s(!0,i.uniqueId):r.type===X.POINTERUP&&this.#s(!1,i.uniqueId)))})};getActiveSelectors=()=>Object.values(Object.values(this.modeSelectorMap[this.interactionMode]));#c=(e,t)=>ue.#d(e,t,this.interactionMode);static#d=(e,t,i)=>{let r=null,n=Number.POSITIVE_INFINITY;switch(i){case 0:case 2:case 1:for(const a of t){const h=b.Distance(e.getAbsolutePosition(),a.getAbsolutePosition());h<n&&(r=a,n=h)}break}return r}}const at=.15;class ge{mesh;spawnPosition=b.Zero();spawnRotation=b.Zero();#e;#t;#n;#a=null;#r;#i;constructor(e=1.25){this.#e=e,this.#r=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}],this.#r.forEach(t=>{t.animation=new J(t.name,"visibility",60,J.ANIMATIONTYPE_FLOAT,J.ANIMATIONLOOPMODE_CONSTANT),t.animation.setKeys([{frame:0,value:t.startValue},{frame:30,value:t.startValue?0:1}])})}init(){}get name(){return"FadeAndRespawn"}attach(e){if(this.mesh=e,this.#t=this.mesh.getBehaviorByName("Interactable"),!this.#t)throw new Error(`${this.name} behavior must be attached to a mesh with an Interactable behavior.`);this.#i=this.mesh.getScene(),this.#n=this.#t.onGrabStateChangedObservable.add(({state:t})=>{t===v.DROP&&this.#s()})}detach(){this.#n.remove(),this.#a&&this.#a.remove()}#s(){if(Math.abs(b.Distance(this.mesh.getAbsolutePosition(),this.spawnPosition))<=at){this.#o();return}this.#i.beginDirectHierarchyAnimation(this.mesh,!1,[this.#r.find(t=>t.name==="Invisibility").animation],0,60,!1,this.#e,()=>{this.#o(),this.#h()})}#h(){this.#i.beginDirectHierarchyAnimation(this.mesh,!1,[this.#r.find(e=>e.name==="Visibility").animation],0,60,!1,this.#e)}#o=()=>{this.mesh.position.copyFrom(this.spawnPosition),this.mesh.rotation.copyFrom(this.spawnRotation)};setSpawnPoint=(e,t)=>{this.spawnPosition.copyFrom(e),this.spawnRotation.copyFrom(t)}}function ot(s){const e=s.meshes.map(t=>t.getBehaviorByName("FadeAndRespawn")).filter(t=>!!t);for(const t of e)t.setSpawnPoint(t.mesh.position,t.mesh.rotation)}const ht=["room","placard","cylinder","clipboard","fire-extinguisher"];function Pe(s=ht){return Promise.all(s.map(e=>Ve.ImportMeshAsync("","./models/",`${e}.glb`).then(t=>{const i=t.meshes.find(r=>r.id==="__root__");return i.id=e,i.name=e,t})))}function Me(s){const t=s.getScene().meshes.find(i=>i.name==="Table");if(s.rotation=b.Zero(),t){const i=t.getBoundingInfo().boundingBox;s.position.x=i.center.x-.5,s.position.y=i.center.y*2+.46,s.position.z=-3}else s.position=b.Zero()}function Te(s,e){return s.id<e.id?-1:s.id>e.id?1:0}function lt(s){const e=s.filter(a=>a.id.split("-").length===2&&a.id.split("-")[0]==="cylinder").sort(Te),t=s.filter(a=>a.name.split("-")[0]==="placard"&&!a.name.includes("placard-base")).sort(Te),i=s.find(a=>a.id==="clipboard"),r=s.find(a=>a.name==="Table"),n=s.find(a=>a.id==="fire-extinguisher");if(r){const a=r.getBoundingInfo().boundingBox;e.forEach((h,o)=>{const l=h.getBoundingInfo().boundingBox,c=h.position.y-l.minimum.y;h.position.copyFromFloats(a.minimum.x+(o+1)*(a.maximum.x-a.minimum.x)/(e.length+2),a.maximum.y+c,(2*a.minimum.z+a.center.z)/3),h.rotationQuaternion=null,h.rotation.copyFromFloats(Math.PI,0,0)}),t.forEach((h,o)=>{const c=h.getChildMeshes().find(_=>_.name==="placard-base").getBoundingInfo().boundingBox,u=h.position.y-c.minimum.y;h.position.y=a.maximum.y+u,h.position.x=a.minimum.x+(o+1)*(a.maximum.x-a.minimum.x)/(t.length+2)+.2,h.position.z=(2*a.minimum.z+a.center.z)/3+.2,h.rotationQuaternion=null,h.rotation.copyFromFloats(0,Math.PI/2,0)}),i.position.copyFromFloats(e[0].position.x+.5,a.maximum.y,e[0].position.z+.3),i.rotationQuaternion=null,i.rotation.copyFromFloats(0,-Math.PI/2,Math.PI),n.position.copyFromFloats(3.73,1.77,-2.51),n.rotationQuaternion=null,n.rotation.copyFromFloats(0,0,Math.PI)}}const ke="./",ct=`${ke}images/sopTemplate.svg`,dt=`${ke}json/HUDhints.json`;var x=(s=>(s[s.SUCCESSFUL=0]="SUCCESSFUL",s[s.FAILURE=1]="FAILURE",s[s.RESET=2]="RESET",s))(x||{});class ae{name;description;#e;optional;subtasks;subtaskObservers;onTaskStateChangeObservable;constructor(e,t,i,r=!1){if(this.name=e,this.description=t,this.#e=2,this.optional=r,i.some(n=>n.length===0))throw new Error(`Task ${this.name}: subtask partition must not be empty.`);this.subtasks=i,this.onTaskStateChangeObservable=new O,this.subtaskObservers=this.subtasks.map(n=>n.map((a,h)=>{const o=a.onTaskStateChangeObservable.add((l,c)=>{switch(l){case 1:a.optional||this.fail();break;case 0:if(h!==0&&n[h-1].status!==0){c.skipNextObservers=!0;break}this.subtasks.every(_=>_.at(-1).status===0)&&this.#t();break}});return a.onTaskStateChangeObservable.makeObserverTopPriority(o),o}))}fail=()=>{if(this.#e!==2)throw new Error(`Attempted to fail a Task (${this.name}) which has already succeeded or failed.`);if(this.onTaskStateChangeObservable.notifyObservers(1))Z(`Failing Task ${this.name}`),this.#e=1;else throw new Error(`Task ${this.name}: An observer skipped following observers.`)};succeed=()=>{if(this.subtasks.length)throw new Error(`Task ${this.name} has subtasks and cannot be manually succeeded.`);this.#t()};#t=()=>{if(this.#e!==2)throw new Error(`Attempted to succeed a Task (${this.name}) which has already succeeded or failed.`);this.#e=0,this.onTaskStateChangeObservable.notifyObservers(this.#e)?Z(`Succeeding Task ${this.name}`):(this.#e=2,this.fail())};reset=()=>{this.subtasks.forEach(e=>{e.forEach(t=>t.reset())}),this.#e=2,this.onTaskStateChangeObservable.notifyObservers(this.#e)};get failed(){return this.#e===1}get successful(){return this.#e===0}get status(){return this.#e}}class ut{mesh;extinguished=!1;onFireObservable=new O;constructor(){}get name(){return"Fire"}init(){}attach=e=>{this.mesh=e};extinguish=()=>{this.extinguished=!0,this.onFireObservable.notifyObservers(!1),this.mesh.isVisible=!1};detach=()=>{}}function gt(){const s=new Ue("fire");s.diffuseTexture=new G("images/fire.png"),s.distortionTexture=new G("images/distortion.png"),s.opacityTexture=new G("images/candleopacity.png"),s.speed=5;const e=new ze("spotlight",new b(2,2,2),new b(-1,-2,-1),3,1),t=new je(10240,e);t.usePercentageCloserFiltering=!0,t.bias=100,t.transparencyShadow=!0;const i=q.CreatePlane("fire-plane",{width:4,height:3});i.receiveShadows=!0,i.position.copyFromFloats(-4.1,0,-1.6),i.rotationQuaternion=null,i.rotation.copyFromFloats(0,-Math.PI/2,0),i.material=s,i.material.shadowDepthWrapper=new Ye(i.material),t.getShadowMap().renderList.push(i);const r=new ut;return i.addBehavior(r),i}class L extends ce{get thickness(){return this._thickness}set thickness(e){this._thickness!==e&&(this._thickness=e,this._markAsDirty())}get cornerRadius(){return this._cornerRadius[0]}set cornerRadius(e){e<0&&(e=0),!(this._cornerRadius[0]===e&&this._cornerRadius[1]===e&&this._cornerRadius[2]===e&&this._cornerRadius[3]===e)&&(this._cornerRadius[0]=this._cornerRadius[1]=this._cornerRadius[2]=this._cornerRadius[3]=e,this._markAsDirty())}get cornerRadiusX(){return this._cornerRadius[0]}set cornerRadiusX(e){this._cornerRadius[0]!==e&&(this._cornerRadius[0]=e)}get cornerRadiusY(){return this._cornerRadius[1]}set cornerRadiusY(e){this._cornerRadius[1]!==e&&(this._cornerRadius[1]=e)}get cornerRadiusZ(){return this._cornerRadius[2]}set cornerRadiusZ(e){this._cornerRadius[2]!==e&&(this._cornerRadius[2]=e)}get cornerRadiusW(){return this._cornerRadius[3]}set cornerRadiusW(e){this._cornerRadius[3]!==e&&(this._cornerRadius[3]=e)}constructor(e){super(e),this.name=e,this._thickness=1,this._cornerRadius=[0,0,0,0],this._cachedRadius=[0,0,0,0]}_getTypeName(){return"Rectangle"}_computeAdditionalOffsetX(){let e=0;return(this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0)&&(e+=1),this.thickness&&(e+=this.thickness/2),e}_computeAdditionalOffsetY(){let e=0;return(this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0)&&(e+=1),this.thickness&&(e+=this.thickness/2),e}_getRectangleFill(e){return this._getBackgroundColor(e)}_localDraw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY),(this._background||this._backgroundGradient)&&(e.fillStyle=this._getRectangleFill(e),this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0?(this._drawRoundedRect(e,this._thickness/2),e.fill()):e.fillRect(this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height)),this._thickness&&((this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),(this.color||this.gradient)&&(e.strokeStyle=this.gradient?this.gradient.getCanvasGradient(e):this.color),e.lineWidth=this._thickness,this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0?(this._drawRoundedRect(e,this._thickness/2),e.stroke()):e.strokeRect(this._currentMeasure.left+this._thickness/2,this._currentMeasure.top+this._thickness/2,this._currentMeasure.width-this._thickness,this._currentMeasure.height-this._thickness)),e.restore()}_additionalProcessing(e,t){super._additionalProcessing(e,t),this._measureForChildren.width-=2*this._thickness,this._measureForChildren.height-=2*this._thickness,this._measureForChildren.left+=this._thickness,this._measureForChildren.top+=this._thickness}_drawRoundedRect(e,t=0){const i=this._currentMeasure.left+t,r=this._currentMeasure.top+t,n=this._currentMeasure.width-t*2,a=this._currentMeasure.height-t*2;for(let h=0;h<this._cornerRadius.length;h++)this._cachedRadius[h]=Math.abs(Math.min(a/2,Math.min(n/2,this._cornerRadius[h])));e.beginPath(),e.moveTo(i+this._cachedRadius[0],r),e.lineTo(i+n-this._cachedRadius[1],r),e.arc(i+n-this._cachedRadius[1],r+this._cachedRadius[1],this._cachedRadius[1],3*Math.PI/2,Math.PI*2),e.lineTo(i+n,r+a-this._cachedRadius[2]),e.arc(i+n-this._cachedRadius[2],r+a-this._cachedRadius[2],this._cachedRadius[2],0,Math.PI/2),e.lineTo(i+this._cachedRadius[3],r+a),e.arc(i+this._cachedRadius[3],r+a-this._cachedRadius[3],this._cachedRadius[3],Math.PI/2,Math.PI),e.lineTo(i,r+this._cachedRadius[0]),e.arc(i+this._cachedRadius[0],r+this._cachedRadius[0],this._cachedRadius[0],Math.PI,3*Math.PI/2),e.closePath()}_clipForChildren(e){(this._cornerRadius[0]!==0||this._cornerRadius[1]!==0||this._cornerRadius[2]!==0||this._cornerRadius[3]!==0)&&(this._drawRoundedRect(e,this._thickness),e.clip())}}g([f()],L.prototype,"thickness",null);g([f()],L.prototype,"cornerRadius",null);g([f()],L.prototype,"cornerRadiusX",null);g([f()],L.prototype,"cornerRadiusY",null);g([f()],L.prototype,"cornerRadiusZ",null);g([f()],L.prototype,"cornerRadiusW",null);$("BABYLON.GUI.Rectangle",L);var H;(function(s){s[s.Clip=0]="Clip",s[s.WordWrap=1]="WordWrap",s[s.Ellipsis=2]="Ellipsis",s[s.WordWrapEllipsis=3]="WordWrapEllipsis"})(H||(H={}));class I extends m{get lines(){return this._lines}get resizeToFit(){return this._resizeToFit}set resizeToFit(e){this._resizeToFit!==e&&(this._resizeToFit=e,this._resizeToFit&&(this._width.ignoreAdaptiveScaling=!0,this._height.ignoreAdaptiveScaling=!0),this._markAsDirty())}get textWrapping(){return this._textWrapping}set textWrapping(e){this._textWrapping!==e&&(this._textWrapping=+e,this._markAsDirty())}get text(){return this._text}set text(e){this._text!==e&&(this._text=e+"",this._markAsDirty(),this.onTextChangedObservable.notifyObservers(this))}get textHorizontalAlignment(){return this._textHorizontalAlignment}set textHorizontalAlignment(e){this._textHorizontalAlignment!==e&&(this._textHorizontalAlignment=e,this._markAsDirty())}get textVerticalAlignment(){return this._textVerticalAlignment}set textVerticalAlignment(e){this._textVerticalAlignment!==e&&(this._textVerticalAlignment=e,this._markAsDirty())}set lineSpacing(e){this._lineSpacing.fromString(e)&&this._markAsDirty()}get lineSpacing(){return this._lineSpacing.toString(this._host)}get outlineWidth(){return this._outlineWidth}set outlineWidth(e){this._outlineWidth!==e&&(this._outlineWidth=e,this._markAsDirty())}get underline(){return this._underline}set underline(e){this._underline!==e&&(this._underline=e,this._markAsDirty())}get lineThrough(){return this._lineThrough}set lineThrough(e){this._lineThrough!==e&&(this._lineThrough=e,this._markAsDirty())}get applyOutlineToUnderline(){return this._applyOutlineToUnderline}set applyOutlineToUnderline(e){this._applyOutlineToUnderline!==e&&(this._applyOutlineToUnderline=e,this._markAsDirty())}get outlineColor(){return this._outlineColor}set outlineColor(e){this._outlineColor!==e&&(this._outlineColor=e,this._markAsDirty())}get wordDivider(){return this._wordDivider}set wordDivider(e){this._wordDivider!==e&&(this._wordDivider=e,this._markAsDirty())}get forceResizeWidth(){return this._forceResizeWidth}set forceResizeWidth(e){this._forceResizeWidth!==e&&(this._forceResizeWidth=e,this._markAsDirty())}constructor(e,t=""){super(e),this.name=e,this._text="",this._textWrapping=H.Clip,this._textHorizontalAlignment=m.HORIZONTAL_ALIGNMENT_CENTER,this._textVerticalAlignment=m.VERTICAL_ALIGNMENT_CENTER,this._resizeToFit=!1,this._lineSpacing=new Q(0),this._outlineWidth=0,this._outlineColor="white",this._underline=!1,this._lineThrough=!1,this._wordDivider=" ",this._forceResizeWidth=!1,this._applyOutlineToUnderline=!1,this.onTextChangedObservable=new O,this.onLinesReadyObservable=new O,this._linesTemp=[],this.text=t}_getTypeName(){return"TextBlock"}_processMeasures(e,t){(!this._fontOffset||this.isDirty)&&(this._fontOffset=m._GetFontOffset(t.font)),super._processMeasures(e,t),this._lines=this._breakLines(this._currentMeasure.width,this._currentMeasure.height,t),this.onLinesReadyObservable.notifyObservers(this);let i=0;for(let r=0;r<this._lines.length;r++){const n=this._lines[r];n.width>i&&(i=n.width)}if(this._resizeToFit){if(this._textWrapping===H.Clip||this._forceResizeWidth){const n=Math.ceil(this._paddingLeftInPixels)+Math.ceil(this._paddingRightInPixels)+Math.ceil(i);n!==this._width.getValueInPixel(this._host,this._tempParentMeasure.width)&&(this._width.updateInPlace(n,Q.UNITMODE_PIXEL),this._rebuildLayout=!0)}let r=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*this._lines.length|0;if(this._lines.length>0&&this._lineSpacing.internalValue!==0){let n=0;this._lineSpacing.isPixel?n=this._lineSpacing.getValue(this._host):n=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),r+=(this._lines.length-1)*n}r!==this._height.internalValue&&(this._height.updateInPlace(r,Q.UNITMODE_PIXEL),this._rebuildLayout=!0)}}_drawText(e,t,i,r){const n=this._currentMeasure.width;let a=0;switch(this._textHorizontalAlignment){case m.HORIZONTAL_ALIGNMENT_LEFT:a=0;break;case m.HORIZONTAL_ALIGNMENT_RIGHT:a=n-t;break;case m.HORIZONTAL_ALIGNMENT_CENTER:a=(n-t)/2;break}(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(r.shadowColor=this.shadowColor,r.shadowBlur=this.shadowBlur,r.shadowOffsetX=this.shadowOffsetX,r.shadowOffsetY=this.shadowOffsetY),this.outlineWidth&&r.strokeText(e,this._currentMeasure.left+a,i),r.fillText(e,this._currentMeasure.left+a,i),this._underline&&this._drawLine(this._currentMeasure.left+a,i+3,this._currentMeasure.left+a+t,i+3,r),this._lineThrough&&this._drawLine(this._currentMeasure.left+a,i-this.fontSizeInPixels/3,this._currentMeasure.left+a+t,i-this.fontSizeInPixels/3,r)}_drawLine(e,t,i,r,n){if(n.beginPath(),n.lineWidth=Math.round(this.fontSizeInPixels*.05),n.moveTo(e,t),n.lineTo(i,r),this.outlineWidth&&this.applyOutlineToUnderline)n.stroke(),n.fill();else{const a=n.strokeStyle;n.strokeStyle=n.fillStyle,n.stroke(),n.strokeStyle=a}n.closePath()}_draw(e){e.save(),this._applyStates(e),this._renderLines(e),e.restore()}_applyStates(e){super._applyStates(e),this.outlineWidth&&(e.lineWidth=this.outlineWidth,e.strokeStyle=this.outlineColor,e.lineJoin="miter",e.miterLimit=2)}_breakLines(e,t,i){this._linesTemp.length=0;const r=this.text.split(`
`);if(this._textWrapping===H.Ellipsis)for(const n of r)this._linesTemp.push(this._parseLineEllipsis(n,e,i));else if(this._textWrapping===H.WordWrap)for(const n of r)this._linesTemp.push(...this._parseLineWordWrap(n,e,i));else if(this._textWrapping===H.WordWrapEllipsis)for(const n of r)this._linesTemp.push(...this._parseLineWordWrapEllipsis(n,e,t,i));else for(const n of r)this._linesTemp.push(this._parseLine(n,i));return this._linesTemp}_parseLine(e="",t){return{text:e,width:this._getTextMetricsWidth(t.measureText(e))}}_getCharsToRemove(e,t,i){const r=e>t?e-t:0,n=e/i;return Math.max(Math.floor(r/n),1)}_parseLineEllipsis(e="",t,i){let r=this._getTextMetricsWidth(i.measureText(e)),n=this._getCharsToRemove(r,t,e.length);const a=Array.from&&Array.from(e);if(a)for(;a.length&&r>t;)a.splice(a.length-n,n),e=`${a.join("")}…`,r=this._getTextMetricsWidth(i.measureText(e)),n=this._getCharsToRemove(r,t,e.length);else{for(;e.length>2&&r>t;)e=e.slice(0,-n),r=this._getTextMetricsWidth(i.measureText(e+"…")),n=this._getCharsToRemove(r,t,e.length);e+="…"}return{text:e,width:r}}_getTextMetricsWidth(e){return e.actualBoundingBoxLeft!==void 0?Math.abs(e.actualBoundingBoxLeft)+Math.abs(e.actualBoundingBoxRight):e.width}_parseLineWordWrap(e="",t,i){const r=[],n=this.wordSplittingFunction?this.wordSplittingFunction(e):e.split(this._wordDivider);let a=this._getTextMetricsWidth(i.measureText(e));for(let h=0;h<n.length;h++){const o=h>0?e+this._wordDivider+n[h]:n[0],l=this._getTextMetricsWidth(i.measureText(o));l>t&&h>0?(r.push({text:e,width:a}),e=n[h],a=this._getTextMetricsWidth(i.measureText(e))):(a=l,e=o)}return r.push({text:e,width:a}),r}_parseLineWordWrapEllipsis(e="",t,i,r){const n=this._parseLineWordWrap(e,t,r);for(let a=1;a<=n.length;a++)if(this._computeHeightForLinesOf(a)>i&&a>1){const o=n[a-2],l=n[a-1];n[a-2]=this._parseLineEllipsis(o.text+this._wordDivider+l.text,t,r);const c=n.length-a+1;for(let u=0;u<c;u++)n.pop();return n}return n}_renderLines(e){if(!this._fontOffset||!this._lines)return;const t=this._currentMeasure.height;let i=0;switch(this._textVerticalAlignment){case m.VERTICAL_ALIGNMENT_TOP:i=this._fontOffset.ascent;break;case m.VERTICAL_ALIGNMENT_BOTTOM:i=t-this._fontOffset.height*(this._lines.length-1)-this._fontOffset.descent;break;case m.VERTICAL_ALIGNMENT_CENTER:i=this._fontOffset.ascent+(t-this._fontOffset.height*this._lines.length)/2;break}i+=this._currentMeasure.top;for(let r=0;r<this._lines.length;r++){const n=this._lines[r];r!==0&&this._lineSpacing.internalValue!==0&&(this._lineSpacing.isPixel?i+=this._lineSpacing.getValue(this._host):i=i+this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height)),this._drawText(n.text,n.width,i,e),i+=this._fontOffset.height}}_computeHeightForLinesOf(e){let t=this._paddingTopInPixels+this._paddingBottomInPixels+this._fontOffset.height*e;if(e>0&&this._lineSpacing.internalValue!==0){let i=0;this._lineSpacing.isPixel?i=this._lineSpacing.getValue(this._host):i=this._lineSpacing.getValue(this._host)*this._height.getValueInPixel(this._host,this._cachedParentMeasure.height),t+=(e-1)*i}return t}computeExpectedHeight(){var e;if(this.text&&this.widthInPixels){const t=(e=B.LastCreatedEngine)===null||e===void 0?void 0:e.createCanvas(0,0).getContext("2d");if(t){this._applyStates(t),this._fontOffset||(this._fontOffset=m._GetFontOffset(t.font));const i=this._lines?this._lines:this._breakLines(this.widthInPixels-this._paddingLeftInPixels-this._paddingRightInPixels,this.heightInPixels-this._paddingTopInPixels-this._paddingBottomInPixels,t);return this._computeHeightForLinesOf(i.length)}}return 0}dispose(){super.dispose(),this.onTextChangedObservable.clear()}}g([f()],I.prototype,"resizeToFit",null);g([f()],I.prototype,"textWrapping",null);g([f()],I.prototype,"text",null);g([f()],I.prototype,"textHorizontalAlignment",null);g([f()],I.prototype,"textVerticalAlignment",null);g([f()],I.prototype,"lineSpacing",null);g([f()],I.prototype,"outlineWidth",null);g([f()],I.prototype,"underline",null);g([f()],I.prototype,"lineThrough",null);g([f()],I.prototype,"applyOutlineToUnderline",null);g([f()],I.prototype,"outlineColor",null);g([f()],I.prototype,"wordDivider",null);g([f()],I.prototype,"forceResizeWidth",null);$("BABYLON.GUI.TextBlock",I);class d extends m{get isLoaded(){return this._loaded}isReady(){return this.isLoaded}get detectPointerOnOpaqueOnly(){return this._detectPointerOnOpaqueOnly}set detectPointerOnOpaqueOnly(e){this._detectPointerOnOpaqueOnly!==e&&(this._detectPointerOnOpaqueOnly=e)}get sliceLeft(){return this._sliceLeft}set sliceLeft(e){this._sliceLeft!==e&&(this._sliceLeft=e,this._markAsDirty())}get sliceRight(){return this._sliceRight}set sliceRight(e){this._sliceRight!==e&&(this._sliceRight=e,this._markAsDirty())}get sliceTop(){return this._sliceTop}set sliceTop(e){this._sliceTop!==e&&(this._sliceTop=e,this._markAsDirty())}get sliceBottom(){return this._sliceBottom}set sliceBottom(e){this._sliceBottom!==e&&(this._sliceBottom=e,this._markAsDirty())}get sourceLeft(){return this._sourceLeft}set sourceLeft(e){this._sourceLeft!==e&&(this._sourceLeft=e,this._markAsDirty())}get sourceTop(){return this._sourceTop}set sourceTop(e){this._sourceTop!==e&&(this._sourceTop=e,this._markAsDirty())}get sourceWidth(){return this._sourceWidth}set sourceWidth(e){this._sourceWidth!==e&&(this._sourceWidth=e,this._markAsDirty())}get sourceHeight(){return this._sourceHeight}set sourceHeight(e){this._sourceHeight!==e&&(this._sourceHeight=e,this._markAsDirty())}get imageWidth(){return this._imageWidth}get imageHeight(){return this._imageHeight}get populateNinePatchSlicesFromImage(){return this._populateNinePatchSlicesFromImage}set populateNinePatchSlicesFromImage(e){this._populateNinePatchSlicesFromImage!==e&&(this._populateNinePatchSlicesFromImage=e,this._populateNinePatchSlicesFromImage&&this._loaded&&this._extractNinePatchSliceDataFromImage())}get isSVG(){return this._isSVG}get svgAttributesComputationCompleted(){return this._svgAttributesComputationCompleted}get autoScale(){return this._autoScale}set autoScale(e){this._autoScale!==e&&(this._autoScale=e,e&&this._loaded&&this.synchronizeSizeWithContent())}get stretch(){return this._stretch}set stretch(e){this._stretch!==e&&(this._stretch=e,this._markAsDirty())}_rotate90(e,t=!1){var i,r;const n=this._domImage.width,a=this._domImage.height,h=((r=(i=this._host)===null||i===void 0?void 0:i.getScene())===null||r===void 0?void 0:r.getEngine())||B.LastCreatedEngine;if(!h)throw new Error("Invalid engine. Unable to create a canvas.");const o=h.createCanvas(a,n),l=o.getContext("2d");l.translate(o.width/2,o.height/2),l.rotate(e*Math.PI/2),l.drawImage(this._domImage,0,0,n,a,-n/2,-a/2,n,a);const c=o.toDataURL("image/jpg"),u=new d(this.name+"rotated",c);return t&&(u._stretch=this._stretch,u._autoScale=this._autoScale,u._cellId=this._cellId,u._cellWidth=e%1?this._cellHeight:this._cellWidth,u._cellHeight=e%1?this._cellWidth:this._cellHeight),this._handleRotationForSVGImage(this,u,e),this._imageDataCache.data=null,u}_handleRotationForSVGImage(e,t,i){e._isSVG&&(e._svgAttributesComputationCompleted?(this._rotate90SourceProperties(e,t,i),this._markAsDirty()):e.onSVGAttributesComputedObservable.addOnce(()=>{this._rotate90SourceProperties(e,t,i),this._markAsDirty()}))}_rotate90SourceProperties(e,t,i){let r=e.sourceLeft,n=e.sourceTop,a=e.domImage.width,h=e.domImage.height,o=r,l=n,c=e.sourceWidth,u=e.sourceHeight;if(i!=0){const _=i<0?-1:1;i=i%4;for(let S=0;S<Math.abs(i);++S)o=-(n-h/2)*_+h/2,l=(r-a/2)*_+a/2,[c,u]=[u,c],i<0?l-=u:o-=c,r=o,n=l,[a,h]=[h,a]}t.sourceLeft=o,t.sourceTop=l,t.sourceWidth=c,t.sourceHeight=u}_extractNinePatchSliceDataFromImage(){var e,t;const i=this._domImage.width,r=this._domImage.height;if(!this._workingCanvas){const o=((t=(e=this._host)===null||e===void 0?void 0:e.getScene())===null||t===void 0?void 0:t.getEngine())||B.LastCreatedEngine;if(!o)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=o.createCanvas(i,r)}const a=this._workingCanvas.getContext("2d");a.drawImage(this._domImage,0,0,i,r);const h=a.getImageData(0,0,i,r);this._sliceLeft=-1,this._sliceRight=-1;for(let o=0;o<i;o++){const l=h.data[o*4+3];if(l>127&&this._sliceLeft===-1){this._sliceLeft=o;continue}if(l<127&&this._sliceLeft>-1){this._sliceRight=o;break}}this._sliceTop=-1,this._sliceBottom=-1;for(let o=0;o<r;o++){const l=h.data[o*i*4+3];if(l>127&&this._sliceTop===-1){this._sliceTop=o;continue}if(l<127&&this._sliceTop>-1){this._sliceBottom=o;break}}}set domImage(e){this._domImage=e,this._loaded=!1,this._imageDataCache.data=null,this._domImage.width?this._onImageLoaded():this._domImage.onload=()=>{this._onImageLoaded()}}get domImage(){return this._domImage}_onImageLoaded(){this._imageDataCache.data=null,this._imageWidth=this._domImage.width,this._imageHeight=this._domImage.height,this._loaded=!0,this._populateNinePatchSlicesFromImage&&this._extractNinePatchSliceDataFromImage(),this._autoScale&&this.synchronizeSizeWithContent(),this.onImageLoadedObservable.notifyObservers(this),this._markAsDirty()}get source(){return this._source}static ResetImageCache(){d.SourceImgCache.clear()}_removeCacheUsage(e){const t=e&&d.SourceImgCache.get(e);t&&(t.timesUsed-=1,t.timesUsed===0&&d.SourceImgCache.delete(e))}set source(e){var t,i;if(this._source===e)return;this._removeCacheUsage(this._source),this._loaded=!1,this._source=e,this._imageDataCache.data=null,e&&(e=this._svgCheck(e));const r=((i=(t=this._host)===null||t===void 0?void 0:t.getScene())===null||i===void 0?void 0:i.getEngine())||B.LastCreatedEngine;if(!r)throw new Error("Invalid engine. Unable to create a canvas.");if(e&&d.SourceImgCache.has(e)){const n=d.SourceImgCache.get(e);this._domImage=n.img,n.timesUsed+=1,n.loaded?this._onImageLoaded():n.waitingForLoadCallback.push(this._onImageLoaded.bind(this));return}this._domImage=r.createCanvasImage(),e&&d.SourceImgCache.set(e,{img:this._domImage,timesUsed:1,loaded:!1,waitingForLoadCallback:[this._onImageLoaded.bind(this)]}),this._domImage.onload=()=>{if(e){const n=d.SourceImgCache.get(e);if(n){n.loaded=!0;for(const a of n.waitingForLoadCallback)a();n.waitingForLoadCallback.length=0;return}}this._onImageLoaded()},e&&(pe.SetCorsBehavior(e,this._domImage),pe.SetReferrerPolicyBehavior(this.referrerPolicy,this._domImage),this._domImage.src=e)}_svgCheck(e){if(window.SVGSVGElement&&e.search(/.svg#/gi)!==-1&&e.indexOf("#")===e.lastIndexOf("#")){this._isSVG=!0;const t=e.split("#")[0],i=e.split("#")[1],r=document.body.querySelector('object[data="'+t+'"]');if(r){const n=r.contentDocument;if(n&&n.documentElement){const a=n.documentElement.getAttribute("viewBox"),h=Number(n.documentElement.getAttribute("width")),o=Number(n.documentElement.getAttribute("height"));if(n.getElementById(i)&&a&&h&&o)return this._getSVGAttribs(r,i),e}r.addEventListener("load",()=>{this._getSVGAttribs(r,i)})}else{const n=document.createElement("object");n.data=t,n.type="image/svg+xml",n.width="0%",n.height="0%",document.body.appendChild(n),n.onload=()=>{const a=document.body.querySelector('object[data="'+t+'"]');a&&this._getSVGAttribs(a,i)}}return t}else return e}_getSVGAttribs(e,t){const i=e.contentDocument;if(i&&i.documentElement){const r=i.documentElement.getAttribute("viewBox"),n=Number(i.documentElement.getAttribute("width")),a=Number(i.documentElement.getAttribute("height")),h=i.getElementById(t);if(r&&n&&a&&h){const o=Number(r.split(" ")[2]),l=Number(r.split(" ")[3]),c=h.getBBox();let u=1,_=1,S=0,y=0;const A=h.transform.baseVal.consolidate().matrix;h.transform&&h.transform.baseVal.consolidate()&&(u=A.a,_=A.d,S=A.e,y=A.f),this.sourceLeft=(u*c.x+S)*n/o,this.sourceTop=(_*c.y+y)*a/l,this.sourceWidth=c.width*u*(n/o),this.sourceHeight=c.height*_*(a/l),this._svgAttributesComputationCompleted=!0,this.onSVGAttributesComputedObservable.notifyObservers(this)}}}get cellWidth(){return this._cellWidth}set cellWidth(e){this._cellWidth!==e&&(this._cellWidth=e,this._markAsDirty())}get cellHeight(){return this._cellHeight}set cellHeight(e){this._cellHeight!==e&&(this._cellHeight=e,this._markAsDirty())}get cellId(){return this._cellId}set cellId(e){this._cellId!==e&&(this._cellId=e,this._markAsDirty())}constructor(e,t=null){super(e),this.name=e,this._workingCanvas=null,this._loaded=!1,this._stretch=d.STRETCH_FILL,this._autoScale=!1,this._sourceLeft=0,this._sourceTop=0,this._sourceWidth=0,this._sourceHeight=0,this._svgAttributesComputationCompleted=!1,this._isSVG=!1,this._cellWidth=0,this._cellHeight=0,this._cellId=-1,this._populateNinePatchSlicesFromImage=!1,this._imageDataCache={data:null,key:""},this.onImageLoadedObservable=new O,this.onSVGAttributesComputedObservable=new O,this.source=t}contains(e,t){if(!super.contains(e,t))return!1;if(!this._detectPointerOnOpaqueOnly||!this._workingCanvas)return!0;const i=this._currentMeasure.width|0,r=this._currentMeasure.height|0,n=i+"_"+r;let a=this._imageDataCache.data;if(!a||this._imageDataCache.key!==n){const l=this._workingCanvas.getContext("2d");this._imageDataCache.data=a=l.getImageData(0,0,i,r).data,this._imageDataCache.key=n}return e=e-this._currentMeasure.left|0,t=t-this._currentMeasure.top|0,a[(e+t*i)*4+3]>0}_getTypeName(){return"Image"}synchronizeSizeWithContent(){this._loaded&&(this.width=this._domImage.width+"px",this.height=this._domImage.height+"px")}_processMeasures(e,t){if(this._loaded)switch(this._stretch){case d.STRETCH_NONE:break;case d.STRETCH_FILL:break;case d.STRETCH_UNIFORM:break;case d.STRETCH_NINE_PATCH:break;case d.STRETCH_EXTEND:this._autoScale&&this.synchronizeSizeWithContent(),this.parent&&this.parent.parent&&(this.parent.adaptWidthToChildren=!0,this.parent.adaptHeightToChildren=!0);break}super._processMeasures(e,t)}_prepareWorkingCanvasForOpaqueDetection(){var e,t;if(!this._detectPointerOnOpaqueOnly)return;const i=this._currentMeasure.width,r=this._currentMeasure.height;if(!this._workingCanvas){const h=((t=(e=this._host)===null||e===void 0?void 0:e.getScene())===null||t===void 0?void 0:t.getEngine())||B.LastCreatedEngine;if(!h)throw new Error("Invalid engine. Unable to create a canvas.");this._workingCanvas=h.createCanvas(i,r)}this._workingCanvas.getContext("2d").clearRect(0,0,i,r)}_drawImage(e,t,i,r,n,a,h,o,l){if(e.drawImage(this._domImage,t,i,r,n,a,h,o,l),!this._detectPointerOnOpaqueOnly)return;e=this._workingCanvas.getContext("2d"),e.drawImage(this._domImage,t,i,r,n,a-this._currentMeasure.left,h-this._currentMeasure.top,o,l)}_draw(e){e.save(),(this.shadowBlur||this.shadowOffsetX||this.shadowOffsetY)&&(e.shadowColor=this.shadowColor,e.shadowBlur=this.shadowBlur,e.shadowOffsetX=this.shadowOffsetX,e.shadowOffsetY=this.shadowOffsetY);let t,i,r,n;if(this.cellId==-1)t=this._sourceLeft,i=this._sourceTop,r=this._sourceWidth?this._sourceWidth:this._imageWidth,n=this._sourceHeight?this._sourceHeight:this._imageHeight;else{const a=this._domImage.naturalWidth/this.cellWidth,h=this.cellId/a>>0,o=this.cellId%a;t=this.cellWidth*o,i=this.cellHeight*h,r=this.cellWidth,n=this.cellHeight}if(this._prepareWorkingCanvasForOpaqueDetection(),this._applyStates(e),this._loaded)switch(this._stretch){case d.STRETCH_NONE:this._drawImage(e,t,i,r,n,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case d.STRETCH_FILL:this._drawImage(e,t,i,r,n,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case d.STRETCH_UNIFORM:{const a=this._currentMeasure.width/r,h=this._currentMeasure.height/n,o=Math.min(a,h),l=(this._currentMeasure.width-r*o)/2,c=(this._currentMeasure.height-n*o)/2;this._drawImage(e,t,i,r,n,this._currentMeasure.left+l,this._currentMeasure.top+c,r*o,n*o);break}case d.STRETCH_EXTEND:this._drawImage(e,t,i,r,n,this._currentMeasure.left,this._currentMeasure.top,this._currentMeasure.width,this._currentMeasure.height);break;case d.STRETCH_NINE_PATCH:this._renderNinePatch(e,t,i,r,n);break}e.restore()}_renderNinePatch(e,t,i,r,n){const a=this._sliceLeft,h=this._sliceTop,o=n-this._sliceBottom,l=r-this._sliceRight,c=this._sliceRight-this._sliceLeft,u=this._sliceBottom-this._sliceTop,_=this._currentMeasure.width-l-a+2,S=this._currentMeasure.height-o-h+2,y=this._currentMeasure.left+a-1,A=this._currentMeasure.top+h-1,w=this._currentMeasure.left+this._currentMeasure.width-l,T=this._currentMeasure.top+this._currentMeasure.height-o;this._drawImage(e,t,i,a,h,this._currentMeasure.left,this._currentMeasure.top,a,h),e.clearRect(y,this._currentMeasure.top,_,h),this._drawImage(e,t+this._sliceLeft,i,c,h,y,this._currentMeasure.top,_,h),e.clearRect(w,this._currentMeasure.top,l,h),this._drawImage(e,t+this._sliceRight,i,l,h,w,this._currentMeasure.top,l,h),e.clearRect(this._currentMeasure.left,A,a,S),this._drawImage(e,t,i+this._sliceTop,a,u,this._currentMeasure.left,A,a,S),e.clearRect(y,A,_,S),this._drawImage(e,t+this._sliceLeft,i+this._sliceTop,c,u,y,A,_,S),e.clearRect(w,A,l,S),this._drawImage(e,t+this._sliceRight,i+this._sliceTop,l,u,w,A,l,S),e.clearRect(this._currentMeasure.left,T,a,o),this._drawImage(e,t,i+this._sliceBottom,a,o,this._currentMeasure.left,T,a,o),e.clearRect(y,T,_,o),this._drawImage(e,t+this.sliceLeft,i+this._sliceBottom,c,o,y,T,_,o),e.clearRect(w,T,l,o),this._drawImage(e,t+this._sliceRight,i+this._sliceBottom,l,o,w,T,l,o)}dispose(){super.dispose(),this.onImageLoadedObservable.clear(),this.onSVGAttributesComputedObservable.clear(),this._removeCacheUsage(this._source)}}d.SourceImgCache=new Map;d.STRETCH_NONE=0;d.STRETCH_FILL=1;d.STRETCH_UNIFORM=2;d.STRETCH_EXTEND=3;d.STRETCH_NINE_PATCH=4;g([f()],d.prototype,"detectPointerOnOpaqueOnly",null);g([f()],d.prototype,"sliceLeft",null);g([f()],d.prototype,"sliceRight",null);g([f()],d.prototype,"sliceTop",null);g([f()],d.prototype,"sliceBottom",null);g([f()],d.prototype,"sourceLeft",null);g([f()],d.prototype,"sourceTop",null);g([f()],d.prototype,"sourceWidth",null);g([f()],d.prototype,"sourceHeight",null);g([f()],d.prototype,"populateNinePatchSlicesFromImage",null);g([f()],d.prototype,"autoScale",null);g([f()],d.prototype,"stretch",null);g([f()],d.prototype,"source",null);g([f()],d.prototype,"cellWidth",null);g([f()],d.prototype,"cellHeight",null);g([f()],d.prototype,"cellId",null);$("BABYLON.GUI.Image",d);class Le extends L{get image(){return this._image}get textBlock(){return this._textBlock}constructor(e){super(e),this.name=e,this.delegatePickingToChildren=!1,this.thickness=1,this.isPointerBlocker=!0;let t=null;this.pointerEnterAnimation=()=>{t=this.alpha,this.alpha-=.1},this.pointerOutAnimation=()=>{t!==null&&(this.alpha=t)},this.pointerDownAnimation=()=>{this.scaleX-=.05,this.scaleY-=.05},this.pointerUpAnimation=()=>{this.scaleX+=.05,this.scaleY+=.05}}_getTypeName(){return"Button"}_processPicking(e,t,i,r,n,a,h,o){if(!this._isEnabled||!this.isHitTestVisible||!this.isVisible||this.notRenderable||!super.contains(e,t))return!1;if(this.delegatePickingToChildren){let l=!1;for(let c=this._children.length-1;c>=0;c--){const u=this._children[c];if(u.isEnabled&&u.isHitTestVisible&&u.isVisible&&!u.notRenderable&&u.contains(e,t)){l=!0;break}}if(!l)return!1}return this._processObservables(r,e,t,i,n,a,h,o),!0}_onPointerEnter(e,t){return super._onPointerEnter(e,t)?(!this.isReadOnly&&this.pointerEnterAnimation&&this.pointerEnterAnimation(),!0):!1}_onPointerOut(e,t,i=!1){!this.isReadOnly&&this.pointerOutAnimation&&this.pointerOutAnimation(),super._onPointerOut(e,t,i)}_onPointerDown(e,t,i,r,n){return super._onPointerDown(e,t,i,r,n)?(!this.isReadOnly&&this.pointerDownAnimation&&this.pointerDownAnimation(),!0):!1}_getRectangleFill(e){return this.isEnabled?this._getBackgroundColor(e):this._disabledColor}_onPointerUp(e,t,i,r,n,a){!this.isReadOnly&&this.pointerUpAnimation&&this.pointerUpAnimation(),super._onPointerUp(e,t,i,r,n,a)}serialize(e){super.serialize(e),this._textBlock&&(e.textBlockName=this._textBlock.name),this._image&&(e.imageName=this._image.name)}_parseFromContent(e,t){super._parseFromContent(e,t),e.textBlockName&&(this._textBlock=this.getChildByName(e.textBlockName)),e.imageName&&(this._image=this.getChildByName(e.imageName))}static CreateImageButton(e,t,i){const r=new this(e),n=new I(e+"_button",t);n.textWrapping=!0,n.textHorizontalAlignment=m.HORIZONTAL_ALIGNMENT_CENTER,n.paddingLeft="20%",r.addControl(n);const a=new d(e+"_icon",i);return a.width="20%",a.stretch=d.STRETCH_UNIFORM,a.horizontalAlignment=m.HORIZONTAL_ALIGNMENT_LEFT,r.addControl(a),r._image=a,r._textBlock=n,r}static CreateImageOnlyButton(e,t){const i=new this(e),r=new d(e+"_icon",t);return r.stretch=d.STRETCH_FILL,r.horizontalAlignment=m.HORIZONTAL_ALIGNMENT_LEFT,i.addControl(r),i._image=r,i}static CreateSimpleButton(e,t){const i=new this(e),r=new I(e+"_button",t);return r.textWrapping=!0,r.textHorizontalAlignment=m.HORIZONTAL_ALIGNMENT_CENTER,i.addControl(r),i._textBlock=r,i}static CreateImageWithCenterTextButton(e,t,i){const r=new this(e),n=new d(e+"_icon",i);n.stretch=d.STRETCH_FILL,r.addControl(n);const a=new I(e+"_button",t);return a.textWrapping=!0,a.textHorizontalAlignment=m.HORIZONTAL_ALIGNMENT_CENTER,r.addControl(a),r._image=n,r._textBlock=a,r}}$("BABYLON.GUI.Button",Le);class ft{rect;text;button;constructor(e,t,i){this.rect=e,this.text=t,this.button=i}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e,document.exitPointerLock(),qt()}}class ee{advancedTexture;welcomePrompt;gameFinishPrompt;camera;screen;scene;constructor(e){this.scene=e,this.camera=e.activeCamera}createPromptWithButton(e,t=null,...i){this.screen=q.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=new b(0,0,.5),this.advancedTexture=le.CreateForMesh(this.screen);let r=new ce("container");var n=new L;n.width=.5,n.height=.2,n.color="cyan",n.thickness=4,n.background="white",r.addControl(n);var a=new I;a.text=e,a.color="black",a.fontSize="17px",a.resizeToFit=!0,a.textWrapping=!0,a.paddingBottomInPixels=40,a.paddingLeftInPixels=15,a.paddingRightInPixels=15,n.addControl(a);var h=Le.CreateSimpleButton("but1","Click to dismiss");h.width="150px",h.height="40px",h.color="black",h.cornerRadius=20,h.background="white",h.topInPixels=40;let o=new ft(n,a,h),l=this.scene.getMeshByName("Start");function c(){r.dispose(),l.dispose(),t&&t(...i)}return o.button.onPointerUpObservable.add(function(){c()}),o.button.onPointerEnterObservable.add(()=>{h.background="grey"}),o.button.onPointerOutObservable.add(()=>{h.background="white"}),r.addControl(o.button),r.addControl(h),this.advancedTexture.addControl(r),o}}class Se{static createWelcomeScreen(e){new ee(e).createPromptWithButton("Welcome to the game. Please click on the clipboard on the table to get started.").setVisible(!0)}static createSuccessScreen(e,t=null,...i){new ee(e).createPromptWithButton("Congratulations! You have completed the SOP",t,...i).setVisible(!0)}static createFailureScreen(e,t=null,...i){new ee(e).createPromptWithButton("Oops! You mixed the wrong chemicals which resulted in a fire",t,...i).setVisible(!0)}}const p={sop:null,taskList:null,json:null,sounds:{},hudHints:{}};class Y{#e;interactionManager;#t=null;#n=null;onGrabStateChangedObservable=new O;onActivationStateChangedObservable=new O;defaults={};hideGrabber=!0;#a;#r=!1;#i;#s=!1;#h=null;#o=null;#l=null;#c=!0;constructor(e,t){this.interactionManager=e,this.#i=!!t?.activatable,this.#a=t?.moveAttached!==!1;for(const i of[R.DESKTOP,R.MOBILE,R.XR,R.LOADING])this.defaults[i]={defaultPosition:t?.modeDefaults?.[i]?.defaultPosition||t?.defaultPosition||b.Zero(),defaultRotation:t?.modeDefaults?.[i]?.defaultRotation||t?.defaultRotation||b.Zero()}}get name(){return"Interactable"}set activatable(e){!e&&this.#s&&this.#u(),this.#i=e}get grabbing(){return!!this.#h&&!!this.#o}get grabStateObserver(){return this.#t}get activationStateObserver(){return this.#n}#d=()=>{this.#l=this.onGrabStateChangedObservable.add(({anchor:e,state:t})=>{if(t===v.GRAB){this.#e.setParent(e);const{defaultPosition:i,defaultRotation:r}=this.defaults[this.interactionManager.interactionMode];this.#e.position.copyFrom(i),this.#e.rotation.copyFrom(r)}else t===v.DROP&&this.#e.setParent(null)})};#f=()=>{this.#l.remove(),this.#l=null,this.grabbing&&this.#e.setParent(null)};set moveAttached(e){e&&!this.#a&&this.#e?this.#d():!e&&this.#a&&this.#e&&this.#f(),this.#a=e}set enabled(e){e&&!this.#c&&!this.#g&&this.#b?this.#p():!e&&this.#c&&this.#g&&this.#m(),this.#c=e}get enabled(){return this.#c}get#b(){return!!this.#e}#T=()=>{this.#s=!0,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#h,grabber:this.#o,state:N.ACTIVE})};#u=()=>{this.#s=!1,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#h,grabber:this.#o,state:N.INACTIVE})};#S=(e,t)=>{this.onGrabStateChangedObservable.notifyObservers({anchor:e,grabber:t,state:v.GRAB}),this.#h=e,this.#o=t,this.hideGrabber&&this.#r&&(t.isVisible=!1)};#_=()=>{this.#s&&this.#u(),this.hideGrabber&&this.#r&&(this.#o.isVisible=!0),this.onGrabStateChangedObservable.notifyObservers({anchor:this.#h,grabber:this.#o,state:v.DROP}),this.#h=null,this.#o=null};init(){}attach=e=>{this.#e=e,this.enabled&&this.#p(),this.#a&&this.#d(),this.interactionManager.interactableMeshes.push(this.#e)};#p=()=>{this.#t=this.interactionManager.onGrabStateChangedObservable.add(({anchor:e,grabber:t,state:i})=>{i===v.GRAB&&!this.grabbing?(this.#r=t.isVisible,this.#S(e,t)):i===v.DROP&&this.grabbing&&this.#_()},this.#e.uniqueId),this.#n=this.interactionManager.onActivationStateChangedObservable.add(({anchor:e,grabber:t,state:i})=>{this.#i&&this.grabbing&&(i===N.ACTIVE&&!this.#s?this.#T():i===N.INACTIVE&&this.#s&&this.#u())},this.#e.uniqueId)};enable=()=>{this.enabled=!0};disable=()=>{this.enabled=!1};#m=()=>{this.#t.remove(),this.#n.remove(),this.#t=null,this.#n=null};get#g(){return!!this.#t&&!!this.#n}detach=()=>{this.#a&&this.#f(),this.grabbing&&this.#_(),this.#g&&this.#m(),this.onGrabStateChangedObservable.clear(),this.onActivationStateChangedObservable.clear();const e=this.interactionManager.interactableMeshes.findIndex(t=>t===this.#e);e!==-1&&this.interactionManager.interactableMeshes.splice(e,1),this.#e=null}}class _t{highlightLayer;mesh;otherMesh;color;constructor(e){this.highlightLayer=new we("highlight-layer"),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1,this.color=e}get name(){return"Highlight"}init(){}attach=e=>{this.mesh=e};detach=()=>{this.unhighlightAll()};highlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)||this.highlightLayer.addMesh(this.mesh,this.color)};highlightOther=e=>{this.highlightLayer.hasMesh(e)||(this.otherMesh=e,this.highlightLayer.addMesh(this.otherMesh,this.color))};unhighlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh)};unhighlightOther=()=>{this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)};unhighlightAll=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh),this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)}}class z{text;advancedTexture;textBlock;rectangle;#e;_platform;set platform(e){this._platform=e,this.#t()}get platform(){return this._platform}#t=()=>{this.#e.setParent(W.originalScene.activeCamera),this.#e.position.copyFromFloats(0,-.5,2),this.#e.rotation.setAll(0)};constructor(e,t){e&&(this.text=e),t&&(this._platform=t),this.#e=ve("plane",{size:2},W.utilityLayerScene),this.#e.isPickable=!1,this.#t(),this.advancedTexture=le.CreateForMesh(this.#e),this.textBlock=new I("textblock"),this.rectangle=new L("rect"),this.rectangle.width=.25,this.rectangle.height=.33,this.rectangle.color="cyan",this.rectangle.thickness=4,this.rectangle.background="black",this.rectangle.alpha=.5,this.rectangle.horizontalAlignment=m.HORIZONTAL_ALIGNMENT_RIGHT,this.rectangle.verticalAlignment=m.VERTICAL_ALIGNMENT_TOP}handleStateChange(e,t,...i){return this._platform=t,e===E.GAME_STATE_START?(this.hideHUD(),new Be(p.hudHints.GAME_STATE_START[this._platform],this._platform)):null}displayHUD(){this.textBlock.text=this.text,this.textBlock.textWrapping=!0,this.textBlock.fontSize=20,this._platform==="mobile"&&(this.textBlock.fontSize=12),this.textBlock.horizontalAlignment=m.HORIZONTAL_ALIGNMENT_RIGHT,this.textBlock.verticalAlignment=m.VERTICAL_ALIGNMENT_TOP,this.textBlock.textVerticalAlignment=m.VERTICAL_ALIGNMENT_TOP,this.textBlock.textHorizontalAlignment=m.HORIZONTAL_ALIGNMENT_LEFT,this.textBlock.paddingTopInPixels=30,this.textBlock.paddingLeftInPixels=5,this.textBlock.alpha=1,this.textBlock.color="white",this.rectangle.addControl(this.textBlock),this.textBlock.isVisible=!0,this.rectangle.isVisible=!0,this.advancedTexture.addControl(this.rectangle)}hideHUD(){this.textBlock.isVisible=!1,this.rectangle.isVisible=!1}}class Be extends z{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...i){return this.hideHUD(),this.platform=t,new U(p.hudHints.GAME_STATE_BASE[this.platform],this.platform)}displayHUD(){let e=this.textBlock,t=this.advancedTexture;e.text=this.text,e.fontSize=30,e.fontWeight="bold",e.top=-50,e.color="white",t.addControl(e),e.isVisible=!0}}class U extends z{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...i){return this.platform=t,e===E.GAME_STATE_PICK_SOP?(this.hideHUD(),new mt(p.hudHints.GAME_STATE_PICK_SOP[this.platform],this.platform)):e===E.GAME_STATE_PICK_CYLINDER?(this.hideHUD(),new pt(p.hudHints.GAME_STATE_PICK_CYLINDER[this.platform],this.platform)):e===E.GAME_STATE_START?(this.hideHUD(),new Be(p.hudHints.GAME_STATE_START[this.platform],this.platform)):null}}class pt extends z{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...i){return this.platform=t,e===E.GAME_STATE_PASS?(this.hideHUD(),new Ce(p.hudHints.GAME_STATE_PASS[this.platform],this.platform,!0)):e===E.GAME_STATE_FAIL?(this.hideHUD(),new Ce(p.hudHints.GAME_STATE_FAIL[this.platform],this.platform)):e===E.GAME_STATE_DROP_CYLINDER?(this.hideHUD(),new U(p.hudHints.GAME_STATE_BASE[this.platform],this.platform)):null}}class Ce extends z{isPass;constructor(e,t,i=!1){super(e,t),this.displayHUD(),this.isPass=i}handleStateChange(e,t,...i){return this.platform=t,this.hideHUD(),e===E.GAME_STATE_SOP_PASS?new U(p.hudHints.GAME_STATE_SOP_PASS[this.platform],this.platform):e===E.GAME_STATE_BASE?new U(p.hudHints.GAME_STATE_BASE[this.platform],this.platform):new U(this.isPass?p.hudHints.GAME_STATE_BASE[this.platform]:this.text,this.platform)}}class mt extends z{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...i){return this.platform=t,this.hideHUD(),new U(p.hudHints.GAME_STATE_BASE[this.platform],this.platform)}}var E=(s=>(s[s.GAME_STATE_START=0]="GAME_STATE_START",s[s.GAME_STATE_BASE=1]="GAME_STATE_BASE",s[s.GAME_STATE_PICK_SOP=2]="GAME_STATE_PICK_SOP",s[s.GAME_STATE_DROP_SOP=3]="GAME_STATE_DROP_SOP",s[s.GAME_STATE_PICK_FIREEXTINGUISHER=4]="GAME_STATE_PICK_FIREEXTINGUISHER",s[s.GAME_STATE_DROP_FIREEXTINGUISHER=5]="GAME_STATE_DROP_FIREEXTINGUISHER",s[s.GAME_STATE_PICK_CYLINDER=6]="GAME_STATE_PICK_CYLINDER",s[s.GAME_STATE_DROP_CYLINDER=7]="GAME_STATE_DROP_CYLINDER",s[s.GAME_STATE_PASS=8]="GAME_STATE_PASS",s[s.GAME_STATE_FAIL=9]="GAME_STATE_FAIL",s[s.GAME_STATE_SOP_PASS=10]="GAME_STATE_SOP_PASS",s))(E||{});class bt{onStateChangeObervable=new O;currentGameState;platform;constructor(){this.currentGameState=new z(null,"desktop"),this.onStateChangeObervable.add(e=>{this.#e(e)}),this.platform="desktop",D.onModeChangeObservable.add(e=>{this.platform=this.#t(e),this.platform!=="loading"&&this.platform!=="null"&&this.#e(1)})}#e(e){let t=this.currentGameState.handleStateChange(e,this.platform);t!==null&&(this.currentGameState=t)}#t(e){switch(e){case R.DESKTOP:return"desktop";case R.MOBILE:return"mobile";case R.XR:return"xr";case R.LOADING:return"loading";default:return"null"}}}let k;const Tt=()=>{k=new bt,fetch(dt).then(s=>s.json()).then(s=>{p.hudHints=Object.assign({},s)})};class St{mesh;#e;#t;#n;#a=null;#r;#i;onBeforePourObservable;onMidPourObservable;onAfterPourObservable;liquidMesh;#s=!1;pourDelay=1e3;animating=!1;onAnimationChangeObservable;constructor(){this.#t=new _t(P.Green()),this.onBeforePourObservable=new O,this.onMidPourObservable=new O,this.onAfterPourObservable=new O,this.onAnimationChangeObservable=new O}get name(){return"Pouring"}init(){}attach=e=>{if(this.mesh=e,this.#e=this.mesh.getBehaviorByName("Interactable"),!this.#e)throw new Error(`${this.name} behavior must have Interactable present on the same mesh.`);this.mesh.addBehavior(this.#t);const t=e.getScene();t.activeCamera;const i=this.#e.interactionManager.interactableMeshes;this.#n=this.#e.onGrabStateChangedObservable.add(({state:n})=>{n===v.GRAB?(k.onStateChangeObervable.notifyObservers(E.GAME_STATE_PICK_CYLINDER),this.#r=t.onBeforeRenderObservable.add(()=>{const a=this.#h(i);this.#o(a)})):n===v.DROP&&(this.#o(null),k.onStateChangeObervable.notifyObservers(E.GAME_STATE_DROP_CYLINDER),this.#r&&(this.#r.remove(),this.#r=null))});let r=!1;this.#a=this.#e.onActivationStateChangedObservable.add(({state:n})=>{if(n===N.ACTIVE&&!this.#s&&this.#i){const a=this.#e.interactionManager.interactionMode;(a===R.DESKTOP||a===R.MOBILE)&&(this.mesh.rotation.z+=Math.PI/4,r=!0),this.pour()}else n===N.INACTIVE&&r&&(this.mesh.rotation.z-=Math.PI/4,r=!1)})};detach=()=>{this.#n.remove(),this.#a.remove(),this.#r&&this.#r.remove()};get empty(){return this.#s}set empty(e){this.#s&&!e?(this.liquidMesh&&(this.liquidMesh.isVisible=!0),this.#s=e):!this.#s&&e&&(this.liquidMesh&&(this.liquidMesh.isVisible=!1),this.#s=e)}#h(e){const t=e.filter(n=>{const a=this.mesh.absolutePosition.y>n.absolutePosition.y,h=!!n.getBehaviorByName("Pouring"),o=!n.getBehaviorByName("Interactable").grabbing,l=this.mesh.intersectsMesh(n);return a&&h&&o&&l});let i=null,r=Number.POSITIVE_INFINITY;for(const n of t){const a=b.Distance(this.mesh.absolutePosition,n.absolutePosition);a<r&&(i=n,r=a)}return i}#o(e){this.#i!==e&&(this.#i&&this.#i instanceof re&&this.#t.unhighlightAll(),this.#i=e,this.#i&&this.#i instanceof re&&(this.#t.highlightSelf(),this.#t.highlightOther(this.#i)))}pour=()=>{if(!this.#i)throw new Error("PouringBehavior: attempted pour with no current target.");const e=this.#i.getBehaviorByName("Pouring");if(!e)throw new Error("PouringBehavior: target is not pourable.");e.empty=!1;const t=this.#i;this.onBeforePourObservable.notifyObservers(t),this.onMidPourObservable.notifyObservers(t),this.onAfterPourObservable.notifyObservers(t),this.empty=!0}}function Ne(s,e){const t=s.getChildMeshes().find(r=>r.id.split("-").pop()==="liquid"),i=new j("liquid-material");i.diffuseColor=e,t.material=i}function te(s,e){Ne(s,e);const t=new de("dynamic-texture",256,null,!0,G.LINEAR_LINEAR_MIPNEAREST);t.uAng=Math.PI;const i=new j("cylinder-label-material");i.diffuseTexture=t;const r="bold 250px monospace",n=s.getChildMeshes().filter(l=>{const c=l.id.split("-").pop();return c==="label"||c==="labelback"});for(const l of n)l.material=i,t.drawText(s.id.split("-").pop().toUpperCase(),0,225,r,"black","white");const a=new Y(D,{activatable:!0,defaultRotation:new b(0,Math.PI/2,Math.PI)}),h=new St,o=new ge;s.addBehavior(a),s.addBehavior(h),h.liquidMesh=s.getChildMeshes().find(l=>l.id.split("-").pop()==="liquid"),s.addBehavior(o)}const Ct=(s,e)=>{let t=[],i=[],r={};e.forEach(n=>{n.logic&&n.logic.taskType==="pouring"&&It(s,n,t,i,r)}),Et(s,i),t.forEach(n=>{n.onTaskStateChangeObservable.add(a=>{a===x.SUCCESSFUL&&!p.sounds.success.isPlaying&&!p.sounds.explosion.isPlaying&&(p.sounds.ding.stop(),p.sounds.ding.play())})}),p.taskList=t},Ie=(s,e,t,i)=>{s===e?(k.onStateChangeObervable.notifyObservers(E.GAME_STATE_PASS),t.succeed()):(k.onStateChangeObervable.notifyObservers(E.GAME_STATE_FAIL),t.fail())},It=(s,e,t,i,r)=>{let n=e.taskName,a=e.text,h=e.logic,o=[];h.subtasks.forEach(_=>{let S=r[_];S&&o.push(S)});let l;o.length?l=new ae(n,a,[[...o]]):l=new ae(n,a,[]),t.push(l),i.push(l),r[n]=l;let u=s.getMeshByName(h.from).getBehaviorByName("Pouring");u.onMidPourObservable.add(_=>{Z(`Pouring mesh name: ${u.mesh.name}`),Z(`Poured mesh name: ${_.name}`);const S=_.getChildMeshes().find(w=>w.id.split("-").pop()==="liquid").material.diffuseColor,y=u.mesh.getChildMeshes().find(w=>w.id.split("-").pop()==="liquid").material.diffuseColor,A=new P((S.r+y.r)/2,(S.g+y.g)/2,(S.b+y.b)/2);Ne(_,A),u.animating?u.onAnimationChangeObservable.addOnce(()=>{Ie(_.name,h.to,l)}):Ie(_.name,h.to,l)})},Et=(s,e)=>{p.sop=new ae("SOP","Standard operating procedure for lab safety.",[e]),p.sop.onTaskStateChangeObservable.add(t=>{switch(t){case x.SUCCESSFUL:s.activeCamera,k.onStateChangeObervable.notifyObservers(E.GAME_STATE_SOP_PASS),Se.createSuccessScreen(s,()=>{Oe(),oe(s)}),p.sounds.success.stop(),p.sounds.success.play();break;case x.FAILURE:p.sounds.explosion.stop(),p.sounds.explosion.play();const r=gt().getBehaviorByName("Fire");r&&r.onFireObservable.add(n=>{n||(Se.createFailureScreen(s,()=>{Oe(),oe(s)}),p.sounds.success.stop(),p.sounds.success.play())});break;case x.RESET:break}})},yt={[x.SUCCESSFUL]:"correct",[x.FAILURE]:"incorrect",[x.RESET]:"empty"};class At{templateString;data;basicTasks;rootTask;#e;mesh;#t;#n;constructor(e,t,i,r){this.templateString=e,this.#t=Xe.compile(this.templateString),this.data=t,this.rootTask=i,this.basicTasks=r,this.#e=[],this.#n=0}get name(){return"UpdateClipboard"}init(){}#a=e=>this.#r.find(t=>t.taskName===e)||null;get#r(){return this.data.items[1].sublist}attach=e=>{this.mesh=e,this.#i(),this.#e.push(...this.basicTasks.map(t=>t.onTaskStateChangeObservable.add(i=>{const r=this.#a(t.name);r.indicator=yt[i],this.#i()}))),this.#e.push(this.rootTask.onTaskStateChangeObservable.add(t=>{}))};detach=()=>{for(let e of this.#e)e.remove()};#i=()=>{const e=document.createElement("template"),t=this.#t(this.data);e.innerHTML=t;const r=new XMLSerializer().serializeToString(e.content),n="data:image/svg+xml;utf8,"+encodeURIComponent(r),a=G.LoadFromDataString(`clipboard-texture-${this.#n++}`,n,this.mesh.getScene(),void 0,void 0,void 0,G.LINEAR_LINEAR_MIPNEAREST,()=>{a.uScale=1,a.vScale=-1,a.hasAlpha=!0,this.#s(a)})};#s=e=>{const t=this.mesh.material;t.diffuseTexture!==e&&(t.diffuseTexture&&t.diffuseTexture.dispose(),t.diffuseTexture=e)}}function Ot(s){const e=s.getScene(),t=new j("clipboard-material",e);t.emissiveColor.copyFrom(P.White()),t.useAlphaFromDiffuseTexture=!0;const i=s.getChildMeshes().find(a=>a.name===`${s.id}-plane`);i.material=t,fetch(ct).then(a=>a.text()).then(a=>{fetch("./json/sopData.json").then(h=>h.json()).then(h=>{let o=h.items[1].sublist;Ct(e,o);const l=new At(a,h,p.sop,p.taskList);i.addBehavior(l)})});const r=new Y(D,{defaultRotation:new b(Math.PI,Math.PI/2,Math.PI/2),modeDefaults:{[R.DESKTOP]:{defaultPosition:new b(0,0,-.5)},[R.MOBILE]:{defaultPosition:new b(0,0,-.5)}}});e.activeCamera,r.onGrabStateChangedObservable.add(({anchor:a,grabber:h,state:o})=>{o===v.GRAB?k.onStateChangeObervable.notifyObservers(E.GAME_STATE_PICK_SOP):k.onStateChangeObervable.notifyObservers(E.GAME_STATE_DROP_SOP)});const n=new ge;s.addBehavior(r),s.addBehavior(n)}function ie(s){const e=s.getScene(),t=s.name.split("-")[1],i=s.getChildMeshes().find(o=>o.name==="Placard"),r=s.getChildMeshes().find(o=>o.name==="Label");i.id="placard-base",i.name="placard-base";const n=new de("dynamic texture",256,e);n.wAng=-Math.PI/2,n.uAng=Math.PI;const a=new j("Mat",e);a.diffuseTexture=n,r.material=a,n.drawText(t.toUpperCase(),65,185,"bold 220px monospace","black","white"),i.addChild(r)}function wt(s){s.keysUp.push(87),s.keysDown.push(83),s.keysLeft.push(65),s.keysRight.push(68)}const vt=["WallsandFloor","Floor","Table","Roof","Countertop","Walls","FumehoodBase_LP","FumehoodInner_LP","FumehoodInnerHook_LP"];function Rt(s){s.getChildMeshes().forEach(e=>{vt.includes(e.name)&&(e.checkCollisions=!0)})}function Pt(s){const e=s.getScene().activeCamera;Rt(s),Me(e),wt(e)}class Mt{particleSystem;#e;constructor(e){this.#e=e,this.#t()}#t(){let e=this.#e.getScene(),t;me.IsSupported?(t=new me("particles",{capacity:15e3},e),t.activeParticleCount=2e3):t=new be("particles",2e3,e),t.particleTexture=new G("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",e),t.emitRate=150,t.createPointEmitter(new b(-3.5,-3.5,0),new b(3.5,3.5,0)),t.gravity=new b(0,0,20),t.isLocal=!0,t.minLifeTime=.3,t.maxLifeTime=.3,t.minEmitPower=.7,t.maxEmitPower=.5,t.minSize=.01,t.maxSize=.02;let i=.3;t.addSizeGradient(i,i,i),t.blendMode=be.BLENDMODE_STANDARD,t.emitter=this.#e,this.particleSystem=t}start(){this.particleSystem.start()}stop(){this.particleSystem.stop()}}const kt=2;function Lt(s){const e=new Y(D,{activatable:!0,defaultRotation:new b(0,0,Math.PI)}),t=new ge;s.addBehavior(e),s.addBehavior(t);let i=new Mt(s),r=null;const n=s.getScene(),a=q.CreateSphere("debug-sphere-1",{diameter:.1}),h=q.CreateSphere("debug-sphere-2",{diameter:.1});a.isVisible=!1,h.isVisible=!1,e.onActivationStateChangedObservable.add(({state:o})=>{o===N.ACTIVE?(i.start(),r=n.onBeforeRenderObservable.add(()=>{const l=new qe(s.absolutePosition,s.getDirection(Re.Z).normalize(),kt);a.setAbsolutePosition(l.origin),h.setAbsolutePosition(l.origin.add(l.direction.scale(l.length)));const c=n.pickWithRay(l,u=>{const _=u.getBehaviorByName("Fire");return!!(_&&!_.extinguished)});if(c.hit){const u=c.pickedMesh.getBehaviorByName("Fire");u.extinguished||u.extinguish()}})):o===N.INACTIVE&&(i.stop(),r&&(r.remove(),r=null))})}function Bt(s){const e=s.getChildMeshes(!0)[0];e.rotationQuaternion=null;const t=new Y(D,{moveAttached:!1});let i=null;const r=s.getScene();t.onGrabStateChangedObservable.add(({anchor:n,state:a})=>{a===v.GRAB?i=r.onBeforeRenderObservable.add(()=>{const h=n.getAbsolutePosition().subtract(e.getAbsolutePosition());if(h.y=0,h.x>0)return;const o=h.z<0?0:Math.PI,l=-Math.atan(h.x/h.z);e.rotation.copyFromFloats(0,l+o,0)}):a===v.DROP&&i&&(i.remove(),i=null)}),e.addBehavior(t)}const Nt=1.93,xt=1.3,Ee=(s,e)=>{let t=Math.floor(s.position.y*100)/100;t+e>=xt&&t+e<=Nt&&(s.position.y+=e)},Dt=s=>{const e=s.getScene();let t=null,i=null;const r=new Y(D,{moveAttached:!1});s.addBehavior(r),r.onGrabStateChangedObservable.add(({anchor:n,state:a})=>{if(a==v.GRAB){const h=s.getBehaviorByName("PointerDrag");if(h&&(i=h.onDragObservable.add(o=>{let l=o.delta.y;Ee(s,l)})),n){let o=b.Zero();o.copyFrom(n.getAbsolutePosition()),t=e.onBeforeRenderObservable.add(()=>{const l=n.getAbsolutePosition().subtract(o);let c=Math.floor(l.y*100)/100;Ee(s,c),o.copyFrom(n.getAbsolutePosition())})}}else a==v.DROP&&(i&&i.remove(),t&&t.remove())})};function Ht(s){const e=s.find(T=>T.name==="room"),t=s.find(T=>T.name==="placard"),i=s.find(T=>T.name==="cylinder").getChildMeshes(!0)[0],r=s.find(T=>T.name==="clipboard").getChildMeshes(!0)[0],n=s.find(T=>T.name==="fire-extinguisher").getChildMeshes(!0)[0],a=s.find(T=>T.name==="FireCabinet"),h=s.find(T=>T.name==="Glass Divider");Pt(e),Dt(h);const o=r.parent;o.id="clipboard-root",o.name=o.id,r.setParent(null),o.dispose(!0),Gt(r),Ot(r);const l=t.clone(`${t.name}-c`,t.parent),c=t.clone(`${t.name}-b`,t.parent),u=t;l.id=l.name,c.id=c.name,u.name+="-a",u.id=u.name,l.getChildMeshes().forEach(T=>T.name=T.name.split(".")[1]),c.getChildMeshes().forEach(T=>T.name=T.name.split(".")[1]),ie(l),ie(c),ie(u),s.push(l,c);const _=i.parent;i.setParent(null),_.dispose(!0);const S=i.clone(`${i.id}-c`,null),y=i.clone(`${i.id}-b`,null),A=i;Ft([A,y,S],["a","b","c"]),te(S,P.Blue()),te(y,P.Green()),te(A,P.Red());const w=n.parent;w.id="fire-extinguisher-root",w.name=w.id,n.setParent(null),w.dispose(),n.id="fire-extinguisher",n.name=n.id,Lt(n),Bt(a),s.push(S,y)}function Ft(s,e){s.forEach((t,i)=>{t.id=`cylinder-${e[i]}`,t.name=t.id,t.getChildMeshes().forEach(r=>{switch(r.id.split(".").pop()){case"BeakerLiquid":r.id=`${t.id}-liquid`,r.name=r.id;break;case"Label":r.id=`${t.id}-label`;break;case"LabelBack":r.id=`${t.id}-labelback`;break}})})}function Gt(s){s.id="clipboard",s.name=s.id,s.getChildMeshes().forEach(e=>{switch(e.id){case"Plane":e.id=`${s.id}-plane`,e.name=e.id;break;case"Clipper":e.id=`${s.id}-clip`,e.name=e.id;break;case"horizontalScrew":e.id=`${s.id}-screw`,e.name=e.id;break;case"metalThingy":e.id=`${s.id}-metal`,e.name=e.id;break}})}const xe=64,se=xe/2,Wt=.005;function Vt(s,e){const t=new de(s,xe),i=t.getContext();i.beginPath(),i.arc(se,se,se,0,2*Math.PI),i.fill(),t.update();const r=new j(s);r.diffuseTexture=t,r.opacityTexture=t;const n=ve(s,{size:Wt},e);return n.material=r,n}async function Ut(s,e){const t=await Pe([s,e]);let i=null,r=null;for(const n of t){const a=n.meshes.find(o=>o.id===s||o.id===e);for(const o of n.animationGroups)o.name+=`-${a.name}`,o.pause();const[h]=a.getChildMeshes();if(!h)throw new Error(`Cannot collapse the root mesh of ${a.name}`);if(h.id=a.id,h.name=a.name,h.setParent(null),a.dispose(!0),h.name===s)i=h;else if(h.name===e)r=h;else throw new Error("Base mesh name is invalid. This shouldn't be possible.")}if(!i)throw new Error("No left hand mesh found.");if(!r)throw new Error("No right hand mesh found.");return{left:i,right:r}}const zt={inputOptions:{doNotLoadControllerMeshes:!0},pointerSelectionOptions:{enablePointerSelectionOnAllControllers:!0},uiOptions:{onError:s=>console.error(s)}};async function jt(s){let e=!1;s.pointerSelection.laserPointerDefaultColor=P.Green(),s.pointerSelection.laserPointerPickedColor=P.Green(),s.pointerSelection.selectionMeshDefaultColor=P.Green(),s.pointerSelection.selectionMeshPickedColor=P.Green(),s.pointerSelection.displayLaserPointer=e,s.pointerSelection.displaySelectionMesh=e,window.addEventListener("keydown",n=>{n.keyCode===73&&(e=!e,s.pointerSelection.displayLaserPointer=e,s.pointerSelection.displaySelectionMesh=e)}),s.baseExperience.onStateChangedObservable.add(n=>{F.IN_XR}),s.baseExperience.camera.onAfterCameraTeleport.add(()=>{s.baseExperience.camera.position.y=s.baseExperience.camera.realWorldHeight});const r=await Ut("left","right");for(const n of s.input.controllers)ye(n,r[`${n.inputSource.handedness}`]);s.input.onControllerAddedObservable.add(n=>{ye(n,r[`${n.inputSource.handedness}`])}),s.input.onControllerRemovedObservable.add(n=>{let a=C.findIndex(h=>h===n.pointer.name);a!==-1&&C.splice(a,1),n.grip&&(a=C.findIndex(h=>h===n.grip.name),a!==-1&&C.splice(a,1))})}function ye(s,e){C.push(s.pointer.name),s.grip&&C.push(s.grip.name),e.isPickable=!1,Yt(s,e,s.inputSource.handedness)}function Yt(s,e,t){e.setParent(s.pointer),e.rotationQuaternion=null,t!=="none"?e.rotation.copyFromFloats(Math.PI,0,Math.PI/2):e.rotation.copyFromFloats(0,0,0),s.motionController&&Ae(s.motionController,e),s.onMotionControllerInitObservable.add(i=>{Ae(i,e)}),D.addSelector(s.pointer,e,[R.XR]),C.push(e.name)}function Ae(s,e){const t=s.getComponentOfType("squeeze"),i=e.getScene().animationGroups.find(r=>r.name===`Fist-${e.name}`);t.onButtonStateChangedObservable.add(r=>{const n=i.from+(i.to-i.from)*r.value;i.goToFrame(n)})}async function Xt(s){function e(t){for(const{name:i,path:r}of t)p.sounds[i]=new Ke(i,r,void 0)}return fetch(s).then(t=>t.json()).then(e)}let M,D;const C=[];let fe=!0;function qt(){fe=!1;const s=W?.utilityLayerScene.getMeshByName("reticle");s&&(s.isVisible=!1)}function Oe(){fe=!0;const s=W?.utilityLayerScene.getMeshByName("reticle");s&&(s.isVisible=!0)}let W;async function Kt(s){const e=new Ze(s),t=new $e("light1",new b(1,1,0),e),i=new Je("camera",et),r=document.getElementById("canvas");let n=!1;("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.maxTouchPoints>0)&&(n=!0),n?(i.inputs.clear(),i.inputs.add(new K)):r.addEventListener("click",()=>{fe&&r.requestPointerLock()}),$t(e,!0),st(i),e.activeCamera=i,e.activeCamera.attachControl(r,!0),t.intensity=0,ne.audioEngine.useCustomUnlockedButton=!0,W=new Qe(e);const a=Vt("reticle",W.utilityLayerScene);if(a.setParent(i),a.position.copyFrom(Re.Z),C.push(a.name),"xr"in window.navigator){M=await e.createDefaultXRExperienceAsync(zt),D=new ue(e,M),await jt(M),C.push(...e.meshes.map(o=>o.name));for(const o of M.input.controllers)C.push(o.pointer.name),o.grip&&C.push(o.grip.name);M.input.onControllerAddedObservable.add(o=>{C.push(o.pointer.name),o.grip&&C.push(o.grip.name)}),M.input.onControllerRemovedObservable.add(o=>{let l=C.findIndex(c=>c===o.pointer.name);l!==-1&&C.splice(l,1),o.grip&&(l=C.findIndex(c=>c===o.grip.name),l!==-1&&C.splice(l,1))}),C.push("laserPointer"),a.isVisible=M.baseExperience.state!==F.IN_XR,M.baseExperience.onStateChangedObservable.add(o=>{a.isVisible=o!==F.IN_XR})}Tt(),await Xt("./json/sounds.json"),await oe(e);const h=document.querySelector("div.splash");return h.textContent="Click to start!",h.addEventListener("click",()=>{h.classList.add("hide"),ne.audioEngine.audioContext.resume()},!1),e}function Zt(s){let e=setInterval(()=>{s.intensity>=1?clearInterval(e):s.intensity+=.1},60)}async function oe(s){const e=s.getLightByName("light1");e.intensity=0;const t=s.activeCamera,i=s.meshes.filter(o=>!C.includes(o.name)).concat(W.utilityLayerScene.meshes.filter(o=>!C.includes(o.name)));for(const o of i)o.dispose();const n=(await Pe()).map(o=>o.meshes).flat();Ht(n),lt(n),ot(s),Me(t),"xr"in window.navigator&&(M.teleportation.removeFloorMeshByName("Floor"),M.teleportation.addFloorMesh(s.getMeshByName("Floor"))),document.exitPointerLock(),k.onStateChangeObervable.notifyObservers(E.GAME_STATE_START);const a=document.getElementById("canvas"),h=o=>{k.onStateChangeObervable.notifyObservers(E.GAME_STATE_BASE),a.removeEventListener("click",h)};return a.addEventListener("click",h),Zt(e),s}function $t(s,e){s.collisionsEnabled=!0}function Jt(s){window.addEventListener("resize",function(){s.resize()})}const Qt=document.getElementById("canvas"),he=new ne(Qt,!0,{stencil:!0});Jt(he);Kt(he).then(s=>{he.runRenderLoop(()=>s.render())});
