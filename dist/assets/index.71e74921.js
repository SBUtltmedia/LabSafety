import{H as ce,M as ie,V as b,S as E,D as se,T as L,P as G,C as Q,a as x,b as de,A as p,c as me,B as J,d as W,e as U,W as k,f as ue,g as ge,R as fe,h as pe,i as ye,E as K,j as be,k as Me,l as Ce,m as ee,n as Ae,o as Pe,U as Se,p as xe,q as ve}from"./vendor.64d77191.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&t(o)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerpolicy&&(s.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?s.credentials="include":n.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();window.exports=window;class Oe{complete=!1;title;description;failed=!1;onFail;onSuccess;onCompletion;currentState;tasks;constructor(e,i,t,n=0){this.title=e,this.description=i,this.tasks=t,this.currentState=n}resetSOP=()=>{this.currentState=0,this.failed=!1,this.complete=!1}}const F="./",T=60,Ie=50,ne=3,O="cylinder",w="liquid",Ne="placard",C=new Oe("","",[{next:"CtoA",label:"BtoC"},{next:"complete",label:"CtoA"}]);function S(m,e){return m.getChildMeshes().find(i=>i.name===e)||null}function B(m){m.rotation.x=0,m.rotation.y=0,m.rotation.z=0}class Y{name;position;mesh;dragCollision;highlightLayer;scene;particleSystem;currentColor;originalColor;startOpacity;toggleControllers;startPos;EllipsoidLines;moveFlag;pourLocations;rotateEnd;startRotation;dropped;constructor(e,i,t,n){this.name=t,this.moveFlag=!0,this.rotateEnd=!0,this.dropped=!1,this.currentColor=Object.assign({},n),this.originalColor=Object.assign({},n),this.startOpacity=.7;const s=e.getScene();this.scene=s,this.highlightLayer=new ce("highlight-layer",s),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1;const o=s.getMeshByName("Table");let a=.1,l=ie.CreateCylinder(`pivot-Cylinder-${t}`,{diameterTop:a,height:.33,diameterBottom:a},e.getScene());if(l.position._y+=.1,l.visibility=0,e.name=t,e.parent=l,e.rotationQuaternion=null,e.getChildMeshes().forEach(A=>{switch(A.name){case"BeakerwOpacity":A.name=O,A.rotationQuaternion=null,A.rotation.z=2*Math.PI,A.isPickable=!1;break;case"BeakerLiquid":A.name=w,A.isPickable=!1;break}}),o){const A=o.getBoundingInfo().boundingBox,v=S(e,O).getBoundingInfo().boundingBox.maximum.y;l.position.y=A.maximumWorld.y+v/2+.0075,l.position.x=(A.maximumWorld.x-A.minimumWorld.x)/ne*i+A.minimumWorld.x-.3,l.position.z=(A.centerWorld.z+A.minimumWorld.z)/2,this.position={...l.position}}else l.position.x=-2+i,l.position.y=1.22,l.position.z=.5;l.checkCollisions=!0,l.ellipsoid=new b(.02,.05,.02),this.startPos=Object.assign({},l.position),this.mesh=l,this.startRotation=Object.assign({},this.mesh.rotation);const d=S(e,w),u=new E("liquid-material");u.diffuseColor=n,d.material=u;const h=S(e,"Label"),f=S(e,"LabelBack"),g=new se("dynamic texture",256,s,!0,L.LINEAR_LINEAR_MIPNEAREST);g.uAng=Math.PI;const c=new E("Mat",s);c.diffuseTexture=g,h.material=c,f.material=c;const y="bold 250px monospace";g.drawText(e.name.toUpperCase(),0,225,y,"black","white");let P=this.mesh.getChildMeshes().find(A=>A.name==="cylinder");this.mesh.animations=P.animations;const M=new G("particles",500,this.scene);M.particleTexture=new L("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),M.minLifeTime=.5,M.maxLifeTime=.7,M.emitRate=100,M.gravity=new b(0,.5,0),M.minSize=.01,M.maxSize=.07,M.createPointEmitter(new b(0,0,0),new b(0,1,0)),M.addColorGradient(1,Q.FromColor3(d.material.diffuseColor,1)),M.blendMode=G.BLENDMODE_STANDARD,M.emitter=this.mesh.position,this.particleSystem=M,this.setOpacity(this.startOpacity),this.addDragCollision()}startParticles(){this.particleSystem.start()}highlight(e=!0){let i=S(this.mesh,O);e?this.highlightLayer.hasMesh(i)||this.highlightLayer.addMesh(i,x.Green()):this.highlightLayer.hasMesh(i)&&this.highlightLayer.removeMesh(i)}addDragCollision(){let e=new de({dragPlaneNormal:new b(0,0,1)});e.useObjectOrientationForDragging=!1,e.moveAttached=!1,e.onDragObservable.add(i=>{i.delta!=b.Zero()&&this.moveFlag&&this.mesh.isPickable&&this.mesh.moveWithCollisions(i.delta)}),e.onDragEndObservable.add(()=>{b.Distance(this.startPos,this.mesh.position)>.1?this.rotateEnd?(this.scene.stopAllAnimations(),this.fadeAndRespawn()):setTimeout(()=>{this.scene.stopAllAnimations(),this.fadeAndRespawn()},1e3):(this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z)}),this.mesh.addBehavior(e),this.dragCollision=e}removeDragCollision(){this.mesh.removeBehavior(this.dragCollision)}fadeAndRespawn(e=Ie,i=null,t=!0){this.mesh.isPickable=!1,setTimeout(()=>{let n=this.mesh.getBehaviorByName("PointerDrag");n&&n.releaseDrag();let s=30;this.mesh.name.split("-")[0];let o=this.mesh.getScene(),a=this.mesh.getChildMeshes(),l=a.find(h=>h.name==="cylinder");a.find(h=>h.name==="liquid");let u=[{name:"Invisibility",startValue:S(this.mesh,w).visibility},{name:"Visibility",startValue:0}];u.forEach(h=>{h.init=new p(h.name,"visibility",120,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT),h.init.setKeys([{frame:0,value:h.startValue},{frame:s,value:h.startValue===0?this.startOpacity:0}])});for(let h=0;h<a.length-1;++h){let f=a[h];o.beginDirectAnimation(f,[u[0].init],0,60,!1)}o.beginDirectAnimation(a[a.length-1],[u[0].init],0,60,!1,void 0,()=>{let h=S(this.mesh,O);B(this.mesh),B(h),this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z,this.mesh.animations=l.animations;for(let f=0;f<a.length-1;++f){let g=a[f];o.beginDirectAnimation(g,[u[1].init],0,60,!1)}o.beginDirectAnimation(a[a.length-1],[u[1].init],0,60,!1,void 0,()=>{if(this.highlight(!1),this.mesh.isPickable=t,S(this.mesh,"cylinder").visibility=this.startOpacity,i)for(let f of i)f&&(f.handMesh.visibility=1)})})},e)}rotateAnimation(e,i=null,t=!1){Object.assign({},this.mesh.position),this.mesh.checkCollisions=!1;let n=this.mesh.getAnimationByName(`${this.name}-${e}`);t||(this.moveFlag=!1,this.rotateEnd=!1,i&&(i.holdingMesh=null)),this.toggleControllers&&this.toggleControllers(),this.scene.beginDirectAnimation(this.mesh,[n],0,600,!1,.5,()=>{this.toggleControllers&&this.toggleControllers(),t||(this.moveFlag=!0,this.rotateEnd=!0,i&&(i.holdingMesh=this.mesh)),this.mesh.checkCollisions=!0})}setColor(e){const i=S(this.mesh,w),t=new E("liquid-material");t.diffuseColor=e,i.material=t,this.currentColor=e}setOpacity(e){const i=S(this.mesh,w);i.visibility=e}resetProperties(){this.setOpacity(this.startOpacity),this.setColor(this.originalColor),B(this.mesh),B(S(this.mesh,O))}showEffects(e=!1){if(e){this.particleSystem.particleTexture=new L("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),this.particleSystem.minLifeTime=.5,this.particleSystem.maxLifeTime=.7,this.particleSystem.emitRate=100,this.particleSystem.gravity=new b(0,.5,0),this.particleSystem.minSize=.01,this.particleSystem.maxSize=.07,this.particleSystem.createPointEmitter(new b(0,0,0),new b(0,1,0));const i=S(this.mesh,w);this.particleSystem.addColorGradient(1,Q.FromColor3(i.material.diffuseColor,1)),this.particleSystem.blendMode=G.BLENDMODE_STANDARD,this.particleSystem.emitter=this.mesh.position,this.particleSystem.start()}else this.particleSystem.stop()}}const Te="Stony Brook University VR Laboratory",we="Victor Ruben",Ee="VR Chemical Mixture Synthesis",Be="4/1/2023",Le="General: Properly mixing VR chemicals",ke="42",De="I",Re=[{text:"HAZARD IDENTIFICATION",sublistType:"a",sublist:[{text:"Improper mixing of chemicals can lead to explosive results!"}]},{text:"CHEMICAL HANDLING PROCEDURES",sublistType:"a",sublist:[{text:"When mixing these chemicals - always follow the correct sequence"},{text:"Pour chemical B into chemical C"},{text:"Then pour chemical mixture B+C into chemical A"}]},{text:"EMERGENCY PROCEDURES",sublistType:"a",sublist:[{text:"In the event of an improper mixture - use the fire extinguisher to put out the flames"},{text:"Evacuate the lab"},{text:"Call for emergency services"}]}],_e={facility:Te,labDirector:we,scope:Ee,lastRevision:Be,general:Le,sopNum:ke,listType:De,items:Re};function Fe(m){m.name="clipboard";const e=m.getScene(),i=e.getMeshByName("Table");if(i){const o=i.getBoundingInfo().boundingBox;m.position.y=o.maximumWorld.y+.003}m.rotationQuaternion=null,m.rotation=new b(0,Math.PI/4,0);const t=e.getMeshByName("pivot-Cylinder-A");t&&(m.position.x=t.position.x+.2,m.position.z=t.position.z+.5);function n(o){let a=document.createElement("template");a.innerHTML=o;var l=me.compile(a.innerHTML),d=l(_e);return a.innerHTML=d,a.content}function s(o){const l="data:image/svg+xml;utf8,"+encodeURIComponent(o),d=L.LoadFromDataString("tex",l,e,void 0,void 0,void 0,L.LINEAR_LINEAR_MIPNEAREST);let u=new E("mat",e);u.diffuseTexture=d,d.uScale=1,d.vScale=-1,u.emissiveColor=x.White(),u.useAlphaFromDiffuseTexture=!0,d.hasAlpha=!0;let h=S(m,"Plane");h.material=u}fetch(`${F}images/sopTemplate.svg`).then(o=>o.text()).then(o=>{let a=n(o);a.getElementById("procedure-list");const d=new XMLSerializer().serializeToString(a);s(d)}).catch(console.error.bind(console))}function We(m){var e=new J(x.FromHexString("#0984e3"));e.ignoreChildren=!0;var i=m[0],t=J.MakeNotPickableAndWrapInBoundingBox(i);e.attachedMesh=t,e.onScaleBoxDragObservable.add(()=>{}),e.onScaleBoxDragEndObservable.add(()=>{const n=e.attachedMesh;n&&n.getHierarchyBoundingVectors(!0)}),e.onRotationSphereDragObservable.add(()=>{}),e.onRotationSphereDragEndObservable.add(()=>{})}function q(m,e,i){const t=m.find(h=>h.name==="__root__"),n=t.getScene();t.name=i;const s=m.find(h=>h.name==="Label"),o=m.find(h=>h.name==="Placard");o.name=Ne;const a=new se("dynamic texture",256,n);a.wAng=-Math.PI/2,a.uAng=Math.PI;const l=new E("Mat",n);l.diffuseTexture=a,s.material=l;const d="bold 220px monospace";a.drawText(t.name.split("-")[1].toUpperCase(),65,185,d,"black","white"),o.addChild(s),o.rotationQuaternion=null,o.rotation=new b(0,Math.PI/2,0);const u=n.getMeshByName("Table");if(u){const h=u.getBoundingInfo().boundingBox;t.position.y=h.maximumWorld.y+.003,t.position.x=(h.maximumWorld.x-h.minimumWorld.x)/ne*e+h.minimumWorld.x-.2,t.position.z=(h.centerWorld.z+h.minimumWorld.z)/2+.2}}class oe{cylinderInstances;clipboard;isRotating;scene;labels;guiManager;soundManager;xrCamera;constructor(e,i,t,n,s){this.labels=["A","B","C"],this.scene=e,this.cylinderInstances=i,this.guiManager=t,this.soundManager=n,this.xrCamera=s,this.isRotating=!1}getCylinderInstanceFromMesh(e){let i=e.name.split("-")[2];for(let t of this.cylinderInstances)if(t.name==i)return t;return null}intersectHandCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(e.intersectsMesh(t,!1)&&t.isPickable)return t}return null}intersectCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(t!=e&&e.intersectsMesh(t))return t}return null}highlightCylinders(e,i){e.highlight(),i.highlight()}RotateCylinders(e,i,t=null){let n=e.mesh.position,s=i.mesh.position,o="rotateAroundZleft";i.mesh.rotation.y=e.mesh.rotation.y;let a=e.mesh.getHierarchyBoundingVectors(),l=a.max.y-a.min.y,d=.2,u=s.x;n.x-u;let h=S(e.mesh,O),f=S(i.mesh,O);s.x<n.x?h.rotation.y=Math.PI:(h.rotation.y=0,o="rotateAroundZright",d=-d),f.rotation.y=h.rotation.y,e.mesh.position.x=i.mesh.position.x+d,e.mesh.position.y=i.mesh.position.y+l/1.5,e.rotateAnimation(o,t)}moveWithCollisions(e,i){e.moveWithCollisions(i)}addColors(e,i){let t=e.currentColor,n=i.currentColor,s=new x((t.r+n.r)/2,(t.g+n.g)/2,(t.b+n.b)/2);i.setColor(s)}showFinishScreen(){for(let i of this.cylinderInstances)i.mesh.isPickable=!1,i.moveFlag=!1;function e(i){for(let t of i)t.mesh.isPickable=!0,t.moveFlag=!0,t.resetProperties(),t.showEffects(!1),setTimeout(()=>{t.setColor(t.originalColor)},1e3)}this.guiManager.createPromptWithButton("You have completed the task! The scene will now reset!",this.xrCamera,e,this.cylinderInstances)}showFailureScreen(){for(let i of this.cylinderInstances)i.mesh.isPickable=!1;function e(i){for(let t of i)t.mesh.isPickable=!0,t.moveFlag=!0,t.resetProperties(),t.showEffects(!1),setTimeout(()=>{t.setColor(t.originalColor)},1e3)}this.guiManager.createPromptWithButton("Task failed! The scene will now reset.",this.xrCamera,e,this.cylinderInstances)}playExplosion(){let e=this.soundManager.loadedSounds.explosion;e.stop(),e.play()}playDing(){let e=this.soundManager.loadedSounds.ding;e.stop(),e.play()}playSuccess(){let e=this.soundManager.loadedSounds.success;e.stop(),e.play()}}class ae extends oe{particleSystem;instances;constructor(e,i,t,n,s){super(e,i,t,n,s),this.instances=i}resetCylinders(){this.particleSystem&&this.particleSystem.stop();let e=["A","B","C"];for(let i=0;i<e.length;i++){const t=this.scene.getMeshByName(`pivot-Cylinder-${e[i]}`),n=this.scene.getMeshByName("Table");if(n&&t){const s=n.getBoundingInfo().boundingBox;t.position.z=(s.centerWorld.z+s.minimumWorld.z)/2}super.getCylinderInstanceFromMesh(t).showEffects(!1),super.getCylinderInstanceFromMesh(t).resetProperties(),super.getCylinderInstanceFromMesh(t).setColor(super.getCylinderInstanceFromMesh(t).originalColor),i==0&&(super.getCylinderInstanceFromMesh(t).setColor(x.Red()),super.getCylinderInstanceFromMesh(t).currentColor=x.Red())}}postSceneCylinder(){let e=["A","B","C"],i=[];for(let n of e){const s=this.scene.getMeshByName(`pivot-Cylinder-${n}`);i.push(s);let o=new p(`${n}-rotateAroundZleft`,"rotation.z",120,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT),a=S(s,O),l=[];l.push({frame:0,value:0}),l.push({frame:60,value:Math.PI/2}),a.animations.push(o),o.setKeys(l);let d=new p(`${n}-rotateAroundZright`,"rotation.z",120,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT);l=[],l.push({frame:0,value:0}),l.push({frame:60,value:-Math.PI/2}),a.animations.push(d),d.setKeys(l);let u=new p(`${n}-resetRotateAroundZleft`,"rotation.z",120,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:Math.PI/2}),h.push({frame:60,value:0}),a.animations.push(u),u.setKeys(h);let f=new p(`${n}-resetRotateAroundZright`,"rotation.z",120,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT);h=[],h.push({frame:0,value:-Math.PI/2}),h.push({frame:60,value:0}),a.animations.push(f),f.setKeys(h)}let t;for(let n=0;n<e.length;n++){const s=this.scene.getMeshByName(`pivot-Cylinder-${e[n]}`);let o=super.getCylinderInstanceFromMesh(s);const a=s.getBehaviorByName("PointerDrag");let l=[];for(let y of i)y!=s&&l.push(y);let d=!1,u=!1,h=S(s,O),f=!1,g="resetRotateAroundZleft",c;s.isPickable&&a.onDragObservable.add(()=>{let y=!1,r=!1;B(s);let P;const M=super.intersectCylinder(s);M&&(P=super.getCylinderInstanceFromMesh(M),t=P,super.highlightCylinders(o,P),r=!0,M.name.split("-")[2],s.name.split("-")[2],f||(f=!0,c=setTimeout(()=>{super.RotateCylinders(o,P);let A=M.name.split("-")[2],I=`${s.name.split("-")[2]}to${A}`;if(C.tasks[C.currentState].label===I)u=!0,C.tasks[C.currentState].next==="complete"?(y=!0,setTimeout(()=>{super.playSuccess()},500),setTimeout(()=>{o.fadeAndRespawn()},1500),C.resetSOP(),this.resetCylinders(),super.showFinishScreen()):(C.currentState=C.tasks.indexOf(C.tasks.find(v=>v.label==C.tasks[C.currentState].next)),super.playDing());else if(!d&&!u){for(let v of this.instances)v.mesh.isPickable=!1,v.moveFlag=!1;P.showEffects(!0),setTimeout(()=>{super.playExplosion()},800),setTimeout(()=>P.showEffects(!1),1e3),d=!0,setTimeout(()=>{a.releaseDrag(),super.showFailureScreen(),C.resetSOP(),d=!1},1500)}y||super.addColors(o,P),M.position.x>s.position.x&&(g="resetRotateAroundZright")},700))),r===!1&&o.rotateEnd&&(o.highlight(!1),t&&(t.highlight(!1),t=void 0),c?(clearTimeout(c),c=null,u=!1,f=!1):(u=!1,f&&(f=!1,o.rotateAnimation(g,null,!0))))}),a.onDragEndObservable.add(()=>{f=!1;for(let y of l)y!==h&&(o.highlight(!1),super.getCylinderInstanceFromMesh(y).highlight(!1),h.intersectsMesh(y)&&(o.rotateAnimation(g),h.position.x=0,h.position.y=0))})}}}class ze{flying=!1;active=!1;camera;mesh;offset=.4;animations;returnPosition;returnRotation;onPointerDownObserver;xrCamera;constructor(e){const i=new p("translate","position",T,p.ANIMATIONTYPE_VECTOR3),t=new p("rotate","rotation",T,p.ANIMATIONTYPE_VECTOR3);this.animations=[i,t],this.xrCamera=e}get name(){return"FlyToCamera"}init(){}attach=(e,i,t,n,s)=>{const o=e.getScene();if(this.mesh=e,!i&&(i=o.activeCamera,!i))throw new Error("The scene has no active camera, and no camera was provided.");this.camera=i,t||(t=this.mesh.position),n||(n=this.mesh.rotation),s&&(this.offset=s),this.returnPosition=t,this.returnRotation=n,this.onPointerDownObserver=o.onPointerObservable.add(this.clipboardClick)};detach=()=>{this.mesh.getScene().onPointerObservable.remove(this.onPointerDownObserver)};clipboardClick=(e={type:W.POINTERDOWN,pickInfo:{pickedMesh:this.mesh}})=>{if(e.type===W.POINTERDOWN){const i=e.pickInfo?.pickedMesh;if(i&&(i===this.mesh||i.isDescendantOf(this.mesh))&&!this.flying||this.active){const t=this.active?T/2:0,n=this.active?0:T/2;this.#e(),this.flying=!0,this.mesh.billboardMode==U.BILLBOARDMODE_ALL?this.mesh.billboardMode=U.BILLBOARDMODE_NONE:this.mesh.billboardMode=U.BILLBOARDMODE_ALL,this.mesh.getScene().beginDirectAnimation(this.mesh,this.animations,t,n,!1,void 0,()=>{this.flying=!1,this.active=!this.active})}}};calculateTargetPositionWithOffset=e=>{if(this.xrCamera!==void 0&&this.xrCamera.state===k.IN_XR){const o=this.xrCamera.camera._position.subtract(this.returnPosition).scale(1-e/b.Distance(this.returnPosition,this.xrCamera.camera._position));return this.returnPosition.add(o)}const t=this.camera._position.subtract(this.returnPosition).scale(1-e/b.Distance(this.returnPosition,this.camera._position));return this.returnPosition.add(t)};setClipboardUp=()=>new b(3.1468286,4.6617744,1.680752);#e=()=>{const e=this.animations.find(({name:s})=>s==="translate"),i=this.animations.find(({name:s})=>s==="rotate"),t=[{frame:0,value:this.returnPosition},{frame:T/2,value:this.calculateTargetPositionWithOffset(this.offset)}],n=[{frame:0,value:this.returnRotation},{frame:T/2,value:this.setClipboardUp()}];e.setKeys(t),i.setKeys(n)}}class He{rect;text;button;constructor(e,i,t){this.rect=e,this.text=i,this.button=t}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e}}class Ve{advancedTexture;welcomePrompt;gameFinishPrompt;camera;screen;scene;constructor(e){this.scene=e,this.camera=e.activeCamera}createPromptWithButton(e,i=null,t=null,...n){this.screen=ie.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=this.camera.position.add(new b(.6,-1.5,2.75)),this.advancedTexture=ue.CreateForMesh(this.screen);let s=new ge("container");var o=new fe;o.width=.5,o.height=.2,o.color="cyan",o.thickness=4,o.background="white",s.addControl(o);var a=new pe;a.text=e,a.color="black",a.fontSize="17px",a.resizeToFit=!0,a.textWrapping=!0,a.paddingBottomInPixels=40,a.paddingLeftInPixels=15,a.paddingRightInPixels=15,o.addControl(a);var l=ye.CreateSimpleButton("but1","Click to dismiss");l.width="150px",l.height="40px",l.color="black",l.cornerRadius=20,l.background="white",l.topInPixels=40;let d=new He(o,a,l),u=this.scene.getMeshByName("Start");document.getElementsByTagName("canvas")[0].addEventListener("pointerdown",function(){i.baseExperience.onStateChangedObservable.add(g=>{g===k.IN_XR&&f()})});function f(){s.dispose(),u.dispose(),t&&t(...n),i&&(i.pointerSelection.displayLaserPointer=!1,i.pointerSelection.displaySelectionMesh=!1)}return d.button.onPointerUpObservable.add(function(){f()}),d.button.onPointerEnterObservable.add(()=>{l.background="grey"}),d.button.onPointerOutObservable.add(()=>{l.background="white"}),s.addControl(d.button),s.addControl(l),this.advancedTexture.addControl(s),d}}class $e{soundList;soundPointer;scene;loadedSounds;constructor(e,i){this.scene=i,this.soundPointer=0,this.soundList=e,this.loadedSounds={}}enableAudio(){K.audioEngine.useCustomUnlockedButton=!0}async loadSounds(){let e=[];return new Promise(i=>{let t=0;this.soundList.forEach(n=>{if(e.push({soundName:n.soundName,sound:new be(n.soundName,n.fileName,this.scene,()=>{},{})}),t++,t===this.soundList.length){for(let s of e)this.loadedSounds[s.soundName]=s.sound;i(e)}})})}}class te extends oe{handedness;holdingInstance;holdingMesh;targetMesh;targetMeshInstance;motionController;handMesh;isVisible;failBeaker;particleSystem;cylinderInstancesHand;constructor(e,i,t,n,s,o){super(i,t,n,s,o),this.handedness=e,this.handMesh=i.getMeshByName(this.handedness),this.isVisible=!0,this.failBeaker=!1}getMotionController(){return this.motionController}setMotionController(e){this.motionController=e}dropped(e=null,i=!0){b.Distance(this.holdingInstance.mesh.position,this.holdingInstance.startPos)==0&&(i=!1),this.motionController.lastPosition=null,e&&clearInterval(e),this.motionController.grabbed=!1,this.motionController.meshGrabbed=void 0,this.holdingMesh&&(i&&this.holdingInstance.fadeAndRespawn(100,null,this.holdingMesh.isPickable),this.holdingMesh=null,this.holdingInstance=null,this.motionController.meshGrabbed=null)}updateSOPTask(e,i,t){let n=`${e}to${i}`;if(C.tasks[C.currentState].label===n)if(C.tasks[C.currentState].next==="complete"){new ae(this.scene,this.cylinderInstances,this.guiManager,this.soundManager,this.xrCamera);for(let s of this.cylinderInstances)s.moveFlag=!1,s.mesh.isPickable=!1;setTimeout(()=>{for(let s of this.cylinderInstances)s.fadeAndRespawn(100,null,!1);if(super.playSuccess(),this.disappearAnimation(!1),this.xrCamera.baseExperience.state==k.IN_XR){super.showFinishScreen();let s=this.scene.getMeshByName("Start");if(s){let o=this.xrCamera.baseExperience.camera;s.parent=o,s.position=o.position.add(new b(-o.position.x,-1.5,1.15)),s.position.x=0,s.position.y=0,s.position.z=.95,this.xrCamera.pointerSelection.displayLaserPointer=!0,this.xrCamera.pointerSelection.displaySelectionMesh=!0,s.rotation=b.Zero()}}},1e3),C.resetSOP(),this.particleSystem&&this.particleSystem.stop();for(let s of this.cylinderInstances)s.showEffects(!1);return!0}else{super.playDing(),C.currentState=C.tasks.indexOf(C.tasks.find(s=>s.label==C.tasks[C.currentState].next));return}else this.failBeaker||(setTimeout(()=>{if(this.xrCamera.baseExperience.state==k.IN_XR){super.showFailureScreen();let s=this.scene.getMeshByName("Start");if(s){let o=this.xrCamera.baseExperience.camera;s.parent=o,s.position=o.position.add(new b(-o.position.x,-1.5,1.15)),this.xrCamera.pointerSelection.displayLaserPointer=!0,this.xrCamera.pointerSelection.displaySelectionMesh=!0,s.position.x=0,s.position.y=0,s.position.z=.95,console.log(s),s.rotation=b.Zero()}}super.playExplosion(),this.targetMeshInstance.showEffects(!0)},1e3),C.resetSOP())}disappearAnimation(e=!0){let i=60,t=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}];t.forEach(n=>{n.init=new p(n.name,"visibility",120,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT),n.init.setKeys([{frame:0,value:n.startValue},{frame:i,value:1-n.startValue}])}),e?(this.isVisible=!1,this.scene.beginDirectAnimation(this.handMesh,[t[0].init],0,60,!1)):(this.isVisible=!0,this.scene.beginDirectAnimation(this.handMesh,[t[1].init],0,60,!1))}}function Ge(m,e,i,t,n,s){let o=new te("right",m,t,n,s,e),a=new te("left",m,t,n,s,e),l=!1,d={right:o,left:a},u=!1;function h(g){let c=g.name.split("-")[2];for(let y of t)if(y.name==c)return y;return null}let f=g=>{i(g),g.onMotionControllerInitObservable.add(c=>{let y=c;y.handID=c.handedness;let r=d[y.handedness];r.getMotionController()||r.setMotionController(y);let P=new Me(b.Zero(),b.Zero(),.25);const M=c.getComponentOfType("squeeze"),A=c.getComponentOfType("trigger");c.getComponentOfType("thumbstick").onAxisValueChangedObservable.add(()=>{e.baseExperience.camera.position.y=e.baseExperience.camera.realWorldHeight}),e.baseExperience.camera.onAfterCameraTeleport.add(()=>{e.baseExperience.camera.position.y=e.baseExperience.camera.realWorldHeight}),console.log("Motion controller: ",c),[A].forEach(I=>{I.onButtonStateChangedObservable.add(v=>{m.getMeshByName("Start")||(v.value>.3&&y.handID==="right"?(e.pointerSelection.displayLaserPointer=!0,e.pointerSelection.displaySelectionMesh=!0):(e.pointerSelection.displayLaserPointer=!1,e.pointerSelection.displaySelectionMesh=!1))})}),[M].forEach(I=>{let v="resetRotateAroundZleft";I.onButtonStateChangedObservable.add(z=>{let D,re={left:"Fist",right:"Fist"},X=m.animationGroups.find((N,$)=>N.name===`${r.motionController.handID}_${re[r.motionController.handID]}`);X.goToFrame(z.value*(X._to-1)+1);let R=r.intersectHandCylinder(m.getMeshByName(y.handID)),H,V;if(z.value>.5&&!r.motionController.grabbed){if(R&&R.isPickable){K.audioEngine.unlock(),l=!1,r.holdingMesh=R,r.holdingInstance=h(r.holdingMesh),r.motionController.meshGrabbed=r.holdingMesh,r.motionController.grabbed=!0;let N=r.motionController.lastPosition,$=P.origin;$!=N&&(r.disappearAnimation(!0),D=setInterval(()=>{let j=r.motionController.lastPosition;if(g.getWorldPointerRayToRef(P),j&&r.holdingMesh&&r.moveWithCollisions(r.holdingMesh,$.subtract(j)),!r.intersectHandCylinder(m.getMeshByName(r.motionController.handID))&&r.holdingMesh&&r.holdingInstance.rotateEnd&&(r.targetMeshInstance&&r.targetMeshInstance.highlight(!1),r.dropped(D),r.motionController.grabbed=!1,r.handMesh.visibility=1,l=!0,u=!1),r.holdingMesh){let _=r.intersectCylinder(r.holdingMesh);if(_){r.targetMesh=_,r.targetMeshInstance=h(_),r.highlightCylinders(r.holdingInstance,r.targetMeshInstance),r.targetMesh.position.x>r.holdingMesh.position.x&&(v="resetRotateAroundZright");let le=_.name.split("-")[2],he=r.holdingMesh.name.split("-")[2];u||(u=!0,V=setTimeout(()=>{r.addColors(r.holdingInstance,r.targetMeshInstance),l=r.updateSOPTask(he,le,D),r.holdingMesh&&(H=Object.assign({},r.holdingMesh.position)),r.RotateCylinders(r.holdingInstance,r.targetMeshInstance,r)},800))}else V&&(clearTimeout(V),r.targetMeshInstance&&r.targetMeshInstance.highlight(!1),r.holdingInstance.highlight(!1),u=!1,r.holdingMesh.rotation.z!=0&&H&&Math.abs(H._x-r.holdingMesh.position.x)>.2&&(r.targetMeshInstance&&r.targetMeshInstance.highlight(!1),r.holdingInstance.highlight(!1),r.holdingInstance.rotateAnimation(v,r,!0),u=!1))}!l&&r.holdingInstance&&r.holdingInstance.rotateEnd&&(r.motionController.lastPosition=Object.assign({},P.origin),y.lastPosition=Object.assign({},P.origin))},10))}}else if((!z.value||!R)&&r.holdingInstance){let N=function(){r.holdingMesh=r.holdingInstance.mesh,r.holdingInstance.highlight(!1),r.motionController.grabbed=!1,r.targetMeshInstance&&r.targetMeshInstance.highlight(!1),r.dropped(D),r.disappearAnimation(!1),u=!1};r.holdingInstance.rotateEnd?N():setTimeout(()=>{N()},800)}})})})};return function(){let c=e.input.onControllerAddedObservable;c.hasObservers()?c.clear():c.add(f)}}function Ue(m,e,i){let t,n;return new Promise(s=>{const o="./models/";let a="";var l={};let d=["left","right"],u={left:new x(1,0,0),right:new x(0,0,1)};const h=new Ce(m);d.forEach(g=>{h.addMeshTask(`load ${g} hand`,"",o,`${g}${a}.glb`)});let f=0;h.onTaskSuccess=g=>{l[d[f]]=g.loadedMeshes[1],g.loadedMeshes[1].name=d[f],t=g.loadedAnimationGroups;for(let c=0;c<t.length;c++)t[c].name=`${d[f]}_${t[c].name}`;f++},h.onTasksDoneObservable.add(()=>{for(let g=0;g<m.animationGroups.length;g++)m.animationGroups[g].pause();n=g=>{console.log(g);let c=g.inputSource.handedness;console.log(l[c]);let y=l[c].parent.parent;l[c].isPickable=!1;for(let M of i)M.removeDragCollision();let r=(Object.keys(l).indexOf(c)-1)*2-1;l[c].rotation.y=Math.PI*r,l[c].rotation.z=-Math.PI/2,l[c].rotation.x=-Math.PI/4;const P=new E("liquid-material");P.diffuseColor=u[c],l[c].material=P,y.parent=g.grip||g.pointer},e.baseExperience.onStateChangedObservable.add(g=>{if(g===k.IN_XR){e.baseExperience.camera.position.y=e.baseExperience.camera.realWorldHeight,e.baseExperience.camera.position.z=-.5;let c=m.getMeshByName("Start");if(c){let y=e.baseExperience.camera;c.parent=y,c.position=y.position.add(new b(-y.position.x,-1.5,1.15)),e.pointerSelection.displayLaserPointer=!0,e.pointerSelection.displaySelectionMesh=!0,c.position.x=0,c.position.y=0,c.position.z=.7,c.rotation=b.Zero()}}}),e.baseExperience.camera.onAfterCameraTeleport.add(()=>{e.baseExperience.camera.position.y=e.baseExperience.camera.realWorldHeight})}),h.loadAsync().then(()=>{s(n),document.getElementsByClassName("babylonVRicon")[0].addEventListener("click",c=>{console.log("hi",c);var y=new AudioContext;y.resume().then(()=>{console.log("Playback resumed successfully")})})})})}class Ye{scene;xrCamera;addHandModels;cylinders;guiManager;soundManager;constructor(e,i,t,n,s,o){this.scene=e,this.xrCamera=i,this.addHandModels=t,this.cylinders=n,this.guiManager=s,this.soundManager=o}async addWebXr(){return await Ue(this.scene,this.xrCamera,this.cylinders)}addWebXrBehaviors(){return Ge(this.scene,this.xrCamera,this.addHandModels,this.cylinders,this.guiManager,this.soundManager)}}class qe{doorMesh;scene;onPointerDownObserver;animations;animating;state;constructor(e){console.log(e[0]),this.scene=e[0].getScene(),console.log(this.scene),e.find(s=>s.name==="Cabinet"),this.doorMesh=e.find(s=>s.name==="Door"),this.doorMesh.rotationQuaternion=null,this.scene.activeCamera,this.doorMesh.rotation.y=Math.PI/2,this.animations=[];let i=new p("rotateAroundY","rotation.y",60,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT),t=[];t.push({frame:0,value:Math.PI/2}),t.push({frame:60,value:0}),this.doorMesh.animations.push(i),i.setKeys(t),this.animations.push(i);let n=new p("resetAroundY","rotation.y",60,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT);t=[],t.push({frame:0,value:0}),t.push({frame:60,value:Math.PI/2}),this.doorMesh.animations.push(n),n.setKeys(t),this.animations.push(n),this.onPointerDownObserver=this.scene.onPointerObservable.add(this.rotateAroundY),this.animating=!1,this.state=!0}rotateAroundY=(e={type:W.POINTERDOWN,pickInfo:{pickedMesh:this.doorMesh}})=>{if(e.type===W.POINTERDOWN){const i=e.pickInfo?.pickedMesh;if(!this.animating&&i&&(i===this.doorMesh||i.isDescendantOf(this.doorMesh))){this.animating=!0;let t;this.state===!0?t=this.animations[0]:t=this.animations[1],this.scene.beginDirectAnimation(this.doorMesh,[t],0,60,!1,1.5,()=>{this.animating=!1,this.state=!this.state})}}}}class Ke{handAnimation;sop;models;cylinders;guiManager;soundManager;loadedSounds;fireCabinet;constructor(){this.cylinders=[];let e="CylinderNewSmoothLabel.glb";this.models=[{fileName:"roomCabinet.glb",callback:t=>this.createRoom(t),label:"floor"},{fileName:"Placard_Label.glb",callback:t=>q(t,1,"Placard-A")},{fileName:"Placard_Label.glb",callback:t=>q(t,2,"Placard-B")},{fileName:"Placard_Label.glb",callback:t=>q(t,3,"Placard-C")},{fileName:e,callback:t=>this.cylinders.push(new Y(t[0],1,"A",new x(1,0,0))),label:"Cylinder-A"},{fileName:e,callback:t=>this.cylinders.push(new Y(t[0],2,"B",new x(0,1,0))),label:"Cylinder-B"},{fileName:e,callback:t=>this.cylinders.push(new Y(t[0],3,"C",new x(0,0,1))),label:"Cylinder-C"},{fileName:"clipBoardWithPaperCompressedTextureNew.glb",callback:t=>Fe(t[0])}].map(function(t){return Object.assign({},{fileName:"LabBench.glb",root:"./models/",callback:We,label:"NoLabel"},t)});let i=[{soundName:"explosion",fileName:`${F}/sound/mi_explosion_03_hpx.mp3`},{soundName:"ding",fileName:`${F}/sound/ding-idea-40142.mp3`},{soundName:"success",fileName:`${F}/sound/success.mp3`}];this.loadedSounds=[],this.createScene().then(t=>{this.soundManager=new $e(i,t),this.soundManager.enableAudio(),this.soundManager.loadSounds().then(n=>{this.loadedSounds=n;for(let s of["A","B","C"])Object.assign({},t.getMeshByName(`pivot-Cylinder-${s}`).position);for(let s of this.loadedSounds);this.processScene(t,this.cylinders,this.soundManager)})})}async processScene(e,i,t){let n=e.getCameraByName("camera"),s=e.getLightByName("light1"),o;n.speed=.16;let a=setInterval(()=>{s.intensity>=1?clearInterval(a):s.intensity+=.1},60),l={floorMeshes:[e.getMeshByName("Floor")],inputOptions:{doNotLoadControllerMeshes:!0}};o=await e.createDefaultXRExperienceAsync(l),o.baseExperience.camera.position.z-=.5;let d=!1;o.pointerSelection.laserPointerDefaultColor=x.Green(),o.pointerSelection.laserPointerPickedColor=x.Green(),o.pointerSelection.selectionMeshPickedColor=x.Green(),o.pointerSelection.selectionMeshDefaultColor=x.Green(),o.pointerSelection.displayLaserPointer=!1,o.pointerSelection.displaySelectionMesh=!1,window.addEventListener("keydown",h=>{h.keyCode===73&&(d?d=!1:d=!0,o.pointerSelection.displayLaserPointer=d,o.pointerSelection.displaySelectionMesh=d)});let u=new Ye(e,o,null,i,null,this.soundManager);u.addWebXr().then(h=>{if(o){const c=new ze(o.baseExperience);e.getMeshByName("clipboard").addBehavior(c)}this.guiManager=new Ve(e),this.guiManager.createPromptWithButton("Welcome to the Lab Safety Simulation. Click on the clipboard to learn more about the simulation!",o),u.guiManager=this.guiManager,u.addHandModels=h,new ae(e,i,this.guiManager,t,o).postSceneCylinder();var g=u.addWebXrBehaviors();g();for(let c of i)c.toggleControllers=g})}createRoom(e){this.fireCabinet=new qe(e);const i=["WallsandFloor","Floor","Table","Roof","Countertop","Walls"];let t,n;for(let s of i){const o=e.find(a=>a.name===s);if(o&&(o.checkCollisions=!0,o.name==="Table")){const a=o.getBoundingInfo().boundingBox;a.center.x,t=o.getScene(),n=t.getCameraByName("camera"),n.position=new b(a.center.x-.5,a.center.y*2+1.75,-1.5),n.rotation=new b(Math.PI/8,0,0)}}}createFireAlarm(e){const i=e.find(a=>a.name==="__root__");i.rotationQuaternion=null,i.rotation.y=.5*Math.PI;const t=10,n=new p("xSlide","rotation.z",t,p.ANIMATIONTYPE_FLOAT,p.ANIMATIONLOOPMODE_CONSTANT),s=e.find(a=>a.name==="LeverRedone");s.rotationQuaternion=null;let o;o=e[0].getScene(),s.actionManager=new ee(o),s.actionManager.registerAction(new Ae(ee.OnPickUpTrigger,function(){o.beginAnimation(s,0,2*t,!0)})),n.setKeys([{frame:0,value:0},{frame:t,value:-.5*Math.PI}]),s.animations.push(n)}createScene(){return new Promise(e=>{const i=document.getElementById("canvas"),t=new K(i,!0,{stencil:!0}),n=new Pe(t);n.collisionsEnabled=!0,window.addEventListener("resize",function(){t.resize()});const s=new Se("camera",new b(0,1,-1.134),n);s.ellipsoid=new b(.4,.7,.4),s.attachControl(i,!0),s.applyGravity=!0,s.minZ=0,s.speed=0,s.checkCollisions=!0,s.keysUp.push(87),s.keysDown.push(83),s.keysLeft.push(65),s.keysRight.push(68);var o=new xe("light1",new b(1,1,0),n);o.intensity=0,Promise.all(this.models.map(a=>new Promise(l=>ve.ImportMesh("",a.root,a.fileName,n,function(d){a.mesh=d,l(d)})))).then(()=>{let a=[];this.models.map(l=>{a.push(l.callback(l.mesh)),e(n)})}),window.addEventListener("keydown",a=>{a.shiftKey&&a.ctrlKey&&a.altKey&&a.keyCode===73&&(n.debugLayer.isVisible()?n.debugLayer.hide():n.debugLayer.show())}),t.runRenderLoop(()=>{n.render()})})}}new Ke;
