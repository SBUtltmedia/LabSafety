import{A as ie,C as E,V as g,M as Re,E as Le,O,W as D,H as ve,a as q,b as P,c as ke,d as Ne,P as oe,e as z,f as K,S as De,F as Ge,T as L,g as Fe,h as He,i as $,j as Ve,k as Ue,R as Te,l as Ee,B as ze,m as Se,D as se,n as V,o as qe,G as le,p as he,q as $e,r as Ae,s as Xe,t as Ke,u as We,U as Ze,v as Q,w as je}from"./vendor-BPbd4YGt.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=i(n);fetch(n.href,a)}})();window.exports=window;const Ye=t=>{let e=ie.CreateFullscreenUI("UI"),i=0,s=0,n=0,a=0,r=150,l=-50,o,h=!1,u=!1,d=N("leftThumb",2,"blue",null);d.height="200px",d.width="200px",d.isPointerBlocker=!0,d.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_LEFT,d.verticalAlignment=E.VERTICAL_ALIGNMENT_BOTTOM,d.alpha=.4,d.left=r,d.top=l;let m=N("leftInnterThumb",4,"blue",null);m.height="80px",m.width="80px",m.isPointerBlocker=!0,m.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_CENTER,m.verticalAlignment=E.VERTICAL_ALIGNMENT_CENTER;let f=N("leftPuck",0,"blue","blue");f.height="60px",f.width="60px",f.isPointerBlocker=!0,f.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_CENTER,f.verticalAlignment=E.VERTICAL_ALIGNMENT_CENTER,d.onPointerDownObservable.add(function(A){f.isVisible=!0,f.left=A.x-d._currentMeasure.width*.5-r,f.left=f.left,f.top=e.getContext().canvas.height-A.y-d._currentMeasure.height*.5+l,f.top=f.top*-1,h=!0,d.alpha=.9}),d.onPointerUpObservable.add(function(A){i=0,s=0,h=!1,f.isVisible=!1,d.alpha=.4}),d.onPointerMoveObservable.add(function(A){h&&(i=A.x-d._currentMeasure.width*.5-r,s=e.getContext().canvas.height-A.y-d._currentMeasure.height*.5+l,f.left=i,f.top=s*-1,f.left=f.left,f.top=f.top)}),e.addControl(d),d.addControl(m),d.addControl(f),f.isVisible=!1;const y=.5;let p=N("rightThumb",2,"red",null);p.height="200px",p.width="200px",p.isPointerBlocker=!0,p.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_RIGHT,p.verticalAlignment=E.VERTICAL_ALIGNMENT_BOTTOM,p.alpha=.4,p.left=-r,p.top=l;let S=N("rightInnterThumb",4,"red",null);S.height="80px",S.width="80px",S.isPointerBlocker=!0,S.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_CENTER,S.verticalAlignment=E.VERTICAL_ALIGNMENT_CENTER;let c=N("rightPuck",0,"red","red");c.height="60px",c.width="60px",c.isPointerBlocker=!0,c.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_CENTER,c.verticalAlignment=E.VERTICAL_ALIGNMENT_CENTER,p.onPointerDownObservable.add(function(A){c.isVisible=!0,c.left=e.getContext().canvas.width-A.x-p._currentMeasure.width*.5-r,c.left=c.left*-1,c.top=e.getContext().canvas.height-A.y-p._currentMeasure.height*.5+l,c.top=c.top*-1,u=!0,p.alpha=.9}),p.onPointerUpObservable.add(function(A){n=0,a=0,u=!1,c.isVisible=!1,p.alpha=.4}),p.onPointerMoveObservable.add(function(A){u&&(n=e.getContext().canvas.width-A.x-p._currentMeasure.width*.5-r,a=e.getContext().canvas.height-A.y-p._currentMeasure.height*.5+l,c.left=n*-1,c.top=a*-1,c.left=c.left,c.top=c.top)}),e.addControl(p),p.addControl(S),p.addControl(c),c.isVisible=!1;let H=t.activeCamera,we=document.getElementById("canvas");H.attachControl(we,!0),t.registerBeforeRender(function(){o=g.TransformCoordinates(new g(i/3e3,0,s/3e3),Re.RotationY(H.rotation.y)),H.cameraDirection.addInPlace(o),H.cameraRotation.y+=y*n/15e3*-1,H.cameraRotation.x+=y*a/15e3*-1});function N(A,_e,Be,xe){let _=new Le;return _.name=A,_.thickness=_e,_.color=Be,_.background=xe,_.paddingLeft="0px",_.paddingRight="0px",_.paddingTop="0px",_.paddingBottom="0px",_}},Qe=new g(0,1,-1.134),Je=new g(.4,.7,.4),et=.16;function tt(t){t.ellipsoid=Je,t.applyGravity=!0,t.minZ=0,t.speed=et,t.checkCollisions=!0,t.needMoveForGravity=!1}function X(...t){}var M=(t=>(t[t.DESKTOP=0]="DESKTOP",t[t.XR=1]="XR",t[t.MOBILE=2]="MOBILE",t[t.LOADING=3]="LOADING",t))(M||{}),C=(t=>(t[t.GRAB=0]="GRAB",t[t.DROP=1]="DROP",t))(C||{}),B=(t=>(t[t.ACTIVE=0]="ACTIVE",t[t.INACTIVE=1]="INACTIVE",t))(B||{});const it=9,st=.005;class ne{onGrabStateChangedObservable=new O;onActivationStateChangedObservable=new O;onModeChangeObservable=new O;#e;highlightLayer;modeSelectorMap={0:{},1:{},2:{},3:{}};hasDefaultSelector=!1;#t=!1;#a=!1;#r=!1;#s=[];interactionMode=3;interactableMeshes=[];xrExperience;constructor(e,i){this.#e=e,i&&(this.xrExperience=i,this.xrExperience.baseExperience.onStateChangedObservable.add(s=>{this.#u(s)})),this.#u(this.xrExperience===void 0?D.NOT_IN_XR:this.xrExperience.baseExperience.state),this.highlightLayer=new ve("interaction-highlight-layer"),this.#e.onBeforeRenderObservable.add(()=>{this.#s.splice(0,this.#s.length);const s=this.getActiveSelectors(),n=s.filter(({grabbedMesh:o})=>!!o).map(({grabbedMesh:o})=>o),a=s.filter(({grabbedMesh:o})=>!o),r=this.interactableMeshes.filter(o=>!n.includes(o)),l={};for(const o of a){const h=[];for(const u of r)o.grabber.intersectsMesh(u,!0)&&h.push(u);o.targetMesh=this.#b(o.grabber,h),o.targetMesh&&(l[o.targetMesh.uniqueId]=o.targetMesh)}this.#s.push(...Object.values(l)),this.highlightLayer.removeAllMeshes();for(const o of this.#s)o instanceof q&&this.highlightLayer.addMesh(o,P.Gray())})}#i=e=>{e.motionController&&this.#n(e.motionController,e.pointer.uniqueId),e.onMotionControllerInitObservable.add(i=>{this.#n(i,e.pointer.uniqueId)})};#n=(e,i)=>{const s=e.getComponentOfType("squeeze");s&&s.onButtonStateChangedObservable.add(()=>{s.changes.pressed&&this.#l(s.pressed,i)});const n=e.getMainComponent();n&&n.onButtonStateChangedObservable.add(()=>{n.changes.pressed&&this.#o(n.pressed,i)})};#l=(e,i)=>{const s=this.modeSelectorMap[this.interactionMode][i];e?s.targetMesh&&(s.grabbedMesh=s.targetMesh,s.targetMesh=null,this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:0})):s.grabbedMesh&&(this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:1}),s.grabbedMesh=null)};#o=(e,i)=>{const{anchor:s,grabber:n,grabbedMesh:a}=this.modeSelectorMap[this.interactionMode][i];a&&(e?this.#c(a,{anchor:s,grabber:n,state:0}):this.#c(a,{anchor:s,grabber:n,state:1}))};#h=(e,i)=>{if(e.isDisposed()){for(const n in this.modeSelectorMap)for(const a of Object.values(this.modeSelectorMap[n]))a.grabbedMesh===e&&(a.grabbedMesh=null);return}const s=e.getBehaviorByName("Interactable");if(!s)throw new Error("InteractionManager: grabbed mesh must have InteractableBehavior.");this.onGrabStateChangedObservable.notifyObserver(s.grabStateObserver,i)};#c=(e,i)=>{if(e.isDisposed())return;const s=e.getBehaviorByName("Interactable");if(!s)throw new Error("InteractionManager: activated mesh must have InteractableBehavior.");this.onActivationStateChangedObservable.notifyObserver(s.activationStateObserver,i,e.uniqueId)};#u=e=>{e===D.NOT_IN_XR?this.#d(0):e===D.IN_XR?this.#d(1):this.#d(3)};#d=e=>{const i=this.getActiveSelectors();this.onModeChangeObservable.notifyObservers(e);for(const s of i)s.grabbedMesh&&(this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:1}),s.grabbedMesh=null);this.interactionMode=e,(e===0||e===2)&&!this.hasDefaultSelector&&this.#p(this.#e.activeCamera),e===0?this.#m():e===2?this.#f():e===1&&this.#v()};addSelector=(e,i,s)=>{const n={anchor:e,grabber:i,grabbedMesh:null,targetMesh:null};for(const a of s)this.modeSelectorMap[a][e.uniqueId]=n};#p=e=>{const i=ke("default-grabber",{height:it,diameter:st});i.isVisible=!1,i.isPickable=!1,i.setParent(e),i.position.setAll(0),i.rotation.copyFromFloats(Math.PI/2,0,0);const s=new Ne("default-anchor");s.isPickable=!1,s.setParent(e),s.position.copyFrom(new g(0,0,1)),this.addSelector(s,i,[0,2]),this.hasDefaultSelector=!0};#m=()=>{if(this.#t)return;const e=Object.values(this.modeSelectorMap[0]).find(({anchor:s})=>s.name==="default-anchor");if(e===void 0)throw new Error("Tried to configure desktop interaction without default selector.");const{anchor:i}=e;this.#e.onPointerObservable.add(s=>{this.interactionMode===0&&(s.event.inputIndex===oe.LeftClick?s.type===z.POINTERDOWN?this.#l(!0,i.uniqueId):s.type===z.POINTERUP&&this.#l(!1,i.uniqueId):s.event.inputIndex===oe.RightClick&&(s.type===z.POINTERDOWN?this.#o(!0,i.uniqueId):s.type===z.POINTERUP&&this.#o(!1,i.uniqueId)))}),this.#t=!0};#f=()=>{if(this.#a)return;if(Object.values(this.modeSelectorMap[2]).find(({anchor:i})=>i.name==="default-anchor")===void 0)throw new Error("Tried to configure mobile interaction without default selector.");this.#a=!0};#v=()=>{if(!this.#r){if(!this.xrExperience)throw new Error("Tried to configure XR interaction without an XR experience.");this.xrExperience.input.controllers.forEach(this.#i),this.xrExperience.input.onControllerAddedObservable.add(this.#i),this.#r=!0}};getActiveSelectors=()=>Object.values(Object.values(this.modeSelectorMap[this.interactionMode]));#b=(e,i)=>ne.#g(e,i,this.interactionMode);static#g=(e,i,s)=>{let n=null,a=Number.POSITIVE_INFINITY;switch(s){case 0:case 2:case 1:for(const r of i){const l=g.Distance(e.getAbsolutePosition(),r.getAbsolutePosition());l<a&&(n=r,a=l)}break}return n}}const nt=.15;class ae{mesh;spawnPosition=g.Zero();spawnRotation=g.Zero();#e;#t;#a;#r=null;#s;#i;constructor(e=1.25){this.#e=e,this.#s=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}],this.#s.forEach(i=>{i.animation=new K(i.name,"visibility",60,K.ANIMATIONTYPE_FLOAT,K.ANIMATIONLOOPMODE_CONSTANT),i.animation.setKeys([{frame:0,value:i.startValue},{frame:30,value:i.startValue?0:1}])})}init(){}get name(){return"FadeAndRespawn"}attach(e){if(this.mesh=e,this.#t=this.mesh.getBehaviorByName("Interactable"),!this.#t)throw new Error(`${this.name} behavior must be attached to a mesh with an Interactable behavior.`);this.#i=this.mesh.getScene(),this.#a=this.#t.onGrabStateChangedObservable.add(({state:i})=>{i===C.DROP&&this.#n()})}detach(){this.#a.remove(),this.#r&&this.#r.remove()}#n(){if(Math.abs(g.Distance(this.mesh.getAbsolutePosition(),this.spawnPosition))<=nt){this.#o();return}this.#i.beginDirectHierarchyAnimation(this.mesh,!1,[this.#s.find(i=>i.name==="Invisibility").animation],0,60,!1,this.#e,()=>{this.#o(),this.#l()})}#l(){this.#i.beginDirectHierarchyAnimation(this.mesh,!1,[this.#s.find(e=>e.name==="Visibility").animation],0,60,!1,this.#e)}#o=()=>{this.mesh.position.copyFrom(this.spawnPosition),this.mesh.rotation.copyFrom(this.spawnRotation)};setSpawnPoint=(e,i)=>{this.spawnPosition.copyFrom(e),this.spawnRotation.copyFrom(i)}}function at(t){const e=t.meshes.map(i=>i.getBehaviorByName("FadeAndRespawn")).filter(i=>!!i);for(const i of e)i.setSpawnPoint(i.mesh.position,i.mesh.rotation)}const rt=["room","placard","cylinder","clipboard","fire-extinguisher"];function Ce(t=rt){return Promise.all(t.map(e=>De.ImportMeshAsync("","./models/",`${e}.glb`).then(i=>{const s=i.meshes.find(n=>n.id==="__root__");return s.id=e,s.name=e,i})))}function Me(t){const i=t.getScene().meshes.find(s=>s.name==="Table");if(t.rotation=g.Zero(),i){const s=i.getBoundingInfo().boundingBox;t.position.x=s.center.x-.5,t.position.y=s.center.y*2+.46,t.position.z=-3}else t.position=g.Zero()}function ce(t,e){return t.id<e.id?-1:t.id>e.id?1:0}function ot(t){const e=t.filter(r=>r.id.split("-").length===2&&r.id.split("-")[0]==="cylinder").sort(ce),i=t.filter(r=>r.name.split("-")[0]==="placard"&&!r.name.includes("placard-base")).sort(ce),s=t.find(r=>r.id==="clipboard"),n=t.find(r=>r.name==="Table"),a=t.find(r=>r.id==="fire-extinguisher");if(n){const r=n.getBoundingInfo().boundingBox;e.forEach((l,o)=>{const h=l.getBoundingInfo().boundingBox,u=l.position.y-h.minimum.y;l.position.copyFromFloats(r.minimum.x+(o+1)*(r.maximum.x-r.minimum.x)/(e.length+2),r.maximum.y+u,(2*r.minimum.z+r.center.z)/3),l.rotationQuaternion=null,l.rotation.copyFromFloats(Math.PI,0,0)}),i.forEach((l,o)=>{const u=l.getChildMeshes().find(m=>m.name==="placard-base").getBoundingInfo().boundingBox,d=l.position.y-u.minimum.y;l.position.y=r.maximum.y+d,l.position.x=r.minimum.x+(o+1)*(r.maximum.x-r.minimum.x)/(i.length+2)+.2,l.position.z=(2*r.minimum.z+r.center.z)/3+.2,l.rotationQuaternion=null,l.rotation.copyFromFloats(0,Math.PI/2,0)}),s.position.copyFromFloats(e[0].position.x+.5,r.maximum.y,e[0].position.z+.3),s.rotationQuaternion=null,s.rotation.copyFromFloats(0,-Math.PI/2,Math.PI),a.position.copyFromFloats(3.73,1.77,-2.51),a.rotationQuaternion=null,a.rotation.copyFromFloats(0,0,Math.PI)}}const Oe="./",lt=`${Oe}images/sopTemplate.svg`,ht=`${Oe}json/HUDhints.json`;var x=(t=>(t[t.SUCCESSFUL=0]="SUCCESSFUL",t[t.FAILURE=1]="FAILURE",t[t.RESET=2]="RESET",t))(x||{});class J{name;description;#e;optional;subtasks;subtaskObservers;onTaskStateChangeObservable;constructor(e,i,s,n=!1){if(this.name=e,this.description=i,this.#e=2,this.optional=n,s.some(a=>a.length===0))throw new Error(`Task ${this.name}: subtask partition must not be empty.`);this.subtasks=s,this.onTaskStateChangeObservable=new O,this.subtaskObservers=this.subtasks.map(a=>a.map((r,l)=>{const o=r.onTaskStateChangeObservable.add((h,u)=>{switch(h){case 1:r.optional||this.fail();break;case 0:if(l!==0&&a[l-1].status!==0){u.skipNextObservers=!0;break}this.subtasks.every(m=>m.at(-1).status===0)&&this.#t();break}});return r.onTaskStateChangeObservable.makeObserverTopPriority(o),o}))}fail=()=>{if(this.#e!==2)throw new Error(`Attempted to fail a Task (${this.name}) which has already succeeded or failed.`);if(this.onTaskStateChangeObservable.notifyObservers(1))X(`Failing Task ${this.name}`),this.#e=1;else throw new Error(`Task ${this.name}: An observer skipped following observers.`)};succeed=()=>{if(this.subtasks.length)throw new Error(`Task ${this.name} has subtasks and cannot be manually succeeded.`);this.#t()};#t=()=>{if(this.#e!==2)throw new Error(`Attempted to succeed a Task (${this.name}) which has already succeeded or failed.`);this.#e=0,this.onTaskStateChangeObservable.notifyObservers(this.#e)?X(`Succeeding Task ${this.name}`):(this.#e=2,this.fail())};reset=()=>{this.subtasks.forEach(e=>{e.forEach(i=>i.reset())}),this.#e=2,this.onTaskStateChangeObservable.notifyObservers(this.#e)};get failed(){return this.#e===1}get successful(){return this.#e===0}get status(){return this.#e}}class ct{mesh;extinguished=!1;onFireObservable=new O;constructor(){}get name(){return"Fire"}init(){}attach=e=>{this.mesh=e};extinguish=()=>{this.extinguished=!0,this.onFireObservable.notifyObservers(!1),this.mesh.isVisible=!1};detach=()=>{}}function dt(){const t=new Ge("fire");t.diffuseTexture=new L("images/fire.png"),t.distortionTexture=new L("images/distortion.png"),t.opacityTexture=new L("images/candleopacity.png"),t.speed=5;const e=new Fe("spotlight",new g(2,2,2),new g(-1,-2,-1),3,1),i=new He(10240,e);i.usePercentageCloserFiltering=!0,i.bias=100,i.transparencyShadow=!0;const s=$.CreatePlane("fire-plane",{width:4,height:3});s.receiveShadows=!0,s.position.copyFromFloats(-4.1,0,-1.6),s.rotationQuaternion=null,s.rotation.copyFromFloats(0,-Math.PI/2,0),s.material=t,s.material.shadowDepthWrapper=new Ve(s.material),i.getShadowMap().renderList.push(s);const n=new ct;return s.addBehavior(n),s}class ut{rect;text;button;constructor(e,i,s){this.rect=e,this.text=i,this.button=s}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e,document.exitPointerLock(),Xt()}}class W{advancedTexture;welcomePrompt;gameFinishPrompt;camera;screen;scene;constructor(e){this.scene=e,this.camera=e.activeCamera}createPromptWithButton(e,i=null,...s){this.screen=$.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=new g(0,0,.5),this.advancedTexture=ie.CreateForMesh(this.screen);let n=new Ue("container");var a=new Te;a.width=.5,a.height=.2,a.color="cyan",a.thickness=4,a.background="white",n.addControl(a);var r=new Ee;r.text=e,r.color="black",r.fontSize="17px",r.resizeToFit=!0,r.textWrapping=!0,r.paddingBottomInPixels=40,r.paddingLeftInPixels=15,r.paddingRightInPixels=15,a.addControl(r);var l=ze.CreateSimpleButton("but1","Click to dismiss");l.width="150px",l.height="40px",l.color="black",l.cornerRadius=20,l.background="white",l.topInPixels=40;let o=new ut(a,r,l),h=this.scene.getMeshByName("Start");function u(){n.dispose(),h.dispose(),i&&i(...s)}return o.button.onPointerUpObservable.add(function(){u()}),o.button.onPointerEnterObservable.add(()=>{l.background="grey"}),o.button.onPointerOutObservable.add(()=>{l.background="white"}),n.addControl(o.button),n.addControl(l),this.advancedTexture.addControl(n),o}}class de{static createWelcomeScreen(e){new W(e).createPromptWithButton("Welcome to the game. Please click on the clipboard on the table to get started.").setVisible(!0)}static createSuccessScreen(e,i=null,...s){new W(e).createPromptWithButton("Congratulations! You have completed the SOP",i,...s).setVisible(!0)}static createFailureScreen(e,i=null,...s){new W(e).createPromptWithButton("Oops! You mixed the wrong chemicals which resulted in a fire",i,...s).setVisible(!0)}}const b={sop:null,taskList:null,json:null,sounds:{},hudHints:{}};class U{#e;interactionManager;#t=null;#a=null;onGrabStateChangedObservable=new O;onActivationStateChangedObservable=new O;defaults={};hideGrabber=!0;#r;#s=!1;#i;#n=!1;#l=null;#o=null;#h=null;#c=!0;constructor(e,i){this.interactionManager=e,this.#i=!!i?.activatable,this.#r=i?.moveAttached!==!1;for(const s of[M.DESKTOP,M.MOBILE,M.XR,M.LOADING])this.defaults[s]={defaultPosition:i?.modeDefaults?.[s]?.defaultPosition||i?.defaultPosition||g.Zero(),defaultRotation:i?.modeDefaults?.[s]?.defaultRotation||i?.defaultRotation||g.Zero()}}get name(){return"Interactable"}set activatable(e){!e&&this.#n&&this.#f(),this.#i=e}get grabbing(){return!!this.#l&&!!this.#o}get grabStateObserver(){return this.#t}get activationStateObserver(){return this.#a}#u=()=>{this.#h=this.onGrabStateChangedObservable.add(({anchor:e,state:i})=>{if(i===C.GRAB){this.#e.setParent(e);const{defaultPosition:s,defaultRotation:n}=this.defaults[this.interactionManager.interactionMode];this.#e.position.copyFrom(s),this.#e.rotation.copyFrom(n)}else i===C.DROP&&this.#e.setParent(null)})};#d=()=>{this.#h.remove(),this.#h=null,this.grabbing&&this.#e.setParent(null)};set moveAttached(e){e&&!this.#r&&this.#e?this.#u():!e&&this.#r&&this.#e&&this.#d(),this.#r=e}set enabled(e){e&&!this.#c&&!this.#T&&this.#p?this.#g():!e&&this.#c&&this.#T&&this.#E(),this.#c=e}get enabled(){return this.#c}get#p(){return!!this.#e}#m=()=>{this.#n=!0,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#o,state:B.ACTIVE})};#f=()=>{this.#n=!1,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#o,state:B.INACTIVE})};#v=(e,i)=>{this.onGrabStateChangedObservable.notifyObservers({anchor:e,grabber:i,state:C.GRAB}),this.#l=e,this.#o=i,this.hideGrabber&&this.#s&&(i.isVisible=!1)};#b=()=>{this.#n&&this.#f(),this.hideGrabber&&this.#s&&(this.#o.isVisible=!0),this.onGrabStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#o,state:C.DROP}),this.#l=null,this.#o=null};init(){}attach=e=>{this.#e=e,this.enabled&&this.#g(),this.#r&&this.#u(),this.interactionManager.interactableMeshes.push(this.#e)};#g=()=>{this.#t=this.interactionManager.onGrabStateChangedObservable.add(({anchor:e,grabber:i,state:s})=>{s===C.GRAB&&!this.grabbing?(this.#s=i.isVisible,this.#v(e,i)):s===C.DROP&&this.grabbing&&this.#b()},this.#e.uniqueId),this.#a=this.interactionManager.onActivationStateChangedObservable.add(({anchor:e,grabber:i,state:s})=>{this.#i&&this.grabbing&&(s===B.ACTIVE&&!this.#n?this.#m():s===B.INACTIVE&&this.#n&&this.#f())},this.#e.uniqueId)};enable=()=>{this.enabled=!0};disable=()=>{this.enabled=!1};#E=()=>{this.#t.remove(),this.#a.remove(),this.#t=null,this.#a=null};get#T(){return!!this.#t&&!!this.#a}detach=()=>{this.#r&&this.#d(),this.grabbing&&this.#b(),this.#T&&this.#E(),this.onGrabStateChangedObservable.clear(),this.onActivationStateChangedObservable.clear();const e=this.interactionManager.interactableMeshes.findIndex(i=>i===this.#e);e!==-1&&this.interactionManager.interactableMeshes.splice(e,1),this.#e=null}}class ft{highlightLayer;mesh;otherMesh;color;constructor(e){this.highlightLayer=new ve("highlight-layer"),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1,this.color=e}get name(){return"Highlight"}init(){}attach=e=>{this.mesh=e};detach=()=>{this.unhighlightAll()};highlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)||this.highlightLayer.addMesh(this.mesh,this.color)};highlightOther=e=>{this.highlightLayer.hasMesh(e)||(this.otherMesh=e,this.highlightLayer.addMesh(this.otherMesh,this.color))};unhighlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh)};unhighlightOther=()=>{this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)};unhighlightAll=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh),this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)}}class F{text;advancedTexture;textBlock;rectangle;#e;_platform;set platform(e){this._platform=e,this.#t()}get platform(){return this._platform}#t=()=>{this.#e.setParent(k.originalScene.activeCamera),this.#e.position.copyFromFloats(0,-.5,2),this.#e.rotation.setAll(0)};constructor(e,i){e&&(this.text=e),i&&(this._platform=i),this.#e=Se("plane",{size:2},k.utilityLayerScene),this.#e.isPickable=!1,this.#t(),this.advancedTexture=ie.CreateForMesh(this.#e),this.textBlock=new Ee("textblock"),this.rectangle=new Te("rect"),this.rectangle.width=.25,this.rectangle.height=.33,this.rectangle.color="cyan",this.rectangle.thickness=4,this.rectangle.background="black",this.rectangle.alpha=.5,this.rectangle.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_RIGHT,this.rectangle.verticalAlignment=E.VERTICAL_ALIGNMENT_TOP}handleStateChange(e,i,...s){return this._platform=i,e===T.GAME_STATE_START?(this.hideHUD(),new Pe(b.hudHints.GAME_STATE_START[this._platform],this._platform)):null}displayHUD(){this.textBlock.text=this.text,this.textBlock.textWrapping=!0,this.textBlock.fontSize=20,this._platform==="mobile"&&(this.textBlock.fontSize=12),this.textBlock.horizontalAlignment=E.HORIZONTAL_ALIGNMENT_RIGHT,this.textBlock.verticalAlignment=E.VERTICAL_ALIGNMENT_TOP,this.textBlock.textVerticalAlignment=E.VERTICAL_ALIGNMENT_TOP,this.textBlock.textHorizontalAlignment=E.HORIZONTAL_ALIGNMENT_LEFT,this.textBlock.paddingTopInPixels=30,this.textBlock.paddingLeftInPixels=5,this.textBlock.alpha=1,this.textBlock.color="white",this.rectangle.addControl(this.textBlock),this.textBlock.isVisible=!0,this.rectangle.isVisible=!0,this.advancedTexture.addControl(this.rectangle)}hideHUD(){this.textBlock.isVisible=!1,this.rectangle.isVisible=!1}}class Pe extends F{constructor(e,i){super(e,i),this.displayHUD()}handleStateChange(e,i,...s){return this.hideHUD(),this.platform=i,new G(b.hudHints.GAME_STATE_BASE[this.platform],this.platform)}displayHUD(){let e=this.textBlock,i=this.advancedTexture;e.text=this.text,e.fontSize=30,e.fontWeight="bold",e.top=-50,e.color="white",i.addControl(e),e.isVisible=!0}}class G extends F{constructor(e,i){super(e,i),this.displayHUD()}handleStateChange(e,i,...s){return this.platform=i,e===T.GAME_STATE_PICK_SOP?(this.hideHUD(),new gt(b.hudHints.GAME_STATE_PICK_SOP[this.platform],this.platform)):e===T.GAME_STATE_PICK_CYLINDER?(this.hideHUD(),new bt(b.hudHints.GAME_STATE_PICK_CYLINDER[this.platform],this.platform)):e===T.GAME_STATE_START?(this.hideHUD(),new Pe(b.hudHints.GAME_STATE_START[this.platform],this.platform)):null}}class bt extends F{constructor(e,i){super(e,i),this.displayHUD()}handleStateChange(e,i,...s){return this.platform=i,e===T.GAME_STATE_PASS?(this.hideHUD(),new ue(b.hudHints.GAME_STATE_PASS[this.platform],this.platform,!0)):e===T.GAME_STATE_FAIL?(this.hideHUD(),new ue(b.hudHints.GAME_STATE_FAIL[this.platform],this.platform)):e===T.GAME_STATE_DROP_CYLINDER?(this.hideHUD(),new G(b.hudHints.GAME_STATE_BASE[this.platform],this.platform)):null}}class ue extends F{isPass;constructor(e,i,s=!1){super(e,i),this.displayHUD(),this.isPass=s}handleStateChange(e,i,...s){return this.platform=i,this.hideHUD(),e===T.GAME_STATE_SOP_PASS?new G(b.hudHints.GAME_STATE_SOP_PASS[this.platform],this.platform):e===T.GAME_STATE_BASE?new G(b.hudHints.GAME_STATE_BASE[this.platform],this.platform):new G(this.isPass?b.hudHints.GAME_STATE_BASE[this.platform]:this.text,this.platform)}}class gt extends F{constructor(e,i){super(e,i),this.displayHUD()}handleStateChange(e,i,...s){return this.platform=i,this.hideHUD(),new G(b.hudHints.GAME_STATE_BASE[this.platform],this.platform)}}var T=(t=>(t[t.GAME_STATE_START=0]="GAME_STATE_START",t[t.GAME_STATE_BASE=1]="GAME_STATE_BASE",t[t.GAME_STATE_PICK_SOP=2]="GAME_STATE_PICK_SOP",t[t.GAME_STATE_DROP_SOP=3]="GAME_STATE_DROP_SOP",t[t.GAME_STATE_PICK_FIREEXTINGUISHER=4]="GAME_STATE_PICK_FIREEXTINGUISHER",t[t.GAME_STATE_DROP_FIREEXTINGUISHER=5]="GAME_STATE_DROP_FIREEXTINGUISHER",t[t.GAME_STATE_PICK_CYLINDER=6]="GAME_STATE_PICK_CYLINDER",t[t.GAME_STATE_DROP_CYLINDER=7]="GAME_STATE_DROP_CYLINDER",t[t.GAME_STATE_PASS=8]="GAME_STATE_PASS",t[t.GAME_STATE_FAIL=9]="GAME_STATE_FAIL",t[t.GAME_STATE_SOP_PASS=10]="GAME_STATE_SOP_PASS",t))(T||{});class pt{onStateChangeObervable=new O;currentGameState;platform;constructor(){this.currentGameState=new F(null,"desktop"),this.onStateChangeObervable.add(e=>{this.#e(e)}),this.platform="desktop",R.onModeChangeObservable.add(e=>{this.platform=this.#t(e),this.platform!=="loading"&&this.platform!=="null"&&this.#e(1)})}#e(e){let i=this.currentGameState.handleStateChange(e,this.platform);i!==null&&(this.currentGameState=i)}#t(e){switch(e){case M.DESKTOP:return"desktop";case M.MOBILE:return"mobile";case M.XR:return"xr";case M.LOADING:return"loading";default:return"null"}}}let w;const mt=()=>{w=new pt,fetch(ht).then(t=>t.json()).then(t=>{b.hudHints=Object.assign({},t)})};class vt{mesh;#e;#t;#a;#r=null;#s;#i;onBeforePourObservable;onMidPourObservable;onAfterPourObservable;liquidMesh;#n=!1;pourDelay=1e3;animating=!1;onAnimationChangeObservable;constructor(){this.#t=new ft(P.Green()),this.onBeforePourObservable=new O,this.onMidPourObservable=new O,this.onAfterPourObservable=new O,this.onAnimationChangeObservable=new O}get name(){return"Pouring"}init(){}attach=e=>{if(this.mesh=e,this.#e=this.mesh.getBehaviorByName("Interactable"),!this.#e)throw new Error(`${this.name} behavior must have Interactable present on the same mesh.`);this.mesh.addBehavior(this.#t);const i=e.getScene();i.activeCamera;const s=this.#e.interactionManager.interactableMeshes;this.#a=this.#e.onGrabStateChangedObservable.add(({state:a})=>{a===C.GRAB?(w.onStateChangeObervable.notifyObservers(T.GAME_STATE_PICK_CYLINDER),this.#s=i.onBeforeRenderObservable.add(()=>{const r=this.#l(s);this.#o(r)})):a===C.DROP&&(this.#o(null),w.onStateChangeObervable.notifyObservers(T.GAME_STATE_DROP_CYLINDER),this.#s&&(this.#s.remove(),this.#s=null))});let n=!1;this.#r=this.#e.onActivationStateChangedObservable.add(({state:a})=>{if(a===B.ACTIVE&&!this.#n&&this.#i){const r=this.#e.interactionManager.interactionMode;(r===M.DESKTOP||r===M.MOBILE)&&(this.mesh.rotation.z+=Math.PI/4,n=!0),this.pour()}else a===B.INACTIVE&&n&&(this.mesh.rotation.z-=Math.PI/4,n=!1)})};detach=()=>{this.#a.remove(),this.#r.remove(),this.#s&&this.#s.remove()};get empty(){return this.#n}set empty(e){this.#n&&!e?(this.liquidMesh&&(this.liquidMesh.isVisible=!0),this.#n=e):!this.#n&&e&&(this.liquidMesh&&(this.liquidMesh.isVisible=!1),this.#n=e)}#l(e){const i=e.filter(a=>{const r=this.mesh.absolutePosition.y>a.absolutePosition.y,l=!!a.getBehaviorByName("Pouring"),o=!a.getBehaviorByName("Interactable").grabbing,h=this.mesh.intersectsMesh(a);return r&&l&&o&&h});let s=null,n=Number.POSITIVE_INFINITY;for(const a of i){const r=g.Distance(this.mesh.absolutePosition,a.absolutePosition);r<n&&(s=a,n=r)}return s}#o(e){this.#i!==e&&(this.#i&&this.#i instanceof q&&this.#t.unhighlightAll(),this.#i=e,this.#i&&this.#i instanceof q&&(this.#t.highlightSelf(),this.#t.highlightOther(this.#i)))}pour=()=>{if(!this.#i)throw new Error("PouringBehavior: attempted pour with no current target.");const e=this.#i.getBehaviorByName("Pouring");if(!e)throw new Error("PouringBehavior: target is not pourable.");e.empty=!1;const i=this.#i;this.onBeforePourObservable.notifyObservers(i),this.onMidPourObservable.notifyObservers(i),this.onAfterPourObservable.notifyObservers(i),this.empty=!0}}function ye(t,e){const i=t.getChildMeshes().find(n=>n.id.split("-").pop()==="liquid"),s=new V("liquid-material");s.diffuseColor=e,i.material=s}function Z(t,e){ye(t,e);const i=new se("dynamic-texture",256,null,!0,L.LINEAR_LINEAR_MIPNEAREST);i.uAng=Math.PI;const s=new V("cylinder-label-material");s.diffuseTexture=i;const n="bold 250px monospace",a=t.getChildMeshes().filter(h=>{const u=h.id.split("-").pop();return u==="label"||u==="labelback"});for(const h of a)h.material=s,i.drawText(t.id.split("-").pop().toUpperCase(),0,225,n,"black","white");const r=new U(R,{activatable:!0,defaultRotation:new g(0,Math.PI/2,Math.PI)}),l=new vt,o=new ae;t.addBehavior(r),t.addBehavior(l),l.liquidMesh=t.getChildMeshes().find(h=>h.id.split("-").pop()==="liquid"),t.addBehavior(o)}const Tt=(t,e)=>{let i=[],s=[],n={};e.forEach(a=>{a.logic&&a.logic.taskType==="pouring"&&Et(t,a,i,s,n)}),St(t,s),i.forEach(a=>{a.onTaskStateChangeObservable.add(r=>{r===x.SUCCESSFUL&&!b.sounds.success.isPlaying&&!b.sounds.explosion.isPlaying&&(b.sounds.ding.stop(),b.sounds.ding.play())})}),b.taskList=i},fe=(t,e,i,s)=>{t===e?(w.onStateChangeObervable.notifyObservers(T.GAME_STATE_PASS),i.succeed()):(w.onStateChangeObervable.notifyObservers(T.GAME_STATE_FAIL),i.fail())},Et=(t,e,i,s,n)=>{let a=e.taskName,r=e.text,l=e.logic,o=[];l.subtasks.forEach(m=>{let f=n[m];f&&o.push(f)});let h;o.length?h=new J(a,r,[[...o]]):h=new J(a,r,[]),i.push(h),s.push(h),n[a]=h;let d=t.getMeshByName(l.from).getBehaviorByName("Pouring");d.onMidPourObservable.add(m=>{X(`Pouring mesh name: ${d.mesh.name}`),X(`Poured mesh name: ${m.name}`);const f=m.getChildMeshes().find(S=>S.id.split("-").pop()==="liquid").material.diffuseColor,y=d.mesh.getChildMeshes().find(S=>S.id.split("-").pop()==="liquid").material.diffuseColor,p=new P((f.r+y.r)/2,(f.g+y.g)/2,(f.b+y.b)/2);ye(m,p),d.animating?d.onAnimationChangeObservable.addOnce(()=>{fe(m.name,l.to,h)}):fe(m.name,l.to,h)})},St=(t,e)=>{b.sop=new J("SOP","Standard operating procedure for lab safety.",[e]),b.sop.onTaskStateChangeObservable.add(i=>{switch(i){case x.SUCCESSFUL:t.activeCamera,w.onStateChangeObervable.notifyObservers(T.GAME_STATE_SOP_PASS),de.createSuccessScreen(t,()=>{me(),ee(t)}),b.sounds.success.stop(),b.sounds.success.play();break;case x.FAILURE:b.sounds.explosion.stop(),b.sounds.explosion.play();const n=dt().getBehaviorByName("Fire");n&&n.onFireObservable.add(a=>{a||(de.createFailureScreen(t,()=>{me(),ee(t)}),b.sounds.success.stop(),b.sounds.success.play())});break;case x.RESET:break}})},At={[x.SUCCESSFUL]:"correct",[x.FAILURE]:"incorrect",[x.RESET]:"empty"};class Ct{templateString;data;basicTasks;rootTask;#e;mesh;#t;#a;constructor(e,i,s,n){this.templateString=e,this.#t=qe.compile(this.templateString),this.data=i,this.rootTask=s,this.basicTasks=n,this.#e=[],this.#a=0}get name(){return"UpdateClipboard"}init(){}#r=e=>this.#s.find(i=>i.taskName===e)||null;get#s(){return this.data.items[1].sublist}attach=e=>{this.mesh=e,this.#i(),this.#e.push(...this.basicTasks.map(i=>i.onTaskStateChangeObservable.add(s=>{const n=this.#r(i.name);n.indicator=At[s],this.#i()}))),this.#e.push(this.rootTask.onTaskStateChangeObservable.add(i=>{}))};detach=()=>{for(let e of this.#e)e.remove()};#i=()=>{const e=document.createElement("template"),i=this.#t(this.data);e.innerHTML=i;const n=new XMLSerializer().serializeToString(e.content),a="data:image/svg+xml;utf8,"+encodeURIComponent(n),r=L.LoadFromDataString(`clipboard-texture-${this.#a++}`,a,this.mesh.getScene(),void 0,void 0,void 0,L.LINEAR_LINEAR_MIPNEAREST,()=>{r.uScale=1,r.vScale=-1,r.hasAlpha=!0,this.#n(r)})};#n=e=>{const i=this.mesh.material;i.diffuseTexture!==e&&(i.diffuseTexture&&i.diffuseTexture.dispose(),i.diffuseTexture=e)}}function Mt(t){const e=t.getScene(),i=new V("clipboard-material",e);i.emissiveColor.copyFrom(P.White()),i.useAlphaFromDiffuseTexture=!0;const s=t.getChildMeshes().find(r=>r.name===`${t.id}-plane`);s.material=i,fetch(lt).then(r=>r.text()).then(r=>{fetch("./json/sopData.json").then(l=>l.json()).then(l=>{let o=l.items[1].sublist;Tt(e,o);const h=new Ct(r,l,b.sop,b.taskList);s.addBehavior(h)})});const n=new U(R,{defaultRotation:new g(Math.PI,Math.PI/2,Math.PI/2),modeDefaults:{[M.DESKTOP]:{defaultPosition:new g(0,0,-.5)},[M.MOBILE]:{defaultPosition:new g(0,0,-.5)}}});n.onGrabStateChangedObservable.add(({anchor:r,grabber:l,state:o})=>{o===C.GRAB?w.onStateChangeObervable.notifyObservers(T.GAME_STATE_PICK_SOP):w.onStateChangeObervable.notifyObservers(T.GAME_STATE_DROP_SOP)}),s instanceof q&&n.interactionManager.highlightLayer.addExcludedMesh(s);const a=new ae;t.addBehavior(n),t.addBehavior(a)}function j(t){const e=t.getScene(),i=t.name.split("-")[1],s=t.getChildMeshes().find(o=>o.name==="Placard"),n=t.getChildMeshes().find(o=>o.name==="Label");s.id="placard-base",s.name="placard-base";const a=new se("dynamic texture",256,e);a.wAng=-Math.PI/2,a.uAng=Math.PI;const r=new V("Mat",e);r.diffuseTexture=a,n.material=r,a.drawText(i.toUpperCase(),65,185,"bold 220px monospace","black","white"),s.addChild(n)}function Ot(t){t.keysUp.push(87),t.keysDown.push(83),t.keysLeft.push(65),t.keysRight.push(68)}const Pt=["WallsandFloor","Floor","Table","Roof","Countertop","Walls","FumehoodBase_LP","FumehoodInner_LP","FumehoodInnerHook_LP"];function yt(t){t.getChildMeshes().forEach(e=>{Pt.includes(e.name)&&(e.checkCollisions=!0)})}function It(t){const e=t.getScene().activeCamera;yt(t),Me(e),Ot(e)}class wt{particleSystem;#e;constructor(e){this.#e=e,this.#t()}#t(){let e=this.#e.getScene(),i;le.IsSupported?(i=new le("particles",{capacity:15e3},e),i.activeParticleCount=2e3):i=new he("particles",2e3,e),i.particleTexture=new L("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",e),i.emitRate=150,i.createPointEmitter(new g(-3.5,-3.5,0),new g(3.5,3.5,0)),i.gravity=new g(0,0,20),i.isLocal=!0,i.minLifeTime=.3,i.maxLifeTime=.3,i.minEmitPower=.7,i.maxEmitPower=.5,i.minSize=.01,i.maxSize=.02;let s=.3;i.addSizeGradient(s,s,s),i.blendMode=he.BLENDMODE_STANDARD,i.emitter=this.#e,this.particleSystem=i}start(){this.particleSystem.start()}stop(){this.particleSystem.stop()}}const _t=2;function Bt(t){const e=new U(R,{activatable:!0,defaultRotation:new g(0,0,Math.PI)}),i=new ae;t.addBehavior(e),t.addBehavior(i);let s=new wt(t),n=null;const a=t.getScene(),r=$.CreateSphere("debug-sphere-1",{diameter:.1}),l=$.CreateSphere("debug-sphere-2",{diameter:.1});r.isVisible=!1,l.isVisible=!1,e.onActivationStateChangedObservable.add(({state:o})=>{o===B.ACTIVE?(s.start(),n=a.onBeforeRenderObservable.add(()=>{const h=new $e(t.absolutePosition,t.getDirection(Ae.Z).normalize(),_t);r.setAbsolutePosition(h.origin),l.setAbsolutePosition(h.origin.add(h.direction.scale(h.length)));const u=a.pickWithRay(h,d=>{const m=d.getBehaviorByName("Fire");return!!(m&&!m.extinguished)});if(u.hit){const d=u.pickedMesh.getBehaviorByName("Fire");d.extinguished||d.extinguish()}})):o===B.INACTIVE&&(s.stop(),n&&(n.remove(),n=null))})}function xt(t){const e=t.getChildMeshes(!0)[0];e.rotationQuaternion=null;const i=new U(R,{moveAttached:!1});let s=null;const n=t.getScene();i.onGrabStateChangedObservable.add(({anchor:a,state:r})=>{r===C.GRAB?s=n.onBeforeRenderObservable.add(()=>{const l=a.getAbsolutePosition().subtract(e.getAbsolutePosition());if(l.y=0,l.x>0)return;const o=l.z<0?0:Math.PI,h=-Math.atan(l.x/l.z);e.rotation.copyFromFloats(0,h+o,0)}):r===C.DROP&&s&&(s.remove(),s=null)}),e.addBehavior(i)}const Rt=1.93,Lt=1.3,be=(t,e)=>{let i=Math.floor(t.position.y*100)/100;i+e>=Lt&&i+e<=Rt&&(t.position.y+=e)},kt=t=>{const e=t.getScene();let i=null,s=null;const n=new U(R,{moveAttached:!1});t.addBehavior(n),n.onGrabStateChangedObservable.add(({anchor:a,state:r})=>{if(r==C.GRAB){const l=t.getBehaviorByName("PointerDrag");if(l&&(s=l.onDragObservable.add(o=>{let h=o.delta.y;be(t,h)})),a){let o=g.Zero();o.copyFrom(a.getAbsolutePosition()),i=e.onBeforeRenderObservable.add(()=>{const h=a.getAbsolutePosition().subtract(o);let u=Math.floor(h.y*100)/100;be(t,u),o.copyFrom(a.getAbsolutePosition())})}}else r==C.DROP&&(s&&s.remove(),i&&i.remove())})};function Nt(t){const e=t.find(c=>c.name==="room"),i=t.find(c=>c.name==="placard"),s=t.find(c=>c.name==="cylinder").getChildMeshes(!0)[0],n=t.find(c=>c.name==="clipboard").getChildMeshes(!0)[0],a=t.find(c=>c.name==="fire-extinguisher").getChildMeshes(!0)[0],r=t.find(c=>c.name==="FireCabinet"),l=t.find(c=>c.name==="Glass Divider");It(e),kt(l);const o=n.parent;o.id="clipboard-root",o.name=o.id,n.setParent(null),o.dispose(!0),Gt(n),Mt(n);const h=i.clone(`${i.name}-c`,i.parent),u=i.clone(`${i.name}-b`,i.parent),d=i;h.id=h.name,u.id=u.name,d.name+="-a",d.id=d.name,h.getChildMeshes().forEach(c=>c.name=c.name.split(".")[1]),u.getChildMeshes().forEach(c=>c.name=c.name.split(".")[1]),j(h),j(u),j(d),t.push(h,u);const m=s.parent;s.setParent(null),m.dispose(!0);const f=s.clone(`${s.id}-c`,null),y=s.clone(`${s.id}-b`,null),p=s;Dt([p,y,f],["a","b","c"]),Z(f,P.Blue()),Z(y,P.Green()),Z(p,P.Red());const S=a.parent;S.id="fire-extinguisher-root",S.name=S.id,a.setParent(null),S.dispose(),a.id="fire-extinguisher",a.name=a.id,Bt(a),xt(r),t.push(f,y)}function Dt(t,e){t.forEach((i,s)=>{i.id=`cylinder-${e[s]}`,i.name=i.id,i.getChildMeshes().forEach(n=>{switch(n.id.split(".").pop()){case"BeakerLiquid":n.id=`${i.id}-liquid`,n.name=n.id;break;case"Label":n.id=`${i.id}-label`;break;case"LabelBack":n.id=`${i.id}-labelback`;break}})})}function Gt(t){t.id="clipboard",t.name=t.id,t.getChildMeshes().forEach(e=>{switch(e.id){case"Plane":e.id=`${t.id}-plane`,e.name=e.id;break;case"Clipper":e.id=`${t.id}-clip`,e.name=e.id;break;case"horizontalScrew":e.id=`${t.id}-screw`,e.name=e.id;break;case"metalThingy":e.id=`${t.id}-metal`,e.name=e.id;break}})}const Ie=64,Y=Ie/2,Ft=.005;function Ht(t,e){const i=new se(t,Ie),s=i.getContext();s.beginPath(),s.arc(Y,Y,Y,0,2*Math.PI),s.fill(),i.update();const n=new V(t);n.diffuseTexture=i,n.opacityTexture=i;const a=Se(t,{size:Ft},e);return a.material=n,a}async function Vt(t,e){const i=await Ce([t,e]);let s=null,n=null;for(const a of i){const r=a.meshes.find(o=>o.id===t||o.id===e);for(const o of a.animationGroups)o.name+=`-${r.name}`,o.pause();const[l]=r.getChildMeshes();if(!l)throw new Error(`Cannot collapse the root mesh of ${r.name}`);if(l.id=r.id,l.name=r.name,l.setParent(null),r.dispose(!0),l.name===t)s=l;else if(l.name===e)n=l;else throw new Error("Base mesh name is invalid. This shouldn't be possible.")}if(!s)throw new Error("No left hand mesh found.");if(!n)throw new Error("No right hand mesh found.");return{left:s,right:n}}const Ut={inputOptions:{doNotLoadControllerMeshes:!0},pointerSelectionOptions:{enablePointerSelectionOnAllControllers:!0},uiOptions:{onError:t=>console.error(t)}};async function zt(t){let e=!1;t.pointerSelection.laserPointerDefaultColor=P.Green(),t.pointerSelection.laserPointerPickedColor=P.Green(),t.pointerSelection.selectionMeshDefaultColor=P.Green(),t.pointerSelection.selectionMeshPickedColor=P.Green(),t.pointerSelection.displayLaserPointer=e,t.pointerSelection.displaySelectionMesh=e,window.addEventListener("keydown",a=>{a.keyCode===73&&(e=!e,t.pointerSelection.displayLaserPointer=e,t.pointerSelection.displaySelectionMesh=e)}),t.baseExperience.onStateChangedObservable.add(a=>{D.IN_XR}),t.baseExperience.camera.onAfterCameraTeleport.add(()=>{t.baseExperience.camera.position.y=t.baseExperience.camera.realWorldHeight});const n=await Vt("left","right");for(const a of t.input.controllers)ge(a,n[`${a.inputSource.handedness}`]);t.input.onControllerAddedObservable.add(a=>{ge(a,n[`${a.inputSource.handedness}`])}),t.input.onControllerRemovedObservable.add(a=>{let r=v.findIndex(l=>l===a.pointer.name);r!==-1&&v.splice(r,1),a.grip&&(r=v.findIndex(l=>l===a.grip.name),r!==-1&&v.splice(r,1))})}function ge(t,e){v.push(t.pointer.name),t.grip&&v.push(t.grip.name),e.isPickable=!1,qt(t,e,t.inputSource.handedness)}function qt(t,e,i){e.setParent(t.pointer),e.rotationQuaternion=null,i!=="none"?e.rotation.copyFromFloats(Math.PI,0,Math.PI/2):e.rotation.copyFromFloats(0,0,0),t.motionController&&pe(t.motionController,e),t.onMotionControllerInitObservable.add(s=>{pe(s,e)}),R.addSelector(t.pointer,e,[M.XR]),v.push(e.name)}function pe(t,e){const i=t.getComponentOfType("squeeze"),s=e.getScene().animationGroups.find(n=>n.name===`Fist-${e.name}`);i.onButtonStateChangedObservable.add(n=>{const a=s.from+(s.to-s.from)*n.value;s.goToFrame(a)})}async function $t(t){function e(i){for(const{name:s,path:n}of i)b.sounds[s]=new Xe(s,n,void 0)}return fetch(t).then(i=>i.json()).then(e)}let I,R;const v=[];let re=!0;function Xt(){re=!1;const t=k?.utilityLayerScene.getMeshByName("reticle");t&&(t.isVisible=!1)}function me(){re=!0;const t=k?.utilityLayerScene.getMeshByName("reticle");t&&(t.isVisible=!0)}let k;async function Kt(t){const e=new Ke(t),i=new We("light1",new g(1,1,0),e),s=new Ze("camera",Qe),n=document.getElementById("canvas");let a=!1;("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.maxTouchPoints>0)&&(a=!0),a?Ye(e):n.addEventListener("click",()=>{re&&n.requestPointerLock()}),Zt(e,!0),tt(s),e.activeCamera=s,e.activeCamera.attachControl(n,!0),i.intensity=0,Q.audioEngine.useCustomUnlockedButton=!0,k=new je(e);const r=Ht("reticle",k.utilityLayerScene);if(r.setParent(s),r.position.copyFrom(Ae.Z),v.push(r.name),"xr"in window.navigator){I=await e.createDefaultXRExperienceAsync(Ut),R=new ne(e,I),await zt(I),v.push(...e.meshes.map(o=>o.name));for(const o of I.input.controllers)v.push(o.pointer.name),o.grip&&v.push(o.grip.name);I.input.onControllerAddedObservable.add(o=>{v.push(o.pointer.name),o.grip&&v.push(o.grip.name)}),I.input.onControllerRemovedObservable.add(o=>{let h=v.findIndex(u=>u===o.pointer.name);h!==-1&&v.splice(h,1),o.grip&&(h=v.findIndex(u=>u===o.grip.name),h!==-1&&v.splice(h,1))}),v.push("laserPointer"),r.isVisible=I.baseExperience.state!==D.IN_XR,I.baseExperience.onStateChangedObservable.add(o=>{r.isVisible=o!==D.IN_XR})}mt(),await $t("./json/sounds.json"),await ee(e);const l=document.querySelector("div.splash");return l.textContent="Click to start!",l.addEventListener("click",()=>{l.classList.add("hide"),Q.audioEngine.audioContext.resume()},!1),e}function Wt(t){let e=setInterval(()=>{t.intensity>=1?clearInterval(e):t.intensity+=.1},60)}async function ee(t){const e=t.getLightByName("light1");e.intensity=0;const i=t.activeCamera,s=t.meshes.filter(o=>!v.includes(o.name)).concat(k.utilityLayerScene.meshes.filter(o=>!v.includes(o.name)));for(const o of s)o.dispose();const a=(await Ce()).map(o=>o.meshes).flat();Nt(a),ot(a),at(t),Me(i),"xr"in window.navigator&&(I.teleportation.removeFloorMeshByName("Floor"),I.teleportation.addFloorMesh(t.getMeshByName("Floor"))),document.exitPointerLock(),w.onStateChangeObervable.notifyObservers(T.GAME_STATE_START);const r=document.getElementById("canvas"),l=o=>{w.onStateChangeObervable.notifyObservers(T.GAME_STATE_BASE),r.removeEventListener("click",l)};return r.addEventListener("click",l),Wt(e),t}function Zt(t,e){t.collisionsEnabled=!0}function jt(t){window.addEventListener("resize",function(){t.resize()})}const Yt=document.getElementById("canvas"),te=new Q(Yt,!0,{stencil:!0});jt(te);Kt(te).then(t=>{te.runRenderLoop(()=>t.render())});
