var ce=Object.defineProperty;var he=(c,e,t)=>e in c?ce(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var r=(c,e,t)=>(he(c,typeof e!="symbol"?e+"":e,t),t),de=(c,e,t)=>{if(!e.has(c))throw TypeError("Cannot "+t)};var K=(c,e,t)=>(de(c,e,"read from private field"),t?t.call(c):e.get(c)),Y=(c,e,t)=>{if(e.has(c))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(c):e.set(c,t)};import{H as me,M as ee,V as f,S as L,D as te,P as _,T as F,C as ie,a as P,b as ue,A as S,c as ge,B as X,d as pe,W as Z,E as T,R as fe,e as j,f as H,g as ye,h as be,i as Ce,j as Me,k as xe,l as Se,m as Pe,U as Ae,n as ve,o as we}from"./vendor.582c87b1.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerpolicy&&(s.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?s.credentials="include":o.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();window.exports=window;class Ie{constructor(e,t,i,o=0){r(this,"complete",!1);r(this,"title");r(this,"description");r(this,"failed",!1);r(this,"onFail");r(this,"onSuccess");r(this,"onCompletion");r(this,"currentState");r(this,"tasks");r(this,"resetSOP",()=>{this.currentState=0,this.failed=!1,this.complete=!1});this.title=e,this.description=t,this.tasks=i,this.currentState=o}}const R="./",N=60,Ne=50,ne=3,v="cylinder",B="liquid",Be="placard",b=new Ie("","",[{next:"CtoA",label:"BtoC"},{next:"complete",label:"CtoA"}]);function M(c,e){return c.getChildMeshes().find(t=>t.name===e)||null}function z(c){c.rotation.x=0,c.rotation.y=0,c.rotation.z=0}function se(c){c.position.x=0,c.position.y=0,c.position.z=0}class ${constructor(e,t,i,o){r(this,"name");r(this,"position");r(this,"mesh");r(this,"dragCollision");r(this,"highlightLayer");r(this,"scene");r(this,"particleSystem");r(this,"currentColor");r(this,"originalColor");r(this,"startOpacity");console.log(e),this.name=i,this.currentColor=o,this.originalColor=o,this.startOpacity=.7;const s=e.getScene();this.scene=s,this.highlightLayer=new me("highlight-layer",s),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1;const a=s.getMeshByName("Table");let n=ee.CreateSphere(`pivot-Cylinder-${i}`,{segments:2,diameterX:.15,diameterY:.33,diameterZ:.2},e.getScene());if(n.visibility=0,e.name=i,e.parent=n,e.rotationQuaternion=null,e.getChildMeshes().forEach(C=>{switch(C.name){case"BeakerwOpacity":C.name=v,C.rotationQuaternion=null,C.rotation.z=2*Math.PI,C.isPickable=!1;break;case"BeakerLiquid":C.name=B,C.isPickable=!1;break}}),a){const C=a.getBoundingInfo().boundingBox,O=M(e,v).getBoundingInfo().boundingBox.maximum.y;console.log(O),n.position.y=C.maximumWorld.y+O/2+.05,n.position.x=(C.maximumWorld.x-C.minimumWorld.x)/ne*t+C.minimumWorld.x-.3,n.position.z=(C.centerWorld.z+C.minimumWorld.z)/2,this.position={...n.position}}else n.position.x=-2+t,n.position.y=1.22,n.position.z=.5,console.log("Else!");n.checkCollisions=!0,n.ellipsoid=new f(.02,.12,.02),console.log(n.ellipsoid.length()),this.mesh=n;const d=M(e,B),m=new L("liquid-material");m.diffuseColor=o,d.material=m;const g=M(e,"Label"),h=M(e,"LabelBack");console.log("Label:",h);const u=new te("dynamic texture",256,s),p=new L("Mat",s);p.diffuseTexture=u,g.material=p,h.material=p;const y="bold 300px monospace";u.drawText(e.name.toUpperCase(),65,225,y,"black","white");let A=this.mesh.getChildMeshes().find(C=>C.name==="cylinder");this.mesh.animations=A.animations,console.log("Children: ",this.mesh.getChildMeshes());const x=new _("particles",500,this.scene);x.particleTexture=new F("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),x.minLifeTime=.5,x.maxLifeTime=.7,x.emitRate=100,x.gravity=new f(0,.5,0),x.minSize=.01,x.maxSize=.07,x.createPointEmitter(new f(0,0,0),new f(0,1,0)),x.addColorGradient(1,ie.FromColor3(d.material.diffuseColor,1)),x.blendMode=_.BLENDMODE_STANDARD,x.emitter=this.mesh.position,this.particleSystem=x,this.setOpacity(this.startOpacity),this.addDragCollision()}startParticles(){this.particleSystem.start()}highlight(e=!0){let t=M(this.mesh,v);e?(console.log("Adding mesh"),this.highlightLayer.hasMesh(t)||this.highlightLayer.addMesh(t,P.Green())):this.highlightLayer.hasMesh(t)&&this.highlightLayer.removeMesh(t)}addDragCollision(){let e=new ue({dragPlaneNormal:new f(0,0,1)});e.useObjectOrientationForDragging=!1,e.moveAttached=!1,e.onDragStartObservable.add(()=>{}),e.onDragObservable.add(t=>{this.mesh.moveWithCollisions(t.delta)}),e.onDragEndObservable.add(()=>{this.fadeAndRespawn()}),this.mesh.addBehavior(e),this.dragCollision=e}removeDragCollision(){this.mesh.removeBehavior(this.dragCollision)}fadeAndRespawn(e=Ne){setTimeout(()=>{let t=this.mesh.getBehaviorByName("PointerDrag");t&&t.releaseDrag(),this.mesh.isPickable=!1;let i=60;this.mesh.name.split("-")[0];let o=this.mesh.getScene(),s=this.mesh.getChildMeshes(),a=s.find(m=>m.name==="cylinder");s.find(m=>m.name==="liquid");const n=M(this.mesh,B);console.log("Visibility: ",n.visibility);let d=[{name:"Invisibility",startValue:n.visibility},{name:"Visibility",startValue:0}];d.forEach(m=>{m.init=new S(m.name,"visibility",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),m.init.setKeys([{frame:0,value:m.startValue},{frame:i,value:n.visibility-m.startValue}])});for(let m=0;m<s.length-1;++m){let g=s[m];o.beginDirectAnimation(g,[d[0].init],0,60,!1)}o.beginDirectAnimation(s[s.length-1],[d[0].init],0,60,!1,void 0,()=>{console.log(this.mesh,this.position),this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z,this.mesh.animations=a.animations;let m=M(this.mesh,v);z(this.mesh),z(m),se(m);for(let g=0;g<s.length-1;++g){let h=s[g];o.beginDirectAnimation(h,[d[1].init],0,60,!1)}o.beginDirectAnimation(s[s.length-1],[d[1].init],0,60,!1,void 0,()=>{this.highlight(!1),this.mesh.isPickable=!0})})},e)}rotateAroundZ(){let e=this.mesh.getAnimationByName(`${this.name}-rotateAroundZ`);this.scene.beginDirectAnimation(M(this.mesh,v),[e],0,60,!1,void 0,()=>{})}resetAroundZ(){let e=this.mesh.getAnimationByName(`${this.name}-resetRotateAroundZ`);this.scene.beginDirectAnimation(M(this.mesh,v),[e],0,60,!1,void 0,()=>{})}setColor(e){const t=M(this.mesh,B),i=new L("liquid-material");i.diffuseColor=e,t.material=i,this.currentColor=e,console.log(this.currentColor)}setOpacity(e){const t=M(this.mesh,B);t.visibility=e}resetProperties(){this.setOpacity(this.startOpacity),this.setColor(this.originalColor)}}const Oe="Stony Brook University VR Laboratory",Le="Victor Ruben",Te="VR Chemical Mixture Synthesis",Ee="4/1/2022",ke="General: Properly mixing VR chemicals",De="42",Re="I",_e=[{text:"HAZARD IDENTIFICATION test from JSON",sublistType:"a",sublist:[{text:"Improper mixing of chemicals can lead to explosive results!"}]},{text:"CHEMICAL HANDLING PROCEDURES",sublistType:"a",sublist:[{text:"When mixing these chemicals - always follow the correct sequence"},{text:"Pour chemical B into chemical C"},{text:"Then pour chemical mixture B+C into chemical A"}]},{text:"EMERGENCY PROCEDURES",sublistType:"a",sublist:[{text:"In the event of an improper mixture - use the fire extinguisher to put out the flames"},{text:"Evacuate the lab"},{text:"Call for emergency services"}]}],Q={facility:Oe,labDirector:Le,scope:Te,lastRevision:Ee,general:ke,sopNum:De,listType:Re,items:_e};function Fe(c){c.name="clipboard";const e=c.getScene(),t=e.getMeshByName("Table");if(t){const a=t.getBoundingInfo().boundingBox;c.position.y=a.maximumWorld.y+.003}c.rotationQuaternion=null,c.rotation=new f(0,Math.PI/4,0);const i=e.getMeshByName("pivot-Cylinder-A");i&&(c.position.x=i.position.x+.2,c.position.z=i.position.z+.5);function o(a){console.log("data: ",Q);let n=document.createElement("template");n.innerHTML=a;var d=ge.compile(n.innerHTML),m=d(Q);return n.innerHTML=m,n.content}function s(a){const d="data:image/svg+xml;utf8,"+encodeURIComponent(a),m=F.LoadFromDataString("tex",d,e,void 0,void 0,void 0,F.LINEAR_LINEAR_MIPNEAREST);let g=new L("mat",e);g.diffuseTexture=m,m.uScale=1,m.vScale=-1,g.emissiveColor=P.White(),g.useAlphaFromDiffuseTexture=!0,m.hasAlpha=!0;let h=M(c,"Plane");h.material=g,console.log("Material set")}fetch(`${R}images/sopTemplate.svg`).then(a=>a.text()).then(a=>{console.log("fetched!");let n=o(a),d=n.getElementById("procedure-list");console.log(d);const g=new XMLSerializer().serializeToString(n);s(g)}).catch(console.error.bind(console))}function ze(c){var e=new X(P.FromHexString("#0984e3"));e.ignoreChildren=!0;var t=c[0],i=X.MakeNotPickableAndWrapInBoundingBox(t);e.attachedMesh=i,e.onScaleBoxDragObservable.add(()=>{console.log("scaleDrag")}),e.onScaleBoxDragEndObservable.add(()=>{const o=e.attachedMesh;if(o){const s=o.getHierarchyBoundingVectors(!0);console.log("size x:",s.max.x-s.min.x),console.log("size y:",s.max.y-s.min.y),console.log("size z:",s.max.z-s.min.z)}console.log("scaleEnd")}),e.onRotationSphereDragObservable.add(()=>{console.log("rotDrag")}),e.onRotationSphereDragEndObservable.add(()=>{console.log("rotEnd")})}function U(c,e,t){const i=c.find(h=>h.name==="__root__"),o=i.getScene();i.name=t;const s=c.find(h=>h.name==="Label"),a=c.find(h=>h.name==="Placard");a.name=Be;const n=new te("dynamic texture",256,o);n.wAng=-Math.PI/2,n.uAng=Math.PI;const d=new L("Mat",o);d.diffuseTexture=n,s.material=d;const m="bold 220px monospace";n.drawText(i.name.split("-")[1].toUpperCase(),65,185,m,"black","white"),a.addChild(s),a.rotationQuaternion=null,a.rotation=new f(0,Math.PI/2,0);const g=o.getMeshByName("Table");if(g){const h=g.getBoundingInfo().boundingBox;i.position.y=h.maximumWorld.y+.003,i.position.x=(h.maximumWorld.x-h.minimumWorld.x)/ne*e+h.minimumWorld.x-.2,i.position.z=(h.centerWorld.z+h.minimumWorld.z)/2+.2}}function We(c,e,t){let i;return new Promise(o=>{const s="./models/";let a="";var n={};let d=["left","right"];const m=new pe(c);d.forEach(h=>{m.addMeshTask(`load ${h} hand`,"",s,`${h}${a}.glb`)});let g=0;m.onTaskSuccess=h=>{n[d[g]]=h.loadedMeshes[1],h.loadedMeshes[1].name=d[g],i=h.loadedAnimationGroups;for(let u=0;u<i.length;u++)i[u].name=`${d[g]}_${i[u].name}`;g++},m.onTasksDoneObservable.add(()=>{for(let h=0;h<c.animationGroups.length;h++)c.animationGroups[h].pause();e.input.onControllerAddedObservable.add(h=>{let u=h.inputSource.handedness;console.log(n[u]);let p=n[u].parent.parent;n[u].isPickable=!1;for(let l of t)l.removeDragCollision();let y=(Object.keys(n).indexOf(u)-1)*2-1;n[u].rotation.y=Math.PI*y,n[u].rotation.z=-Math.PI/2,n[u].rotation.x=-Math.PI/4,p.parent=h.grip||h.pointer}),e.baseExperience.onStateChangedObservable.add(h=>{if(h===Z.IN_XR){e.baseExperience.camera.position.y=1.5,e.baseExperience.camera.position.z=-.5;let u=c.getMeshByName("Start");if(u){let p=e.baseExperience.camera;u.parent=p,u.position=p.position.add(new f(-p.position.x,-1.5,1.15)),e.pointerSelection.displayLaserPointer=!0,e.pointerSelection.displaySelectionMesh=!0,u.rotation=f.Zero()}}}),e.baseExperience.camera.onAfterCameraTeleport.add(h=>{e.baseExperience.camera.position.y=.5})}),m.loadAsync().then(()=>{o(i)})})}class oe{constructor(e,t,i,o,s){r(this,"cylinderInstances");r(this,"clipboard");r(this,"scene");r(this,"labels");r(this,"guiManager");r(this,"soundManager");r(this,"xrCamera");console.log("Cylinders interact: ",t),this.labels=["A","B","C"],this.scene=e,this.cylinderInstances=t,this.guiManager=i,this.soundManager=o,this.xrCamera=s}getCylinderInstanceFromMesh(e){let t=e.name.split("-")[2];for(let i of this.cylinderInstances)if(i.name==t)return i;return null}intersectHandCylinder(e){for(let t of this.labels){let i=this.scene.getMeshByName(`pivot-Cylinder-${t}`);if(e.intersectsMesh(i,!1)&&i.isPickable)return i}return null}intersectCylinder(e){for(let t of this.labels){let i=this.scene.getMeshByName(`pivot-Cylinder-${t}`);if(i!=e&&e.intersectsMesh(i))return i}return null}highlightAndRotateCylinders(e,t,i){e.highlight(),t.highlight();let o=e.mesh.getAbsolutePosition()._x,s=t.mesh.getAbsolutePosition()._x;if(s<o?(e.mesh.rotation.y=Math.PI,t.mesh.rotation.y=e.mesh.rotation.y):(e.mesh.rotation.y=0,t.mesh.rotation.y=e.mesh.rotation.y),!i){i=!0;let a=e.mesh.getHierarchyBoundingVectors(),n=a.max.y-a.min.y,d=-.09,g=o-s,h=M(e.mesh,v);s<o?(h.position.x=g+d,h.position.y=n-.2):(h.position.x=g-d,h.position.y=n-.2),e.rotateAroundZ()}return i}moveWithCollisions(e,t){e.moveWithCollisions(t)}addColors(e,t){let i=e.currentColor,o=t.currentColor,s=new P((i.r+o.r)/2,(i.g+o.g)/2,(i.b+o.b)/2);t.setColor(s)}showFinishScreen(){console.log("XR this: ",this.xrCamera),this.guiManager.createPromptWithButton("You have completed the task! The scene will now reset!",this.xrCamera)}playExplosion(){console.log(this.soundManager.loadedSounds.explosion);let e=this.soundManager.loadedSounds.explosion;e.stop(),e.play()}playDing(){let e=this.soundManager.loadedSounds.ding;e.stop(),e.play()}playSuccess(){let e=this.soundManager.loadedSounds.success;console.log("Success: ",e),e.stop(),e.play()}showEffects(e){const t=new _("particles",500,this.scene);t.particleTexture=new F("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),t.minLifeTime=.5,t.maxLifeTime=.7,t.emitRate=100,t.gravity=new f(0,.5,0),t.minSize=.01,t.maxSize=.07,t.createPointEmitter(new f(0,0,0),new f(0,1,0));const i=M(e,B);return t.addColorGradient(1,ie.FromColor3(i.material.diffuseColor,1)),t.blendMode=_.BLENDMODE_STANDARD,t.emitter=e.position,t.start(),this.playExplosion(),t}}class ae extends oe{constructor(t,i,o,s,a){super(t,i,o,s,a);r(this,"particleSystem")}resetCylinders(){this.particleSystem&&this.particleSystem.stop();let t=["A","B","C"];for(let i=0;i<t.length;i++){const o=this.scene.getMeshByName(`pivot-Cylinder-${t[i]}`),s=this.scene.getMeshByName("Table");if(s&&o){const a=s.getBoundingInfo().boundingBox;o.position.z=(a.centerWorld.z+a.minimumWorld.z)/2}super.getCylinderInstanceFromMesh(o).setOpacity(.85),super.getCylinderInstanceFromMesh(o).setColor(super.getCylinderInstanceFromMesh(o).originalColor),i==0&&(super.getCylinderInstanceFromMesh(o).setColor(P.Red()),super.getCylinderInstanceFromMesh(o).currentColor=P.Red())}}postSceneCylinder(){let t=["A","B","C"],i=[];for(let a of t){const n=this.scene.getMeshByName(`pivot-Cylinder-${a}`);i.push(n);let d=new S(`${a}-rotateAroundZ`,"rotation.z",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),m=M(n,v);const g=[];g.push({frame:0,value:Math.PI*2}),g.push({frame:60,value:4.62}),m.animations.push(d),d.setKeys(g);let h=new S(`${a}-resetRotateAroundZ`,"rotation.z",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT);const u=[];u.push({frame:0,value:4.62}),u.push({frame:60,value:Math.PI*2}),m.animations.push(h),h.setKeys(u)}let o=!1,s=!1;for(let a=0;a<t.length;a++){const n=this.scene.getMeshByName(`pivot-Cylinder-${t[a]}`);let d=super.getCylinderInstanceFromMesh(n);const m=n.getBehaviorByName("PointerDrag");console.log(m);let g=[];for(let p of i)p!=n&&g.push(p);let h=M(n,v),u=!1;m.onDragObservable.add(()=>{T.audioEngine.unlock(),T.audioEngine.audioContext.resume();let p=!1,y=!1;z(n);const l=super.intersectCylinder(n);if(l){let A=super.getCylinderInstanceFromMesh(l);y=!0;let x=l.name.split("-")[2],I=`${n.name.split("-")[2]}to${x}`;b.tasks[b.currentState].label===I?(s=!0,b.tasks[b.currentState].next==="complete"?(p=!0,console.log(A),setTimeout(()=>{super.playSuccess()},300),d.fadeAndRespawn(),b.resetSOP(),this.resetCylinders(),super.showFinishScreen()):(b.currentState=b.tasks.indexOf(b.tasks.find(E=>E.label==b.tasks[b.currentState].next)),super.playDing())):!o&&!s&&(this.particleSystem=super.showEffects(l),o=!0);let w=n.getAbsolutePosition()._x;l.getAbsolutePosition()._x<w?(h.rotation.y=Math.PI,l.rotation.y=h.rotation.y):(h.rotation.y=0,l.rotation.y=h.rotation.y),u||(u=super.highlightAndRotateCylinders(d,A,u),l.name.split("-")[2],n.name.split("-")[2],p||super.addColors(d,A))}else d.highlight(!1),z(n);y==!1&&(d.highlight(!1),s=!1,u&&(h.position.x=0,h.position.y=0,u=!1,d.resetAroundZ()))}),m.onDragEndObservable.add(()=>{M(n,v).getBehaviorByName("Highlight");for(let p of g)p!=h&&(d.highlight(!1),super.getCylinderInstanceFromMesh(p).highlight(!1),h.intersectsMesh(p)&&(d.resetAroundZ(),h.position.x=0,h.position.y=0,u=!1))})}}}class J extends oe{constructor(t,i,o,s,a,n){console.log("Cylinders hand: ",o);super(i,o,s,a,n);r(this,"handedness");r(this,"holdingInstance");r(this,"holdingMesh");r(this,"targetMesh");r(this,"targetMeshInstance");r(this,"motionController");r(this,"handMesh");r(this,"isVisible");r(this,"failBeaker");r(this,"particleSystem");r(this,"cylinderInstancesHand");this.handedness=t,this.handMesh=i.getMeshByName(this.handedness),this.isVisible=!0,this.failBeaker=!1}getMotionController(){return this.motionController}setMotionController(t){this.motionController=t}dropped(t){this.motionController.lastPosition=null,clearInterval(t),this.motionController.grabbed=!1,this.motionController.meshGrabbed=void 0,console.log(this.holdingMesh),this.holdingMesh&&(this.holdingInstance.fadeAndRespawn(100),this.holdingMesh=null,this.holdingInstance=null,this.motionController.meshGrabbed=null)}updateSOPTask(t,i,o){console.log(this.scene);let s=`${t}to${i}`;if(b.tasks[b.currentState].label===s)if(b.tasks[b.currentState].next==="complete"){console.log("GUI mgr",this.guiManager,"Sound mgr: ",this.soundManager);let a=new ae(this.scene,this.cylinderInstances,this.guiManager,this.soundManager,this.xrCamera);for(let n of this.cylinderInstances)n.fadeAndRespawn(100);if(super.playSuccess(),console.log("Showing finish screen!"),this.xrCamera.baseExperience.state==Z.IN_XR){super.showFinishScreen();let n=this.scene.getMeshByName("Start");if(n){let d=this.xrCamera.baseExperience.camera;n.parent=d,n.position=d.position.add(new f(-d.position.x,-1.5,1.15)),this.xrCamera.pointerSelection.displayLaserPointer=!0,this.xrCamera.pointerSelection.displaySelectionMesh=!0,n.rotation=f.Zero()}}b.resetSOP(),this.disappearAnimation(!1),this.dropped(o),this.particleSystem&&(this.particleSystem.stop(),console.log("Stopping particle system!")),a.resetCylinders();for(let n of this.cylinderInstances)n.resetProperties();return!0}else return super.playDing(),b.currentState=b.tasks.indexOf(b.tasks.find(a=>a.label==b.tasks[b.currentState].next)),!1;else this.failBeaker||(super.playExplosion(),this.particleSystem=super.showEffects(this.targetMesh));return!1}disappearAnimation(t=!0){console.log("DISAPPEAR: ",t);let i=60,o=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}];o.forEach(s=>{s.init=new S(s.name,"visibility",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),s.init.setKeys([{frame:0,value:s.startValue},{frame:i,value:1-s.startValue}])}),console.log(this.handMesh),t?(this.isVisible=!1,this.scene.beginDirectAnimation(this.handMesh,[o[0].init],0,60,!1)):(this.isVisible=!0,this.scene.beginDirectAnimation(this.handMesh,[o[1].init],0,60,!1))}}function Ve(c,e,t,i,o,s){let a=new J("right",c,i,o,s,e),n=new J("left",c,i,o,s,e),d=!1,m={right:a,left:n},g=!1;function h(u){let p=u.name.split("-")[2];console.log("Name: ",p);for(let y of i)if(console.log("Instance name: ",y.name),y.name==p)return y;return null}e.input.onControllerAddedObservable.add(u=>{u.onMotionControllerInitObservable.add(p=>{let y=p;y.handID=p.handedness;let l=m[y.handedness];l.getMotionController()||l.setMotionController(y),console.log(l);let A=new fe(f.Zero(),f.Zero(),.25);const x=p.getComponentOfType("squeeze");p.getComponentOfType("trigger"),[x].forEach(C=>{console.log(c.getMeshByName("left")),C.onButtonStateChangedObservable.add(I=>{let w,O={left:"Fist",right:"Grip"},E=c.animationGroups.find((V,G)=>V.name===`${l.motionController.handID}_${O[l.motionController.handID]}`);E.goToFrame(I.value*(E._to-1)+1);let k=l.intersectHandCylinder(c.getMeshByName(y.handID));if(console.log("Grabbed Cylinder: ",k),I.value>.5&&!l.motionController.grabbed){if(k){T.audioEngine.unlock(),d=!1,l.holdingMesh=k,l.holdingInstance=h(l.holdingMesh),l.motionController.meshGrabbed=l.holdingMesh,l.motionController.grabbed=!0;let V=l.motionController.lastPosition,G=A.origin;G!=V&&(l.disappearAnimation(!0),w=setInterval(()=>{let q=l.motionController.lastPosition;if(u.getWorldPointerRayToRef(A),q&&l.holdingMesh&&l.moveWithCollisions(l.holdingMesh,G.subtract(q)),!l.intersectHandCylinder(c.getMeshByName(l.motionController.handID))&&l.holdingMesh&&(l.targetMeshInstance&&l.targetMeshInstance.highlight(!1),l.dropped(w),l.motionController.grabbed=!1,l.handMesh.visibility=1,d=!0),l.holdingMesh){let D=l.intersectCylinder(l.holdingMesh);if(D){l.targetMesh=D,l.targetMeshInstance=h(D);let re=D.name.split("-")[2],le=l.holdingMesh.name.split("-")[2];g||(l.addColors(l.holdingInstance,l.targetMeshInstance),g=l.highlightAndRotateCylinders(l.holdingInstance,l.targetMeshInstance,g),d=l.updateSOPTask(le,re,w))}else l.targetMeshInstance&&l.targetMeshInstance.highlight(!1),l.holdingInstance.highlight(!1),g&&(l.holdingInstance.resetAroundZ(),se(M(l.holdingMesh,v)),g=!1)}d||(l.motionController.lastPosition=Object.assign({},A.origin),y.lastPosition=Object.assign({},A.origin))},10))}}else(!I.value||!k)&&l.holdingMesh&&(l.holdingInstance.highlight(!1),l.motionController.grabbed=!1,l.targetMeshInstance&&l.targetMeshInstance.highlight(!1),l.dropped(w),l.disappearAnimation(!1))})})})})}var W;class Ge{constructor(e){r(this,"flying",!1);r(this,"active",!1);r(this,"camera");r(this,"mesh");r(this,"offset",.3);r(this,"animations");r(this,"returnPosition");r(this,"returnRotation");r(this,"onPointerDownObserver");r(this,"xrCamera");r(this,"attach",(e,t,i,o,s)=>{const a=e.getScene();if(this.mesh=e,!t&&(t=a.activeCamera,!t))throw new Error("The scene has no active camera, and no camera was provided.");this.camera=t,i||(i=this.mesh.position),o||(o=this.mesh.rotation),s&&(this.offset=s),this.returnPosition=i,this.returnRotation=o,this.onPointerDownObserver=a.onPointerObservable.add(this.clipboardClick)});r(this,"detach",()=>{this.mesh.getScene().onPointerObservable.remove(this.onPointerDownObserver)});r(this,"clipboardClick",(e={type:j.POINTERDOWN,pickInfo:{pickedMesh:this.mesh}})=>{var t;if(e.type===j.POINTERDOWN){console.log("Clipboard click");const i=(t=e.pickInfo)==null?void 0:t.pickedMesh;if(i&&(i===this.mesh||i.isDescendantOf(this.mesh))&&!this.flying||this.active){const o=this.active?N/2:0,s=this.active?0:N/2;K(this,W).call(this),this.flying=!0,this.mesh.billboardMode==H.BILLBOARDMODE_ALL?this.mesh.billboardMode=H.BILLBOARDMODE_NONE:this.mesh.billboardMode=H.BILLBOARDMODE_ALL,this.mesh.getScene().beginDirectAnimation(this.mesh,this.animations,o,s,!1,void 0,()=>{this.flying=!1,this.active=!this.active})}}});r(this,"calculateTargetPositionWithOffset",e=>{if(this.xrCamera!==void 0&&this.xrCamera.state===Z.IN_XR){const a=this.xrCamera.camera._position.subtract(this.returnPosition).scale(1-e/f.Distance(this.returnPosition,this.xrCamera.camera._position));return this.returnPosition.add(a)}const i=this.camera._position.subtract(this.returnPosition).scale(1-e/f.Distance(this.returnPosition,this.camera._position));return this.returnPosition.add(i)});r(this,"setClipboardUp",()=>new f(3.1468286,4.6617744,1.680752));Y(this,W,()=>{const e=this.animations.find(({name:s})=>s==="translate"),t=this.animations.find(({name:s})=>s==="rotate"),i=[{frame:0,value:this.returnPosition},{frame:N/2,value:this.calculateTargetPositionWithOffset(this.offset)}],o=[{frame:0,value:this.returnRotation},{frame:N/2,value:this.setClipboardUp()}];e.setKeys(i),t.setKeys(o)});const t=new S("translate","position",N,S.ANIMATIONTYPE_VECTOR3),i=new S("rotate","rotation",N,S.ANIMATIONTYPE_VECTOR3);this.animations=[t,i],this.xrCamera=e}get name(){return"FlyToCamera"}init(){}}W=new WeakMap;class He{constructor(e,t,i){r(this,"rect");r(this,"text");r(this,"button");this.rect=e,this.text=t,this.button=i}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e}}class $e{constructor(e){r(this,"advancedTexture");r(this,"welcomePrompt");r(this,"gameFinishPrompt");r(this,"camera");r(this,"screen");r(this,"scene");this.scene=e,this.camera=e.activeCamera,console.log("Scene: ",this.scene)}createPromptWithButton(e,t=null,i=null){this.screen=ee.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=this.camera.position.add(new f(.7,-2,2.5)),this.advancedTexture=ye.CreateForMesh(this.screen);let o=new be("container");var s=new Ce;s.width=.5,s.height=.2,s.color="cyan",s.thickness=4,s.background="white",o.addControl(s);var a=new Me;a.text=e,a.color="black",a.fontSize="17px",a.resizeToFit=!0,a.textWrapping=!0,a.paddingBottomInPixels=40,a.paddingLeftInPixels=15,a.paddingRightInPixels=15,s.addControl(a);var n=xe.CreateSimpleButton("but1","Click to dismiss");n.width="150px",n.height="40px",n.color="black",n.cornerRadius=20,n.background="white",n.topInPixels=40;let d=new He(s,a,n),m=this.scene.getMeshByName("Start");return d.button.onPointerUpObservable.add(function(){o.dispose(),m.dispose(),console.log("XR cam: ",t),t&&(console.log("Hiding Pointer!"),t.pointerSelection.displayLaserPointer=!1,t.pointerSelection.displaySelectionMesh=!1)}),d.button.onPointerEnterObservable.add(()=>{n.background="grey"}),d.button.onPointerOutObservable.add(()=>{n.background="white"}),o.addControl(d.button),o.addControl(n),this.advancedTexture.addControl(o),d}}class Ue{constructor(e,t){r(this,"soundList");r(this,"soundPointer");r(this,"scene");r(this,"loadedSounds");this.scene=t,this.soundPointer=0,this.soundList=e,this.loadedSounds={}}async loadSounds(){let e=[];return new Promise(t=>{let i=0;this.soundList.forEach(o=>{if(e.push({soundName:o.soundName,sound:new Se(o.soundName,o.fileName,this.scene,()=>{T.audioEngine.unlock()},{})}),i++,i===this.soundList.length){for(let s of e)this.loadedSounds[s.soundName]=s.sound;t(e),console.log("Sounds loaded!!",this.loadedSounds)}})})}}console.log=()=>{};class Ze{constructor(){r(this,"handAnimation");r(this,"sop");r(this,"models");r(this,"cylinders");r(this,"guiManager");r(this,"soundManager");r(this,"loadedSounds");this.cylinders=[];let e="TLLGraduatedCylinderNewLabel.glb";this.models=[{fileName:"LabWithTable.glb",callback:i=>this.createRoom(i),label:"floor"},{fileName:"Placard_Label.glb",callback:i=>U(i,1,"Placard-A")},{fileName:"Placard_Label.glb",callback:i=>U(i,2,"Placard-B")},{fileName:"Placard_Label.glb",callback:i=>U(i,3,"Placard-C")},{fileName:e,callback:i=>this.cylinders.push(new $(i[0],1,"A",new P(1,0,0))),label:"Cylinder-A"},{fileName:e,callback:i=>this.cylinders.push(new $(i[0],2,"B",new P(0,1,0))),label:"Cylinder-B"},{fileName:e,callback:i=>this.cylinders.push(new $(i[0],3,"C",new P(0,0,1))),label:"Cylinder-C"},{fileName:"clipBoardWithPaperCompressedTextureNew.glb",callback:i=>Fe(i[0])}].map(function(i){return Object.assign({},{fileName:"LabBench.glb",root:"./models/",callback:ze,label:"NoLabel"},i)});let t=[{soundName:"explosion",fileName:`${R}/sound/mi_explosion_03_hpx.mp3`},{soundName:"ding",fileName:`${R}/sound/ding-idea-40142.mp3`},{soundName:"success",fileName:`${R}/sound/success.mp3`}];this.loadedSounds=[],this.createScene().then(i=>{this.soundManager=new Ue(t,i),this.soundManager.loadSounds().then(o=>{this.loadedSounds=o;for(let s of["A","B","C"])Object.assign({},i.getMeshByName(`pivot-Cylinder-${s}`).position);console.log("Loaded sounds: ",this.loadedSounds);for(let s of this.loadedSounds)console.log(s.sound);this.processScene(i,this.cylinders,this.guiManager,this.soundManager)})})}async processScene(e,t,i,o){let s=e.getCameraByName("camera"),a=e.getLightByName("light1"),n;s.speed=.16;let d=setInterval(()=>{a.intensity>=1?clearInterval(d):a.intensity+=.1},60);const m=["WallsandFloor","WallsAndFloor.001"],g=[];for(let p of m){console.log(p);const y=e.getMeshByName(p);y&&g.push(y)}let h={floorMeshes:g,inputOptions:{doNotLoadControllerMeshes:!0}};n=await e.createDefaultXRExperienceAsync(h);let u=!1;n.pointerSelection.laserPointerDefaultColor=P.Green(),n.pointerSelection.laserPointerPickedColor=P.Green(),n.pointerSelection.selectionMeshPickedColor=P.Green(),n.pointerSelection.selectionMeshDefaultColor=P.Green(),n.pointerSelection.displayLaserPointer=!1,n.pointerSelection.displaySelectionMesh=!1,window.addEventListener("keydown",p=>{p.keyCode===73&&(u?u=!1:u=!0,n.pointerSelection.displayLaserPointer=u,n.pointerSelection.displaySelectionMesh=u)}),We(e,n,t).then(p=>{if(console.log("add webxr"),n){const l=new Ge(n.baseExperience);e.getMeshByName("clipboard").addBehavior(l)}this.guiManager=new $e(e),this.guiManager.createPromptWithButton("Welcome to the Lab Safety Simulation. Click on the clipboard to learn more about the simulation!",n),console.log("Cylinders app: ",t),new ae(e,t,this.guiManager,o,n).postSceneCylinder(),Ve(e,n,p,t,this.guiManager,this.soundManager)})}createRoom(e){const t=["WallsandFloor","WallsAndFloor.001","Table","Roof","Countertop","Walls"];let i,o;for(let s of t){const a=e.find(n=>n.name===s);if(a&&(a.checkCollisions=!0,a.name==="Table")){const n=a.getBoundingInfo().boundingBox;n.center.x,i=a.getScene(),o=i.getCameraByName("camera"),o.position=new f(n.center.x*-1,n.center.y*2+.5,-1.5),o.rotation=new f(Math.PI/8,0,0)}}}createScene(){return new Promise(e=>{const t=document.getElementById("canvas"),i=new T(t,!0,{stencil:!0}),o=new Pe(i);o.collisionsEnabled=!0,window.addEventListener("resize",function(){i.resize()});const s=new Ae("camera",new f(0,1.84,-1.134),o);s.ellipsoid=new f(.4,.7,.4),s.attachControl(t,!0),s.applyGravity=!0,s.minZ=0,s.speed=0,s.checkCollisions=!0,s.keysUp.push(87),s.keysDown.push(83),s.keysLeft.push(65),s.keysRight.push(68);var a=new ve("light1",new f(1,1,0),o);a.intensity=0,Promise.all(this.models.map(n=>new Promise(d=>we.ImportMesh("",n.root,n.fileName,o,function(m){n.mesh=m,d(m)})))).then(()=>{let n=[];this.models.map(d=>{n.push(d.callback(d.mesh)),e(o)})}),window.addEventListener("keydown",n=>{n.shiftKey&&n.ctrlKey&&n.altKey&&n.keyCode===73&&(o.debugLayer.isVisible()?o.debugLayer.hide():o.debugLayer.show())}),i.runRenderLoop(()=>{o.render()})})}}new Ze;
