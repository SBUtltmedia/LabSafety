var le=Object.defineProperty;var re=(h,e,i)=>e in h?le(h,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):h[e]=i;var r=(h,e,i)=>(re(h,typeof e!="symbol"?e+"":e,i),i),he=(h,e,i)=>{if(!e.has(h))throw TypeError("Cannot "+i)};var Z=(h,e,i)=>(he(h,e,"read from private field"),i?i.call(h):e.get(h)),K=(h,e,i)=>{if(e.has(h))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(h):e.set(h,i)};import{H as de,M as ce,V as b,S as D,D as J,P as _,T as F,C as ee,a as I,b as me,A as S,c as ue,B as Y,d as ge,E,R as fe,e as j,f as H,W as pe,g as ye,h as be,U as Ce,i as Me,j as xe}from"./vendor.2c53feab.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&t(l)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerpolicy&&(s.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?s.credentials="include":n.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();window.exports=window;class Ae{constructor(e,i,t,n=0){r(this,"complete",!1);r(this,"title");r(this,"description");r(this,"failed",!1);r(this,"onFail");r(this,"onSuccess");r(this,"onCompletion");r(this,"currentState");r(this,"tasks");r(this,"resetSOP",()=>{this.currentState=0,this.failed=!1,this.complete=!1});this.title=e,this.description=i,this.tasks=t,this.currentState=n}}const R="./",B=60,Se=50,te=3,P="cylinder",L="liquid",ve="placard",y=new Ae("","",[{next:"CtoA",label:"BtoC"},{next:"complete",label:"CtoA"}]);function M(h,e){return h.getChildMeshes().find(i=>i.name===e)||null}function z(h){h.rotation.x=0,h.rotation.y=0,h.rotation.z=0}function ie(h){h.position.x=0,h.position.y=0,h.position.z=0}class G{constructor(e,i,t,n){r(this,"name");r(this,"position");r(this,"mesh");r(this,"dragCollision");r(this,"highlightLayer");r(this,"scene");r(this,"particleSystem");r(this,"currentColor");r(this,"originalColor");r(this,"startOpacity");console.log(e),this.name=t,this.currentColor=n,this.originalColor=n,this.startOpacity=.7;const s=e.getScene();this.scene=s,this.highlightLayer=new de("highlight-layer",s),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1;const l=s.getMeshByName("Table");let o=ce.CreateSphere(`pivot-Cylinder-${t}`,{segments:2,diameterX:.15,diameterY:.33,diameterZ:.2},e.getScene());if(o.visibility=0,e.name=t,e.parent=o,e.rotationQuaternion=null,e.getChildMeshes().forEach(C=>{switch(C.name){case"BeakerwOpacity":C.name=P,C.rotationQuaternion=null,C.rotation.z=2*Math.PI,C.isPickable=!1;break;case"BeakerLiquid":C.name=L,C.isPickable=!1;break}}),l){const C=l.getBoundingInfo().boundingBox,T=M(e,P).getBoundingInfo().boundingBox.maximum.y;console.log(T),o.position.y=C.maximumWorld.y+T/2+.05,o.position.x=(C.maximumWorld.x-C.minimumWorld.x)/te*i+C.minimumWorld.x-.3,o.position.z=(C.centerWorld.z+C.minimumWorld.z)/2,this.position={...o.position}}else o.position.x=-2+i,o.position.y=1.22,o.position.z=.5,console.log("Else!");o.checkCollisions=!0,o.ellipsoid=new b(.02,.16,.02),this.mesh=o;const c=M(e,L),m=new D("liquid-material");m.diffuseColor=n,c.material=m;const u=M(e,"Label"),d=M(e,"LabelBack");console.log("Label:",d);const g=new J("dynamic texture",256,s),f=new D("Mat",s);f.diffuseTexture=g,u.material=f,d.material=f;const p="bold 300px monospace";g.drawText(e.name.toUpperCase(),65,225,p,"black","white");let v=this.mesh.getChildMeshes().find(C=>C.name==="cylinder");this.mesh.animations=v.animations,console.log("Children: ",this.mesh.getChildMeshes());const A=new _("particles",500,this.scene);A.particleTexture=new F("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),A.minLifeTime=.5,A.maxLifeTime=.7,A.emitRate=100,A.gravity=new b(0,.5,0),A.minSize=.01,A.maxSize=.07,A.createPointEmitter(new b(0,0,0),new b(0,1,0)),A.addColorGradient(1,ee.FromColor3(c.material.diffuseColor,1)),A.blendMode=_.BLENDMODE_STANDARD,A.emitter=this.mesh.position,this.particleSystem=A,this.setOpacity(this.startOpacity),this.addDragCollision()}startParticles(){this.particleSystem.start()}highlight(e=!0){let i=M(this.mesh,P);e?(console.log("Adding mesh"),this.highlightLayer.hasMesh(i)||this.highlightLayer.addMesh(i,I.Green())):this.highlightLayer.hasMesh(i)&&this.highlightLayer.removeMesh(i)}addDragCollision(){let e=new me({dragPlaneNormal:new b(0,0,1)});e.useObjectOrientationForDragging=!1,e.moveAttached=!1,e.onDragStartObservable.add(()=>{}),e.onDragObservable.add(i=>{this.mesh.moveWithCollisions(i.delta)}),e.onDragEndObservable.add(()=>{this.fadeAndRespawn()}),this.mesh.addBehavior(e),this.dragCollision=e}removeDragCollision(){this.mesh.removeBehavior(this.dragCollision)}fadeAndRespawn(e=Se){setTimeout(()=>{let i=this.mesh.getBehaviorByName("PointerDrag");i&&i.releaseDrag(),this.mesh.isPickable=!1;let t=60;this.mesh.name.split("-")[0];let n=this.mesh.getScene(),s=this.mesh.getChildMeshes(),l=s.find(m=>m.name==="cylinder");s.find(m=>m.name==="liquid");const o=M(this.mesh,L);console.log("Visibility: ",o.visibility);let c=[{name:"Invisibility",startValue:o.visibility},{name:"Visibility",startValue:0}];c.forEach(m=>{m.init=new S(m.name,"visibility",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),m.init.setKeys([{frame:0,value:m.startValue},{frame:t,value:o.visibility-m.startValue}])});for(let m=0;m<s.length-1;++m){let u=s[m];n.beginDirectAnimation(u,[c[0].init],0,60,!1)}n.beginDirectAnimation(s[s.length-1],[c[0].init],0,60,!1,void 0,()=>{console.log(this.mesh,this.position),this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z,this.mesh.animations=l.animations;let m=M(this.mesh,P);z(this.mesh),z(m),ie(m);for(let u=0;u<s.length-1;++u){let d=s[u];n.beginDirectAnimation(d,[c[1].init],0,60,!1)}n.beginDirectAnimation(s[s.length-1],[c[1].init],0,60,!1,void 0,()=>{this.highlight(!1),this.mesh.isPickable=!0})})},e)}rotateAroundZ(){let e=this.mesh.getAnimationByName(`${this.name}-rotateAroundZ`);this.scene.beginDirectAnimation(M(this.mesh,P),[e],0,60,!1,void 0,()=>{})}resetAroundZ(){let e=this.mesh.getAnimationByName(`${this.name}-resetRotateAroundZ`);this.scene.beginDirectAnimation(M(this.mesh,P),[e],0,60,!1,void 0,()=>{})}setColor(e){const i=M(this.mesh,L),t=new D("liquid-material");t.diffuseColor=e,i.material=t,this.currentColor=e,console.log(this.currentColor)}setOpacity(e){const i=M(this.mesh,L);i.visibility=e}resetProperties(){this.setOpacity(this.startOpacity),this.setColor(this.originalColor)}}const Pe="Stony Brook University VR Laboratory",Ie="Victor Ruben",Ne="VR Chemical Mixture Synthesis",Oe="4/1/2022",we="General: Properly mixing VR chemicals",Be="42",Le="I",Te=[{text:"HAZARD IDENTIFICATION test from JSON",sublistType:"a",sublist:[{text:"Improper mixing of chemicals can lead to explosive results!"}]},{text:"CHEMICAL HANDLING PROCEDURES",sublistType:"a",sublist:[{text:"When mixing these chemicals - always follow the correct sequence"},{text:"Pour chemical B into chemical C"},{text:"Then pour chemical mixture B+C into chemical A"}]},{text:"EMERGENCY PROCEDURES",sublistType:"a",sublist:[{text:"In the event of an improper mixture - use the fire extinguisher to put out the flames"},{text:"Evacuate the lab"},{text:"Call for emergency services"}]}],X={facility:Pe,labDirector:Ie,scope:Ne,lastRevision:Oe,general:we,sopNum:Be,listType:Le,items:Te};function De(h){h.name="clipboard";const e=h.getScene(),i=e.getMeshByName("Table");if(i){const l=i.getBoundingInfo().boundingBox;h.position.y=l.maximumWorld.y+.003}h.rotationQuaternion=null,h.rotation=new b(0,Math.PI/4,0);const t=e.getMeshByName("pivot-Cylinder-A");t&&(h.position.x=t.position.x+.2,h.position.z=t.position.z+.5);function n(l){console.log("data: ",X);let o=document.createElement("template");o.innerHTML=l;var c=ue.compile(o.innerHTML),m=c(X);return o.innerHTML=m,o.content}function s(l){const c="data:image/svg+xml;utf8,"+encodeURIComponent(l),m=F.LoadFromDataString("tex",c,e,void 0,void 0,void 0,F.LINEAR_LINEAR_MIPNEAREST);let u=new D("mat",e);u.diffuseTexture=m,m.uScale=1,m.vScale=-1,u.emissiveColor=I.White(),u.useAlphaFromDiffuseTexture=!0,m.hasAlpha=!0;let d=M(h,"Plane");d.material=u,console.log("Material set")}fetch(`${R}images/sopTemplate.svg`).then(l=>l.text()).then(l=>{console.log("fetched!");let o=n(l),c=o.getElementById("procedure-list");console.log(c);const u=new XMLSerializer().serializeToString(o);s(u)}).catch(console.error.bind(console))}function Ee(h){var e=new Y(I.FromHexString("#0984e3"));e.ignoreChildren=!0;var i=h[0],t=Y.MakeNotPickableAndWrapInBoundingBox(i);e.attachedMesh=t,e.onScaleBoxDragObservable.add(()=>{console.log("scaleDrag")}),e.onScaleBoxDragEndObservable.add(()=>{const n=e.attachedMesh;if(n){const s=n.getHierarchyBoundingVectors(!0);console.log("size x:",s.max.x-s.min.x),console.log("size y:",s.max.y-s.min.y),console.log("size z:",s.max.z-s.min.z)}console.log("scaleEnd")}),e.onRotationSphereDragObservable.add(()=>{console.log("rotDrag")}),e.onRotationSphereDragEndObservable.add(()=>{console.log("rotEnd")})}function q(h,e,i){const t=h.find(d=>d.name==="__root__"),n=t.getScene();t.name=i;const s=h.find(d=>d.name==="Label"),l=h.find(d=>d.name==="Placard");l.name=ve;const o=new J("dynamic texture",256,n);o.wAng=-Math.PI/2,o.uAng=Math.PI;const c=new D("Mat",n);c.diffuseTexture=o,s.material=c;const m="bold 220px monospace";o.drawText(t.name.split("-")[1].toUpperCase(),65,185,m,"black","white"),l.addChild(s),l.rotationQuaternion=null,l.rotation=new b(0,Math.PI/2,0);const u=n.getMeshByName("Table");if(u){const d=u.getBoundingInfo().boundingBox;t.position.y=d.maximumWorld.y+.003,t.position.x=(d.maximumWorld.x-d.minimumWorld.x)/te*e+d.minimumWorld.x-.2,t.position.z=(d.centerWorld.z+d.minimumWorld.z)/2+.2}}function ke(h,e,i){let t;return new Promise(n=>{const s="./models/";let l="";var o={};let c=["left","right"];const m=new ge(h);c.forEach(d=>{m.addMeshTask(`load ${d} hand`,"",s,`${d}${l}.glb`)});let u=0;m.onTaskSuccess=d=>{o[c[u]]=d.loadedMeshes[1],d.loadedMeshes[1].name=c[u],t=d.loadedAnimationGroups;for(let g=0;g<t.length;g++)t[g].name=`${c[u]}_${t[g].name}`;u++},m.onTasksDoneObservable.add(()=>{for(let d=0;d<h.animationGroups.length;d++)h.animationGroups[d].pause();e.input.onControllerAddedObservable.add(d=>{let g=d.inputSource.handedness;console.log(o[g]);let f=o[g].parent.parent;o[g].isPickable=!1;for(let a of i)a.removeDragCollision();let p=(Object.keys(o).indexOf(g)-1)*2-1;o[g].rotation.y=Math.PI*p,o[g].rotation.z=0,o[g].rotation.x=-Math.PI/4,f.parent=d.grip||d.pointer})}),m.loadAsync().then(()=>{n(t)})})}class ne{constructor(e,i,t,n){r(this,"cylinderInstances");r(this,"clipboard");r(this,"scene");r(this,"labels");r(this,"guiManager");r(this,"soundManager");this.labels=["A","B","C"],this.scene=e,this.cylinderInstances=i,this.guiManager=t,this.soundManager=n}getCylinderInstanceFromMesh(e){let i=e.name.split("-")[2];for(let t of this.cylinderInstances)if(t.name==i)return t;return null}intersectHandCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(e.intersectsMesh(t,!1)&&t.isPickable)return t}return null}intersectCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(t!=e&&e.intersectsMesh(t))return t}return null}highlightAndRotateCylinders(e,i,t){e.highlight(),i.highlight();let n=e.mesh.getAbsolutePosition()._x,s=i.mesh.getAbsolutePosition()._x;if(s<n?(e.mesh.rotation.y=Math.PI,i.mesh.rotation.y=e.mesh.rotation.y):(e.mesh.rotation.y=0,i.mesh.rotation.y=e.mesh.rotation.y),!t){t=!0;let l=e.mesh.getHierarchyBoundingVectors(),o=l.max.y-l.min.y,c=-.09,u=n-s,d=M(e.mesh,P);s<n?(d.position.x=u+c,d.position.y=o-.2):(d.position.x=u-c,d.position.y=o-.2),e.rotateAroundZ()}return t}moveWithCollisions(e,i){e.moveWithCollisions(i)}addColors(e,i){let t=e.currentColor,n=i.currentColor,s=new I((t.r+n.r)/2,(t.g+n.g)/2,(t.b+n.b)/2);i.setColor(s)}showFinishScreen(){this.guiManager.gameFinishPrompt.setVisible(!0)}playExplosion(){console.log(this.soundManager.loadedSounds.explosion);let e=this.soundManager.loadedSounds.explosion;e.stop(),e.play()}playDing(){let e=this.soundManager.loadedSounds.ding;e.stop(),e.play()}playSuccess(){let e=this.soundManager.loadedSounds.success;console.log("Success: ",e),e.stop(),e.play()}}class se extends ne{constructor(i,t,n,s){super(i,t,n,s);r(this,"particleSystem")}resetCylinders(){this.particleSystem&&this.particleSystem.stop();let i=["A","B","C"];for(let t=0;t<i.length;t++){const n=this.scene.getMeshByName(`pivot-Cylinder-${i[t]}`),s=this.scene.getMeshByName("Table");if(s&&n){const l=s.getBoundingInfo().boundingBox;n.position.z=(l.centerWorld.z+l.minimumWorld.z)/2}super.getCylinderInstanceFromMesh(n).setOpacity(.85),super.getCylinderInstanceFromMesh(n).setColor(super.getCylinderInstanceFromMesh(n).originalColor),t==0&&(super.getCylinderInstanceFromMesh(n).setColor(I.Red()),super.getCylinderInstanceFromMesh(n).currentColor=I.Red())}}postSceneCylinder(){let i=["A","B","C"],t=[];for(let l of i){const o=this.scene.getMeshByName(`pivot-Cylinder-${l}`);t.push(o);let c=new S(`${l}-rotateAroundZ`,"rotation.z",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),m=M(o,P);const u=[];u.push({frame:0,value:Math.PI*2}),u.push({frame:60,value:4.62}),m.animations.push(c),c.setKeys(u);let d=new S(`${l}-resetRotateAroundZ`,"rotation.z",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT);const g=[];g.push({frame:0,value:4.62}),g.push({frame:60,value:Math.PI*2}),m.animations.push(d),d.setKeys(g)}let n=!1,s=!1;for(let l=0;l<i.length;l++){const o=this.scene.getMeshByName(`pivot-Cylinder-${i[l]}`);let c=super.getCylinderInstanceFromMesh(o);const m=o.getBehaviorByName("PointerDrag");console.log(m);let u=[];for(let f of t)f!=o&&u.push(f);let d=M(o,P),g=!1;m.onDragObservable.add(()=>{E.audioEngine.unlock(),E.audioEngine.audioContext.resume();let f=!1,p=!1;z(o);const a=super.intersectCylinder(o);if(a){let v=super.getCylinderInstanceFromMesh(a);p=!0;let A=a.name.split("-")[2],O=`${o.name.split("-")[2]}to${A}`;if(y.tasks[y.currentState].label===O)s=!0,y.tasks[y.currentState].next==="complete"?(f=!0,console.log(v),super.playSuccess(),c.fadeAndRespawn(),y.resetSOP(),this.resetCylinders()):(y.currentState=y.tasks.indexOf(y.tasks.find(x=>x.label==y.tasks[y.currentState].next)),super.playDing());else if(!n&&!s){n=!0;const x=new _("particles",500,this.scene);x.particleTexture=new F("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),x.minLifeTime=.5,x.maxLifeTime=.7,x.emitRate=100,x.gravity=new b(0,.5,0),x.minSize=.01,x.maxSize=.07,x.createPointEmitter(new b(0,0,0),new b(0,1,0));const w=M(a,L);x.addColorGradient(1,ee.FromColor3(w.material.diffuseColor,1)),x.blendMode=_.BLENDMODE_STANDARD,x.emitter=a.position,this.particleSystem=x,this.particleSystem.start(),console.log("Playing explosion!"),super.playExplosion()}let N=o.getAbsolutePosition()._x;a.getAbsolutePosition()._x<N?(d.rotation.y=Math.PI,a.rotation.y=d.rotation.y):(d.rotation.y=0,a.rotation.y=d.rotation.y),g||(g=super.highlightAndRotateCylinders(c,v,g),a.name.split("-")[2],o.name.split("-")[2],f||super.addColors(c,v))}else c.highlight(!1),z(o);p==!1&&(c.highlight(!1),s=!1,g&&(d.position.x=0,d.position.y=0,g=!1,c.resetAroundZ()))}),m.onDragEndObservable.add(()=>{M(o,P).getBehaviorByName("Highlight");for(let f of u)f!=d&&(c.highlight(!1),super.getCylinderInstanceFromMesh(f).highlight(!1),d.intersectsMesh(f)&&(c.resetAroundZ(),d.position.x=0,d.position.y=0,g=!1))})}}}class Q extends ne{constructor(i,t,n,s,l){super(t,n,s,l);r(this,"handedness");r(this,"holdingInstance");r(this,"holdingMesh");r(this,"targetMesh");r(this,"targetMeshInstance");r(this,"motionController");r(this,"handMesh");r(this,"isVisible");this.handedness=i,this.handMesh=t.getMeshByName(this.handedness),this.isVisible=!0}getMotionController(){return this.motionController}setMotionController(i){this.motionController=i}dropped(i){this.motionController.lastPosition=null,clearInterval(i),this.motionController.grabbed=!1,this.motionController.meshGrabbed=void 0,console.log(this.holdingMesh),this.holdingMesh&&(this.holdingInstance.fadeAndRespawn(100),this.holdingMesh=null,this.holdingInstance=null,this.motionController.meshGrabbed=null)}updateSOPTask(i,t,n){console.log(this.scene);let s=`${i}to${t}`;if(y.tasks[y.currentState].label===s)if(y.tasks[y.currentState].next==="complete"){let l=new se(this.scene,this.cylinderInstances,this.guiManager,super.soundManager);for(let o of this.cylinderInstances)o.fadeAndRespawn(100);super.playSuccess(),y.resetSOP(),this.disappearAnimation(!1),this.dropped(n),l.resetCylinders();for(let o of super.cylinderInstances)o.resetProperties();return!0}else return super.playDing(),y.currentState=y.tasks.indexOf(y.tasks.find(l=>l.label==y.tasks[y.currentState].next)),!1;else super.playExplosion()}disappearAnimation(i=!0){console.log("DISAPPEAR: ",i);let t=60,n=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}];n.forEach(s=>{s.init=new S(s.name,"visibility",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),s.init.setKeys([{frame:0,value:s.startValue},{frame:t,value:1-s.startValue}])}),console.log(this.handMesh),i?(this.isVisible=!1,this.scene.beginDirectAnimation(this.handMesh,[n[0].init],0,60,!1)):(this.isVisible=!0,this.scene.beginDirectAnimation(this.handMesh,[n[1].init],0,60,!1))}}function Re(h,e,i,t,n,s){let l=new Q("right",h,t,n,s),o=new Q("left",h,t,n,s),c=!1,m={right:l,left:o},u=!1;function d(g){let f=g.name.split("-")[2];console.log("Name: ",f);for(let p of t)if(console.log("Instance name: ",p.name),p.name==f)return p;return null}e.input.onControllerAddedObservable.add(g=>{g.onMotionControllerInitObservable.add(f=>{let p=f;p.handID=f.handedness;let a=m[p.handedness];a.getMotionController()||a.setMotionController(p),console.log(a);let v=new fe(b.Zero(),b.Zero(),.25);const A=f.getComponentOfType("squeeze");f.getComponentOfType("trigger"),[A].forEach(C=>{console.log(h.getMeshByName("left")),C.onButtonStateChangedObservable.add(O=>{let N,T={left:"Fist",right:"Grip"},x=h.animationGroups.find((V,$)=>V.name===`${a.motionController.handID}_${T[a.motionController.handID]}`);x.goToFrame(O.value*(x._to-1)+1);let w=a.intersectHandCylinder(h.getMeshByName(p.handID));if(console.log("Grabbed Cylinder: ",w),O.value>.5&&!a.motionController.grabbed){if(w){E.audioEngine.unlock(),c=!1,a.holdingMesh=w,a.holdingInstance=d(a.holdingMesh),a.motionController.meshGrabbed=a.holdingMesh,a.motionController.grabbed=!0;let V=a.motionController.lastPosition,$=v.origin;$!=V&&(a.disappearAnimation(!0),N=setInterval(()=>{let U=a.motionController.lastPosition;if(g.getWorldPointerRayToRef(v),U&&a.holdingMesh&&a.moveWithCollisions(a.holdingMesh,$.subtract(U)),!a.intersectHandCylinder(h.getMeshByName(a.motionController.handID))&&a.holdingMesh&&(a.targetMeshInstance&&a.targetMeshInstance.highlight(!1),a.dropped(N),a.motionController.grabbed=!1,a.handMesh.visibility=1,c=!0),a.holdingMesh){let k=a.intersectCylinder(a.holdingMesh);if(k){a.targetMesh=k,a.targetMeshInstance=d(k);let oe=k.name.split("-")[2],ae=a.holdingMesh.name.split("-")[2];u||(a.addColors(a.holdingInstance,a.targetMeshInstance),c=a.updateSOPTask(ae,oe,N),u=a.highlightAndRotateCylinders(a.holdingInstance,a.targetMeshInstance,u))}else a.targetMeshInstance&&a.targetMeshInstance.highlight(!1),a.holdingInstance.highlight(!1),u&&(a.holdingInstance.resetAroundZ(),ie(M(a.holdingMesh,P)),u=!1)}c||(a.motionController.lastPosition=Object.assign({},v.origin),p.lastPosition=Object.assign({},v.origin))},10))}}else(!O.value||!w)&&a.holdingMesh&&(a.holdingInstance.highlight(!1),a.motionController.grabbed=!1,a.targetMeshInstance&&a.targetMeshInstance.highlight(!1),a.dropped(N),a.disappearAnimation(!1))})})})})}var W;class _e{constructor(e){r(this,"flying",!1);r(this,"active",!1);r(this,"camera");r(this,"mesh");r(this,"offset",.3);r(this,"animations");r(this,"returnPosition");r(this,"returnRotation");r(this,"onPointerDownObserver");r(this,"xrCamera");r(this,"attach",(e,i,t,n,s)=>{const l=e.getScene();if(this.mesh=e,!i&&(i=l.activeCamera,!i))throw new Error("The scene has no active camera, and no camera was provided.");this.camera=i,t||(t=this.mesh.position),n||(n=this.mesh.rotation),s&&(this.offset=s),this.returnPosition=t,this.returnRotation=n,this.onPointerDownObserver=l.onPointerObservable.add(this.clipboardClick)});r(this,"detach",()=>{this.mesh.getScene().onPointerObservable.remove(this.onPointerDownObserver)});r(this,"clipboardClick",(e={type:j.POINTERDOWN,pickInfo:{pickedMesh:this.mesh}})=>{var i;if(e.type===j.POINTERDOWN){console.log("Clipboard click");const t=(i=e.pickInfo)==null?void 0:i.pickedMesh;if(t&&(t===this.mesh||t.isDescendantOf(this.mesh))&&!this.flying||this.active){const n=this.active?B/2:0,s=this.active?0:B/2;Z(this,W).call(this),this.flying=!0,this.mesh.billboardMode==H.BILLBOARDMODE_ALL?this.mesh.billboardMode=H.BILLBOARDMODE_NONE:this.mesh.billboardMode=H.BILLBOARDMODE_ALL,this.mesh.getScene().beginDirectAnimation(this.mesh,this.animations,n,s,!1,void 0,()=>{this.flying=!1,this.active=!this.active})}}});r(this,"calculateTargetPositionWithOffset",e=>{if(this.xrCamera!==void 0&&this.xrCamera.state===pe.IN_XR){const l=this.xrCamera.camera._position.subtract(this.returnPosition).scale(1-e/b.Distance(this.returnPosition,this.xrCamera.camera._position));return this.returnPosition.add(l)}const t=this.camera._position.subtract(this.returnPosition).scale(1-e/b.Distance(this.returnPosition,this.camera._position));return this.returnPosition.add(t)});r(this,"setClipboardUp",()=>new b(3.1468286,4.6617744,1.680752));K(this,W,()=>{const e=this.animations.find(({name:s})=>s==="translate"),i=this.animations.find(({name:s})=>s==="rotate"),t=[{frame:0,value:this.returnPosition},{frame:B/2,value:this.calculateTargetPositionWithOffset(this.offset)}],n=[{frame:0,value:this.returnRotation},{frame:B/2,value:this.setClipboardUp()}];e.setKeys(t),i.setKeys(n)});const i=new S("translate","position",B,S.ANIMATIONTYPE_VECTOR3),t=new S("rotate","rotation",B,S.ANIMATIONTYPE_VECTOR3);this.animations=[i,t],this.xrCamera=e}get name(){return"FlyToCamera"}init(){}}W=new WeakMap;class Fe{constructor(e,i){r(this,"soundList");r(this,"soundPointer");r(this,"scene");r(this,"loadedSounds");this.scene=i,this.soundPointer=0,this.soundList=e,this.loadedSounds={}}async loadSounds(){let e=[];return new Promise(i=>{let t=0;this.soundList.forEach(n=>{if(e.push({soundName:n.soundName,sound:new ye(n.soundName,n.fileName,this.scene,()=>{E.audioEngine.unlock()},{})}),t++,t===this.soundList.length){for(let s of e)this.loadedSounds[s.soundName]=s.sound;i(e),console.log("Sounds loaded!!",this.loadedSounds)}})})}}class ze{constructor(){r(this,"handAnimation");r(this,"sop");r(this,"models");r(this,"cylinders");r(this,"guiManager");r(this,"soundManager");r(this,"loadedSounds");this.cylinders=[];let e="TLLGraduatedCylinderNewLabel.glb";this.models=[{fileName:"LabWithTable.glb",callback:t=>this.createRoom(t),label:"floor"},{fileName:"Placard_Label.glb",callback:t=>q(t,1,"Placard-A")},{fileName:"Placard_Label.glb",callback:t=>q(t,2,"Placard-B")},{fileName:"Placard_Label.glb",callback:t=>q(t,3,"Placard-C")},{fileName:e,callback:t=>this.cylinders.push(new G(t[0],1,"A",new I(1,0,0))),label:"Cylinder-A"},{fileName:e,callback:t=>this.cylinders.push(new G(t[0],2,"B",new I(0,1,0))),label:"Cylinder-B"},{fileName:e,callback:t=>this.cylinders.push(new G(t[0],3,"C",new I(0,0,1))),label:"Cylinder-C"},{fileName:"clipBoardWithPaperCompressedTextureNew.glb",callback:t=>De(t[0])}].map(function(t){return Object.assign({},{fileName:"LabBench.glb",root:"./models/",callback:Ee,label:"NoLabel"},t)});let i=[{soundName:"explosion",fileName:`${R}/sound/mi_explosion_03_hpx.mp3`},{soundName:"ding",fileName:`${R}/sound/ding-idea-40142.mp3`},{soundName:"success",fileName:`${R}/sound/success.mp3`}];this.loadedSounds=[],this.createScene().then(t=>{this.soundManager=new Fe(i,t),this.soundManager.loadSounds().then(n=>{this.loadedSounds=n;for(let s of["A","B","C"])Object.assign({},t.getMeshByName(`pivot-Cylinder-${s}`).position);console.log("Loaded sounds: ",this.loadedSounds);for(let s of this.loadedSounds)console.log(s.sound);this.processScene(t,this.cylinders,this.guiManager,this.soundManager)})})}async processScene(e,i,t,n){let s=e.getCameraByName("camera"),l=e.getLightByName("light1"),o;s.speed=.16;let c=setInterval(()=>{l.intensity>=1?clearInterval(c):l.intensity+=.1},60);const m=["WallsandFloor","WallsAndFloor.001"],u=[];for(let f of m){console.log(f);const p=e.getMeshByName(f);p&&u.push(p)}let d={floorMeshes:u,inputOptions:{doNotLoadControllerMeshes:!0}};o=await e.createDefaultXRExperienceAsync(d);let g=!1;o.pointerSelection.displayLaserPointer=!1,o.pointerSelection.displaySelectionMesh=!1,window.addEventListener("keydown",f=>{f.keyCode===73&&(g?g=!1:g=!0,o.pointerSelection.displayLaserPointer=g,o.pointerSelection.displaySelectionMesh=g)}),ke(e,o,i).then(f=>{if(console.log("add webxr"),o){const a=new _e(o.baseExperience);e.getMeshByName("clipboard").addBehavior(a)}new se(e,i,t,n).postSceneCylinder(),Re(e,o,f,i,t,n)})}createRoom(e){const i=["WallsandFloor","WallsAndFloor.001","Table","Roof","Countertop","Walls"];let t,n;for(let s of i){const l=e.find(o=>o.name===s);if(l&&(l.checkCollisions=!0,l.name==="Table")){const o=l.getBoundingInfo().boundingBox;o.center.x,t=l.getScene(),n=t.getCameraByName("camera"),n.position=new b(o.center.x*-1,o.center.y*2+.5,-1.5),n.rotation=new b(Math.PI/8,0,0)}}}createScene(){return new Promise(e=>{const i=document.getElementById("canvas"),t=new E(i,!0,{stencil:!0}),n=new be(t);n.collisionsEnabled=!0,window.addEventListener("resize",function(){t.resize()});const s=new Ce("camera",new b(0,1.84,-1.134),n);s.ellipsoid=new b(.4,.7,.4),s.attachControl(i,!0),s.applyGravity=!0,s.minZ=0,s.speed=0,s.checkCollisions=!0,s.keysUp.push(87),s.keysDown.push(83),s.keysLeft.push(65),s.keysRight.push(68);var l=new Me("light1",new b(1,1,0),n);l.intensity=0,Promise.all(this.models.map(o=>new Promise(c=>xe.ImportMesh("",o.root,o.fileName,n,function(m){o.mesh=m,c(m)})))).then(()=>{let o=[];this.models.map(c=>{o.push(c.callback(c.mesh)),e(n)})}),window.addEventListener("keydown",o=>{o.shiftKey&&o.ctrlKey&&o.altKey&&o.keyCode===73&&(n.debugLayer.isVisible()?n.debugLayer.hide():n.debugLayer.show())}),t.runRenderLoop(()=>{n.render()})})}}new ze;
