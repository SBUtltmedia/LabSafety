var fe=Object.defineProperty;var pe=(c,e,i)=>e in c?fe(c,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[e]=i;var r=(c,e,i)=>(pe(c,typeof e!="symbol"?e+"":e,i),i),ye=(c,e,i)=>{if(!e.has(c))throw TypeError("Cannot "+i)};var ee=(c,e,i)=>(ye(c,e,"read from private field"),i?i.call(c):e.get(c)),te=(c,e,i)=>{if(e.has(c))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(c):e.set(c,i)};import{H as be,M as le,V as y,S as R,D as re,T as F,P as K,C as ie,a as v,b as Me,A as C,c as Ce,B as se,d as Se,W as $,E as N,R as xe,e as oe,f as Y,g as Pe,h as ve,i as Ae,j as Ie,k as Oe,l as Ne,m as we,n as Te,U as Ee,o as Be,p as Le}from"./vendor.450d7f07.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&t(s)}).observe(document,{childList:!0,subtree:!0});function i(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerpolicy&&(n.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?n.credentials="include":o.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function t(o){if(o.ep)return;o.ep=!0;const n=i(o);fetch(o.href,n)}})();window.exports=window;class ke{constructor(e,i,t,o=0){r(this,"complete",!1);r(this,"title");r(this,"description");r(this,"failed",!1);r(this,"onFail");r(this,"onSuccess");r(this,"onCompletion");r(this,"currentState");r(this,"tasks");r(this,"resetSOP",()=>{this.currentState=0,this.failed=!1,this.complete=!1});this.title=e,this.description=i,this.tasks=t,this.currentState=o}}const H="./",w=60,De=50,he=3,I="cylinder",T="liquid",Re="placard",S=new ke("","",[{next:"CtoA",label:"BtoC"},{next:"complete",label:"CtoA"}]);function P(c,e){return c.getChildMeshes().find(i=>i.name===e)||null}function D(c){c.rotation.x=0,c.rotation.y=0,c.rotation.z=0}class j{constructor(e,i,t,o){r(this,"name");r(this,"position");r(this,"mesh");r(this,"dragCollision");r(this,"highlightLayer");r(this,"scene");r(this,"particleSystem");r(this,"currentColor");r(this,"originalColor");r(this,"startOpacity");r(this,"toggleControllers");r(this,"startPos");r(this,"EllipsoidLines");r(this,"moveFlag");r(this,"pourLocations");r(this,"rotateEnd");r(this,"startRotation");console.log(e),this.name=t,this.moveFlag=!0,this.rotateEnd=!0,this.currentColor=Object.assign({},o),this.originalColor=Object.assign({},o),this.startOpacity=.7;const n=e.getScene();this.scene=n,this.highlightLayer=new be("highlight-layer",n),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1;const s=n.getMeshByName("Table");let a=le.CreateCylinder(`pivot-Cylinder-${t}`,{diameterTop:.1,height:.33,diameterBottom:.1},e.getScene());if(a.position._y+=.1,a.visibility=0,e.name=t,e.parent=a,e.rotationQuaternion=null,e.getChildMeshes().forEach(p=>{switch(p.name){case"BeakerwOpacity":p.name=I,p.rotationQuaternion=null,p.rotation.z=2*Math.PI,p.isPickable=!1;break;case"BeakerLiquid":p.name=T,p.isPickable=!1;break}}),s){const p=s.getBoundingInfo().boundingBox,z=P(e,I).getBoundingInfo().boundingBox.maximum.y;console.log(z),a.position.y=p.maximumWorld.y+z/2+.0075,a.position.x=(p.maximumWorld.x-p.minimumWorld.x)/he*i+p.minimumWorld.x-.3,a.position.z=(p.centerWorld.z+p.minimumWorld.z)/2,this.position={...a.position}}else a.position.x=-2+i,a.position.y=1.22,a.position.z=.5,console.log("Else!");a.checkCollisions=!0,a.ellipsoid=new y(.02,.05,.02),console.log(a.ellipsoid.length()),this.startPos=Object.assign({},a.position),this.mesh=a,this.startRotation=Object.assign({},this.mesh.rotation);const d=P(e,T),u=new R("liquid-material");u.diffuseColor=o,d.material=u;const f=P(e,"Label"),h=P(e,"LabelBack");console.log("Label:",h);const m=new re("dynamic texture",256,n,!0,F.LINEAR_LINEAR_MIPNEAREST);m.uAng=Math.PI;const g=new R("Mat",n);g.diffuseTexture=m,f.material=g,h.material=g;const x="bold 250px monospace";m.drawText(e.name.toUpperCase(),0,225,x,"black","white");let b=this.mesh.getChildMeshes().find(p=>p.name==="cylinder");this.mesh.animations=b.animations,console.log("Children: ",this.mesh.getChildMeshes());const l=new K("particles",500,this.scene);l.particleTexture=new F("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),l.minLifeTime=.5,l.maxLifeTime=.7,l.emitRate=100,l.gravity=new y(0,.5,0),l.minSize=.01,l.maxSize=.07,l.createPointEmitter(new y(0,0,0),new y(0,1,0)),l.addColorGradient(1,ie.FromColor3(d.material.diffuseColor,1)),l.blendMode=K.BLENDMODE_STANDARD,l.emitter=this.mesh.position,this.particleSystem=l,this.setOpacity(this.startOpacity),this.addDragCollision()}startParticles(){this.particleSystem.start()}highlight(e=!0){let i=P(this.mesh,I);e?(console.log("Adding mesh"),this.highlightLayer.hasMesh(i)||this.highlightLayer.addMesh(i,v.Green())):this.highlightLayer.hasMesh(i)&&this.highlightLayer.removeMesh(i)}addDragCollision(){let e=new Me({dragPlaneNormal:new y(0,0,1)});e.useObjectOrientationForDragging=!1,e.moveAttached=!1,e.onDragObservable.add(i=>{i.delta!=y.Zero()&&this.moveFlag&&this.mesh.isPickable&&this.mesh.moveWithCollisions(i.delta)}),e.onDragEndObservable.add(()=>{y.Distance(this.startPos,this.mesh.position)>.1?(this.scene.stopAllAnimations(),this.fadeAndRespawn()):(this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z)}),this.mesh.addBehavior(e),this.dragCollision=e}removeDragCollision(){this.mesh.removeBehavior(this.dragCollision)}fadeAndRespawn(e=De,i=null,t=!0){this.mesh.isPickable=!1,setTimeout(()=>{let o=this.mesh.getBehaviorByName("PointerDrag");o&&o.releaseDrag();let n=30;this.mesh.name.split("-")[0];let s=this.mesh.getScene(),a=this.mesh.getChildMeshes(),d=a.find(h=>h.name==="cylinder");a.find(h=>h.name==="liquid");const u=P(this.mesh,T);console.log("Visibility: ",u.visibility);let f=[{name:"Invisibility",startValue:u.visibility},{name:"Visibility",startValue:0}];f.forEach(h=>{h.init=new C(h.name,"visibility",120,C.ANIMATIONTYPE_FLOAT,C.ANIMATIONLOOPMODE_CONSTANT),h.init.setKeys([{frame:0,value:h.startValue},{frame:n,value:h.startValue===0?this.startOpacity:0}])});for(let h=0;h<a.length-1;++h){let m=a[h];s.beginDirectAnimation(m,[f[0].init],0,60,!1)}s.beginDirectAnimation(a[a.length-1],[f[0].init],0,60,!1,void 0,()=>{console.log(this.mesh,this.position);let h=P(this.mesh,I);D(this.mesh),D(h),this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z,this.mesh.animations=d.animations;for(let m=0;m<a.length-1;++m){let g=a[m];s.beginDirectAnimation(g,[f[1].init],0,60,!1)}s.beginDirectAnimation(a[a.length-1],[f[1].init],0,60,!1,void 0,()=>{if(this.highlight(!1),this.mesh.isPickable=t,console.log("Resetting rotation!"),P(this.mesh,"cylinder").visibility=this.startOpacity,i)for(let m of i)m&&(m.handMesh.visibility=1)})})},e)}rotateAnimation(e,i=null,t=!1){Object.assign({},this.mesh.position),this.mesh.checkCollisions=!1,console.log(i?"HANDDD":"NO HAND!!!!");let o=this.mesh.getAnimationByName(`${this.name}-${e}`);t||(this.moveFlag=!1,this.rotateEnd=!1,i&&(i.holdingMesh=null)),this.toggleControllers&&this.toggleControllers(),this.scene.beginDirectAnimation(this.mesh,[o],0,600,!1,.5,()=>{this.toggleControllers&&this.toggleControllers(),t||(this.moveFlag=!0,this.rotateEnd=!0,i&&(i.holdingMesh=this.mesh,console.log(i.holdingMesh))),this.mesh.checkCollisions=!0})}setColor(e){const i=P(this.mesh,T),t=new R("liquid-material");t.diffuseColor=e,i.material=t,this.currentColor=e,console.log(this.currentColor)}setOpacity(e){const i=P(this.mesh,T);i.visibility=e}resetProperties(){this.setOpacity(this.startOpacity),this.setColor(this.originalColor),D(this.mesh),D(P(this.mesh,I))}showEffects(e=!1){if(e){this.particleSystem.particleTexture=new F("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),this.particleSystem.minLifeTime=.5,this.particleSystem.maxLifeTime=.7,this.particleSystem.emitRate=100,this.particleSystem.gravity=new y(0,.5,0),this.particleSystem.minSize=.01,this.particleSystem.maxSize=.07,this.particleSystem.createPointEmitter(new y(0,0,0),new y(0,1,0));const i=P(this.mesh,T);this.particleSystem.addColorGradient(1,ie.FromColor3(i.material.diffuseColor,1)),this.particleSystem.blendMode=K.BLENDMODE_STANDARD,this.particleSystem.emitter=this.mesh.position,this.particleSystem.start()}else this.particleSystem.stop()}}const Fe="Stony Brook University VR Laboratory",_e="Victor Ruben",ze="VR Chemical Mixture Synthesis",We="4/1/2022",Ve="General: Properly mixing VR chemicals",He="42",$e="I",Ge=[{text:"HAZARD IDENTIFICATION test from JSON",sublistType:"a",sublist:[{text:"Improper mixing of chemicals can lead to explosive results!"}]},{text:"CHEMICAL HANDLING PROCEDURES",sublistType:"a",sublist:[{text:"When mixing these chemicals - always follow the correct sequence"},{text:"Pour chemical B into chemical C"},{text:"Then pour chemical mixture B+C into chemical A"}]},{text:"EMERGENCY PROCEDURES",sublistType:"a",sublist:[{text:"In the event of an improper mixture - use the fire extinguisher to put out the flames"},{text:"Evacuate the lab"},{text:"Call for emergency services"}]}],ne={facility:Fe,labDirector:_e,scope:ze,lastRevision:We,general:Ve,sopNum:He,listType:$e,items:Ge};function Ue(c){c.name="clipboard";const e=c.getScene(),i=e.getMeshByName("Table");if(i){const s=i.getBoundingInfo().boundingBox;c.position.y=s.maximumWorld.y+.003}c.rotationQuaternion=null,c.rotation=new y(0,Math.PI/4,0);const t=e.getMeshByName("pivot-Cylinder-A");t&&(c.position.x=t.position.x+.2,c.position.z=t.position.z+.5);function o(s){console.log("data: ",ne);let a=document.createElement("template");a.innerHTML=s;var d=Ce.compile(a.innerHTML),u=d(ne);return a.innerHTML=u,a.content}function n(s){const d="data:image/svg+xml;utf8,"+encodeURIComponent(s),u=F.LoadFromDataString("tex",d,e,void 0,void 0,void 0,F.LINEAR_LINEAR_MIPNEAREST);let f=new R("mat",e);f.diffuseTexture=u,u.uScale=1,u.vScale=-1,f.emissiveColor=v.White(),f.useAlphaFromDiffuseTexture=!0,u.hasAlpha=!0;let h=P(c,"Plane");h.material=f,console.log("Material set")}fetch(`${H}images/sopTemplate.svg`).then(s=>s.text()).then(s=>{console.log("fetched!");let a=o(s),d=a.getElementById("procedure-list");console.log(d);const f=new XMLSerializer().serializeToString(a);n(f)}).catch(console.error.bind(console))}function Ze(c){var e=new se(v.FromHexString("#0984e3"));e.ignoreChildren=!0;var i=c[0],t=se.MakeNotPickableAndWrapInBoundingBox(i);e.attachedMesh=t,e.onScaleBoxDragObservable.add(()=>{console.log("scaleDrag")}),e.onScaleBoxDragEndObservable.add(()=>{const o=e.attachedMesh;if(o){const n=o.getHierarchyBoundingVectors(!0);console.log("size x:",n.max.x-n.min.x),console.log("size y:",n.max.y-n.min.y),console.log("size z:",n.max.z-n.min.z)}console.log("scaleEnd")}),e.onRotationSphereDragObservable.add(()=>{console.log("rotDrag")}),e.onRotationSphereDragEndObservable.add(()=>{console.log("rotEnd")})}function X(c,e,i){const t=c.find(h=>h.name==="__root__"),o=t.getScene();t.name=i;const n=c.find(h=>h.name==="Label"),s=c.find(h=>h.name==="Placard");s.name=Re;const a=new re("dynamic texture",256,o);a.wAng=-Math.PI/2,a.uAng=Math.PI;const d=new R("Mat",o);d.diffuseTexture=a,n.material=d;const u="bold 220px monospace";a.drawText(t.name.split("-")[1].toUpperCase(),65,185,u,"black","white"),s.addChild(n),s.rotationQuaternion=null,s.rotation=new y(0,Math.PI/2,0);const f=o.getMeshByName("Table");if(f){const h=f.getBoundingInfo().boundingBox;t.position.y=h.maximumWorld.y+.003,t.position.x=(h.maximumWorld.x-h.minimumWorld.x)/he*e+h.minimumWorld.x-.2,t.position.z=(h.centerWorld.z+h.minimumWorld.z)/2+.2}}function qe(c,e,i){let t,o;return new Promise(n=>{const s="./models/";let a="";var d={};let u=["left","right"];const f=new Se(c);u.forEach(m=>{f.addMeshTask(`load ${m} hand`,"",s,`${m}${a}.glb`)});let h=0;f.onTaskSuccess=m=>{d[u[h]]=m.loadedMeshes[1],m.loadedMeshes[1].name=u[h],t=m.loadedAnimationGroups;for(let g=0;g<t.length;g++)t[g].name=`${u[h]}_${t[g].name}`;h++},f.onTasksDoneObservable.add(()=>{for(let m=0;m<c.animationGroups.length;m++)c.animationGroups[m].pause();o=m=>{console.log(m);let g=m.inputSource.handedness;console.log(d[g]);let x=d[g].parent.parent;d[g].isPickable=!1;for(let b of i)b.removeDragCollision();let M=(Object.keys(d).indexOf(g)-1)*2-1;d[g].rotation.y=Math.PI*M,d[g].rotation.z=-Math.PI/2,d[g].rotation.x=-Math.PI/4,x.parent=m.grip||m.pointer},e.baseExperience.onStateChangedObservable.add(m=>{if(m===$.IN_XR){e.baseExperience.camera.position.y=1.5,e.baseExperience.camera.position.z=-.5;let g=c.getMeshByName("Start");if(g){let x=e.baseExperience.camera;g.parent=x,g.position=x.position.add(new y(-x.position.x,-1.5,1.15)),e.pointerSelection.displayLaserPointer=!0,e.pointerSelection.displaySelectionMesh=!0,g.rotation=y.Zero()}}}),e.baseExperience.camera.onAfterCameraTeleport.add(()=>{e.baseExperience.camera.position.y=.5})}),f.loadAsync().then(()=>{n(o)})})}class ce{constructor(e,i,t,o,n){r(this,"cylinderInstances");r(this,"clipboard");r(this,"isRotating");r(this,"scene");r(this,"labels");r(this,"guiManager");r(this,"soundManager");r(this,"xrCamera");console.log("Cylinders interact: ",i),this.labels=["A","B","C"],this.scene=e,this.cylinderInstances=i,this.guiManager=t,this.soundManager=o,this.xrCamera=n,this.isRotating=!1}getCylinderInstanceFromMesh(e){let i=e.name.split("-")[2];for(let t of this.cylinderInstances)if(t.name==i)return t;return null}intersectHandCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(e.intersectsMesh(t,!1)&&t.isPickable)return t}return null}intersectCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(t!=e&&e.intersectsMesh(t))return t}return null}highlightCylinders(e,i){e.highlight(),i.highlight()}RotateCylinders(e,i,t=null){let o=e.mesh.position,n=i.mesh.position,s="rotateAroundZleft";i.mesh.rotation.y=e.mesh.rotation.y;let a=e.mesh.getHierarchyBoundingVectors(),d=a.max.y-a.min.y,u=.2,f=n.x;o.x-f;let h=P(e.mesh,I),m=P(i.mesh,I);n.x<o.x?(console.log("Left hit"),h.rotation.y=Math.PI):(h.rotation.y=0,s="rotateAroundZright",console.log("Right hit"),u=-u),m.rotation.y=h.rotation.y,e.mesh.position.x=i.mesh.position.x+u,e.mesh.position.y=i.mesh.position.y+d/1.5,console.log(h.position),e.rotateAnimation(s,t)}moveWithCollisions(e,i){e.moveWithCollisions(i)}addColors(e,i){let t=e.currentColor,o=i.currentColor,n=new v((t.r+o.r)/2,(t.g+o.g)/2,(t.b+o.b)/2);i.setColor(n)}showFinishScreen(){console.log("XR this: ",this.xrCamera);for(let i of this.cylinderInstances)i.mesh.isPickable=!1,i.moveFlag=!1;function e(i){for(let t of i)t.mesh.isPickable=!0,t.moveFlag=!0,t.resetProperties(),t.showEffects(!1),setTimeout(()=>{t.setColor(t.originalColor)},1e3)}this.guiManager.createPromptWithButton("You have completed the task! The scene will now reset!",this.xrCamera,e,this.cylinderInstances)}showFailureScreen(){for(let i of this.cylinderInstances)i.mesh.isPickable=!1;function e(i){for(let t of i)t.mesh.isPickable=!0,t.moveFlag=!0,t.resetProperties(),t.showEffects(!1),setTimeout(()=>{t.setColor(t.originalColor)},1e3)}console.log("Show failure screen"),this.guiManager.createPromptWithButton("Task failed! The scene will now reset.",this.xrCamera,e,this.cylinderInstances)}playExplosion(){console.log(this.soundManager.loadedSounds.explosion);let e=this.soundManager.loadedSounds.explosion;e.stop(),e.play()}playDing(){let e=this.soundManager.loadedSounds.ding;e.stop(),e.play()}playSuccess(){let e=this.soundManager.loadedSounds.success;console.log("Success: ",e),e.stop(),e.play()}}class de extends ce{constructor(i,t,o,n,s){super(i,t,o,n,s);r(this,"particleSystem");r(this,"instances");this.instances=t}resetCylinders(){this.particleSystem&&this.particleSystem.stop();let i=["A","B","C"];for(let t=0;t<i.length;t++){const o=this.scene.getMeshByName(`pivot-Cylinder-${i[t]}`),n=this.scene.getMeshByName("Table");if(n&&o){const s=n.getBoundingInfo().boundingBox;o.position.z=(s.centerWorld.z+s.minimumWorld.z)/2}super.getCylinderInstanceFromMesh(o).showEffects(!1),super.getCylinderInstanceFromMesh(o).resetProperties(),super.getCylinderInstanceFromMesh(o).setColor(super.getCylinderInstanceFromMesh(o).originalColor),t==0&&(super.getCylinderInstanceFromMesh(o).setColor(v.Red()),super.getCylinderInstanceFromMesh(o).currentColor=v.Red())}}postSceneCylinder(){let i=["A","B","C"],t=[];for(let n of i){const s=this.scene.getMeshByName(`pivot-Cylinder-${n}`);t.push(s);let a=new C(`${n}-rotateAroundZleft`,"rotation.z",120,C.ANIMATIONTYPE_FLOAT,C.ANIMATIONLOOPMODE_CONSTANT),d=P(s,I),u=[];u.push({frame:0,value:0}),u.push({frame:60,value:Math.PI/2}),d.animations.push(a),a.setKeys(u);let f=new C(`${n}-rotateAroundZright`,"rotation.z",120,C.ANIMATIONTYPE_FLOAT,C.ANIMATIONLOOPMODE_CONSTANT);u=[],u.push({frame:0,value:0}),u.push({frame:60,value:-Math.PI/2}),d.animations.push(f),f.setKeys(u);let h=new C(`${n}-resetRotateAroundZleft`,"rotation.z",120,C.ANIMATIONTYPE_FLOAT,C.ANIMATIONLOOPMODE_CONSTANT),m=[];m.push({frame:0,value:Math.PI/2}),m.push({frame:60,value:0}),d.animations.push(h),h.setKeys(m);let g=new C(`${n}-resetRotateAroundZright`,"rotation.z",120,C.ANIMATIONTYPE_FLOAT,C.ANIMATIONLOOPMODE_CONSTANT);m=[],m.push({frame:0,value:-Math.PI/2}),m.push({frame:60,value:0}),d.animations.push(g),g.setKeys(m)}let o;for(let n=0;n<i.length;n++){const s=this.scene.getMeshByName(`pivot-Cylinder-${i[n]}`);let a=super.getCylinderInstanceFromMesh(s);const d=s.getBehaviorByName("PointerDrag");console.log(d);let u=[];for(let b of t)b!=s&&u.push(b);let f=!1,h=!1,m=P(s,I),g=!1,x="resetRotateAroundZleft",M;s.isPickable&&d.onDragObservable.add(()=>{N.audioEngine.unlock(),N.audioEngine.audioContext.resume();let b=!1,l=!1;D(s);let p;const O=super.intersectCylinder(s);O&&(p=super.getCylinderInstanceFromMesh(O),o=p,super.highlightCylinders(a,p),l=!0,O.name.split("-")[2],s.name.split("-")[2],g||(g=!0,M=setTimeout(()=>{super.RotateCylinders(a,p);let _=O.name.split("-")[2],E=`${s.name.split("-")[2]}to${_}`;if(S.tasks[S.currentState].label===E)h=!0,S.tasks[S.currentState].next==="complete"?(b=!0,console.log(p),setTimeout(()=>{super.playSuccess()},500),setTimeout(()=>{a.fadeAndRespawn()},1500),S.resetSOP(),this.resetCylinders(),super.showFinishScreen()):(S.currentState=S.tasks.indexOf(S.tasks.find(A=>A.label==S.tasks[S.currentState].next)),super.playDing());else if(console.log(f,h),!f&&!h){console.log("Failure!!!");for(let A of this.instances)A.mesh.isPickable=!1,A.moveFlag=!1;p.showEffects(!0),super.playExplosion(),setTimeout(()=>p.showEffects(!1),1e3),f=!0,setTimeout(()=>{d.releaseDrag(),super.showFailureScreen(),S.resetSOP(),f=!1},1500)}b||super.addColors(a,p),O.position.x>s.position.x&&(x="resetRotateAroundZright")},700))),l===!1&&a.rotateEnd&&(a.highlight(!1),o&&(console.log(o),o.highlight(!1),o=void 0),M?(clearTimeout(M),M=null,h=!1,g=!1):(h=!1,g&&(console.log("reset second click"),g=!1,a.rotateAnimation(x,null,!0))))}),d.onDragEndObservable.add(()=>{g=!1;for(let b of u)b!==m&&(a.highlight(!1),super.getCylinderInstanceFromMesh(b).highlight(!1),m.intersectsMesh(b)&&(a.rotateAnimation(x),m.position.x=0,m.position.y=0))})}}}class ae extends ce{constructor(i,t,o,n,s,a){console.log("Cylinders hand: ",o);super(t,o,n,s,a);r(this,"handedness");r(this,"holdingInstance");r(this,"holdingMesh");r(this,"targetMesh");r(this,"targetMeshInstance");r(this,"motionController");r(this,"handMesh");r(this,"isVisible");r(this,"failBeaker");r(this,"particleSystem");r(this,"cylinderInstancesHand");this.handedness=i,this.handMesh=t.getMeshByName(this.handedness),this.isVisible=!0,this.failBeaker=!1}getMotionController(){return this.motionController}setMotionController(i){this.motionController=i}dropped(i=null,t=!0){console.log(this.holdingInstance.mesh.position,this.holdingInstance.startPos),y.Distance(this.holdingInstance.mesh.position,this.holdingInstance.startPos)==0&&(t=!1),this.motionController.lastPosition=null,i&&clearInterval(i),this.motionController.grabbed=!1,this.motionController.meshGrabbed=void 0,console.log(this.holdingMesh),this.holdingMesh&&(t&&this.holdingInstance.fadeAndRespawn(100,null,this.holdingMesh.isPickable),this.holdingMesh=null,this.holdingInstance=null,this.motionController.meshGrabbed=null)}updateSOPTask(i,t,o){console.log(this.scene);let n=`${i}to${t}`;if(S.tasks[S.currentState].label===n)if(S.tasks[S.currentState].next==="complete"){new de(this.scene,this.cylinderInstances,this.guiManager,this.soundManager,this.xrCamera);for(let s of this.cylinderInstances)s.moveFlag=!1,s.mesh.isPickable=!1;setTimeout(()=>{console.log("GUI mgr",this.guiManager,"Sound mgr: ",this.soundManager);for(let s of this.cylinderInstances)s.fadeAndRespawn(100,null,!1);if(super.playSuccess(),console.log("Showing finish screen!"),this.disappearAnimation(!1),this.xrCamera.baseExperience.state==$.IN_XR){super.showFinishScreen();let s=this.scene.getMeshByName("Start");if(s){let a=this.xrCamera.baseExperience.camera;s.parent=a,s.position=a.position.add(new y(-a.position.x,-1.5,1.15)),this.xrCamera.pointerSelection.displayLaserPointer=!0,this.xrCamera.pointerSelection.displaySelectionMesh=!0,s.rotation=y.Zero()}}},1e3),S.resetSOP(),this.particleSystem&&(this.particleSystem.stop(),console.log("Stopping particle system!"));for(let s of this.cylinderInstances)s.showEffects(!1);return!0}else{super.playDing(),S.currentState=S.tasks.indexOf(S.tasks.find(s=>s.label==S.tasks[S.currentState].next));return}else this.failBeaker||(console.log("Fail VR"),setTimeout(()=>{if(this.xrCamera.baseExperience.state==$.IN_XR){super.showFailureScreen();let s=this.scene.getMeshByName("Start");if(s){let a=this.xrCamera.baseExperience.camera;s.parent=a,s.position=a.position.add(new y(-a.position.x,-1.5,1.15)),this.xrCamera.pointerSelection.displayLaserPointer=!0,this.xrCamera.pointerSelection.displaySelectionMesh=!0,s.rotation=y.Zero()}}super.playExplosion(),this.targetMeshInstance.showEffects(!0)},1e3),S.resetSOP())}disappearAnimation(i=!0){console.log("DISAPPEAR: ",i);let t=60,o=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}];o.forEach(n=>{n.init=new C(n.name,"visibility",120,C.ANIMATIONTYPE_FLOAT,C.ANIMATIONLOOPMODE_CONSTANT),n.init.setKeys([{frame:0,value:n.startValue},{frame:t,value:1-n.startValue}])}),console.log(this.handMesh),i?(this.isVisible=!1,this.scene.beginDirectAnimation(this.handMesh,[o[0].init],0,60,!1)):(this.isVisible=!0,this.scene.beginDirectAnimation(this.handMesh,[o[1].init],0,60,!1))}}function Ke(c,e,i,t,o,n){let s=new ae("right",c,t,o,n,e),a=new ae("left",c,t,o,n,e),d=!1,u=null,f={right:s,left:a},h=!1;function m(x){let M=x.name.split("-")[2];for(let b of t)if(b.name==M)return b;return null}let g=x=>{i(x),x.onMotionControllerInitObservable.add(M=>{let b=M;b.handID=M.handedness;let l=f[b.handedness];l.getMotionController()||l.setMotionController(b);let p=new xe(y.Zero(),y.Zero(),.25);const O=M.getComponentOfType("squeeze"),_=M.getComponentOfType("trigger");M.getComponentOfType("thumbstick").onAxisValueChangedObservable.add(()=>{e.baseExperience.camera.position.y=1.5}),e.baseExperience.camera.onAfterCameraTeleport.add(()=>{console.log("End teleport"),e.baseExperience.camera.position.y=1.5}),console.log("Motion controller: ",M),[_].forEach(E=>{E.onButtonStateChangedObservable.add(A=>{A.value>.3&&b.handID==="right"?(e.pointerSelection.displayLaserPointer=!0,e.pointerSelection.displaySelectionMesh=!0):(e.pointerSelection.displayLaserPointer=!1,e.pointerSelection.displaySelectionMesh=!1)})}),console.log(),[O].forEach(E=>{let A="resetRotateAroundZleft";console.log(c.getMeshByName("left")),E.onButtonStateChangedObservable.add(W=>{u=W,console.log(u);let V,me={left:"Fist",right:"Grip"},Q=c.animationGroups.find((Z,q)=>Z.name===`${l.motionController.handID}_${me[l.motionController.handID]}`);Q.goToFrame(W.value*(Q._to-1)+1);let B=l.intersectHandCylinder(c.getMeshByName(b.handID));console.log("Grabbed Cylinder: ",B);let U,L;if(W.value>.5&&!l.motionController.grabbed){if(B&&B.isPickable){N.audioEngine.unlock(),d=!1,l.holdingMesh=B,l.holdingInstance=m(l.holdingMesh),l.motionController.meshGrabbed=l.holdingMesh,l.motionController.grabbed=!0;let Z=l.motionController.lastPosition,q=p.origin;q!=Z&&(l.disappearAnimation(!0),V=setInterval(()=>{let J=l.motionController.lastPosition;if(x.getWorldPointerRayToRef(p),J&&l.holdingMesh&&l.moveWithCollisions(l.holdingMesh,q.subtract(J)),!l.intersectHandCylinder(c.getMeshByName(l.motionController.handID))&&l.holdingMesh&&l.holdingInstance.rotateEnd&&(l.targetMeshInstance&&l.targetMeshInstance.highlight(!1),l.dropped(V),l.motionController.grabbed=!1,l.handMesh.visibility=1,d=!0,h=!1),l.holdingMesh){let k=l.intersectCylinder(l.holdingMesh);if(console.log(k),k){l.targetMesh=k,l.targetMeshInstance=m(k),l.highlightCylinders(l.holdingInstance,l.targetMeshInstance),l.targetMesh.position.x>l.holdingMesh.position.x&&(A="resetRotateAroundZright");let ue=k.name.split("-")[2],ge=l.holdingMesh.name.split("-")[2];h||(h=!0,L=setTimeout(()=>{l.addColors(l.holdingInstance,l.targetMeshInstance),d=l.updateSOPTask(ge,ue,V),l.holdingMesh&&(U=Object.assign({},l.holdingMesh.position)),l.RotateCylinders(l.holdingInstance,l.targetMeshInstance,l)},1e3),console.log(L))}else console.log(L),L&&(console.log("Clearing timeout"),clearTimeout(L),l.targetMeshInstance&&l.targetMeshInstance.highlight(!1),l.holdingInstance.highlight(!1),h=!1,l.holdingMesh.rotation.z!=0&&U&&Math.abs(U._x-l.holdingMesh.position.x)>.2&&(console.log("Here!"),l.targetMeshInstance&&l.targetMeshInstance.highlight(!1),l.holdingInstance.highlight(!1),l.holdingInstance.rotateAnimation(A,l,!0),h=!1))}!d&&l.holdingInstance&&l.holdingInstance.rotateEnd&&(u=null,l.motionController.lastPosition=Object.assign({},p.origin),b.lastPosition=Object.assign({},p.origin))},10))}}else(!W.value||!B)&&l.holdingMesh&&l.holdingInstance.rotateEnd&&(u=null,l.holdingInstance.highlight(!1),l.motionController.grabbed=!1,l.targetMeshInstance&&l.targetMeshInstance.highlight(!1),l.dropped(V),l.disappearAnimation(!1),h=!1)})})})};return function(){let M=e.input.onControllerAddedObservable;M.hasObservers()?(M.clear(),console.log("removed")):(M.add(g),console.log("added"))}}var G;class Ye{constructor(e){r(this,"flying",!1);r(this,"active",!1);r(this,"camera");r(this,"mesh");r(this,"offset",.3);r(this,"animations");r(this,"returnPosition");r(this,"returnRotation");r(this,"onPointerDownObserver");r(this,"xrCamera");r(this,"attach",(e,i,t,o,n)=>{const s=e.getScene();if(this.mesh=e,!i&&(i=s.activeCamera,!i))throw new Error("The scene has no active camera, and no camera was provided.");this.camera=i,t||(t=this.mesh.position),o||(o=this.mesh.rotation),n&&(this.offset=n),this.returnPosition=t,this.returnRotation=o,this.onPointerDownObserver=s.onPointerObservable.add(this.clipboardClick)});r(this,"detach",()=>{this.mesh.getScene().onPointerObservable.remove(this.onPointerDownObserver)});r(this,"clipboardClick",(e={type:oe.POINTERDOWN,pickInfo:{pickedMesh:this.mesh}})=>{var i;if(e.type===oe.POINTERDOWN){console.log("Clipboard click");const t=(i=e.pickInfo)==null?void 0:i.pickedMesh;if(t&&(t===this.mesh||t.isDescendantOf(this.mesh))&&!this.flying||this.active){const o=this.active?w/2:0,n=this.active?0:w/2;ee(this,G).call(this),this.flying=!0,this.mesh.billboardMode==Y.BILLBOARDMODE_ALL?this.mesh.billboardMode=Y.BILLBOARDMODE_NONE:this.mesh.billboardMode=Y.BILLBOARDMODE_ALL,this.mesh.getScene().beginDirectAnimation(this.mesh,this.animations,o,n,!1,void 0,()=>{this.flying=!1,this.active=!this.active})}}});r(this,"calculateTargetPositionWithOffset",e=>{if(this.xrCamera!==void 0&&this.xrCamera.state===$.IN_XR){const s=this.xrCamera.camera._position.subtract(this.returnPosition).scale(1-e/y.Distance(this.returnPosition,this.xrCamera.camera._position));return this.returnPosition.add(s)}const t=this.camera._position.subtract(this.returnPosition).scale(1-e/y.Distance(this.returnPosition,this.camera._position));return this.returnPosition.add(t)});r(this,"setClipboardUp",()=>new y(3.1468286,4.6617744,1.680752));te(this,G,()=>{const e=this.animations.find(({name:n})=>n==="translate"),i=this.animations.find(({name:n})=>n==="rotate"),t=[{frame:0,value:this.returnPosition},{frame:w/2,value:this.calculateTargetPositionWithOffset(this.offset)}],o=[{frame:0,value:this.returnRotation},{frame:w/2,value:this.setClipboardUp()}];e.setKeys(t),i.setKeys(o)});const i=new C("translate","position",w,C.ANIMATIONTYPE_VECTOR3),t=new C("rotate","rotation",w,C.ANIMATIONTYPE_VECTOR3);this.animations=[i,t],this.xrCamera=e}get name(){return"FlyToCamera"}init(){}}G=new WeakMap;class je{constructor(e,i,t){r(this,"rect");r(this,"text");r(this,"button");this.rect=e,this.text=i,this.button=t}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e}}class Xe{constructor(e){r(this,"advancedTexture");r(this,"welcomePrompt");r(this,"gameFinishPrompt");r(this,"camera");r(this,"screen");r(this,"scene");this.scene=e,this.camera=e.activeCamera,console.log("Scene: ",this.scene)}createPromptWithButton(e,i=null,t=null,...o){this.screen=le.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=this.camera.position.add(new y(.7,-2,2.5)),this.advancedTexture=Pe.CreateForMesh(this.screen);let n=new ve("container");var s=new Ae;s.width=.5,s.height=.2,s.color="cyan",s.thickness=4,s.background="white",n.addControl(s);var a=new Ie;a.text=e,a.color="black",a.fontSize="17px",a.resizeToFit=!0,a.textWrapping=!0,a.paddingBottomInPixels=40,a.paddingLeftInPixels=15,a.paddingRightInPixels=15,s.addControl(a);var d=Oe.CreateSimpleButton("but1","Click to dismiss");d.width="150px",d.height="40px",d.color="black",d.cornerRadius=20,d.background="white",d.topInPixels=40;let u=new je(s,a,d),f=this.scene.getMeshByName("Start");return u.button.onPointerUpObservable.add(function(){n.dispose(),f.dispose(),console.log("XR cam: ",i),i&&(console.log("Hiding Pointer!"),i.pointerSelection.displayLaserPointer=!1,i.pointerSelection.displaySelectionMesh=!1),t&&t(...o)}),u.button.onPointerEnterObservable.add(()=>{d.background="grey"}),u.button.onPointerOutObservable.add(()=>{d.background="white"}),n.addControl(u.button),n.addControl(d),this.advancedTexture.addControl(n),u}}class Qe{constructor(e,i){r(this,"soundList");r(this,"soundPointer");r(this,"scene");r(this,"loadedSounds");this.scene=i,this.soundPointer=0,this.soundList=e,this.loadedSounds={}}enableAudio(){N.audioEngine.useCustomUnlockedButton=!0;var e=void 0;N.audioEngine.onAudioLockedObservable.add(()=>{e||(e=document.createElement("button"),e.innerText="CLICK ON ME !!!",e.style.position="absolute",e.style.top="100px",e.style.right="200px",e.style.zIndex="99999",document.body.append(e),e.onclick=()=>{N.audioEngine.unlock(),e.remove()})})}async loadSounds(){let e=[];return new Promise(i=>{let t=0;this.soundList.forEach(o=>{if(e.push({soundName:o.soundName,sound:new Ne(o.soundName,o.fileName,this.scene,()=>{N.audioEngine.unlock()},{})}),t++,t===this.soundList.length){for(let n of e)this.loadedSounds[n.soundName]=n.sound;i(e),console.log("Sounds loaded!!",this.loadedSounds)}})})}}console.log=()=>{};class Je{constructor(){r(this,"handAnimation");r(this,"sop");r(this,"models");r(this,"cylinders");r(this,"guiManager");r(this,"soundManager");r(this,"loadedSounds");this.cylinders=[];let e="CylinderNewSmoothLabel.glb";this.models=[{fileName:"room.glb",callback:t=>this.createRoom(t),label:"floor"},{fileName:"Placard_Label.glb",callback:t=>X(t,1,"Placard-A")},{fileName:"Placard_Label.glb",callback:t=>X(t,2,"Placard-B")},{fileName:"Placard_Label.glb",callback:t=>X(t,3,"Placard-C")},{fileName:e,callback:t=>this.cylinders.push(new j(t[0],1,"A",new v(1,0,0))),label:"Cylinder-A"},{fileName:e,callback:t=>this.cylinders.push(new j(t[0],2,"B",new v(0,1,0))),label:"Cylinder-B"},{fileName:e,callback:t=>this.cylinders.push(new j(t[0],3,"C",new v(0,0,1))),label:"Cylinder-C"},{fileName:"clipBoardWithPaperCompressedTextureNew.glb",callback:t=>Ue(t[0])}].map(function(t){return Object.assign({},{fileName:"LabBench.glb",root:"./models/",callback:Ze,label:"NoLabel"},t)});let i=[{soundName:"explosion",fileName:`${H}/sound/mi_explosion_03_hpx.mp3`},{soundName:"ding",fileName:`${H}/sound/ding-idea-40142.mp3`},{soundName:"success",fileName:`${H}/sound/success.mp3`}];this.loadedSounds=[],this.createScene().then(t=>{this.soundManager=new Qe(i,t),console.log(t.getActiveMeshes()),this.soundManager.loadSounds().then(o=>{this.loadedSounds=o;for(let n of["A","B","C"])Object.assign({},t.getMeshByName(`pivot-Cylinder-${n}`).position);console.log("Loaded sounds: ",this.loadedSounds);for(let n of this.loadedSounds)console.log(n.sound);this.processScene(t,this.cylinders,this.soundManager)})})}async processScene(e,i,t){let o=e.getCameraByName("camera"),n=e.getLightByName("light1"),s;o.speed=.16;let a=setInterval(()=>{n.intensity>=1?clearInterval(a):n.intensity+=.1},60);const d=["WallsandFloor","Floor"];for(let g of d)console.log(g),e.getMeshByName(g);let u={floorMeshes:[e.getMeshByName("Floor")],inputOptions:{doNotLoadControllerMeshes:!0}};s=await e.createDefaultXRExperienceAsync(u);const h=s.baseExperience.featuresManager.enableFeature(we.TELEPORTATION,"stable",{xrInput:s.input,floorMeshes:[e.getMeshByName("Floor")],timeToTeleport:5e3});s.teleportation=h,s.teleportation.parabolicRayEnabled=!0,s.teleportation.parabolicCheckRadius=10;let m=!1;s.pointerSelection.laserPointerDefaultColor=v.Green(),s.pointerSelection.laserPointerPickedColor=v.Green(),s.pointerSelection.selectionMeshPickedColor=v.Green(),s.pointerSelection.selectionMeshDefaultColor=v.Green(),s.pointerSelection.displayLaserPointer=!1,s.pointerSelection.displaySelectionMesh=!1,window.addEventListener("keydown",g=>{g.keyCode===73&&(m?m=!1:m=!0,s.pointerSelection.displayLaserPointer=m,s.pointerSelection.displaySelectionMesh=m)}),qe(e,s,i).then(g=>{if(console.log("add webxr"),s){const b=new Ye(s.baseExperience);e.getMeshByName("clipboard").addBehavior(b)}this.guiManager=new Xe(e),this.guiManager.createPromptWithButton("Welcome to the Lab Safety Simulation. Click on the clipboard to learn more about the simulation!",s),console.log("Cylinders app: ",i),new de(e,i,this.guiManager,t,s).postSceneCylinder();var M=Ke(e,s,g,i,this.guiManager,this.soundManager);M();for(let b of i)b.toggleControllers=M})}createRoom(e){const i=["WallsandFloor","Floor","Table","Roof","Countertop","Walls"];let t,o;for(let n of i){const s=e.find(a=>a.name===n);if(s&&(s.checkCollisions=!0,s.name==="Table")){const a=s.getBoundingInfo().boundingBox;a.center.x,t=s.getScene(),o=t.getCameraByName("camera"),o.position=new y(a.center.x*-1,a.center.y*2+.5,-1.5),o.rotation=new y(Math.PI/8,0,0)}}}createScene(){return new Promise(e=>{const i=document.getElementById("canvas"),t=new N(i,!0,{stencil:!0}),o=new Te(t);o.collisionsEnabled=!0,window.addEventListener("resize",function(){t.resize()});const n=new Ee("camera",new y(0,1,-1.134),o);n.ellipsoid=new y(.4,.7,.4),n.attachControl(i,!0),n.applyGravity=!0,n.minZ=0,n.speed=0,n.checkCollisions=!0,n.keysUp.push(87),n.keysDown.push(83),n.keysLeft.push(65),n.keysRight.push(68);var s=new Be("light1",new y(1,1,0),o);s.intensity=0,Promise.all(this.models.map(a=>new Promise(d=>Le.ImportMesh("",a.root,a.fileName,o,function(u){a.mesh=u,d(u)})))).then(()=>{let a=[];this.models.map(d=>{a.push(d.callback(d.mesh)),e(o)})}),window.addEventListener("keydown",a=>{a.shiftKey&&a.ctrlKey&&a.altKey&&a.keyCode===73&&(o.debugLayer.isVisible()?o.debugLayer.hide():o.debugLayer.show())}),t.runRenderLoop(()=>{o.render()})})}}new Je;
