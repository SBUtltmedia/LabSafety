import{A as W,C as S,V as g,M as Ae,E as Be,O as w,W as F,H as ye,a as z,b as I,c as xe,d as ke,P as le,e as H,f as Z,S as Le,F as Re,T as R,g as Ne,h as Fe,i as q,j as _e,k as De,R as Ge,l as Se,B as He,D as ne,m as D,n as Ve,G as he,o as ce,p as Ue,q as Te,r as we,s as ze,t as qe,u as $e,U as We,v as J,w as Xe}from"./vendor-DPTaCEoP.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();window.exports=window;let v;const Ze=i=>{let e=W.CreateFullscreenUI("UI"),t=0,s=0,n=0,a=0,o=150,r=-50,h,l=!1,d=!1,c=L("leftThumb",2,"blue",null);c.height="120px",c.width="120px",c.isPointerBlocker=!0,c.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_LEFT,c.verticalAlignment=S.VERTICAL_ALIGNMENT_BOTTOM,c.alpha=.4,c.left=o,c.top=r;let b=L("leftInnterThumb",4,"blue",null);b.height="50px",b.width="50px",b.isPointerBlocker=!0,b.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_CENTER,b.verticalAlignment=S.VERTICAL_ALIGNMENT_CENTER;let u=L("leftPuck",0,"blue","blue");u.height="10px",u.width="10px",u.isPointerBlocker=!0,u.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_CENTER,u.verticalAlignment=S.VERTICAL_ALIGNMENT_CENTER,c.onPointerDownObservable.add(function(O){u.isVisible=!0,u.left=O.x-c._currentMeasure.width*.5-o,u.left=u.left,u.top=e.getContext().canvas.height-O.y-c._currentMeasure.height*.5+r,u.top=u.top*-1,l=!0,c.alpha=.9}),c.onPointerUpObservable.add(function(O){t=0,s=0,l=!1,u.isVisible=!1,c.alpha=.4}),c.onPointerMoveObservable.add(function(O){l&&(t=O.x-c._currentMeasure.width*.5-o,s=e.getContext().canvas.height-O.y-c._currentMeasure.height*.5+r,u.left=t,u.top=s*-1,u.left=u.left,u.top=u.top)}),e.addControl(c),c.addControl(b),c.addControl(u),u.isVisible=!1;const P=.5;v=L("rightThumb",2,"red",null),v.height="120px",v.width="120px",v.isPointerBlocker=!0,v.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_RIGHT,v.verticalAlignment=S.VERTICAL_ALIGNMENT_BOTTOM,v.alpha=.4,v.left=-o,v.top=r;let M=L("rightInnterThumb",4,"red",null);M.height="50px",M.width="50px",M.isPointerBlocker=!0,M.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_CENTER,M.verticalAlignment=S.VERTICAL_ALIGNMENT_CENTER;let f=L("rightPuck",0,"red","red");f.height="10px",f.width="10px",f.isPointerBlocker=!0,f.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_CENTER,f.verticalAlignment=S.VERTICAL_ALIGNMENT_CENTER,v.onPointerDownObservable.add(function(O){f.isVisible=!0,f.left=e.getContext().canvas.width-O.x-v._currentMeasure.width*.5-o,f.left=f.left*-1,f.top=e.getContext().canvas.height-O.y-v._currentMeasure.height*.5+r,f.top=f.top*-1,d=!0,v.alpha=.9}),v.onPointerUpObservable.add(function(O){n=0,a=0,d=!1,f.isVisible=!1,v.alpha=.4}),v.onPointerMoveObservable.add(function(O){d&&(n=e.getContext().canvas.width-O.x-v._currentMeasure.width*.5-o,a=e.getContext().canvas.height-O.y-v._currentMeasure.height*.5+r,f.left=n*-1,f.top=a*-1,f.left=f.left,f.top=f.top)}),e.addControl(v),v.addControl(M),v.addControl(f),f.isVisible=!1;let p=i.activeCamera,Ee=document.getElementById("canvas");p.attachControl(Ee,!0),i.registerBeforeRender(function(){h=g.TransformCoordinates(new g(t/3e3,0,s/3e3),Ae.RotationY(p.rotation.y)),p.cameraDirection.addInPlace(h),p.cameraRotation.y+=P*n/15e3*-1,p.cameraRotation.x+=P*a/15e3*-1})};function L(i,e,t,s){let n=new Be;return n.name=i,n.thickness=e,n.color=t,n.background=s,n.paddingLeft="0px",n.paddingRight="0px",n.paddingTop="0px",n.paddingBottom="0px",n}const je=new g(0,1,-1.134),Ke=new g(.4,.7,.4),Qe=.16;function Ye(i){i.ellipsoid=Ke,i.applyGravity=!0,i.minZ=0,i.speed=Qe,i.checkCollisions=!0,i.needMoveForGravity=!1}function $(...i){}var C=(i=>(i[i.DESKTOP=0]="DESKTOP",i[i.XR=1]="XR",i[i.MOBILE=2]="MOBILE",i[i.LOADING=3]="LOADING",i))(C||{}),T=(i=>(i[i.GRAB=0]="GRAB",i[i.DROP=1]="DROP",i))(T||{}),A=(i=>(i[i.ACTIVE=0]="ACTIVE",i[i.INACTIVE=1]="INACTIVE",i))(A||{});const Je=9,et=.005;class ae{onMeshGrabStateChangedObservable=new w;onMeshActivationStateChangedObservable=new w;onModeChangeObservable=new w;onHasAnyTargetsObservable=new w;onGrabStateChangedObservable=new w;#e;highlightLayer;modeSelectorMap={0:{},1:{},2:{},3:{}};hasDefaultSelector=!1;#t=!1;#o=!1;#r=!1;#i=[];interactionMode=3;interactableMeshes=[];xrExperience;constructor(e,t){this.#e=e,t&&(this.xrExperience=t,this.xrExperience.baseExperience.onStateChangedObservable.add(s=>{this.#u(s)})),this.#u(this.xrExperience===void 0?F.NOT_IN_XR:this.xrExperience.baseExperience.state),this.highlightLayer=new ye("interaction-highlight-layer"),this.#e.onBeforeRenderObservable.add(()=>{const s=this.#i.length;this.#i.splice(0,this.#i.length);const n=this.getActiveSelectors(),a=n.filter(({grabbedMesh:l})=>!!l).map(({grabbedMesh:l})=>l),o=n.filter(({grabbedMesh:l})=>!l),r=this.interactableMeshes.filter(l=>!a.includes(l)),h={};for(const l of o){const d=[];for(const c of r)l.grabber.intersectsMesh(c,!0)&&d.push(c);l.targetMesh=this.#b(l.grabber,d),l.targetMesh&&(h[l.targetMesh.uniqueId]=l.targetMesh)}this.#i.push(...Object.values(h)),this.highlightLayer.removeAllMeshes();for(const l of this.#i)l instanceof z&&this.highlightLayer.addMesh(l,I.Gray());this.#i.length===0&&s!==0?this.onHasAnyTargetsObservable.notifyObservers(!1):this.#i.length!==0&&s===0&&this.onHasAnyTargetsObservable.notifyObservers(!0)})}#s=e=>{e.motionController&&this.#n(e.motionController,e.pointer.uniqueId),e.onMotionControllerInitObservable.add(t=>{this.#n(t,e.pointer.uniqueId)})};#n=(e,t)=>{const s=e.getComponentOfType("squeeze");s&&s.onButtonStateChangedObservable.add(()=>{s.changes.pressed&&this.#l(s.pressed,t)});const n=e.getMainComponent();n&&n.onButtonStateChangedObservable.add(()=>{n.changes.pressed&&this.#a(n.pressed,t)})};#l=(e,t)=>{const s=this.modeSelectorMap[this.interactionMode][t];e?s.targetMesh&&(s.grabbedMesh=s.targetMesh,s.targetMesh=null,this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:0})):s.grabbedMesh&&(this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:1}),s.grabbedMesh=null)};#a=(e,t)=>{const{anchor:s,grabber:n,grabbedMesh:a}=this.modeSelectorMap[this.interactionMode][t];a&&(e?this.#c(a,{anchor:s,grabber:n,state:0}):this.#c(a,{anchor:s,grabber:n,state:1}))};#h=(e,t)=>{if(e.isDisposed()){for(const n in this.modeSelectorMap)for(const a of Object.values(this.modeSelectorMap[n]))a.grabbedMesh===e&&(a.grabbedMesh=null);return}const s=e.getBehaviorByName("Interactable");if(!s)throw new Error("InteractionManager: grabbed mesh must have InteractableBehavior.");this.onMeshGrabStateChangedObservable.notifyObserver(s.grabStateObserver,t),this.onGrabStateChangedObservable.notifyObservers({mesh:e,state:t.state})};#c=(e,t)=>{if(e.isDisposed())return;const s=e.getBehaviorByName("Interactable");if(!s)throw new Error("InteractionManager: activated mesh must have InteractableBehavior.");this.onMeshActivationStateChangedObservable.notifyObserver(s.activationStateObserver,t,e.uniqueId)};#u=e=>{e===F.NOT_IN_XR?"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.maxTouchPoints>0?this.#d(2):this.#d(0):e===F.IN_XR?this.#d(1):this.#d(3)};#d=e=>{const t=this.getActiveSelectors();this.onModeChangeObservable.notifyObservers(e);for(const s of t)s.grabbedMesh&&(this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:1}),s.grabbedMesh=null);this.interactionMode=e,(e===0||e===2)&&!this.hasDefaultSelector&&this.#p(this.#e.activeCamera),console.log("Mode: ",e),e===0?this.#m():e===2?this.#f():e===1&&this.#v()};addSelector=(e,t,s)=>{const n={anchor:e,grabber:t,grabbedMesh:null,targetMesh:null};for(const a of s)this.modeSelectorMap[a][e.uniqueId]=n};#p=e=>{const t=xe("default-grabber",{height:Je,diameter:et});t.isVisible=!1,t.isPickable=!1,t.setParent(e),t.position.setAll(0),t.rotation.copyFromFloats(Math.PI/2,0,0);const s=new ke("default-anchor");s.isPickable=!1,s.setParent(e),s.position.copyFrom(new g(0,0,1)),this.addSelector(s,t,[0,2]),this.hasDefaultSelector=!0};#m=()=>{if(this.#t)return;const e=Object.values(this.modeSelectorMap[0]).find(({anchor:s})=>s.name==="default-anchor");if(e===void 0)throw new Error("Tried to configure desktop interaction without default selector.");const{anchor:t}=e;this.#e.onPointerObservable.add(s=>{this.interactionMode===0&&(s.event.inputIndex===le.LeftClick?s.type===H.POINTERDOWN?this.#l(!0,t.uniqueId):s.type===H.POINTERUP&&this.#l(!1,t.uniqueId):s.event.inputIndex===le.RightClick&&(s.type===H.POINTERDOWN?this.#a(!0,t.uniqueId):s.type===H.POINTERUP&&this.#a(!1,t.uniqueId)))}),this.#t=!0};#f=()=>{if(this.#o)return;const e=Object.values(this.modeSelectorMap[2]).find(({anchor:a})=>a.name==="default-anchor");if(e===void 0)throw new Error("Tried to configure mobile interaction without default selector.");const{anchor:t}=e;console.log("Mobile");let s=this.#l,n=this.#a;s(!1,t.uniqueId),n(!1,t.uniqueId),V&&(V.onPointerDownObservable.add(function(a){s(!0,t.uniqueId)}),V.onPointerUpObservable.add(function(a){s(!1,t.uniqueId)})),U&&(U.onPointerDownObservable.add(function(a){n(!0,t.uniqueId)}),U.onPointerUpObservable.add(function(a){n(!1,t.uniqueId)})),this.#o=!0};#v=()=>{if(!this.#r){if(!this.xrExperience)throw new Error("Tried to configure XR interaction without an XR experience.");this.xrExperience.input.controllers.forEach(this.#s),this.xrExperience.input.onControllerAddedObservable.add(this.#s),this.#r=!0}};getActiveSelectors=()=>Object.values(Object.values(this.modeSelectorMap[this.interactionMode]));#b=(e,t)=>ae.#g(e,t,this.interactionMode);static#g=(e,t,s)=>{let n=null,a=Number.POSITIVE_INFINITY;switch(s){case 0:case 2:case 1:for(const o of t){const r=g.Distance(e.getAbsolutePosition(),o.getAbsolutePosition());r<a&&(n=o,a=r)}break}return n}}const tt=.15;class oe{mesh;spawnPosition=g.Zero();spawnRotation=g.Zero();#e;#t;#o;#r=null;#i;#s;constructor(e=1.25){this.#e=e,this.#i=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}],this.#i.forEach(t=>{t.animation=new Z(t.name,"visibility",60,Z.ANIMATIONTYPE_FLOAT,Z.ANIMATIONLOOPMODE_CONSTANT),t.animation.setKeys([{frame:0,value:t.startValue},{frame:30,value:t.startValue?0:1}])})}init(){}get name(){return"FadeAndRespawn"}attach(e){if(this.mesh=e,this.#t=this.mesh.getBehaviorByName("Interactable"),!this.#t)throw new Error(`${this.name} behavior must be attached to a mesh with an Interactable behavior.`);this.#s=this.mesh.getScene(),this.#o=this.#t.onGrabStateChangedObservable.add(({state:t})=>{t===T.DROP&&this.#n()})}detach(){this.#o.remove(),this.#r&&this.#r.remove()}#n(){if(Math.abs(g.Distance(this.mesh.getAbsolutePosition(),this.spawnPosition))<=tt){this.#a();return}this.#s.beginDirectHierarchyAnimation(this.mesh,!1,[this.#i.find(t=>t.name==="Invisibility").animation],0,60,!1,this.#e,()=>{this.#a(),this.#l()})}#l(){this.#s.beginDirectHierarchyAnimation(this.mesh,!1,[this.#i.find(e=>e.name==="Visibility").animation],0,60,!1,this.#e)}#a=()=>{this.mesh.position.copyFrom(this.spawnPosition),this.mesh.rotation.copyFrom(this.spawnRotation)};setSpawnPoint=(e,t)=>{this.spawnPosition.copyFrom(e),this.spawnRotation.copyFrom(t)}}function it(i){const e=i.meshes.map(t=>t.getBehaviorByName("FadeAndRespawn")).filter(t=>!!t);for(const t of e)t.setSpawnPoint(t.mesh.position,t.mesh.rotation)}const st=["room","placard","cylinder","clipboard","fire-extinguisher"];function Ce(i=st){return Promise.all(i.map(e=>Le.ImportMeshAsync("","./models/",`${e}.glb`).then(t=>{const s=t.meshes.find(n=>n.id==="__root__");return s.id=e,s.name=e,t})))}function Oe(i){const t=i.getScene().meshes.find(s=>s.name==="Table");if(i.rotation=g.Zero(),t){const s=t.getBoundingInfo().boundingBox;i.position.x=s.center.x-.5,i.position.y=s.center.y*2+.46,i.position.z=-3}else i.position=g.Zero()}function de(i,e){return i.id<e.id?-1:i.id>e.id?1:0}function nt(i){const e=i.filter(o=>o.id.split("-").length===2&&o.id.split("-")[0]==="cylinder").sort(de),t=i.filter(o=>o.name.split("-")[0]==="placard"&&!o.name.includes("placard-base")).sort(de),s=i.find(o=>o.id==="clipboard"),n=i.find(o=>o.name==="Table"),a=i.find(o=>o.id==="fire-extinguisher");if(n){const o=n.getBoundingInfo().boundingBox;e.forEach((r,h)=>{const l=r.getBoundingInfo().boundingBox,d=r.position.y-l.minimum.y;r.position.copyFromFloats(o.minimum.x+(h+1)*(o.maximum.x-o.minimum.x)/(e.length+2),o.maximum.y+d,(2*o.minimum.z+o.center.z)/3),r.rotationQuaternion=null,r.rotation.copyFromFloats(Math.PI,0,0)}),t.forEach((r,h)=>{const d=r.getChildMeshes().find(b=>b.name==="placard-base").getBoundingInfo().boundingBox,c=r.position.y-d.minimum.y;r.position.y=o.maximum.y+c,r.position.x=o.minimum.x+(h+1)*(o.maximum.x-o.minimum.x)/(t.length+2)+.2,r.position.z=(2*o.minimum.z+o.center.z)/3+.2,r.rotationQuaternion=null,r.rotation.copyFromFloats(0,Math.PI/2,0)}),s.position.copyFromFloats(e[0].position.x+.5,o.maximum.y,e[0].position.z+.3),s.rotationQuaternion=null,s.rotation.copyFromFloats(0,-Math.PI/2,Math.PI),a.position.copyFromFloats(3.73,1.77,-2.51),a.rotationQuaternion=null,a.rotation.copyFromFloats(0,0,Math.PI)}}const Me="./",at=`${Me}images/sopTemplate.svg`,ot=`${Me}json/HUDhints.json`;var x=(i=>(i[i.SUCCESSFUL=0]="SUCCESSFUL",i[i.FAILURE=1]="FAILURE",i[i.RESET=2]="RESET",i))(x||{});class ee{name;description;#e;optional;subtasks;subtaskObservers;onTaskStateChangeObservable;constructor(e,t,s,n=!1){if(this.name=e,this.description=t,this.#e=2,this.optional=n,s.some(a=>a.length===0))throw new Error(`Task ${this.name}: subtask partition must not be empty.`);this.subtasks=s,this.onTaskStateChangeObservable=new w,this.subtaskObservers=this.subtasks.map(a=>a.map((o,r)=>{const h=o.onTaskStateChangeObservable.add((l,d)=>{switch(l){case 1:o.optional||this.fail();break;case 0:if(r!==0&&a[r-1].status!==0){d.skipNextObservers=!0;break}this.subtasks.every(b=>b.at(-1).status===0)&&this.#t();break}});return o.onTaskStateChangeObservable.makeObserverTopPriority(h),h}))}fail=()=>{if(this.#e!==2)throw new Error(`Attempted to fail a Task (${this.name}) which has already succeeded or failed.`);if(this.onTaskStateChangeObservable.notifyObservers(1))$(`Failing Task ${this.name}`),this.#e=1;else throw new Error(`Task ${this.name}: An observer skipped following observers.`)};succeed=()=>{if(this.subtasks.length)throw new Error(`Task ${this.name} has subtasks and cannot be manually succeeded.`);this.#t()};#t=()=>{if(this.#e!==2)throw new Error(`Attempted to succeed a Task (${this.name}) which has already succeeded or failed.`);this.#e=0,this.onTaskStateChangeObservable.notifyObservers(this.#e)?$(`Succeeding Task ${this.name}`):(this.#e=2,this.fail())};reset=()=>{this.subtasks.forEach(e=>{e.forEach(t=>t.reset())}),this.#e=2,this.onTaskStateChangeObservable.notifyObservers(this.#e)};get failed(){return this.#e===1}get successful(){return this.#e===0}get status(){return this.#e}}class rt{mesh;extinguished=!1;onFireObservable=new w;constructor(){}get name(){return"Fire"}init(){}attach=e=>{this.mesh=e};extinguish=()=>{this.extinguished=!0,this.onFireObservable.notifyObservers(!1),this.mesh.isVisible=!1};detach=()=>{}}function lt(){const i=new Re("fire");i.diffuseTexture=new R("images/fire.png"),i.distortionTexture=new R("images/distortion.png"),i.opacityTexture=new R("images/candleopacity.png"),i.speed=5;const e=new Ne("spotlight",new g(2,2,2),new g(-1,-2,-1),3,1),t=new Fe(10240,e);t.usePercentageCloserFiltering=!0,t.bias=100,t.transparencyShadow=!0;const s=q.CreatePlane("fire-plane",{width:4,height:3});s.receiveShadows=!0,s.position.copyFromFloats(-4.1,0,-1.6),s.rotationQuaternion=null,s.rotation.copyFromFloats(0,-Math.PI/2,0),s.material=i,s.material.shadowDepthWrapper=new _e(s.material),t.getShadowMap().renderList.push(s);const n=new rt;return s.addBehavior(n),s}class ht{rect;text;button;constructor(e,t,s){this.rect=e,this.text=t,this.button=s}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e,document.exitPointerLock(),$t()}}class j{advancedTexture;welcomePrompt;gameFinishPrompt;camera;screen;scene;constructor(e){this.scene=e,this.camera=e.activeCamera}createPromptWithButton(e,t=null,...s){this.screen=q.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=new g(0,0,.5),this.advancedTexture=W.CreateForMesh(this.screen);let n=new De("container");var a=new Ge;a.width=.5,a.height=.2,a.color="cyan",a.thickness=4,a.background="white",n.addControl(a);var o=new Se;o.text=e,o.color="black",o.fontSize="17px",o.resizeToFit=!0,o.textWrapping=!0,o.paddingBottomInPixels=40,o.paddingLeftInPixels=15,o.paddingRightInPixels=15,a.addControl(o);var r=He.CreateSimpleButton("but1","Click to dismiss");r.width="150px",r.height="40px",r.color="black",r.cornerRadius=20,r.background="white",r.topInPixels=40;let h=new ht(a,o,r),l=this.scene.getMeshByName("Start");function d(){n.dispose(),l.dispose(),t&&t(...s)}return h.button.onPointerUpObservable.add(function(){d()}),h.button.onPointerEnterObservable.add(()=>{r.background="grey"}),h.button.onPointerOutObservable.add(()=>{r.background="white"}),n.addControl(h.button),n.addControl(r),this.advancedTexture.addControl(n),h}}class ue{static createWelcomeScreen(e){new j(e).createPromptWithButton("Welcome to the game. Please click on the clipboard on the table to get started.").setVisible(!0)}static createSuccessScreen(e,t=null,...s){new j(e).createPromptWithButton("Congratulations! You have completed the SOP",t,...s).setVisible(!0)}static createFailureScreen(e,t=null,...s){new j(e).createPromptWithButton("Oops! You mixed the wrong chemicals which resulted in a fire",t,...s).setVisible(!0)}}const m={sop:null,taskList:null,json:null,sounds:{},hudHints:{}};class G{#e;interactionManager;#t=null;#o=null;onGrabStateChangedObservable=new w;onActivationStateChangedObservable=new w;defaults={};hideGrabber=!0;#r;#i=!1;#s;#n=!1;#l=null;#a=null;#h=null;#c=!0;constructor(e,t){this.interactionManager=e,this.#s=!!t?.activatable,this.#r=t?.moveAttached!==!1;for(const s of[C.DESKTOP,C.MOBILE,C.XR,C.LOADING])this.defaults[s]={defaultPosition:t?.modeDefaults?.[s]?.defaultPosition||t?.defaultPosition||g.Zero(),defaultRotation:t?.modeDefaults?.[s]?.defaultRotation||t?.defaultRotation||g.Zero()}}get name(){return"Interactable"}set activatable(e){!e&&this.#n&&this.#f(),this.#s=e}get grabbing(){return!!this.#l&&!!this.#a}get grabStateObserver(){return this.#t}get activationStateObserver(){return this.#o}#u=()=>{this.#h=this.onGrabStateChangedObservable.add(({anchor:e,state:t})=>{if(t===T.GRAB){this.#e.setParent(e);const{defaultPosition:s,defaultRotation:n}=this.defaults[this.interactionManager.interactionMode];this.#e.position.copyFrom(s),this.#e.rotation.copyFrom(n)}else t===T.DROP&&this.#e.setParent(null)})};#d=()=>{this.#h.remove(),this.#h=null,this.grabbing&&this.#e.setParent(null)};set moveAttached(e){e&&!this.#r&&this.#e?this.#u():!e&&this.#r&&this.#e&&this.#d(),this.#r=e}set enabled(e){e&&!this.#c&&!this.#y&&this.#p?this.#g():!e&&this.#c&&this.#y&&this.#S(),this.#c=e}get enabled(){return this.#c}get#p(){return!!this.#e}#m=()=>{this.#n=!0,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#a,state:A.ACTIVE})};#f=()=>{this.#n=!1,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#a,state:A.INACTIVE})};#v=(e,t)=>{this.onGrabStateChangedObservable.notifyObservers({anchor:e,grabber:t,state:T.GRAB}),this.#l=e,this.#a=t,this.hideGrabber&&this.#i&&(t.isVisible=!1)};#b=()=>{this.#n&&this.#f(),this.hideGrabber&&this.#i&&(this.#a.isVisible=!0),this.onGrabStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#a,state:T.DROP}),this.#l=null,this.#a=null};init(){}attach=e=>{this.#e=e,this.enabled&&this.#g(),this.#r&&this.#u(),this.interactionManager.interactableMeshes.push(this.#e)};#g=()=>{this.#t=this.interactionManager.onMeshGrabStateChangedObservable.add(({anchor:e,grabber:t,state:s})=>{s===T.GRAB&&!this.grabbing?(this.#i=t.isVisible,this.#v(e,t)):s===T.DROP&&this.grabbing&&this.#b()},this.#e.uniqueId),this.#o=this.interactionManager.onMeshActivationStateChangedObservable.add(({anchor:e,grabber:t,state:s})=>{this.#s&&this.grabbing&&(s===A.ACTIVE&&!this.#n?this.#m():s===A.INACTIVE&&this.#n&&this.#f())},this.#e.uniqueId)};enable=()=>{this.enabled=!0};disable=()=>{this.enabled=!1};#S=()=>{this.#t.remove(),this.#o.remove(),this.#t=null,this.#o=null};get#y(){return!!this.#t&&!!this.#o}detach=()=>{this.#r&&this.#d(),this.grabbing&&this.#b(),this.#y&&this.#S(),this.onGrabStateChangedObservable.clear(),this.onActivationStateChangedObservable.clear();const e=this.interactionManager.interactableMeshes.findIndex(t=>t===this.#e);e!==-1&&this.interactionManager.interactableMeshes.splice(e,1),this.#e=null}}class ct{highlightLayer;mesh;otherMesh;color;constructor(e){this.highlightLayer=new ye("highlight-layer"),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1,this.color=e}get name(){return"Highlight"}init(){}attach=e=>{this.mesh=e};detach=()=>{this.unhighlightAll()};highlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)||this.highlightLayer.addMesh(this.mesh,this.color)};highlightOther=e=>{this.highlightLayer.hasMesh(e)||(this.otherMesh=e,this.highlightLayer.addMesh(this.otherMesh,this.color))};unhighlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh)};unhighlightOther=()=>{this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)};unhighlightAll=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh),this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)}}class dt{mesh;#e;#t;#o;#r=null;#i;#s;onBeforePourObservable;onMidPourObservable;onAfterPourObservable;liquidMesh;#n=!1;pourDelay=1e3;animating=!1;onAnimationChangeObservable;constructor(){this.#t=new ct(I.Green()),this.onBeforePourObservable=new w,this.onMidPourObservable=new w,this.onAfterPourObservable=new w,this.onAnimationChangeObservable=new w}get name(){return"Pouring"}init(){}attach=e=>{if(this.mesh=e,this.#e=this.mesh.getBehaviorByName("Interactable"),!this.#e)throw new Error(`${this.name} behavior must have Interactable present on the same mesh.`);this.mesh.addBehavior(this.#t);const t=e.getScene();t.activeCamera;const s=this.#e.interactionManager.interactableMeshes;this.#o=this.#e.onGrabStateChangedObservable.add(({state:a})=>{a===T.GRAB?this.#i=t.onBeforeRenderObservable.add(()=>{const o=this.#l(s);this.#a(o)}):a===T.DROP&&(this.#a(null),this.#i&&(this.#i.remove(),this.#i=null))});let n=!1;this.#r=this.#e.onActivationStateChangedObservable.add(({state:a})=>{if(a===A.ACTIVE&&!this.#n&&this.#s){const o=this.#e.interactionManager.interactionMode;(o===C.DESKTOP||o===C.MOBILE)&&(this.mesh.rotation.z+=Math.PI/4,n=!0),this.pour()}else a===A.INACTIVE&&n&&(this.mesh.rotation.z-=Math.PI/4,n=!1)})};detach=()=>{this.#o.remove(),this.#r.remove(),this.#i&&this.#i.remove()};get empty(){return this.#n}set empty(e){this.#n&&!e?(this.liquidMesh&&(this.liquidMesh.isVisible=!0),this.#n=e):!this.#n&&e&&(this.liquidMesh&&(this.liquidMesh.isVisible=!1),this.#n=e)}#l(e){const t=e.filter(a=>{const o=this.mesh.absolutePosition.y>a.absolutePosition.y,r=!!a.getBehaviorByName("Pouring"),h=!a.getBehaviorByName("Interactable").grabbing,l=this.mesh.intersectsMesh(a);return o&&r&&h&&l});let s=null,n=Number.POSITIVE_INFINITY;for(const a of t){const o=g.Distance(this.mesh.absolutePosition,a.absolutePosition);o<n&&(s=a,n=o)}return s}#a(e){this.#s!==e&&(this.#s&&this.#s instanceof z&&this.#t.unhighlightAll(),this.#s=e,this.#s&&this.#s instanceof z&&(this.#t.highlightSelf(),this.#t.highlightOther(this.#s)))}pour=()=>{if(!this.#s)throw new Error("PouringBehavior: attempted pour with no current target.");const e=this.#s.getBehaviorByName("Pouring");if(!e)throw new Error("PouringBehavior: target is not pourable.");e.empty=!1;const t=this.#s;this.onBeforePourObservable.notifyObservers(t),this.onMidPourObservable.notifyObservers(t),this.onAfterPourObservable.notifyObservers(t),this.empty=!0}}function Ie(i,e){const t=i.getChildMeshes().find(n=>n.id.split("-").pop()==="liquid"),s=new D("liquid-material");s.diffuseColor=e,t.material=s}function K(i,e){Ie(i,e);const t=new ne("dynamic-texture",256,null,!0,R.LINEAR_LINEAR_MIPNEAREST);t.uAng=Math.PI;const s=new D("cylinder-label-material");s.diffuseTexture=t;const n="bold 250px monospace",a=i.getChildMeshes().filter(l=>{const d=l.id.split("-").pop();return d==="label"||d==="labelback"});for(const l of a)l.material=s,t.drawText(i.id.split("-").pop().toUpperCase(),0,225,n,"black","white");const o=new G(B,{activatable:!0,defaultRotation:new g(0,Math.PI/2,Math.PI)}),r=new dt,h=new oe;i.addBehavior(o),i.addBehavior(r),r.liquidMesh=i.getChildMeshes().find(l=>l.id.split("-").pop()==="liquid"),i.addBehavior(h)}const ut=(i,e)=>{let t=[],s=[],n={};e.forEach(a=>{a.logic&&a.logic.taskType==="pouring"&&ft(i,a,t,s,n)}),bt(i,s),t.forEach(a=>{a.onTaskStateChangeObservable.add(o=>{o===x.SUCCESSFUL&&!m.sounds.success.isPlaying&&!m.sounds.explosion.isPlaying&&(m.sounds.ding.stop(),m.sounds.ding.play())})}),m.taskList=t},fe=(i,e,t,s)=>{i===e?t.succeed():t.fail()},ft=(i,e,t,s,n)=>{let a=e.taskName,o=e.text,r=e.logic,h=[];r.subtasks.forEach(b=>{let u=n[b];u&&h.push(u)});let l;h.length?l=new ee(a,o,[[...h]]):l=new ee(a,o,[]),t.push(l),s.push(l),n[a]=l;let c=i.getMeshByName(r.from).getBehaviorByName("Pouring");c.onMidPourObservable.add(b=>{$(`Pouring mesh name: ${c.mesh.name}`),$(`Poured mesh name: ${b.name}`);const u=b.getChildMeshes().find(f=>f.id.split("-").pop()==="liquid").material.diffuseColor,P=c.mesh.getChildMeshes().find(f=>f.id.split("-").pop()==="liquid").material.diffuseColor,M=new I((u.r+P.r)/2,(u.g+P.g)/2,(u.b+P.b)/2);Ie(b,M),c.animating?c.onAnimationChangeObservable.addOnce(()=>{fe(b.name,r.to,l)}):fe(b.name,r.to,l)})},bt=(i,e)=>{m.sop=new ee("SOP","Standard operating procedure for lab safety.",[e]),m.sop.onTaskStateChangeObservable.add(t=>{switch(t){case x.SUCCESSFUL:i.activeCamera,ue.createSuccessScreen(i,()=>{ve(),ie(i)}),m.sounds.success.stop(),m.sounds.success.play();break;case x.FAILURE:m.sounds.explosion.stop(),m.sounds.explosion.play();const n=lt().getBehaviorByName("Fire");n&&n.onFireObservable.add(a=>{a||(ue.createFailureScreen(i,()=>{ve(),ie(i)}),m.sounds.success.stop(),m.sounds.success.play())});break;case x.RESET:break}})},gt={[x.SUCCESSFUL]:"correct",[x.FAILURE]:"incorrect",[x.RESET]:"empty"};class pt{templateString;data;basicTasks;rootTask;#e;mesh;#t;#o;constructor(e,t,s,n){this.templateString=e,this.#t=Ve.compile(this.templateString),this.data=t,this.rootTask=s,this.basicTasks=n,this.#e=[],this.#o=0}get name(){return"UpdateClipboard"}init(){}#r=e=>this.#i.find(t=>t.taskName===e)||null;get#i(){return this.data.items[1].sublist}attach=e=>{this.mesh=e,this.#s(),this.#e.push(...this.basicTasks.map(t=>t.onTaskStateChangeObservable.add(s=>{const n=this.#r(t.name);n.indicator=gt[s],this.#s()}))),this.#e.push(this.rootTask.onTaskStateChangeObservable.add(t=>{}))};detach=()=>{for(let e of this.#e)e.remove()};#s=()=>{const e=document.createElement("template"),t=this.#t(this.data);e.innerHTML=t;const n=new XMLSerializer().serializeToString(e.content),a="data:image/svg+xml;utf8,"+encodeURIComponent(n),o=R.LoadFromDataString(`clipboard-texture-${this.#o++}`,a,this.mesh.getScene(),void 0,void 0,void 0,R.LINEAR_LINEAR_MIPNEAREST,()=>{o.uScale=1,o.vScale=-1,o.hasAlpha=!0,this.#n(o)})};#n=e=>{const t=this.mesh.material;t.diffuseTexture!==e&&(t.diffuseTexture&&t.diffuseTexture.dispose(),t.diffuseTexture=e)}}function mt(i){const e=i.getScene(),t=new D("clipboard-material",e);t.emissiveColor.copyFrom(I.White()),t.useAlphaFromDiffuseTexture=!0;const s=i.getChildMeshes().find(o=>o.name===`${i.id}-plane`);s.material=t,fetch(at).then(o=>o.text()).then(o=>{fetch("./json/sopData.json").then(r=>r.json()).then(r=>{let h=r.items[1].sublist;ut(e,h);const l=new pt(o,r,m.sop,m.taskList);s.addBehavior(l)})});const n=new G(B,{defaultRotation:new g(Math.PI,Math.PI/2,Math.PI/2),modeDefaults:{[C.DESKTOP]:{defaultPosition:new g(0,0,-.5)},[C.MOBILE]:{defaultPosition:new g(0,0,-.5)}}});s instanceof z&&n.interactionManager.highlightLayer.addExcludedMesh(s);const a=new oe;i.addBehavior(n),i.addBehavior(a)}function Q(i){const e=i.getScene(),t=i.name.split("-")[1],s=i.getChildMeshes().find(h=>h.name==="Placard"),n=i.getChildMeshes().find(h=>h.name==="Label");s.id="placard-base",s.name="placard-base";const a=new ne("dynamic texture",256,e);a.wAng=-Math.PI/2,a.uAng=Math.PI;const o=new D("Mat",e);o.diffuseTexture=a,n.material=o,a.drawText(t.toUpperCase(),65,185,"bold 220px monospace","black","white"),s.addChild(n)}function vt(i){i.keysUp.push(87),i.keysDown.push(83),i.keysLeft.push(65),i.keysRight.push(68)}const yt=["WallsandFloor","Floor","Table","Roof","Countertop","Walls","FumehoodBase_LP","FumehoodInner_LP","FumehoodInnerHook_LP"];function St(i){i.getChildMeshes().forEach(e=>{yt.includes(e.name)&&(e.checkCollisions=!0)})}function Tt(i){const e=i.getScene().activeCamera;St(i),Oe(e),vt(e)}class wt{particleSystem;#e;constructor(e){this.#e=e,this.#t()}#t(){let e=this.#e.getScene(),t;he.IsSupported?(t=new he("particles",{capacity:15e3},e),t.activeParticleCount=2e3):t=new ce("particles",2e3,e),t.particleTexture=new R("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",e),t.emitRate=150,t.createPointEmitter(new g(-3.5,-3.5,0),new g(3.5,3.5,0)),t.gravity=new g(0,0,20),t.isLocal=!0,t.minLifeTime=.3,t.maxLifeTime=.3,t.minEmitPower=.7,t.maxEmitPower=.5,t.minSize=.01,t.maxSize=.02;let s=.3;t.addSizeGradient(s,s,s),t.blendMode=ce.BLENDMODE_STANDARD,t.emitter=this.#e,this.particleSystem=t}start(){this.particleSystem.start()}stop(){this.particleSystem.stop()}}const Ct=2;function Ot(i){const e=new G(B,{activatable:!0,defaultRotation:new g(0,0,Math.PI)}),t=new oe;i.addBehavior(e),i.addBehavior(t);let s=new wt(i),n=null;const a=i.getScene(),o=q.CreateSphere("debug-sphere-1",{diameter:.1}),r=q.CreateSphere("debug-sphere-2",{diameter:.1});o.isVisible=!1,r.isVisible=!1,e.onActivationStateChangedObservable.add(({state:h})=>{h===A.ACTIVE?(s.start(),n=a.onBeforeRenderObservable.add(()=>{const l=new Ue(i.absolutePosition,i.getDirection(Te.Z).normalize(),Ct);o.setAbsolutePosition(l.origin),r.setAbsolutePosition(l.origin.add(l.direction.scale(l.length)));const d=a.pickWithRay(l,c=>{const b=c.getBehaviorByName("Fire");return!!(b&&!b.extinguished)});if(d.hit){const c=d.pickedMesh.getBehaviorByName("Fire");c.extinguished||c.extinguish()}})):h===A.INACTIVE&&(s.stop(),n&&(n.remove(),n=null))})}function Mt(i){const e=i.getChildMeshes(!0)[0];e.rotationQuaternion=null;const t=new G(B,{moveAttached:!1});let s=null;const n=i.getScene();t.onGrabStateChangedObservable.add(({anchor:a,state:o})=>{o===T.GRAB?s=n.onBeforeRenderObservable.add(()=>{const r=a.getAbsolutePosition().subtract(e.getAbsolutePosition());if(r.y=0,r.x>0)return;const h=r.z<0?0:Math.PI,l=-Math.atan(r.x/r.z);e.rotation.copyFromFloats(0,l+h,0)}):o===T.DROP&&s&&(s.remove(),s=null)}),e.addBehavior(t)}const It=1.93,Pt=1.3,be=(i,e)=>{let t=Math.floor(i.position.y*100)/100;t+e>=Pt&&t+e<=It&&(i.position.y+=e)},Et=i=>{const e=i.getScene();let t=null,s=null;const n=new G(B,{moveAttached:!1});i.addBehavior(n),n.onGrabStateChangedObservable.add(({anchor:a,state:o})=>{if(o==T.GRAB){const r=i.getBehaviorByName("PointerDrag");if(r&&(s=r.onDragObservable.add(h=>{let l=h.delta.y;be(i,l)})),a){let h=g.Zero();h.copyFrom(a.getAbsolutePosition()),t=e.onBeforeRenderObservable.add(()=>{const l=a.getAbsolutePosition().subtract(h);let d=Math.floor(l.y*100)/100;be(i,d),h.copyFrom(a.getAbsolutePosition())})}}else o==T.DROP&&(s&&s.remove(),t&&t.remove())})};function At(i){const e=i.find(p=>p.name==="room"),t=i.find(p=>p.name==="placard"),s=i.find(p=>p.name==="cylinder").getChildMeshes(!0)[0],n=i.find(p=>p.name==="clipboard").getChildMeshes(!0)[0],a=i.find(p=>p.name==="fire-extinguisher").getChildMeshes(!0)[0],o=i.find(p=>p.name==="FireCabinet"),r=i.find(p=>p.name==="Glass Divider");Tt(e),Et(r);const h=n.parent;h.id="clipboard-root",h.name=h.id,n.setParent(null),h.dispose(!0),xt(n),mt(n);const l=t.clone(`${t.name}-c`,t.parent),d=t.clone(`${t.name}-b`,t.parent),c=t;l.id=l.name,d.id=d.name,c.name+="-a",c.id=c.name,l.getChildMeshes().forEach(p=>p.name=p.name.split(".")[1]),d.getChildMeshes().forEach(p=>p.name=p.name.split(".")[1]),Q(l),Q(d),Q(c),i.push(l,d);const b=s.parent;s.setParent(null),b.dispose(!0);const u=s.clone(`${s.id}-c`,null),P=s.clone(`${s.id}-b`,null),M=s;Bt([M,P,u],["a","b","c"]),K(u,I.Blue()),K(P,I.Green()),K(M,I.Red());const f=a.parent;f.id="fire-extinguisher-root",f.name=f.id,a.setParent(null),f.dispose(),a.id="fire-extinguisher",a.name=a.id,Ot(a),Mt(o),i.push(u,P)}function Bt(i,e){i.forEach((t,s)=>{t.id=`cylinder-${e[s]}`,t.name=t.id,t.getChildMeshes().forEach(n=>{switch(n.id.split(".").pop()){case"BeakerLiquid":n.id=`${t.id}-liquid`,n.name=n.id;break;case"Label":n.id=`${t.id}-label`;break;case"LabelBack":n.id=`${t.id}-labelback`;break}})})}function xt(i){i.id="clipboard",i.name=i.id,i.getChildMeshes().forEach(e=>{switch(e.id){case"Plane":e.id=`${i.id}-plane`,e.name=e.id;break;case"Clipper":e.id=`${i.id}-clip`,e.name=e.id;break;case"horizontalScrew":e.id=`${i.id}-screw`,e.name=e.id;break;case"metalThingy":e.id=`${i.id}-metal`,e.name=e.id;break}})}const Pe=64,Y=Pe/2,kt=.005;function Lt(i,e){const t=new ne(i,Pe),s=t.getContext();s.beginPath(),s.arc(Y,Y,Y,0,2*Math.PI),s.fill(),t.update();const n=new D(i);n.diffuseTexture=t,n.opacityTexture=t;const a=we(i,{size:kt},e);return a.material=n,a}async function Rt(i,e){const t=await Ce([i,e]);let s=null,n=null;for(const a of t){const o=a.meshes.find(h=>h.id===i||h.id===e);for(const h of a.animationGroups)h.name+=`-${o.name}`,h.pause();const[r]=o.getChildMeshes();if(!r)throw new Error(`Cannot collapse the root mesh of ${o.name}`);if(r.id=o.id,r.name=o.name,r.setParent(null),o.dispose(!0),r.name===i)s=r;else if(r.name===e)n=r;else throw new Error("Base mesh name is invalid. This shouldn't be possible.")}if(!s)throw new Error("No left hand mesh found.");if(!n)throw new Error("No right hand mesh found.");return{left:s,right:n}}const Nt={inputOptions:{doNotLoadControllerMeshes:!0},pointerSelectionOptions:{enablePointerSelectionOnAllControllers:!0},uiOptions:{onError:i=>console.error(i)}};async function Ft(i){let e=!1;i.pointerSelection.laserPointerDefaultColor=I.Green(),i.pointerSelection.laserPointerPickedColor=I.Green(),i.pointerSelection.selectionMeshDefaultColor=I.Green(),i.pointerSelection.selectionMeshPickedColor=I.Green(),i.pointerSelection.displayLaserPointer=e,i.pointerSelection.displaySelectionMesh=e,window.addEventListener("keydown",a=>{a.keyCode===73&&(e=!e,i.pointerSelection.displayLaserPointer=e,i.pointerSelection.displaySelectionMesh=e)}),i.baseExperience.onStateChangedObservable.add(a=>{F.IN_XR}),i.baseExperience.camera.onAfterCameraTeleport.add(()=>{i.baseExperience.camera.position.y=i.baseExperience.camera.realWorldHeight});const n=await Rt("left","right");for(const a of i.input.controllers)ge(a,n[`${a.inputSource.handedness}`]);i.input.onControllerAddedObservable.add(a=>{ge(a,n[`${a.inputSource.handedness}`])}),i.input.onControllerRemovedObservable.add(a=>{let o=y.findIndex(r=>r===a.pointer.name);o!==-1&&y.splice(o,1),a.grip&&(o=y.findIndex(r=>r===a.grip.name),o!==-1&&y.splice(o,1))})}function ge(i,e){y.push(i.pointer.name),i.grip&&y.push(i.grip.name),e.isPickable=!1,_t(i,e,i.inputSource.handedness)}function _t(i,e,t){e.setParent(i.pointer),e.rotationQuaternion=null,t!=="none"?e.rotation.copyFromFloats(Math.PI,0,Math.PI/2):e.rotation.copyFromFloats(0,0,0),i.motionController&&pe(i.motionController,e),i.onMotionControllerInitObservable.add(s=>{pe(s,e)}),B.addSelector(i.pointer,e,[C.XR]),y.push(e.name)}function pe(i,e){const t=i.getComponentOfType("squeeze"),s=e.getScene().animationGroups.find(n=>n.name===`Fist-${e.name}`);t.onButtonStateChangedObservable.add(n=>{const a=s.from+(s.to-s.from)*n.value;s.goToFrame(a)})}async function Dt(i){function e(t){for(const{name:s,path:n}of t)m.sounds[s]=new ze(s,n,void 0)}return fetch(i).then(t=>t.json()).then(e)}class _{text;advancedTexture;textBlock;rectangle;#e;_platform;set platform(e){this._platform=e,this.#t()}get platform(){return this._platform}#t=()=>{this.#e.setParent(N.originalScene.activeCamera),this.#e.position.copyFromFloats(0,-.5,2),this.#e.rotation.setAll(0)};constructor(e,t){e&&(this.text=e),t&&(this._platform=t),this.#e=we("plane_text",{size:2},N.utilityLayerScene),this.#e.isPickable=!1,this.#t(),this.advancedTexture=W.CreateForMesh(this.#e),this.textBlock=new Se("textblock")}handleStateChange(e,t,...s){return this._platform=t,e===k.START?(this.hideHUD(),new Gt(m.hudHints.GAME_STATE_START[this._platform],this._platform)):null}displayHUD(){this.textBlock.text=this.text,this.textBlock.textWrapping=!0,this.textBlock.fontSize=20,this._platform==="mobile"&&(this.textBlock.fontSize=12),this.textBlock.paddingBottomInPixels=200,this.textBlock.alpha=1,this.textBlock.color="white",this.textBlock.isVisible=!0,this.advancedTexture.addControl(this.textBlock)}hideHUD(){this.textBlock.isVisible=!1}}class Gt extends _{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...s){return this.hideHUD(),this.platform=t,new X(m.hudHints.GAME_STATE_BASE[this.platform],this.platform)}displayHUD(){let e=this.textBlock,t=this.advancedTexture;e.text=this.text,e.fontSize=30,e.fontWeight="bold",e.color="white",t.addControl(e),e.isVisible=!0}}class X extends _{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...s){return this.platform=t,e===k.GRAB?(this.hideHUD(),new Ht(m.hudHints.GAME_STATE_PICK_SOP[this.platform],this.platform)):e===k.HIGHLIGHT?(this.hideHUD(),new Ut(m.hudHints.GAME_STATE_PICK_CYLINDER[this.platform],this.platform)):null}}class Ht extends _{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...s){return this.platform=t,e===k.ACTIVATE?(this.hideHUD(),new Vt(m.hudHints.GAME_STATE_PASS[this.platform],this.platform)):e===k.BASE?(this.hideHUD(),new X(m.hudHints.GAME_STATE_FAIL[this.platform],this.platform)):null}}class Vt extends _{constructor(e,t){super(e,t)}handleStateChange(e,t,...s){return new X(m.hudHints.GAME_STATE_BASE[this.platform],this.platform)}}class Ut extends _{constructor(e,t){super(e,t),this.displayHUD()}handleStateChange(e,t,...s){return this.platform=t,this.hideHUD(),new X(m.hudHints.GAME_STATE_BASE[this.platform],this.platform)}}var k=(i=>(i[i.START=0]="START",i[i.BASE=1]="BASE",i[i.HIGHLIGHT=2]="HIGHLIGHT",i[i.GRAB=3]="GRAB",i[i.ACTIVATE=4]="ACTIVATE",i))(k||{});class zt{onStateChangeObervable=new w;currentGameState;platform;constructor(){this.currentGameState=new _(null,"desktop"),this.onStateChangeObervable.add(e=>{this.#e(e)}),this.platform="desktop",B.onHasAnyTargetsObservable.add(e=>{e?this.#e(2):this.#e(1)}),B.onModeChangeObservable.add(e=>{this.platform=this.#t(e),this.platform!=="loading"&&this.platform!=="null"&&this.#e(1)})}#e(e){let t=this.currentGameState.handleStateChange(e,this.platform);t!==null&&(this.currentGameState=t)}#t(e){switch(e){case C.DESKTOP:return"desktop";case C.MOBILE:return"mobile";case C.XR:return"xr";case C.LOADING:return"loading";default:return"null"}}}let te;const qt=()=>{te=new zt,fetch(ot).then(i=>i.json()).then(i=>{m.hudHints=Object.assign({},i)})},me=(i=!0)=>{let e=W.CreateFullscreenUI("UI"),t=L("action",0,"blue","white");t.height="60px",t.width="60px",t.isPointerBlocker=!0,console.log(S.HORIZONTAL_ALIGNMENT_RIGHT),i?t.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_RIGHT:t.horizontalAlignment=S.HORIZONTAL_ALIGNMENT_LEFT,t.isVisible=!0,t.alpha=.4;let s=150,n=-50;return i?t.leftInPixels-=s:t.leftInPixels-=-s,t.top=n,e.addControl(t),t};let E,B;const y=[];let V,U,re=!0;function $t(){re=!1;const i=N?.utilityLayerScene.getMeshByName("reticle");i&&(i.isVisible=!1)}function ve(){re=!0;const i=N?.utilityLayerScene.getMeshByName("reticle");i&&(i.isVisible=!0)}let N;async function Wt(i){const e=new qe(i),t=new $e("light1",new g(1,1,0),e),s=new We("camera",je),n=document.getElementById("canvas");let a=!1;("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.maxTouchPoints>0)&&(a=!0),a?(Ze(e),V=me(),U=me(!1)):n.addEventListener("click",()=>{re&&n.requestPointerLock()}),Zt(e,!0),Ye(s),e.activeCamera=s,e.activeCamera.attachControl(n,!0),t.intensity=0,J.audioEngine.useCustomUnlockedButton=!0,N=new Xe(e);const o=Lt("reticle",N.utilityLayerScene);if(o.setParent(s),o.position.copyFrom(Te.Z),y.push(o.name),"xr"in window.navigator){E=await e.createDefaultXRExperienceAsync(Nt),B=new ae(e,E),await Ft(E),y.push(...e.meshes.map(d=>d.name));for(const d of E.input.controllers)y.push(d.pointer.name),d.grip&&y.push(d.grip.name);E.input.onControllerAddedObservable.add(d=>{y.push(d.pointer.name),d.grip&&y.push(d.grip.name)}),E.input.onControllerRemovedObservable.add(d=>{let c=y.findIndex(b=>b===d.pointer.name);c!==-1&&y.splice(c,1),d.grip&&(c=y.findIndex(b=>b===d.grip.name),c!==-1&&y.splice(c,1))}),y.push("laserPointer"),o.isVisible=E.baseExperience.state!==F.IN_XR,E.baseExperience.onStateChangedObservable.add(d=>{o.isVisible=d!==F.IN_XR})}qt(),await Dt("./json/sounds.json"),await ie(e);const r=document.querySelector("div.splash");let l=await(await fetch("./images/Notebook.svg")).text();return r.style.opacity=0,r.innerHTML=l,setTimeout(()=>r.style.opacity=1,1e3),r.addEventListener("click",()=>{r.classList.add("hide"),J.audioEngine.audioContext.resume()},!1),e}function Xt(i){let e=setInterval(()=>{i.intensity>=1?clearInterval(e):i.intensity+=.1},60)}async function ie(i){const e=i.getLightByName("light1");e.intensity=0;const t=i.activeCamera,s=i.meshes.filter(h=>!y.includes(h.name)).concat(N.utilityLayerScene.meshes.filter(h=>!y.includes(h.name)));for(const h of s)h.dispose();const a=(await Ce()).map(h=>h.meshes).flat();At(a),nt(a),it(i),Oe(t),"xr"in window.navigator&&(E.teleportation.removeFloorMeshByName("Floor"),E.teleportation.addFloorMesh(i.getMeshByName("Floor"))),document.exitPointerLock(),te.onStateChangeObervable.notifyObservers(k.START);const o=document.getElementById("canvas"),r=h=>{te.onStateChangeObervable.notifyObservers(k.BASE),o.removeEventListener("click",r)};return o.addEventListener("click",r),Xt(e),i}function Zt(i,e){i.collisionsEnabled=!0}function jt(i){window.addEventListener("resize",function(){i.resize()})}const Kt=document.getElementById("canvas"),se=new J(Kt,!0,{stencil:!0});jt(se);Wt(se).then(i=>{se.runRenderLoop(()=>i.render())});
