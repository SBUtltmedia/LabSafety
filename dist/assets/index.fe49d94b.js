var he=Object.defineProperty;var ce=(c,e,i)=>e in c?he(c,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[e]=i;var l=(c,e,i)=>(ce(c,typeof e!="symbol"?e+"":e,i),i),de=(c,e,i)=>{if(!e.has(c))throw TypeError("Cannot "+i)};var K=(c,e,i)=>(de(c,e,"read from private field"),i?i.call(c):e.get(c)),Y=(c,e,i)=>{if(e.has(c))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(c):e.set(c,i)};import{H as me,M as te,V as f,S as L,D as ie,P as H,T as _,C as X,a as P,b as ue,A as S,c as ge,B as j,d as pe,W as Z,E as T,R as fe,e as Q,f as G,g as ye,h as be,i as Ce,j as Me,k as xe,l as Se,m as Pe,U as Ae,n as ve,o as we}from"./vendor.582c87b1.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(n){if(n.ep)return;n.ep=!0;const o=i(n);fetch(n.href,o)}})();window.exports=window;class Ie{constructor(e,i,t,n=0){l(this,"complete",!1);l(this,"title");l(this,"description");l(this,"failed",!1);l(this,"onFail");l(this,"onSuccess");l(this,"onCompletion");l(this,"currentState");l(this,"tasks");l(this,"resetSOP",()=>{this.currentState=0,this.failed=!1,this.complete=!1});this.title=e,this.description=i,this.tasks=t,this.currentState=n}}const R="./",N=60,Ne=50,se=3,v="cylinder",B="liquid",Be="placard",b=new Ie("","",[{next:"CtoA",label:"BtoC"},{next:"complete",label:"CtoA"}]);function M(c,e){return c.getChildMeshes().find(i=>i.name===e)||null}function F(c){c.rotation.x=0,c.rotation.y=0,c.rotation.z=0}function ne(c){c.position.x=0,c.position.y=0,c.position.z=0}class ${constructor(e,i,t,n){l(this,"name");l(this,"position");l(this,"mesh");l(this,"dragCollision");l(this,"highlightLayer");l(this,"scene");l(this,"particleSystem");l(this,"currentColor");l(this,"originalColor");l(this,"startOpacity");console.log(e),this.name=t,this.currentColor=n,this.originalColor=n,this.startOpacity=.7;const o=e.getScene();this.scene=o,this.highlightLayer=new me("highlight-layer",o),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1;const a=o.getMeshByName("Table");let s=te.CreateSphere(`pivot-Cylinder-${t}`,{segments:2,diameterX:.15,diameterY:.33,diameterZ:.2},e.getScene());if(s.visibility=0,e.name=t,e.parent=s,e.rotationQuaternion=null,e.getChildMeshes().forEach(C=>{switch(C.name){case"BeakerwOpacity":C.name=v,C.rotationQuaternion=null,C.rotation.z=2*Math.PI,C.isPickable=!1;break;case"BeakerLiquid":C.name=B,C.isPickable=!1;break}}),a){const C=a.getBoundingInfo().boundingBox,O=M(e,v).getBoundingInfo().boundingBox.maximum.y;console.log(O),s.position.y=C.maximumWorld.y+O/2+.05,s.position.x=(C.maximumWorld.x-C.minimumWorld.x)/se*i+C.minimumWorld.x-.3,s.position.z=(C.centerWorld.z+C.minimumWorld.z)/2,this.position={...s.position}}else s.position.x=-2+i,s.position.y=1.22,s.position.z=.5,console.log("Else!");s.checkCollisions=!0,s.ellipsoid=new f(.02,.12,.02),console.log(s.ellipsoid.length()),this.mesh=s;const d=M(e,B),g=new L("liquid-material");g.diffuseColor=n,d.material=g;const m=M(e,"Label"),r=M(e,"LabelBack");console.log("Label:",r);const u=new ie("dynamic texture",256,o),p=new L("Mat",o);p.diffuseTexture=u,m.material=p,r.material=p;const y="bold 300px monospace";u.drawText(e.name.toUpperCase(),65,225,y,"black","white");let A=this.mesh.getChildMeshes().find(C=>C.name==="cylinder");this.mesh.animations=A.animations,console.log("Children: ",this.mesh.getChildMeshes());const x=new H("particles",500,this.scene);x.particleTexture=new _("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),x.minLifeTime=.5,x.maxLifeTime=.7,x.emitRate=100,x.gravity=new f(0,.5,0),x.minSize=.01,x.maxSize=.07,x.createPointEmitter(new f(0,0,0),new f(0,1,0)),x.addColorGradient(1,X.FromColor3(d.material.diffuseColor,1)),x.blendMode=H.BLENDMODE_STANDARD,x.emitter=this.mesh.position,this.particleSystem=x,this.setOpacity(this.startOpacity),this.addDragCollision()}startParticles(){this.particleSystem.start()}highlight(e=!0){let i=M(this.mesh,v);e?(console.log("Adding mesh"),this.highlightLayer.hasMesh(i)||this.highlightLayer.addMesh(i,P.Green())):this.highlightLayer.hasMesh(i)&&this.highlightLayer.removeMesh(i)}addDragCollision(){let e=new ue({dragPlaneNormal:new f(0,0,1)});e.useObjectOrientationForDragging=!1,e.moveAttached=!1,e.onDragStartObservable.add(()=>{}),e.onDragObservable.add(i=>{this.mesh.moveWithCollisions(i.delta)}),e.onDragEndObservable.add(()=>{this.fadeAndRespawn()}),this.mesh.addBehavior(e),this.dragCollision=e}removeDragCollision(){this.mesh.removeBehavior(this.dragCollision)}fadeAndRespawn(e=Ne,i=null){setTimeout(()=>{let t=this.mesh.getBehaviorByName("PointerDrag");t&&t.releaseDrag(),this.mesh.isPickable=!1;let n=60;this.mesh.name.split("-")[0];let o=this.mesh.getScene(),a=this.mesh.getChildMeshes(),s=a.find(m=>m.name==="cylinder");a.find(m=>m.name==="liquid");const d=M(this.mesh,B);console.log("Visibility: ",d.visibility);let g=[{name:"Invisibility",startValue:d.visibility},{name:"Visibility",startValue:0}];g.forEach(m=>{m.init=new S(m.name,"visibility",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),m.init.setKeys([{frame:0,value:m.startValue},{frame:n,value:d.visibility-m.startValue}])});for(let m=0;m<a.length-1;++m){let r=a[m];o.beginDirectAnimation(r,[g[0].init],0,60,!1)}o.beginDirectAnimation(a[a.length-1],[g[0].init],0,60,!1,void 0,()=>{console.log(this.mesh,this.position),this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z,this.mesh.animations=s.animations;let m=M(this.mesh,v);F(this.mesh),F(m),ne(m);for(let r=0;r<a.length-1;++r){let u=a[r];o.beginDirectAnimation(u,[g[1].init],0,60,!1)}o.beginDirectAnimation(a[a.length-1],[g[1].init],0,60,!1,void 0,()=>{if(this.highlight(!1),this.mesh.isPickable=!0,i)for(let r of i)r&&(r.handMesh.visibility=1,r.dropped())})})},e)}rotateAroundZ(){let e=this.mesh.getAnimationByName(`${this.name}-rotateAroundZ`);this.scene.beginDirectAnimation(M(this.mesh,v),[e],0,60,!1,void 0,()=>{})}resetAroundZ(){let e=this.mesh.getAnimationByName(`${this.name}-resetRotateAroundZ`);this.scene.beginDirectAnimation(M(this.mesh,v),[e],0,60,!1,void 0,()=>{})}setColor(e){const i=M(this.mesh,B),t=new L("liquid-material");t.diffuseColor=e,i.material=t,this.currentColor=e,console.log(this.currentColor)}setOpacity(e){const i=M(this.mesh,B);i.visibility=e}resetProperties(){this.setOpacity(this.startOpacity),this.setColor(this.originalColor)}showEffects(e=!0){if(e){this.particleSystem.particleTexture=new _("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),this.particleSystem.minLifeTime=.5,this.particleSystem.maxLifeTime=.7,this.particleSystem.emitRate=100,this.particleSystem.gravity=new f(0,.5,0),this.particleSystem.minSize=.01,this.particleSystem.maxSize=.07,this.particleSystem.createPointEmitter(new f(0,0,0),new f(0,1,0));const i=M(this.mesh,B);this.particleSystem.addColorGradient(1,X.FromColor3(i.material.diffuseColor,1)),this.particleSystem.blendMode=H.BLENDMODE_STANDARD,this.particleSystem.emitter=this.mesh.position,this.particleSystem.start()}else this.particleSystem.stop()}}const Oe="Stony Brook University VR Laboratory",Le="Victor Ruben",Te="VR Chemical Mixture Synthesis",Ee="4/1/2022",ke="General: Properly mixing VR chemicals",De="42",Re="I",_e=[{text:"HAZARD IDENTIFICATION test from JSON",sublistType:"a",sublist:[{text:"Improper mixing of chemicals can lead to explosive results!"}]},{text:"CHEMICAL HANDLING PROCEDURES",sublistType:"a",sublist:[{text:"When mixing these chemicals - always follow the correct sequence"},{text:"Pour chemical B into chemical C"},{text:"Then pour chemical mixture B+C into chemical A"}]},{text:"EMERGENCY PROCEDURES",sublistType:"a",sublist:[{text:"In the event of an improper mixture - use the fire extinguisher to put out the flames"},{text:"Evacuate the lab"},{text:"Call for emergency services"}]}],J={facility:Oe,labDirector:Le,scope:Te,lastRevision:Ee,general:ke,sopNum:De,listType:Re,items:_e};function Fe(c){c.name="clipboard";const e=c.getScene(),i=e.getMeshByName("Table");if(i){const a=i.getBoundingInfo().boundingBox;c.position.y=a.maximumWorld.y+.003}c.rotationQuaternion=null,c.rotation=new f(0,Math.PI/4,0);const t=e.getMeshByName("pivot-Cylinder-A");t&&(c.position.x=t.position.x+.2,c.position.z=t.position.z+.5);function n(a){console.log("data: ",J);let s=document.createElement("template");s.innerHTML=a;var d=ge.compile(s.innerHTML),g=d(J);return s.innerHTML=g,s.content}function o(a){const d="data:image/svg+xml;utf8,"+encodeURIComponent(a),g=_.LoadFromDataString("tex",d,e,void 0,void 0,void 0,_.LINEAR_LINEAR_MIPNEAREST);let m=new L("mat",e);m.diffuseTexture=g,g.uScale=1,g.vScale=-1,m.emissiveColor=P.White(),m.useAlphaFromDiffuseTexture=!0,g.hasAlpha=!0;let r=M(c,"Plane");r.material=m,console.log("Material set")}fetch(`${R}images/sopTemplate.svg`).then(a=>a.text()).then(a=>{console.log("fetched!");let s=n(a),d=s.getElementById("procedure-list");console.log(d);const m=new XMLSerializer().serializeToString(s);o(m)}).catch(console.error.bind(console))}function ze(c){var e=new j(P.FromHexString("#0984e3"));e.ignoreChildren=!0;var i=c[0],t=j.MakeNotPickableAndWrapInBoundingBox(i);e.attachedMesh=t,e.onScaleBoxDragObservable.add(()=>{console.log("scaleDrag")}),e.onScaleBoxDragEndObservable.add(()=>{const n=e.attachedMesh;if(n){const o=n.getHierarchyBoundingVectors(!0);console.log("size x:",o.max.x-o.min.x),console.log("size y:",o.max.y-o.min.y),console.log("size z:",o.max.z-o.min.z)}console.log("scaleEnd")}),e.onRotationSphereDragObservable.add(()=>{console.log("rotDrag")}),e.onRotationSphereDragEndObservable.add(()=>{console.log("rotEnd")})}function U(c,e,i){const t=c.find(r=>r.name==="__root__"),n=t.getScene();t.name=i;const o=c.find(r=>r.name==="Label"),a=c.find(r=>r.name==="Placard");a.name=Be;const s=new ie("dynamic texture",256,n);s.wAng=-Math.PI/2,s.uAng=Math.PI;const d=new L("Mat",n);d.diffuseTexture=s,o.material=d;const g="bold 220px monospace";s.drawText(t.name.split("-")[1].toUpperCase(),65,185,g,"black","white"),a.addChild(o),a.rotationQuaternion=null,a.rotation=new f(0,Math.PI/2,0);const m=n.getMeshByName("Table");if(m){const r=m.getBoundingInfo().boundingBox;t.position.y=r.maximumWorld.y+.003,t.position.x=(r.maximumWorld.x-r.minimumWorld.x)/se*e+r.minimumWorld.x-.2,t.position.z=(r.centerWorld.z+r.minimumWorld.z)/2+.2}}function We(c,e,i){let t;return new Promise(n=>{const o="./models/";let a="";var s={};let d=["left","right"];const g=new pe(c);d.forEach(r=>{g.addMeshTask(`load ${r} hand`,"",o,`${r}${a}.glb`)});let m=0;g.onTaskSuccess=r=>{s[d[m]]=r.loadedMeshes[1],r.loadedMeshes[1].name=d[m],t=r.loadedAnimationGroups;for(let u=0;u<t.length;u++)t[u].name=`${d[m]}_${t[u].name}`;m++},g.onTasksDoneObservable.add(()=>{for(let r=0;r<c.animationGroups.length;r++)c.animationGroups[r].pause();e.input.onControllerAddedObservable.add(r=>{let u=r.inputSource.handedness;console.log(s[u]);let p=s[u].parent.parent;s[u].isPickable=!1;for(let h of i)h.removeDragCollision();let y=(Object.keys(s).indexOf(u)-1)*2-1;s[u].rotation.y=Math.PI*y,s[u].rotation.z=-Math.PI/2,s[u].rotation.x=-Math.PI/4,p.parent=r.grip||r.pointer}),e.baseExperience.onStateChangedObservable.add(r=>{if(r===Z.IN_XR){e.baseExperience.camera.position.y=1.5,e.baseExperience.camera.position.z=-.5;let u=c.getMeshByName("Start");if(u){let p=e.baseExperience.camera;u.parent=p,u.position=p.position.add(new f(-p.position.x,-1.5,1.15)),e.pointerSelection.displayLaserPointer=!0,e.pointerSelection.displaySelectionMesh=!0,u.rotation=f.Zero()}}}),e.baseExperience.camera.onAfterCameraTeleport.add(r=>{e.baseExperience.camera.position.y=.5})}),g.loadAsync().then(()=>{n(t)})})}class oe{constructor(e,i,t,n,o){l(this,"cylinderInstances");l(this,"clipboard");l(this,"scene");l(this,"labels");l(this,"guiManager");l(this,"soundManager");l(this,"xrCamera");console.log("Cylinders interact: ",i),this.labels=["A","B","C"],this.scene=e,this.cylinderInstances=i,this.guiManager=t,this.soundManager=n,this.xrCamera=o}getCylinderInstanceFromMesh(e){let i=e.name.split("-")[2];for(let t of this.cylinderInstances)if(t.name==i)return t;return null}intersectHandCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(e.intersectsMesh(t,!1)&&t.isPickable)return t}return null}intersectCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(t!=e&&e.intersectsMesh(t))return t}return null}highlightAndRotateCylinders(e,i,t){e.highlight(),i.highlight();let n=e.mesh.getAbsolutePosition()._x,o=i.mesh.getAbsolutePosition()._x;if(o<n?(e.mesh.rotation.y=Math.PI,i.mesh.rotation.y=e.mesh.rotation.y):(e.mesh.rotation.y=0,i.mesh.rotation.y=e.mesh.rotation.y),!t){t=!0;let a=e.mesh.getHierarchyBoundingVectors(),s=a.max.y-a.min.y,d=-.09,m=n-o,r=M(e.mesh,v);o<n?(r.position.x=m+d,r.position.y=s-.2):(r.position.x=m-d,r.position.y=s-.2),e.rotateAroundZ()}return t}moveWithCollisions(e,i){e.moveWithCollisions(i)}addColors(e,i){let t=e.currentColor,n=i.currentColor,o=new P((t.r+n.r)/2,(t.g+n.g)/2,(t.b+n.b)/2);i.setColor(o)}showFinishScreen(){console.log("XR this: ",this.xrCamera),this.guiManager.createPromptWithButton("You have completed the task! The scene will now reset!",this.xrCamera)}playExplosion(){console.log(this.soundManager.loadedSounds.explosion);let e=this.soundManager.loadedSounds.explosion;e.stop(),e.play()}playDing(){let e=this.soundManager.loadedSounds.ding;e.stop(),e.play()}playSuccess(){let e=this.soundManager.loadedSounds.success;console.log("Success: ",e),e.stop(),e.play()}}class ae extends oe{constructor(i,t,n,o,a){super(i,t,n,o,a);l(this,"particleSystem")}resetCylinders(){this.particleSystem&&this.particleSystem.stop();let i=["A","B","C"];for(let t=0;t<i.length;t++){const n=this.scene.getMeshByName(`pivot-Cylinder-${i[t]}`),o=this.scene.getMeshByName("Table");if(o&&n){const a=o.getBoundingInfo().boundingBox;n.position.z=(a.centerWorld.z+a.minimumWorld.z)/2}super.getCylinderInstanceFromMesh(n).showEffects(!1),super.getCylinderInstanceFromMesh(n).setOpacity(.85),super.getCylinderInstanceFromMesh(n).setColor(super.getCylinderInstanceFromMesh(n).originalColor),t==0&&(super.getCylinderInstanceFromMesh(n).setColor(P.Red()),super.getCylinderInstanceFromMesh(n).currentColor=P.Red())}}postSceneCylinder(){let i=["A","B","C"],t=[];for(let a of i){const s=this.scene.getMeshByName(`pivot-Cylinder-${a}`);t.push(s);let d=new S(`${a}-rotateAroundZ`,"rotation.z",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),g=M(s,v);const m=[];m.push({frame:0,value:Math.PI*2}),m.push({frame:60,value:4.62}),g.animations.push(d),d.setKeys(m);let r=new S(`${a}-resetRotateAroundZ`,"rotation.z",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT);const u=[];u.push({frame:0,value:4.62}),u.push({frame:60,value:Math.PI*2}),g.animations.push(r),r.setKeys(u)}let n=!1,o=!1;for(let a=0;a<i.length;a++){const s=this.scene.getMeshByName(`pivot-Cylinder-${i[a]}`);let d=super.getCylinderInstanceFromMesh(s);const g=s.getBehaviorByName("PointerDrag");console.log(g);let m=[];for(let p of t)p!=s&&m.push(p);let r=M(s,v),u=!1;g.onDragObservable.add(()=>{T.audioEngine.unlock(),T.audioEngine.audioContext.resume();let p=!1,y=!1;F(s);const h=super.intersectCylinder(s);if(h){let A=super.getCylinderInstanceFromMesh(h);y=!0;let x=h.name.split("-")[2],I=`${s.name.split("-")[2]}to${x}`;b.tasks[b.currentState].label===I?(o=!0,b.tasks[b.currentState].next==="complete"?(p=!0,console.log(A),setTimeout(()=>{super.playSuccess()},300),d.fadeAndRespawn(),b.resetSOP(),this.resetCylinders(),super.showFinishScreen()):(b.currentState=b.tasks.indexOf(b.tasks.find(E=>E.label==b.tasks[b.currentState].next)),super.playDing())):!n&&!o&&(A.showEffects(!0),super.playExplosion(),n=!0);let w=s.getAbsolutePosition()._x;h.getAbsolutePosition()._x<w?(r.rotation.y=Math.PI,h.rotation.y=r.rotation.y):(r.rotation.y=0,h.rotation.y=r.rotation.y),u||(u=super.highlightAndRotateCylinders(d,A,u),h.name.split("-")[2],s.name.split("-")[2],p||super.addColors(d,A))}else d.highlight(!1),F(s);y==!1&&(d.highlight(!1),o=!1,u&&(r.position.x=0,r.position.y=0,u=!1,d.resetAroundZ()))}),g.onDragEndObservable.add(()=>{M(s,v).getBehaviorByName("Highlight");for(let p of m)p!=r&&(d.highlight(!1),super.getCylinderInstanceFromMesh(p).highlight(!1),r.intersectsMesh(p)&&(d.resetAroundZ(),r.position.x=0,r.position.y=0,u=!1))})}}}class ee extends oe{constructor(i,t,n,o,a,s){console.log("Cylinders hand: ",n);super(t,n,o,a,s);l(this,"handedness");l(this,"holdingInstance");l(this,"holdingMesh");l(this,"targetMesh");l(this,"targetMeshInstance");l(this,"motionController");l(this,"handMesh");l(this,"isVisible");l(this,"failBeaker");l(this,"particleSystem");l(this,"cylinderInstancesHand");this.handedness=i,this.handMesh=t.getMeshByName(this.handedness),this.isVisible=!0,this.failBeaker=!1}getMotionController(){return this.motionController}setMotionController(i){this.motionController=i}dropped(i=null){this.motionController.lastPosition=null,i&&clearInterval(i),this.motionController.grabbed=!1,this.motionController.meshGrabbed=void 0,console.log(this.holdingMesh),this.holdingMesh&&(this.holdingInstance.fadeAndRespawn(100),this.holdingMesh=null,this.holdingInstance=null,this.motionController.meshGrabbed=null)}updateSOPTask(i,t,n){console.log(this.scene);let o=`${i}to${t}`;if(b.tasks[b.currentState].label===o)if(b.tasks[b.currentState].next==="complete"){console.log("GUI mgr",this.guiManager,"Sound mgr: ",this.soundManager);let a=new ae(this.scene,this.cylinderInstances,this.guiManager,this.soundManager,this.xrCamera);for(let s of this.cylinderInstances)s.fadeAndRespawn(100);if(super.playSuccess(),console.log("Showing finish screen!"),this.xrCamera.baseExperience.state==Z.IN_XR){super.showFinishScreen();let s=this.scene.getMeshByName("Start");if(s){let d=this.xrCamera.baseExperience.camera;s.parent=d,s.position=d.position.add(new f(-d.position.x,-1.5,1.15)),this.xrCamera.pointerSelection.displayLaserPointer=!0,this.xrCamera.pointerSelection.displaySelectionMesh=!0,s.rotation=f.Zero()}}b.resetSOP(),this.disappearAnimation(!1),this.dropped(n),this.particleSystem&&(this.particleSystem.stop(),console.log("Stopping particle system!")),a.resetCylinders();for(let s of this.cylinderInstances)s.resetProperties(),s.showEffects(!1);return!0}else return super.playDing(),b.currentState=b.tasks.indexOf(b.tasks.find(a=>a.label==b.tasks[b.currentState].next)),!1;else this.failBeaker||(super.playExplosion(),this.targetMeshInstance.showEffects(!0));return!1}disappearAnimation(i=!0){console.log("DISAPPEAR: ",i);let t=60,n=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}];n.forEach(o=>{o.init=new S(o.name,"visibility",120,S.ANIMATIONTYPE_FLOAT,S.ANIMATIONLOOPMODE_CONSTANT),o.init.setKeys([{frame:0,value:o.startValue},{frame:t,value:1-o.startValue}])}),console.log(this.handMesh),i?(this.isVisible=!1,this.scene.beginDirectAnimation(this.handMesh,[n[0].init],0,60,!1)):(this.isVisible=!0,this.scene.beginDirectAnimation(this.handMesh,[n[1].init],0,60,!1))}}function Ve(c,e,i,t,n,o){let a=new ee("right",c,t,n,o,e),s=new ee("left",c,t,n,o,e),d=!1,g={right:a,left:s},m=!1;function r(u){let p=u.name.split("-")[2];console.log("Name: ",p);for(let y of t)if(console.log("Instance name: ",y.name),y.name==p)return y;return null}e.input.onControllerAddedObservable.add(u=>{u.onMotionControllerInitObservable.add(p=>{let y=p;y.handID=p.handedness;let h=g[y.handedness];h.getMotionController()||h.setMotionController(y),console.log(h);let A=new fe(f.Zero(),f.Zero(),.25);const x=p.getComponentOfType("squeeze");p.getComponentOfType("trigger"),[x].forEach(C=>{console.log(c.getMeshByName("left")),C.onButtonStateChangedObservable.add(I=>{let w,O={left:"Fist",right:"Grip"},E=c.animationGroups.find((W,V)=>W.name===`${h.motionController.handID}_${O[h.motionController.handID]}`);E.goToFrame(I.value*(E._to-1)+1);let k=h.intersectHandCylinder(c.getMeshByName(y.handID));if(console.log("Grabbed Cylinder: ",k),I.value>.5&&!h.motionController.grabbed){if(k){T.audioEngine.unlock(),d=!1,h.holdingMesh=k,h.holdingInstance=r(h.holdingMesh),h.motionController.meshGrabbed=h.holdingMesh,h.motionController.grabbed=!0;let W=h.motionController.lastPosition,V=A.origin;V!=W&&(h.disappearAnimation(!0),w=setInterval(()=>{let q=h.motionController.lastPosition;if(u.getWorldPointerRayToRef(A),q&&h.holdingMesh&&h.moveWithCollisions(h.holdingMesh,V.subtract(q)),!h.intersectHandCylinder(c.getMeshByName(h.motionController.handID))&&h.holdingMesh&&(h.targetMeshInstance&&h.targetMeshInstance.highlight(!1),h.dropped(w),h.motionController.grabbed=!1,h.handMesh.visibility=1,d=!0),h.holdingMesh){let D=h.intersectCylinder(h.holdingMesh);if(D){h.targetMesh=D,h.targetMeshInstance=r(D);let le=D.name.split("-")[2],re=h.holdingMesh.name.split("-")[2];m||(h.addColors(h.holdingInstance,h.targetMeshInstance),m=h.highlightAndRotateCylinders(h.holdingInstance,h.targetMeshInstance,m),d=h.updateSOPTask(re,le,w))}else h.targetMeshInstance&&h.targetMeshInstance.highlight(!1),h.holdingInstance.highlight(!1),m&&(h.holdingInstance.resetAroundZ(),ne(M(h.holdingMesh,v)),m=!1)}d||(h.motionController.lastPosition=Object.assign({},A.origin),y.lastPosition=Object.assign({},A.origin))},10))}}else(!I.value||!k)&&h.holdingMesh&&(h.holdingInstance.highlight(!1),h.motionController.grabbed=!1,h.targetMeshInstance&&h.targetMeshInstance.highlight(!1),h.dropped(w),h.disappearAnimation(!1))})})})})}var z;class He{constructor(e){l(this,"flying",!1);l(this,"active",!1);l(this,"camera");l(this,"mesh");l(this,"offset",.3);l(this,"animations");l(this,"returnPosition");l(this,"returnRotation");l(this,"onPointerDownObserver");l(this,"xrCamera");l(this,"attach",(e,i,t,n,o)=>{const a=e.getScene();if(this.mesh=e,!i&&(i=a.activeCamera,!i))throw new Error("The scene has no active camera, and no camera was provided.");this.camera=i,t||(t=this.mesh.position),n||(n=this.mesh.rotation),o&&(this.offset=o),this.returnPosition=t,this.returnRotation=n,this.onPointerDownObserver=a.onPointerObservable.add(this.clipboardClick)});l(this,"detach",()=>{this.mesh.getScene().onPointerObservable.remove(this.onPointerDownObserver)});l(this,"clipboardClick",(e={type:Q.POINTERDOWN,pickInfo:{pickedMesh:this.mesh}})=>{var i;if(e.type===Q.POINTERDOWN){console.log("Clipboard click");const t=(i=e.pickInfo)==null?void 0:i.pickedMesh;if(t&&(t===this.mesh||t.isDescendantOf(this.mesh))&&!this.flying||this.active){const n=this.active?N/2:0,o=this.active?0:N/2;K(this,z).call(this),this.flying=!0,this.mesh.billboardMode==G.BILLBOARDMODE_ALL?this.mesh.billboardMode=G.BILLBOARDMODE_NONE:this.mesh.billboardMode=G.BILLBOARDMODE_ALL,this.mesh.getScene().beginDirectAnimation(this.mesh,this.animations,n,o,!1,void 0,()=>{this.flying=!1,this.active=!this.active})}}});l(this,"calculateTargetPositionWithOffset",e=>{if(this.xrCamera!==void 0&&this.xrCamera.state===Z.IN_XR){const a=this.xrCamera.camera._position.subtract(this.returnPosition).scale(1-e/f.Distance(this.returnPosition,this.xrCamera.camera._position));return this.returnPosition.add(a)}const t=this.camera._position.subtract(this.returnPosition).scale(1-e/f.Distance(this.returnPosition,this.camera._position));return this.returnPosition.add(t)});l(this,"setClipboardUp",()=>new f(3.1468286,4.6617744,1.680752));Y(this,z,()=>{const e=this.animations.find(({name:o})=>o==="translate"),i=this.animations.find(({name:o})=>o==="rotate"),t=[{frame:0,value:this.returnPosition},{frame:N/2,value:this.calculateTargetPositionWithOffset(this.offset)}],n=[{frame:0,value:this.returnRotation},{frame:N/2,value:this.setClipboardUp()}];e.setKeys(t),i.setKeys(n)});const i=new S("translate","position",N,S.ANIMATIONTYPE_VECTOR3),t=new S("rotate","rotation",N,S.ANIMATIONTYPE_VECTOR3);this.animations=[i,t],this.xrCamera=e}get name(){return"FlyToCamera"}init(){}}z=new WeakMap;class Ge{constructor(e,i,t){l(this,"rect");l(this,"text");l(this,"button");this.rect=e,this.text=i,this.button=t}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e}}class $e{constructor(e){l(this,"advancedTexture");l(this,"welcomePrompt");l(this,"gameFinishPrompt");l(this,"camera");l(this,"screen");l(this,"scene");this.scene=e,this.camera=e.activeCamera,console.log("Scene: ",this.scene)}createPromptWithButton(e,i=null,t=null){this.screen=te.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=this.camera.position.add(new f(.7,-2,2.5)),this.advancedTexture=ye.CreateForMesh(this.screen);let n=new be("container");var o=new Ce;o.width=.5,o.height=.2,o.color="cyan",o.thickness=4,o.background="white",n.addControl(o);var a=new Me;a.text=e,a.color="black",a.fontSize="17px",a.resizeToFit=!0,a.textWrapping=!0,a.paddingBottomInPixels=40,a.paddingLeftInPixels=15,a.paddingRightInPixels=15,o.addControl(a);var s=xe.CreateSimpleButton("but1","Click to dismiss");s.width="150px",s.height="40px",s.color="black",s.cornerRadius=20,s.background="white",s.topInPixels=40;let d=new Ge(o,a,s),g=this.scene.getMeshByName("Start");return d.button.onPointerUpObservable.add(function(){n.dispose(),g.dispose(),console.log("XR cam: ",i),i&&(console.log("Hiding Pointer!"),i.pointerSelection.displayLaserPointer=!1,i.pointerSelection.displaySelectionMesh=!1)}),d.button.onPointerEnterObservable.add(()=>{s.background="grey"}),d.button.onPointerOutObservable.add(()=>{s.background="white"}),n.addControl(d.button),n.addControl(s),this.advancedTexture.addControl(n),d}}class Ue{constructor(e,i){l(this,"soundList");l(this,"soundPointer");l(this,"scene");l(this,"loadedSounds");this.scene=i,this.soundPointer=0,this.soundList=e,this.loadedSounds={}}async loadSounds(){let e=[];return new Promise(i=>{let t=0;this.soundList.forEach(n=>{if(e.push({soundName:n.soundName,sound:new Se(n.soundName,n.fileName,this.scene,()=>{T.audioEngine.unlock()},{})}),t++,t===this.soundList.length){for(let o of e)this.loadedSounds[o.soundName]=o.sound;i(e),console.log("Sounds loaded!!",this.loadedSounds)}})})}}console.log=()=>{};class Ze{constructor(){l(this,"handAnimation");l(this,"sop");l(this,"models");l(this,"cylinders");l(this,"guiManager");l(this,"soundManager");l(this,"loadedSounds");this.cylinders=[];let e="TLLGraduatedCylinderNewLabel.glb";this.models=[{fileName:"LabWithTable.glb",callback:t=>this.createRoom(t),label:"floor"},{fileName:"Placard_Label.glb",callback:t=>U(t,1,"Placard-A")},{fileName:"Placard_Label.glb",callback:t=>U(t,2,"Placard-B")},{fileName:"Placard_Label.glb",callback:t=>U(t,3,"Placard-C")},{fileName:e,callback:t=>this.cylinders.push(new $(t[0],1,"A",new P(1,0,0))),label:"Cylinder-A"},{fileName:e,callback:t=>this.cylinders.push(new $(t[0],2,"B",new P(0,1,0))),label:"Cylinder-B"},{fileName:e,callback:t=>this.cylinders.push(new $(t[0],3,"C",new P(0,0,1))),label:"Cylinder-C"},{fileName:"clipBoardWithPaperCompressedTextureNew.glb",callback:t=>Fe(t[0])}].map(function(t){return Object.assign({},{fileName:"LabBench.glb",root:"./models/",callback:ze,label:"NoLabel"},t)});let i=[{soundName:"explosion",fileName:`${R}/sound/mi_explosion_03_hpx.mp3`},{soundName:"ding",fileName:`${R}/sound/ding-idea-40142.mp3`},{soundName:"success",fileName:`${R}/sound/success.mp3`}];this.loadedSounds=[],this.createScene().then(t=>{this.soundManager=new Ue(i,t),this.soundManager.loadSounds().then(n=>{this.loadedSounds=n;for(let o of["A","B","C"])Object.assign({},t.getMeshByName(`pivot-Cylinder-${o}`).position);console.log("Loaded sounds: ",this.loadedSounds);for(let o of this.loadedSounds)console.log(o.sound);this.processScene(t,this.cylinders,this.guiManager,this.soundManager)})})}async processScene(e,i,t,n){let o=e.getCameraByName("camera"),a=e.getLightByName("light1"),s;o.speed=.16;let d=setInterval(()=>{a.intensity>=1?clearInterval(d):a.intensity+=.1},60);const g=["WallsandFloor","WallsAndFloor.001"],m=[];for(let p of g){console.log(p);const y=e.getMeshByName(p);y&&m.push(y)}let r={floorMeshes:m,inputOptions:{doNotLoadControllerMeshes:!0}};s=await e.createDefaultXRExperienceAsync(r);let u=!1;s.pointerSelection.laserPointerDefaultColor=P.Green(),s.pointerSelection.laserPointerPickedColor=P.Green(),s.pointerSelection.selectionMeshPickedColor=P.Green(),s.pointerSelection.selectionMeshDefaultColor=P.Green(),s.pointerSelection.displayLaserPointer=!1,s.pointerSelection.displaySelectionMesh=!1,window.addEventListener("keydown",p=>{p.keyCode===73&&(u?u=!1:u=!0,s.pointerSelection.displayLaserPointer=u,s.pointerSelection.displaySelectionMesh=u)}),We(e,s,i).then(p=>{if(console.log("add webxr"),s){const h=new He(s.baseExperience);e.getMeshByName("clipboard").addBehavior(h)}this.guiManager=new $e(e),this.guiManager.createPromptWithButton("Welcome to the Lab Safety Simulation. Click on the clipboard to learn more about the simulation!",s),console.log("Cylinders app: ",i),new ae(e,i,this.guiManager,n,s).postSceneCylinder(),Ve(e,s,p,i,this.guiManager,this.soundManager)})}createRoom(e){const i=["WallsandFloor","WallsAndFloor.001","Table","Roof","Countertop","Walls"];let t,n;for(let o of i){const a=e.find(s=>s.name===o);if(a&&(a.checkCollisions=!0,a.name==="Table")){const s=a.getBoundingInfo().boundingBox;s.center.x,t=a.getScene(),n=t.getCameraByName("camera"),n.position=new f(s.center.x*-1,s.center.y*2+.5,-1.5),n.rotation=new f(Math.PI/8,0,0)}}}createScene(){return new Promise(e=>{const i=document.getElementById("canvas"),t=new T(i,!0,{stencil:!0}),n=new Pe(t);n.collisionsEnabled=!0,window.addEventListener("resize",function(){t.resize()});const o=new Ae("camera",new f(0,1.84,-1.134),n);o.ellipsoid=new f(.4,.7,.4),o.attachControl(i,!0),o.applyGravity=!0,o.minZ=0,o.speed=0,o.checkCollisions=!0,o.keysUp.push(87),o.keysDown.push(83),o.keysLeft.push(65),o.keysRight.push(68);var a=new ve("light1",new f(1,1,0),n);a.intensity=0,Promise.all(this.models.map(s=>new Promise(d=>we.ImportMesh("",s.root,s.fileName,n,function(g){s.mesh=g,d(g)})))).then(()=>{let s=[];this.models.map(d=>{s.push(d.callback(d.mesh)),e(n)})}),window.addEventListener("keydown",s=>{s.shiftKey&&s.ctrlKey&&s.altKey&&s.keyCode===73&&(n.debugLayer.isVisible()?n.debugLayer.hide():n.debugLayer.show())}),t.runRenderLoop(()=>{n.render()})})}}new Ze;
