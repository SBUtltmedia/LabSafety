var me=Object.defineProperty;var ge=(h,e,i)=>e in h?me(h,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):h[e]=i;var l=(h,e,i)=>(ge(h,typeof e!="symbol"?e+"":e,i),i),ue=(h,e,i)=>{if(!e.has(h))throw TypeError("Cannot "+i)};var X=(h,e,i)=>(ue(h,e,"read from private field"),i?i.call(h):e.get(h)),j=(h,e,i)=>{if(e.has(h))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(h):e.set(h,i)};import{H as pe,M as oe,V as f,S as B,D as se,T as E,P as H,C as Q,a as A,b as fe,A as P,c as ye,B as J,d as be,W as q,E as T,R as Ce,e as ee,f as $,g as Me,h as xe,i as Se,j as Pe,k as Ae,l as ve,m as Ie,n as we,U as Ne,o as Oe,p as Be}from"./vendor.450d7f07.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerpolicy&&(s.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?s.credentials="include":n.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();window.exports=window;class Ee{constructor(e,i,t,n=0){l(this,"complete",!1);l(this,"title");l(this,"description");l(this,"failed",!1);l(this,"onFail");l(this,"onSuccess");l(this,"onCompletion");l(this,"currentState");l(this,"tasks");l(this,"resetSOP",()=>{this.currentState=0,this.failed=!1,this.complete=!1});this.title=e,this.description=i,this.tasks=t,this.currentState=n}}const _="./",w=60,Te=50,ne=3,v="cylinder",N="liquid",Le="placard",S=new Ee("","",[{next:"CtoA",label:"BtoC"},{next:"complete",label:"CtoA"}]);function x(h,e){return h.getChildMeshes().find(i=>i.name===e)||null}function F(h){h.rotation.x=0,h.rotation.y=0,h.rotation.z=0}function ae(h){h.position.x=0,h.position.y=0,h.position.z=0}class Z{constructor(e,i,t,n){l(this,"name");l(this,"position");l(this,"mesh");l(this,"dragCollision");l(this,"highlightLayer");l(this,"scene");l(this,"particleSystem");l(this,"currentColor");l(this,"originalColor");l(this,"startOpacity");l(this,"toggleControllers");l(this,"startPos");l(this,"EllipsoidLines");l(this,"moveFlag");l(this,"pourLocations");l(this,"rotateEnd");l(this,"startRotation");console.log(e),this.name=t,this.moveFlag=!0,this.rotateEnd=!0,this.currentColor=n,this.originalColor=n,this.startOpacity=.7;const s=e.getScene();this.scene=s,this.highlightLayer=new pe("highlight-layer",s),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1;const a=s.getMeshByName("Table");let o=oe.CreateCylinder(`pivot-Cylinder-${t}`,{diameterTop:.1,height:.33,diameterBottom:.1},e.getScene());if(o.position._y+=.1,o.visibility=0,e.name=t,e.parent=o,e.rotationQuaternion=null,e.getChildMeshes().forEach(C=>{switch(C.name){case"BeakerwOpacity":C.name=v,C.rotationQuaternion=null,C.rotation.z=2*Math.PI,C.isPickable=!1;break;case"BeakerLiquid":C.name=N,C.isPickable=!1;break}}),a){const C=a.getBoundingInfo().boundingBox,O=x(e,v).getBoundingInfo().boundingBox.maximum.y;console.log(O),o.position.y=C.maximumWorld.y+O/2+.0075,o.position.x=(C.maximumWorld.x-C.minimumWorld.x)/ne*i+C.minimumWorld.x-.3,o.position.z=(C.centerWorld.z+C.minimumWorld.z)/2,this.position={...o.position}}else o.position.x=-2+i,o.position.y=1.22,o.position.z=.5,console.log("Else!");o.checkCollisions=!0,o.ellipsoid=new f(.02,.09,.02),o.ellipsoidOffset.y+=.001,console.log(o.ellipsoid.length()),this.startPos=Object.assign({},o.position),this.mesh=o,this.startRotation=Object.assign({},this.mesh.rotation);const c=x(e,N),m=new B("liquid-material");m.diffuseColor=n,c.material=m;const g=x(e,"Label"),d=x(e,"LabelBack");console.log("Label:",d);const u=new se("dynamic texture",256,s,!0,E.LINEAR_LINEAR_MIPNEAREST);u.uAng=Math.PI;const p=new B("Mat",s);p.diffuseTexture=u,g.material=p,d.material=p;const y="bold 250px monospace";u.drawText(e.name.toUpperCase(),0,225,y,"black","white");let M=this.mesh.getChildMeshes().find(C=>C.name==="cylinder");this.mesh.animations=M.animations,console.log("Children: ",this.mesh.getChildMeshes());const r=new H("particles",500,this.scene);r.particleTexture=new E("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),r.minLifeTime=.5,r.maxLifeTime=.7,r.emitRate=100,r.gravity=new f(0,.5,0),r.minSize=.01,r.maxSize=.07,r.createPointEmitter(new f(0,0,0),new f(0,1,0)),r.addColorGradient(1,Q.FromColor3(c.material.diffuseColor,1)),r.blendMode=H.BLENDMODE_STANDARD,r.emitter=this.mesh.position,this.particleSystem=r,this.setOpacity(this.startOpacity),this.addDragCollision()}startParticles(){this.particleSystem.start()}highlight(e=!0){let i=x(this.mesh,v);e?(console.log("Adding mesh"),this.highlightLayer.hasMesh(i)||this.highlightLayer.addMesh(i,A.Green())):this.highlightLayer.hasMesh(i)&&this.highlightLayer.removeMesh(i)}addDragCollision(){let e=new fe({dragPlaneNormal:new f(0,0,1)});e.useObjectOrientationForDragging=!1,e.moveAttached=!1,e.onDragStartObservable.add(()=>{}),e.onDragObservable.add(i=>{i.delta!=f.Zero()&&this.moveFlag&&this.mesh.isPickable&&this.mesh.moveWithCollisions(i.delta)}),e.onDragEndObservable.add(()=>{f.Distance(this.startPos,this.mesh.position)>.1?(this.scene.stopAllAnimations(),this.fadeAndRespawn()):(this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z)}),this.mesh.addBehavior(e),this.dragCollision=e}removeDragCollision(){this.mesh.removeBehavior(this.dragCollision)}fadeAndRespawn(e=Te,i=null){this.mesh.isPickable=!1,setTimeout(()=>{let t=this.mesh.getBehaviorByName("PointerDrag");t&&t.releaseDrag();let n=30;this.mesh.name.split("-")[0];let s=this.mesh.getScene(),a=this.mesh.getChildMeshes(),o=a.find(g=>g.name==="cylinder");a.find(g=>g.name==="liquid");const c=x(this.mesh,N);console.log("Visibility: ",c.visibility);let m=[{name:"Invisibility",startValue:c.visibility},{name:"Visibility",startValue:0}];m.forEach(g=>{g.init=new P(g.name,"visibility",120,P.ANIMATIONTYPE_FLOAT,P.ANIMATIONLOOPMODE_CONSTANT),g.init.setKeys([{frame:0,value:g.startValue},{frame:n,value:c.visibility-g.startValue}])});for(let g=0;g<a.length-1;++g){let d=a[g];s.beginDirectAnimation(d,[m[0].init],0,60,!1)}s.beginDirectAnimation(a[a.length-1],[m[0].init],0,60,!1,void 0,()=>{console.log(this.mesh,this.position);let g=x(this.mesh,v);F(this.mesh),F(g),ae(g),this.mesh.position.x=this.position._x,this.mesh.position.y=this.position._y,this.mesh.position.z=this.position._z,s.stopAnimation(o,"resetRotateAroundZ"),s.stopAnimation(o,"rotateAroundZ"),this.mesh.animations=o.animations;for(let d=0;d<a.length-1;++d){let u=a[d];s.beginDirectAnimation(u,[m[1].init],0,60,!1)}s.beginDirectAnimation(a[a.length-1],[m[1].init],0,60,!1,void 0,()=>{if(this.highlight(!1),this.mesh.isPickable=!0,console.log("Resetting rotation!"),x(this.mesh,"cylinder").visibility=this.startOpacity,i)for(let d of i)d&&(d.handMesh.visibility=1)})})},e)}rotateAroundZ(e=null){let i=this.mesh.getAnimationByName(`${this.name}-rotateAroundZ`),t;this.moveFlag=!1,this.rotateEnd=!1,e&&(t=[e.motionController.lastPosition,e.motionController.grabbed,e.motionController.meshGrabbed,e.holdingMesh,e.holdingInstance,e.motionController.meshGrabbed],e.droppedWithoutRespawn(),console.log("Dropped without respawn")),this.toggleControllers&&this.toggleControllers(),this.scene.beginDirectAnimation(x(this.mesh,v),[i],0,600,!1,.5,()=>{e&&(e.motionController.lastPosition=t[0],e.motionController.grabbed=t[1],e.motionController.meshGrabbed=t[2],e.holdingMesh=t[3],e.holdingInstance=t[4],e.motionController.meshGrabbed=t[5]),this.toggleControllers&&this.toggleControllers(),this.moveFlag=!0,this.rotateEnd=!0})}resetAroundZ(e=null){let i=this.mesh.getAnimationByName(`${this.name}-resetRotateAroundZ`),t;e&&(t=[e.motionController.lastPosition,e.motionController.grabbed,e.motionController.meshGrabbed,e.holdingMesh,e.holdingInstance,e.motionController.meshGrabbed],e.droppedWithoutRespawn(),console.log("Dropped without respawn")),this.toggleControllers&&this.toggleControllers(),this.scene.beginDirectAnimation(x(this.mesh,v),[i],0,600,!1,1,()=>{e&&(e.motionController.lastPosition=t[0],e.motionController.grabbed=t[1],e.motionController.meshGrabbed=t[2],e.holdingMesh=t[3],e.holdingInstance=t[4],e.motionController.meshGrabbed=t[5]),this.toggleControllers&&this.toggleControllers()})}setColor(e){const i=x(this.mesh,N),t=new B("liquid-material");t.diffuseColor=e,i.material=t,this.currentColor=e,console.log(this.currentColor)}setOpacity(e){const i=x(this.mesh,N);i.visibility=e}resetProperties(){this.setOpacity(this.startOpacity),this.setColor(this.originalColor)}showEffects(e=!0){if(e){this.particleSystem.particleTexture=new E("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",this.scene),this.particleSystem.minLifeTime=.5,this.particleSystem.maxLifeTime=.7,this.particleSystem.emitRate=100,this.particleSystem.gravity=new f(0,.5,0),this.particleSystem.minSize=.01,this.particleSystem.maxSize=.07,this.particleSystem.createPointEmitter(new f(0,0,0),new f(0,1,0));const i=x(this.mesh,N);this.particleSystem.addColorGradient(1,Q.FromColor3(i.material.diffuseColor,1)),this.particleSystem.blendMode=H.BLENDMODE_STANDARD,this.particleSystem.emitter=this.mesh.position,this.particleSystem.start()}else this.particleSystem.stop()}}const De="Stony Brook University VR Laboratory",ke="Victor Ruben",Re="VR Chemical Mixture Synthesis",_e="4/1/2022",Fe="General: Properly mixing VR chemicals",ze="42",We="I",Ge=[{text:"HAZARD IDENTIFICATION test from JSON",sublistType:"a",sublist:[{text:"Improper mixing of chemicals can lead to explosive results!"}]},{text:"CHEMICAL HANDLING PROCEDURES",sublistType:"a",sublist:[{text:"When mixing these chemicals - always follow the correct sequence"},{text:"Pour chemical B into chemical C"},{text:"Then pour chemical mixture B+C into chemical A"}]},{text:"EMERGENCY PROCEDURES",sublistType:"a",sublist:[{text:"In the event of an improper mixture - use the fire extinguisher to put out the flames"},{text:"Evacuate the lab"},{text:"Call for emergency services"}]}],te={facility:De,labDirector:ke,scope:Re,lastRevision:_e,general:Fe,sopNum:ze,listType:We,items:Ge};function Ve(h){h.name="clipboard";const e=h.getScene(),i=e.getMeshByName("Table");if(i){const a=i.getBoundingInfo().boundingBox;h.position.y=a.maximumWorld.y+.003}h.rotationQuaternion=null,h.rotation=new f(0,Math.PI/4,0);const t=e.getMeshByName("pivot-Cylinder-A");t&&(h.position.x=t.position.x+.2,h.position.z=t.position.z+.5);function n(a){console.log("data: ",te);let o=document.createElement("template");o.innerHTML=a;var c=ye.compile(o.innerHTML),m=c(te);return o.innerHTML=m,o.content}function s(a){const c="data:image/svg+xml;utf8,"+encodeURIComponent(a),m=E.LoadFromDataString("tex",c,e,void 0,void 0,void 0,E.LINEAR_LINEAR_MIPNEAREST);let g=new B("mat",e);g.diffuseTexture=m,m.uScale=1,m.vScale=-1,g.emissiveColor=A.White(),g.useAlphaFromDiffuseTexture=!0,m.hasAlpha=!0;let d=x(h,"Plane");d.material=g,console.log("Material set")}fetch(`${_}images/sopTemplate.svg`).then(a=>a.text()).then(a=>{console.log("fetched!");let o=n(a),c=o.getElementById("procedure-list");console.log(c);const g=new XMLSerializer().serializeToString(o);s(g)}).catch(console.error.bind(console))}function He(h){var e=new J(A.FromHexString("#0984e3"));e.ignoreChildren=!0;var i=h[0],t=J.MakeNotPickableAndWrapInBoundingBox(i);e.attachedMesh=t,e.onScaleBoxDragObservable.add(()=>{console.log("scaleDrag")}),e.onScaleBoxDragEndObservable.add(()=>{const n=e.attachedMesh;if(n){const s=n.getHierarchyBoundingVectors(!0);console.log("size x:",s.max.x-s.min.x),console.log("size y:",s.max.y-s.min.y),console.log("size z:",s.max.z-s.min.z)}console.log("scaleEnd")}),e.onRotationSphereDragObservable.add(()=>{console.log("rotDrag")}),e.onRotationSphereDragEndObservable.add(()=>{console.log("rotEnd")})}function U(h,e,i){const t=h.find(d=>d.name==="__root__"),n=t.getScene();t.name=i;const s=h.find(d=>d.name==="Label"),a=h.find(d=>d.name==="Placard");a.name=Le;const o=new se("dynamic texture",256,n);o.wAng=-Math.PI/2,o.uAng=Math.PI;const c=new B("Mat",n);c.diffuseTexture=o,s.material=c;const m="bold 220px monospace";o.drawText(t.name.split("-")[1].toUpperCase(),65,185,m,"black","white"),a.addChild(s),a.rotationQuaternion=null,a.rotation=new f(0,Math.PI/2,0);const g=n.getMeshByName("Table");if(g){const d=g.getBoundingInfo().boundingBox;t.position.y=d.maximumWorld.y+.003,t.position.x=(d.maximumWorld.x-d.minimumWorld.x)/ne*e+d.minimumWorld.x-.2,t.position.z=(d.centerWorld.z+d.minimumWorld.z)/2+.2}}function $e(h,e,i){let t,n;return new Promise(s=>{const a="./models/";let o="";var c={};let m=["left","right"];const g=new be(h);m.forEach(u=>{g.addMeshTask(`load ${u} hand`,"",a,`${u}${o}.glb`)});let d=0;g.onTaskSuccess=u=>{c[m[d]]=u.loadedMeshes[1],u.loadedMeshes[1].name=m[d],t=u.loadedAnimationGroups;for(let p=0;p<t.length;p++)t[p].name=`${m[d]}_${t[p].name}`;d++},g.onTasksDoneObservable.add(()=>{for(let u=0;u<h.animationGroups.length;u++)h.animationGroups[u].pause();n=u=>{console.log(u);let p=u.inputSource.handedness;console.log(c[p]);let y=c[p].parent.parent;c[p].isPickable=!1;for(let M of i)M.removeDragCollision();let b=(Object.keys(c).indexOf(p)-1)*2-1;c[p].rotation.y=Math.PI*b,c[p].rotation.z=-Math.PI/2,c[p].rotation.x=-Math.PI/4,y.parent=u.grip||u.pointer},e.baseExperience.onStateChangedObservable.add(u=>{if(u===q.IN_XR){e.baseExperience.camera.position.y=1.5,e.baseExperience.camera.position.z=-.5;let p=h.getMeshByName("Start");if(p){let y=e.baseExperience.camera;p.parent=y,p.position=y.position.add(new f(-y.position.x,-1.5,1.15)),e.pointerSelection.displayLaserPointer=!0,e.pointerSelection.displaySelectionMesh=!0,p.rotation=f.Zero()}}}),e.baseExperience.camera.onAfterCameraTeleport.add(u=>{e.baseExperience.camera.position.y=.5})}),g.loadAsync().then(()=>{s(n)})})}class le{constructor(e,i,t,n,s){l(this,"cylinderInstances");l(this,"clipboard");l(this,"scene");l(this,"labels");l(this,"guiManager");l(this,"soundManager");l(this,"xrCamera");console.log("Cylinders interact: ",i),this.labels=["A","B","C"],this.scene=e,this.cylinderInstances=i,this.guiManager=t,this.soundManager=n,this.xrCamera=s}getCylinderInstanceFromMesh(e){let i=e.name.split("-")[2];for(let t of this.cylinderInstances)if(t.name==i)return t;return null}intersectHandCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(e.intersectsMesh(t,!1)&&t.isPickable)return t}return null}intersectCylinder(e){for(let i of this.labels){let t=this.scene.getMeshByName(`pivot-Cylinder-${i}`);if(t!=e&&e.intersectsMesh(t))return t}return null}highlightAndRotateCylinders(e,i,t,n=null){e.highlight(),i.highlight();let s=e.mesh.position,a=i.mesh.position;if(e.mesh.rotation.y=0,a.x<s.x&&(e.mesh.rotation.y=Math.PI),i.mesh.rotation.y=e.mesh.rotation.y,!t){t=!0;let o=e.mesh.getHierarchyBoundingVectors(),c=o.max.y-o.min.y,m=.1,g=a.x;s.x-g;let d=x(e.mesh,v),u=x(i.mesh,v);a.x>s.x&&(m=-m),d.position.x=u.position.x+m,d.position.y=u.position.y+c/2,n?(console.log("HANDDD"),e.rotateAroundZ(n)):(console.log("NO HAND!!!!"),e.rotateAroundZ())}return t}moveWithCollisions(e,i){e.moveWithCollisions(i)}addColors(e,i){let t=e.currentColor,n=i.currentColor,s=new A((t.r+n.r)/2,(t.g+n.g)/2,(t.b+n.b)/2);i.setColor(s)}showFinishScreen(){console.log("XR this: ",this.xrCamera),this.guiManager.createPromptWithButton("You have completed the task! The scene will now reset!",this.xrCamera)}playExplosion(){console.log(this.soundManager.loadedSounds.explosion);let e=this.soundManager.loadedSounds.explosion;e.stop(),e.play()}playDing(){let e=this.soundManager.loadedSounds.ding;e.stop(),e.play()}playSuccess(){let e=this.soundManager.loadedSounds.success;console.log("Success: ",e),e.stop(),e.play()}}class re extends le{constructor(i,t,n,s,a){super(i,t,n,s,a);l(this,"particleSystem")}resetCylinders(){this.particleSystem&&this.particleSystem.stop();let i=["A","B","C"];for(let t=0;t<i.length;t++){const n=this.scene.getMeshByName(`pivot-Cylinder-${i[t]}`),s=this.scene.getMeshByName("Table");if(s&&n){const a=s.getBoundingInfo().boundingBox;n.position.z=(a.centerWorld.z+a.minimumWorld.z)/2}super.getCylinderInstanceFromMesh(n).showEffects(!1),super.getCylinderInstanceFromMesh(n).setOpacity(.85),super.getCylinderInstanceFromMesh(n).setColor(super.getCylinderInstanceFromMesh(n).originalColor),t==0&&(super.getCylinderInstanceFromMesh(n).setColor(A.Red()),super.getCylinderInstanceFromMesh(n).currentColor=A.Red())}}postSceneCylinder(){let i=!1,t=!1,n=["A","B","C"],s=[];for(let a of n){const o=this.scene.getMeshByName(`pivot-Cylinder-${a}`);s.push(o);let c=new P(`${a}-rotateAroundZ`,"rotation.z",120,P.ANIMATIONTYPE_FLOAT,P.ANIMATIONLOOPMODE_CONSTANT),m=x(o,v);const g=[];g.push({frame:0,value:Math.PI*2}),g.push({frame:60,value:4.62}),m.animations.push(c),c.setKeys(g);let d=new P(`${a}-resetRotateAroundZ`,"rotation.z",120,P.ANIMATIONTYPE_FLOAT,P.ANIMATIONLOOPMODE_CONSTANT);const u=[];u.push({frame:0,value:4.62}),u.push({frame:60,value:Math.PI*2}),m.animations.push(d),d.setKeys(u)}for(let a=0;a<n.length;a++){const o=this.scene.getMeshByName(`pivot-Cylinder-${n[a]}`);let c=super.getCylinderInstanceFromMesh(o);const m=o.getBehaviorByName("PointerDrag");console.log(m);let g=[];for(let p of s)p!=o&&g.push(p);let d=x(o,v),u=!1;o.isPickable&&m.onDragObservable.add(()=>{T.audioEngine.unlock(),T.audioEngine.audioContext.resume();let p=!1,y=!1;F(o);const b=super.intersectCylinder(o);if(b){let M=super.getCylinderInstanceFromMesh(b);y=!0;let r=b.name.split("-")[2],L=`${o.name.split("-")[2]}to${r}`;S.tasks[S.currentState].label===L?(t=!0,S.tasks[S.currentState].next==="complete"?(p=!0,console.log(M),setTimeout(()=>{c.fadeAndRespawn(),super.playSuccess()},1500),S.resetSOP(),this.resetCylinders(),super.showFinishScreen()):(S.currentState=S.tasks.indexOf(S.tasks.find(I=>I.label==S.tasks[S.currentState].next)),super.playDing())):!i&&!t&&(M.showEffects(!0),super.playExplosion(),i=!0,t=!0);let W=o.getAbsolutePosition()._x;b.getAbsolutePosition()._x<W?(d.rotation.y=Math.PI,b.rotation.y=d.rotation.y):(d.rotation.y=0,b.rotation.y=d.rotation.y),u||(u=super.highlightAndRotateCylinders(c,M,u),b.name.split("-")[2],o.name.split("-")[2],p||super.addColors(c,M))}else c.highlight(!1),F(o);y==!1&&(c.highlight(!1),t=!1,u&&(d.position.x=0,d.position.y=0,u=!1,c.resetAroundZ()))}),m.onDragEndObservable.add(()=>{x(o,v).getBehaviorByName("Highlight");for(let p of g)p!=d&&(c.highlight(!1),super.getCylinderInstanceFromMesh(p).highlight(!1),d.intersectsMesh(p)&&(c.resetAroundZ(),d.position.x=0,d.position.y=0,u=!1))})}}}class ie extends le{constructor(i,t,n,s,a,o){console.log("Cylinders hand: ",n);super(t,n,s,a,o);l(this,"handedness");l(this,"holdingInstance");l(this,"holdingMesh");l(this,"targetMesh");l(this,"targetMeshInstance");l(this,"motionController");l(this,"handMesh");l(this,"isVisible");l(this,"failBeaker");l(this,"particleSystem");l(this,"cylinderInstancesHand");this.handedness=i,this.handMesh=t.getMeshByName(this.handedness),this.isVisible=!0,this.failBeaker=!1}getMotionController(){return this.motionController}setMotionController(i){this.motionController=i}dropped(i=null){if(console.log(this.holdingInstance.mesh.position,this.holdingInstance.startPos),f.Distance(this.holdingInstance.mesh.position,this.holdingInstance.startPos)==0){this.droppedWithoutRespawn();return}this.motionController.lastPosition=null,i&&clearInterval(i),this.motionController.grabbed=!1,this.motionController.meshGrabbed=void 0,console.log(this.holdingMesh),this.holdingMesh&&(this.holdingInstance.fadeAndRespawn(100),this.holdingMesh=null,this.holdingInstance=null,this.motionController.meshGrabbed=null)}droppedWithoutRespawn(){this.motionController.lastPosition=null,this.motionController.grabbed=!1,this.motionController.meshGrabbed=void 0,console.log(this.holdingMesh),this.holdingMesh&&(this.holdingMesh=null,this.holdingInstance=null,this.motionController.meshGrabbed=null)}updateSOPTask(i,t,n){console.log(this.scene);let s=`${i}to${t}`;if(S.tasks[S.currentState].label===s)if(S.tasks[S.currentState].next==="complete"){console.log("GUI mgr",this.guiManager,"Sound mgr: ",this.soundManager);let a=new re(this.scene,this.cylinderInstances,this.guiManager,this.soundManager,this.xrCamera);for(let o of this.cylinderInstances)o.fadeAndRespawn(100);if(super.playSuccess(),console.log("Showing finish screen!"),this.xrCamera.baseExperience.state==q.IN_XR){super.showFinishScreen();let o=this.scene.getMeshByName("Start");if(o){let c=this.xrCamera.baseExperience.camera;o.parent=c,o.position=c.position.add(new f(-c.position.x,-1.5,1.15)),this.xrCamera.pointerSelection.displayLaserPointer=!0,this.xrCamera.pointerSelection.displaySelectionMesh=!0,o.rotation=f.Zero()}}S.resetSOP(),this.disappearAnimation(!1),this.dropped(n),this.particleSystem&&(this.particleSystem.stop(),console.log("Stopping particle system!")),a.resetCylinders();for(let o of this.cylinderInstances)o.resetProperties(),o.showEffects(!1);return!0}else return super.playDing(),S.currentState=S.tasks.indexOf(S.tasks.find(a=>a.label==S.tasks[S.currentState].next)),!1;else this.failBeaker||(super.playExplosion(),this.targetMeshInstance.showEffects(!0));return!1}disappearAnimation(i=!0){console.log("DISAPPEAR: ",i);let t=60,n=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}];n.forEach(s=>{s.init=new P(s.name,"visibility",120,P.ANIMATIONTYPE_FLOAT,P.ANIMATIONLOOPMODE_CONSTANT),s.init.setKeys([{frame:0,value:s.startValue},{frame:t,value:1-s.startValue}])}),console.log(this.handMesh),i?(this.isVisible=!1,this.scene.beginDirectAnimation(this.handMesh,[n[0].init],0,60,!1)):(this.isVisible=!0,this.scene.beginDirectAnimation(this.handMesh,[n[1].init],0,60,!1))}}function Ze(h,e,i,t,n,s){let a=new ie("right",h,t,n,s,e),o=new ie("left",h,t,n,s,e),c=!1,m=null,g={right:a,left:o},d=!1;function u(y){let b=y.name.split("-")[2];for(let M of t)if(M.name==b)return M;return null}let p=y=>{i(y),y.onMotionControllerInitObservable.add(b=>{let M=b;M.handID=b.handedness;let r=g[M.handedness];r.getMotionController()||r.setMotionController(M);let C=new Ce(f.Zero(),f.Zero(),.25);const L=b.getComponentOfType("squeeze");b.getComponentOfType("trigger"),b.getComponentOfType("thumbstick").onAxisValueChangedObservable.add(()=>{e.baseExperience.camera.position.y=1.5}),e.baseExperience.camera.onAfterCameraTeleport.add(()=>{console.log("End teleport"),e.baseExperience.camera.position.y=1.5}),console.log("Motion controller: ",b),[L].forEach(O=>{console.log(h.getMeshByName("left")),O.onButtonStateChangedObservable.add(I=>{m=I,console.log(m);let D,he={left:"Fist",right:"Grip"},K=h.animationGroups.find((G,V)=>G.name===`${r.motionController.handID}_${he[r.motionController.handID]}`);K.goToFrame(I.value*(K._to-1)+1);let k=r.intersectHandCylinder(h.getMeshByName(M.handID));if(console.log("Grabbed Cylinder: ",k),I.value>.5&&!r.motionController.grabbed){if(k){T.audioEngine.unlock(),c=!1,r.holdingMesh=k,r.holdingInstance=u(r.holdingMesh),r.motionController.meshGrabbed=r.holdingMesh,r.motionController.grabbed=!0;let G=r.motionController.lastPosition,V=C.origin;V!=G&&(r.disappearAnimation(!0),D=setInterval(()=>{let Y=r.motionController.lastPosition;if(y.getWorldPointerRayToRef(C),Y&&r.holdingMesh&&r.moveWithCollisions(r.holdingMesh,V.subtract(Y)),!r.intersectHandCylinder(h.getMeshByName(r.motionController.handID))&&r.holdingMesh&&(r.targetMeshInstance&&r.targetMeshInstance.highlight(!1),r.dropped(D),r.motionController.grabbed=!1,r.handMesh.visibility=1,c=!0),r.holdingMesh){let R=r.intersectCylinder(r.holdingMesh);if(R){r.targetMesh=R,r.targetMeshInstance=u(R);let ce=R.name.split("-")[2],de=r.holdingMesh.name.split("-")[2];d||(r.addColors(r.holdingInstance,r.targetMeshInstance),c=r.updateSOPTask(de,ce,D),c?d=r.highlightAndRotateCylinders(r.holdingInstance,r.targetMeshInstance,d):d=r.highlightAndRotateCylinders(r.holdingInstance,r.targetMeshInstance,d,r))}else r.targetMeshInstance&&r.targetMeshInstance.highlight(!1),r.holdingInstance.highlight(!1),d&&(r.holdingInstance.resetAroundZ(),ae(x(r.holdingMesh,v)),d=!1)}c||(m=null,r.motionController.lastPosition=Object.assign({},C.origin),M.lastPosition=Object.assign({},C.origin))},10))}}else(!I.value||!k)&&r.holdingMesh&&(m=null,r.holdingInstance.highlight(!1),r.motionController.grabbed=!1,r.targetMeshInstance&&r.targetMeshInstance.highlight(!1),r.dropped(D),r.disappearAnimation(!1))})})})};return function(){let b=e.input.onControllerAddedObservable;b.hasObservers()?(b.clear(),console.log("removed")):(b.add(p),console.log("added"))}}var z;class Ue{constructor(e){l(this,"flying",!1);l(this,"active",!1);l(this,"camera");l(this,"mesh");l(this,"offset",.3);l(this,"animations");l(this,"returnPosition");l(this,"returnRotation");l(this,"onPointerDownObserver");l(this,"xrCamera");l(this,"attach",(e,i,t,n,s)=>{const a=e.getScene();if(this.mesh=e,!i&&(i=a.activeCamera,!i))throw new Error("The scene has no active camera, and no camera was provided.");this.camera=i,t||(t=this.mesh.position),n||(n=this.mesh.rotation),s&&(this.offset=s),this.returnPosition=t,this.returnRotation=n,this.onPointerDownObserver=a.onPointerObservable.add(this.clipboardClick)});l(this,"detach",()=>{this.mesh.getScene().onPointerObservable.remove(this.onPointerDownObserver)});l(this,"clipboardClick",(e={type:ee.POINTERDOWN,pickInfo:{pickedMesh:this.mesh}})=>{var i;if(e.type===ee.POINTERDOWN){console.log("Clipboard click");const t=(i=e.pickInfo)==null?void 0:i.pickedMesh;if(t&&(t===this.mesh||t.isDescendantOf(this.mesh))&&!this.flying||this.active){const n=this.active?w/2:0,s=this.active?0:w/2;X(this,z).call(this),this.flying=!0,this.mesh.billboardMode==$.BILLBOARDMODE_ALL?this.mesh.billboardMode=$.BILLBOARDMODE_NONE:this.mesh.billboardMode=$.BILLBOARDMODE_ALL,this.mesh.getScene().beginDirectAnimation(this.mesh,this.animations,n,s,!1,void 0,()=>{this.flying=!1,this.active=!this.active})}}});l(this,"calculateTargetPositionWithOffset",e=>{if(this.xrCamera!==void 0&&this.xrCamera.state===q.IN_XR){const a=this.xrCamera.camera._position.subtract(this.returnPosition).scale(1-e/f.Distance(this.returnPosition,this.xrCamera.camera._position));return this.returnPosition.add(a)}const t=this.camera._position.subtract(this.returnPosition).scale(1-e/f.Distance(this.returnPosition,this.camera._position));return this.returnPosition.add(t)});l(this,"setClipboardUp",()=>new f(3.1468286,4.6617744,1.680752));j(this,z,()=>{const e=this.animations.find(({name:s})=>s==="translate"),i=this.animations.find(({name:s})=>s==="rotate"),t=[{frame:0,value:this.returnPosition},{frame:w/2,value:this.calculateTargetPositionWithOffset(this.offset)}],n=[{frame:0,value:this.returnRotation},{frame:w/2,value:this.setClipboardUp()}];e.setKeys(t),i.setKeys(n)});const i=new P("translate","position",w,P.ANIMATIONTYPE_VECTOR3),t=new P("rotate","rotation",w,P.ANIMATIONTYPE_VECTOR3);this.animations=[i,t],this.xrCamera=e}get name(){return"FlyToCamera"}init(){}}z=new WeakMap;class qe{constructor(e,i,t){l(this,"rect");l(this,"text");l(this,"button");this.rect=e,this.text=i,this.button=t}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e}}class Ke{constructor(e){l(this,"advancedTexture");l(this,"welcomePrompt");l(this,"gameFinishPrompt");l(this,"camera");l(this,"screen");l(this,"scene");this.scene=e,this.camera=e.activeCamera,console.log("Scene: ",this.scene)}createPromptWithButton(e,i=null,t=null){this.screen=oe.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=this.camera.position.add(new f(.7,-2,2.5)),this.advancedTexture=Me.CreateForMesh(this.screen);let n=new xe("container");var s=new Se;s.width=.5,s.height=.2,s.color="cyan",s.thickness=4,s.background="white",n.addControl(s);var a=new Pe;a.text=e,a.color="black",a.fontSize="17px",a.resizeToFit=!0,a.textWrapping=!0,a.paddingBottomInPixels=40,a.paddingLeftInPixels=15,a.paddingRightInPixels=15,s.addControl(a);var o=Ae.CreateSimpleButton("but1","Click to dismiss");o.width="150px",o.height="40px",o.color="black",o.cornerRadius=20,o.background="white",o.topInPixels=40;let c=new qe(s,a,o),m=this.scene.getMeshByName("Start");return c.button.onPointerUpObservable.add(function(){n.dispose(),m.dispose(),console.log("XR cam: ",i),i&&(console.log("Hiding Pointer!"),i.pointerSelection.displayLaserPointer=!1,i.pointerSelection.displaySelectionMesh=!1)}),c.button.onPointerEnterObservable.add(()=>{o.background="grey"}),c.button.onPointerOutObservable.add(()=>{o.background="white"}),n.addControl(c.button),n.addControl(o),this.advancedTexture.addControl(n),c}}class Ye{constructor(e,i){l(this,"soundList");l(this,"soundPointer");l(this,"scene");l(this,"loadedSounds");this.scene=i,this.soundPointer=0,this.soundList=e,this.loadedSounds={}}async loadSounds(){let e=[];return new Promise(i=>{let t=0;this.soundList.forEach(n=>{if(e.push({soundName:n.soundName,sound:new ve(n.soundName,n.fileName,this.scene,()=>{T.audioEngine.unlock()},{})}),t++,t===this.soundList.length){for(let s of e)this.loadedSounds[s.soundName]=s.sound;i(e),console.log("Sounds loaded!!",this.loadedSounds)}})})}}console.log=()=>{};class Xe{constructor(){l(this,"handAnimation");l(this,"sop");l(this,"models");l(this,"cylinders");l(this,"guiManager");l(this,"soundManager");l(this,"loadedSounds");this.cylinders=[];let e="CylinderNewSmoothLabel.glb";this.models=[{fileName:"room.glb",callback:t=>this.createRoom(t),label:"floor"},{fileName:"Placard_Label.glb",callback:t=>U(t,1,"Placard-A")},{fileName:"Placard_Label.glb",callback:t=>U(t,2,"Placard-B")},{fileName:"Placard_Label.glb",callback:t=>U(t,3,"Placard-C")},{fileName:e,callback:t=>this.cylinders.push(new Z(t[0],1,"A",new A(1,0,0))),label:"Cylinder-A"},{fileName:e,callback:t=>this.cylinders.push(new Z(t[0],2,"B",new A(0,1,0))),label:"Cylinder-B"},{fileName:e,callback:t=>this.cylinders.push(new Z(t[0],3,"C",new A(0,0,1))),label:"Cylinder-C"},{fileName:"clipBoardWithPaperCompressedTextureNew.glb",callback:t=>Ve(t[0])}].map(function(t){return Object.assign({},{fileName:"LabBench.glb",root:"./models/",callback:He,label:"NoLabel"},t)});let i=[{soundName:"explosion",fileName:`${_}/sound/mi_explosion_03_hpx.mp3`},{soundName:"ding",fileName:`${_}/sound/ding-idea-40142.mp3`},{soundName:"success",fileName:`${_}/sound/success.mp3`}];this.loadedSounds=[],this.createScene().then(t=>{this.soundManager=new Ye(i,t),this.soundManager.loadSounds().then(n=>{this.loadedSounds=n;for(let s of["A","B","C"])Object.assign({},t.getMeshByName(`pivot-Cylinder-${s}`).position);console.log("Loaded sounds: ",this.loadedSounds);for(let s of this.loadedSounds)console.log(s.sound);this.processScene(t,this.cylinders,this.guiManager,this.soundManager)})})}async processScene(e,i,t,n){let s=e.getCameraByName("camera"),a=e.getLightByName("light1"),o;s.speed=.16;let c=setInterval(()=>{a.intensity>=1?clearInterval(c):a.intensity+=.1},60);const m=["WallsandFloor","Floor"];for(let y of m)console.log(y),e.getMeshByName(y);let g={floorMeshes:[e.getMeshByName("Floor")],inputOptions:{doNotLoadControllerMeshes:!0}};o=await e.createDefaultXRExperienceAsync(g);const u=o.baseExperience.featuresManager.enableFeature(Ie.TELEPORTATION,"stable",{xrInput:o.input,floorMeshes:[e.getMeshByName("Floor")],timeToTeleport:5e3});o.teleportation=u,o.teleportation.parabolicRayEnabled=!0,o.teleportation.parabolicCheckRadius=10;let p=!1;o.pointerSelection.laserPointerDefaultColor=A.Green(),o.pointerSelection.laserPointerPickedColor=A.Green(),o.pointerSelection.selectionMeshPickedColor=A.Green(),o.pointerSelection.selectionMeshDefaultColor=A.Green(),o.pointerSelection.displayLaserPointer=!1,o.pointerSelection.displaySelectionMesh=!1,window.addEventListener("keydown",y=>{y.keyCode===73&&(p?p=!1:p=!0,o.pointerSelection.displayLaserPointer=p,o.pointerSelection.displaySelectionMesh=p)}),$e(e,o,i).then(y=>{if(console.log("add webxr"),o){const r=new Ue(o.baseExperience);e.getMeshByName("clipboard").addBehavior(r)}this.guiManager=new Ke(e),this.guiManager.createPromptWithButton("Welcome to the Lab Safety Simulation. Click on the clipboard to learn more about the simulation!",o),console.log("Cylinders app: ",i),new re(e,i,this.guiManager,n,o).postSceneCylinder();var M=Ze(e,o,y,i,this.guiManager,this.soundManager);M();for(let r of i)r.toggleControllers=M})}createRoom(e){const i=["WallsandFloor","Floor","Table","Roof","Countertop","Walls"];let t,n;for(let s of i){const a=e.find(o=>o.name===s);if(a&&(a.checkCollisions=!0,a.name==="Table")){const o=a.getBoundingInfo().boundingBox;o.center.x,t=a.getScene(),n=t.getCameraByName("camera"),n.position=new f(o.center.x*-1,o.center.y*2+.5,-1.5)}}}createScene(){return new Promise(e=>{const i=document.getElementById("canvas"),t=new T(i,!0,{stencil:!0}),n=new we(t);n.collisionsEnabled=!0,window.addEventListener("resize",function(){t.resize()});const s=new Ne("camera",new f(0,1,-1.134),n);s.ellipsoid=new f(.4,.7,.4),s.attachControl(i,!0),s.applyGravity=!0,s.minZ=0,s.speed=0,s.checkCollisions=!0,s.keysUp.push(87),s.keysDown.push(83),s.keysLeft.push(65),s.keysRight.push(68);var a=new Oe("light1",new f(1,1,0),n);a.intensity=0,Promise.all(this.models.map(o=>new Promise(c=>Be.ImportMesh("",o.root,o.fileName,n,function(m){o.mesh=m,c(m)})))).then(()=>{let o=[];this.models.map(c=>{o.push(c.callback(c.mesh)),e(n)})}),window.addEventListener("keydown",o=>{o.shiftKey&&o.ctrlKey&&o.altKey&&o.keyCode===73&&(n.debugLayer.isVisible()?n.debugLayer.hide():n.debugLayer.show())}),t.runRenderLoop(()=>{n.render()})})}}new Xe;
