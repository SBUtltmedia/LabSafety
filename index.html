<html>

<head>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.misc.min.js"></script>
  <!-- <script src="https://unpkg.com/super-hands@^3.0.3/dist/super-hands.min.js"></script> -->

  <script src="https://mixedreality.mozilla.org/ammo.js/builds/ammo.wasm.js"></script>

  <script src="super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
  <script
    src="https://unpkg.com/aframe-render-order-component@1.0.0/dist/aframe-render-order-component.min.js"></script>
  <script src="aframe-particle-system-component.min.js"></script>
  <script>
    document.addEventListener('cntextmenu', function (ev) {
      ev.preventDefault();
      // alert('success!');
      return false;
    }, false);

    AFRAME.registerComponent('capture-mouse', {
      init: function () {
        this.eventRepeater = this.eventRepeater.bind(this)
        this.el.sceneEl.addEventListener('loaded', () => {
          this.el.sceneEl.canvas.addEventListener('mousedown', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('mouseup', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('touchstart', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('touchmove', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('touchend', this.eventRepeater)
        }, { once: true })
        this.el.addEventListener('start-grab', (e) => { console.log(e) })
      },
      eventRepeater: function (evt) {

        if (evt.type.startsWith('touch')) {
          evt.preventDefault()
          // avoid repeating touchmove because it interferes with look-controls
          if (evt.type === 'touchmove') { return }
        }
        this.el.emit(evt.type, evt.detail)
      }
    })
    AFRAME.registerComponent('phase-shift', {
      init: function () {
        var el = this.el
        el.addEventListener('gripdown', function () {
          el.setAttribute('collision-filter', { collisionForces: true })
        })
        el.addEventListener('gripup', function () {
          el.setAttribute('collision-filter', { collisionForces: false })
        })
      }
    });

    AFRAME.registerComponent('model-opacity', {
      schema: { default: 1.0 },
      init: function () {
        this.el.addEventListener('model-loaded', this.update.bind(this));
      },
      update: function () {
        var mesh = this.el.getObject3D('mesh');
        var data = this.data;
        if (!mesh) { return; }
        mesh.traverse(function (node) {
          if (node.isMesh) {
            node.material.opacity = data;
            node.material.transparent = data < 1.0;
            node.material.needsUpdate = true;
          }
        });
      }
    });
  </script>
</head>

<body>

  <a-scene render-order="layer1, layer2, layer3" webxr="overlayElement:#dom-overlay;"
    background="directionalLight:#dirlight;" ar-hit-test="type:map;"
    physics="driver: ammo; debug: false; debugDrawMode: 1;" basketball-game>

    <a-assets>
      <a-mixin id="controllerEvents" hoverable grabbable stretchable draggable droppable amo-body="type: static;"
        amo-shape="type: sphere; fit: manual; sphereRadius:0.5"></a-mixin>
      </a-mixin>
      <a-mixin id="liquidPour"
        particle-system="velocityValue:0 20 0;opacity:1,0;velocitySpread:0 0 0;velocityValue:0 10 0;size:.5;blending:1;maxAge:.8;maxParticleCount:400;">
      </a-mixin>


      <a-asset-item id="beaker" src="beaker.glb"></a-asset-item>
      <a-asset-item id="table" src="table.glb"></a-asset-item>
      <a-asset-item id="liquid" src="liquid.obj"></a-asset-item>

    </a-assets>

    <a-entity camera look-controls wasd-controls position="0 10 10" capture-mouse raycaster cursor="rayOrigin:mouse"
      ammo-body="type:static;" ammo-shape="type:box" super-hands="colliderEvent: raycaster-intersection;
                         colliderEventProperty: els;
                         colliderEndEvent:raycaster-intersection-cleared;
                         colliderEndEventProperty: clearedEls;">
    </a-entity>
    <!-- <a-entity sphere-collider="objects: a-box" super-hands hand-controls="hand: left"></a-entity>
      <a-entity sphere-collider="objects: a-box" super-hands hand-controls="hand: right"></a-entity> -->
    <a-entity  scale="1 1 1" position="0 0 0" color="#7BC8A4" gltf-model="#table">
      <a-entity animation="property: rotation; from: 0 0 90; to: 0 0 360; loop: true; dur: 2000"
        mixin="controllerEvents" render-order="layer2" scale="1 1 1" position="0 9 0" color="#7BC8A4"
        gltf-model="#beaker">
        <a-entity position="0 0 0" mixin="liquidPour" particle-system="color: #ff0000">

        </a-entity>
        <a-entity render-order="layer1"
          animation="property: components.material.material.opacity; from: 1; to: 0;loop: true; dur: 2000"
          scale=".9 .9 .9" obj-model="obj: #liquid;"
          material="color: red;roughness: 0;transparent:true;opacity:1.0;premultipliedAlpha: true;">

        </a-entity>
      </a-entity>

      <a-entity mixin="controllerEvents" scale="1 1 1" position="4 9 0" color="#7BC8A4" gltf-model="#beaker">
        <a-entity position="0 0 0" mixin="liquidPour" particle-system="color: #00ff00"></a-entity>
        <a-entity scale=".9 .9 .9" obj-model="obj: #liquid;"
          material="color: green;roughness: 0;transparent:true;opacity:1.0;">
        </a-entity>
      </a-entity>
      <a-entity mixin="controllerEvents" scale="1 1 1" position="8 9 0" color="#7BC8A4" gltf-model="#beaker">
        <a-entity position="0 0 0" mixin="liquidPour" particle-system="color: #0000ff"></a-entity>
        <a-entity scale=".9 .9 .9" obj-model="obj: #liquid;"
          material="color: blue;roughness: 0;transparent:true;opacity:1.0;">
        </a-entity>
      </a-entity>
    </a-entity>
    <!-- <a-box ammo-body="type:static;" ammo-shape="type:box" width="20" height="20" depth="1" rotation="-90 0 0"
      visible="false" position="0 -0.5 0" ammo-restitution="0.5" visible="false"></a-box> -->
    <a-box body="type: static; shape: none" shape="shape: box; halfExtents: 50 0.0005 50" width=100 height=0.001
      depth=100 color="#CCCCCC"></a-box>

    <a-sky color="#ECECEC"></a-sky>
  </a-scene>
</body>

</html>