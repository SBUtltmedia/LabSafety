<html>

<head>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v4.1.2/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/super-hands@^3.0.1/dist/super-hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
  <!-- <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script> -->
  <script src="https://unpkg.com/aframe-environment-component@1.3.1/dist/aframe-environment-component.min.js"></script>
  <script>
    document.addEventListener('cntextmenu', function (ev) {
      ev.preventDefault();
      // alert('success!');
      return false;
    }, false);

    AFRAME.registerComponent('capture-mouse', {
      init: function () {
        this.eventRepeater = this.eventRepeater.bind(this)
        this.el.sceneEl.addEventListener('loaded', () => {
          this.el.sceneEl.canvas.addEventListener('mousedown', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('mouseup', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('touchstart', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('touchmove', this.eventRepeater)
          this.el.sceneEl.canvas.addEventListener('touchend', this.eventRepeater)
        }, { once: true })
      },
      eventRepeater: function (evt) {
        if (evt.type.startsWith('touch')) {
          evt.preventDefault()
          // avoid repeating touchmove because it interferes with look-controls
          if (evt.type === 'touchmove') { return }
        }
        this.el.emit(evt.type, evt.detail)
      }
    })
    AFRAME.registerComponent('phase-shift', {
        init: function () {
          var el = this.el
          el.addEventListener('gripdown', function () {
            el.setAttribute('collision-filter', {collisionForces: true})
          })
          el.addEventListener('gripup', function () {
            el.setAttribute('collision-filter', {collisionForces: false})
          })
        }
      });

    AFRAME.registerComponent('model-opacity', {
      schema: { default: 1.0 },
      init: function () {
        this.el.addEventListener('model-loaded', this.update.bind(this));
      },
      update: function () {
        var mesh = this.el.getObject3D('mesh');
        var data = this.data;
        if (!mesh) { return; }
        mesh.traverse(function (node) {
          if (node.isMesh) {
            node.material.opacity = data;
            node.material.transparent = data < 1.0;
            node.material.needsUpdate = true;
          }
        });
      }
    });
  </script>
</head>

<body>

  <a-scene physics >
    <a-assets>
      <a-mixin id="controllerEvents" hoverable
        grabbable stretchable draggable droppable
        dynamic-body shadow shape="cube" angularDamping="0"></a-mixin>
      </a-mixin>
      <a-asset-item id="beaker" src="beaker.glb"></a-asset-item>
      <a-asset-item id="liquid_red" src="liquid_red.glb"></a-asset-item>
      <a-asset-item id="liquid_green" src="liquid_green.glb"></a-asset-item>
      <a-asset-item id="liquid_blue" src="liquid_blue.glb"></a-asset-item>
    </a-assets>

    <a-entity camera look-controls wasd-controls position="0 10 10" capture-mouse raycaster cursor="rayOrigin:mouse"
      body="type: static; shape: sphere; sphereRadius: 0.001" super-hands="colliderEvent: raycaster-intersection;
                         colliderEventProperty: els;
                         colliderEndEvent:raycaster-intersection-cleared;
                         colliderEndEventProperty: clearedEls;">
    </a-entity>
    <!-- <a-entity sphere-collider="objects: a-box" super-hands hand-controls="hand: left"></a-entity>
      <a-entity sphere-collider="objects: a-box" super-hands hand-controls="hand: right"></a-entity> -->

    <a-entity mixin="controllerEvents" scale="1 1 1" position="0 0 0" color="#7BC8A4" gltf-model="#beaker">
      <a-animation attribute="model-opacity" dur="100" from="1" to="0" repeat="indefinite"></a-animation>
      <a-entity position=".1 .01 -.3" scale=".9 .9 .9" gltf-model="#liquid_red">
      </a-entity>
    </a-entity>
    <a-box body="type: static; shape: none" shape="shape: box; halfExtents: 50 0.0005 50" width=100 height=0.001
      depth=100 isible="false" color="#7BC8A4"></a-box>

    <a-sky color="#ECECEC"></a-sky>
  </a-scene>
</body>

</html>