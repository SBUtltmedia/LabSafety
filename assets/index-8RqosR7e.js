import{A as X,C as O,V as p,M as Re,E as Le,O as T,W as F,H as Te,a as q,b as E,c as ke,d as Ne,P as ce,e as U,f as K,S as Fe,F as _e,T as k,g as De,h as Ge,i as $,j as He,k as Ue,R as Ve,l as Ce,B as ze,D as ae,m as G,n as qe,G as de,o as ue,p as $e,q as Oe,r as we,s as We,t as Xe,u as Ke,U as Ze,v as J,w as je}from"./vendor-DPTaCEoP.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();window.exports=window;let v;const Qe=i=>{let e=X.CreateFullscreenUI("UI"),t=0,s=0,n=0,a=0,r=150,o=-50,h,l=!1,d=!1,c=L("leftThumb",2,"blue",null);c.height="120px",c.width="120px",c.isPointerBlocker=!0,c.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_LEFT,c.verticalAlignment=O.VERTICAL_ALIGNMENT_BOTTOM,c.alpha=.4,c.left=r,c.top=o;let b=L("leftInnterThumb",4,"blue",null);b.height="50px",b.width="50px",b.isPointerBlocker=!0,b.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_CENTER,b.verticalAlignment=O.VERTICAL_ALIGNMENT_CENTER;let u=L("leftPuck",0,"blue","blue");u.height="10px",u.width="10px",u.isPointerBlocker=!0,u.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_CENTER,u.verticalAlignment=O.VERTICAL_ALIGNMENT_CENTER,c.onPointerDownObservable.add(function(I){u.isVisible=!0,u.left=I.x-c._currentMeasure.width*.5-r,u.left=u.left,u.top=e.getContext().canvas.height-I.y-c._currentMeasure.height*.5+o,u.top=u.top*-1,l=!0,c.alpha=.9}),c.onPointerUpObservable.add(function(I){t=0,s=0,l=!1,u.isVisible=!1,c.alpha=.4}),c.onPointerMoveObservable.add(function(I){l&&(t=I.x-c._currentMeasure.width*.5-r,s=e.getContext().canvas.height-I.y-c._currentMeasure.height*.5+o,u.left=t,u.top=s*-1,u.left=u.left,u.top=u.top)}),e.addControl(c),c.addControl(b),c.addControl(u),u.isVisible=!1;const A=.5;v=L("rightThumb",2,"red",null),v.height="120px",v.width="120px",v.isPointerBlocker=!0,v.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_RIGHT,v.verticalAlignment=O.VERTICAL_ALIGNMENT_BOTTOM,v.alpha=.4,v.left=-r,v.top=o;let M=L("rightInnterThumb",4,"red",null);M.height="50px",M.width="50px",M.isPointerBlocker=!0,M.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_CENTER,M.verticalAlignment=O.VERTICAL_ALIGNMENT_CENTER;let f=L("rightPuck",0,"red","red");f.height="10px",f.width="10px",f.isPointerBlocker=!0,f.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_CENTER,f.verticalAlignment=O.VERTICAL_ALIGNMENT_CENTER,v.onPointerDownObservable.add(function(I){f.isVisible=!0,f.left=e.getContext().canvas.width-I.x-v._currentMeasure.width*.5-r,f.left=f.left*-1,f.top=e.getContext().canvas.height-I.y-v._currentMeasure.height*.5+o,f.top=f.top*-1,d=!0,v.alpha=.9}),v.onPointerUpObservable.add(function(I){n=0,a=0,d=!1,f.isVisible=!1,v.alpha=.4}),v.onPointerMoveObservable.add(function(I){d&&(n=e.getContext().canvas.width-I.x-v._currentMeasure.width*.5-r,a=e.getContext().canvas.height-I.y-v._currentMeasure.height*.5+o,f.left=n*-1,f.top=a*-1,f.left=f.left,f.top=f.top)}),e.addControl(v),v.addControl(M),v.addControl(f),f.isVisible=!1;let m=i.activeCamera,xe=document.getElementById("canvas");m.attachControl(xe,!0),i.registerBeforeRender(function(){h=p.TransformCoordinates(new p(t/3e3,0,s/3e3),Re.RotationY(m.rotation.y)),m.cameraDirection.addInPlace(h),m.cameraRotation.y+=A*n/15e3*-1,m.cameraRotation.x+=A*a/15e3*-1})};function L(i,e,t,s){let n=new Le;return n.name=i,n.thickness=e,n.color=t,n.background=s,n.paddingLeft="0px",n.paddingRight="0px",n.paddingTop="0px",n.paddingBottom="0px",n}const Ye=new p(0,1,-1.134),Je=new p(.4,.7,.4),et=.16;function tt(i){i.ellipsoid=Je,i.applyGravity=!0,i.minZ=0,i.speed=et,i.checkCollisions=!0,i.needMoveForGravity=!1}function W(...i){}var w=(i=>(i[i.DESKTOP=0]="DESKTOP",i[i.XR=1]="XR",i[i.MOBILE=2]="MOBILE",i[i.LOADING=3]="LOADING",i))(w||{}),S=(i=>(i[i.GRAB=0]="GRAB",i[i.DROP=1]="DROP",i))(S||{}),R=(i=>(i[i.ACTIVE=0]="ACTIVE",i[i.INACTIVE=1]="INACTIVE",i))(R||{});const it=9,st=.005;class re{onMeshGrabStateChangedObservable=new T;onMeshActivationStateChangedObservable=new T;onModeChangeObservable=new T;onHasAnyTargetsObservable=new T;onGrabStateChangedObservable=new T;#e;highlightLayer;modeSelectorMap={0:{},1:{},2:{},3:{}};hasDefaultSelector=!1;#t=!1;#r=!1;#o=!1;#i=[];interactionMode=3;interactableMeshes=[];xrExperience;constructor(e,t){this.#e=e,t&&(this.xrExperience=t,this.xrExperience.baseExperience.onStateChangedObservable.add(s=>{this.#u(s)})),this.#u(this.xrExperience===void 0?F.NOT_IN_XR:this.xrExperience.baseExperience.state),this.highlightLayer=new Te("interaction-highlight-layer"),this.#e.onBeforeRenderObservable.add(()=>{const s=this.#i.length;this.#i.splice(0,this.#i.length);const n=this.getActiveSelectors(),a=n.filter(({grabbedMesh:l})=>!!l).map(({grabbedMesh:l})=>l),r=n.filter(({grabbedMesh:l})=>!l),o=this.interactableMeshes.filter(l=>!a.includes(l)),h={};for(const l of r){const d=[];for(const c of o)l.grabber.intersectsMesh(c,!0)&&d.push(c);l.targetMesh=this.#b(l.grabber,d),l.targetMesh&&(h[l.targetMesh.uniqueId]=l.targetMesh)}this.#i.push(...Object.values(h)),this.highlightLayer.removeAllMeshes();for(const l of this.#i)l instanceof q&&this.highlightLayer.addMesh(l,E.Gray());this.#i.length===0&&s!==0?this.onHasAnyTargetsObservable.notifyObservers(!1):this.#i.length!==0&&s===0&&this.onHasAnyTargetsObservable.notifyObservers(!0)})}#s=e=>{e.motionController&&this.#n(e.motionController,e.pointer.uniqueId),e.onMotionControllerInitObservable.add(t=>{this.#n(t,e.pointer.uniqueId)})};#n=(e,t)=>{const s=e.getComponentOfType("squeeze");s&&s.onButtonStateChangedObservable.add(()=>{s.changes.pressed&&this.#l(s.pressed,t)});const n=e.getMainComponent();n&&n.onButtonStateChangedObservable.add(()=>{n.changes.pressed&&this.#a(n.pressed,t)})};#l=(e,t)=>{const s=this.modeSelectorMap[this.interactionMode][t];e?s.targetMesh&&(s.grabbedMesh=s.targetMesh,s.targetMesh=null,this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:0})):s.grabbedMesh&&(this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:1}),s.grabbedMesh=null)};#a=(e,t)=>{const{anchor:s,grabber:n,grabbedMesh:a}=this.modeSelectorMap[this.interactionMode][t];a&&(e?this.#c(a,{anchor:s,grabber:n,state:0}):this.#c(a,{anchor:s,grabber:n,state:1}))};#h=(e,t)=>{if(e.isDisposed()){for(const n in this.modeSelectorMap)for(const a of Object.values(this.modeSelectorMap[n]))a.grabbedMesh===e&&(a.grabbedMesh=null);return}const s=e.getBehaviorByName("Interactable");if(!s)throw new Error("InteractionManager: grabbed mesh must have InteractableBehavior.");this.onMeshGrabStateChangedObservable.notifyObserver(s.grabStateObserver,t),this.onGrabStateChangedObservable.notifyObservers({mesh:e,state:t.state})};#c=(e,t)=>{if(e.isDisposed())return;const s=e.getBehaviorByName("Interactable");if(!s)throw new Error("InteractionManager: activated mesh must have InteractableBehavior.");this.onMeshActivationStateChangedObservable.notifyObserver(s.activationStateObserver,t,e.uniqueId)};#u=e=>{e===F.NOT_IN_XR?"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.maxTouchPoints>0?this.#d(2):this.#d(0):e===F.IN_XR?this.#d(1):this.#d(3)};#d=e=>{const t=this.getActiveSelectors();this.onModeChangeObservable.notifyObservers(e);for(const s of t)s.grabbedMesh&&(this.#h(s.grabbedMesh,{anchor:s.anchor,grabber:s.grabber,state:1}),s.grabbedMesh=null);this.interactionMode=e,(e===0||e===2)&&!this.hasDefaultSelector&&this.#p(this.#e.activeCamera),console.log("Mode: ",e),e===0?this.#m():e===2?this.#f():e===1&&this.#v()};addSelector=(e,t,s)=>{const n={anchor:e,grabber:t,grabbedMesh:null,targetMesh:null};for(const a of s)this.modeSelectorMap[a][e.uniqueId]=n};#p=e=>{const t=ke("default-grabber",{height:it,diameter:st});t.isVisible=!1,t.isPickable=!1,t.setParent(e),t.position.setAll(0),t.rotation.copyFromFloats(Math.PI/2,0,0);const s=new Ne("default-anchor");s.isPickable=!1,s.setParent(e),s.position.copyFrom(new p(0,0,1)),this.addSelector(s,t,[0,2]),this.hasDefaultSelector=!0};#m=()=>{if(this.#t)return;const e=Object.values(this.modeSelectorMap[0]).find(({anchor:s})=>s.name==="default-anchor");if(e===void 0)throw new Error("Tried to configure desktop interaction without default selector.");const{anchor:t}=e;this.#e.onPointerObservable.add(s=>{this.interactionMode===0&&(s.event.inputIndex===ce.LeftClick?s.type===U.POINTERDOWN?this.#l(!0,t.uniqueId):s.type===U.POINTERUP&&this.#l(!1,t.uniqueId):s.event.inputIndex===ce.RightClick&&(s.type===U.POINTERDOWN?this.#a(!0,t.uniqueId):s.type===U.POINTERUP&&this.#a(!1,t.uniqueId)))}),this.#t=!0};#f=()=>{if(this.#r)return;const e=Object.values(this.modeSelectorMap[2]).find(({anchor:a})=>a.name==="default-anchor");if(e===void 0)throw new Error("Tried to configure mobile interaction without default selector.");const{anchor:t}=e;console.log("Mobile");let s=this.#l,n=this.#a;s(!1,t.uniqueId),n(!1,t.uniqueId),V&&(V.onPointerDownObservable.add(function(a){s(!0,t.uniqueId)}),V.onPointerUpObservable.add(function(a){s(!1,t.uniqueId)})),z&&(z.onPointerDownObservable.add(function(a){n(!0,t.uniqueId)}),z.onPointerUpObservable.add(function(a){n(!1,t.uniqueId)})),this.#r=!0};#v=()=>{if(!this.#o){if(!this.xrExperience)throw new Error("Tried to configure XR interaction without an XR experience.");this.xrExperience.input.controllers.forEach(this.#s),this.xrExperience.input.onControllerAddedObservable.add(this.#s),this.#o=!0}};getActiveSelectors=()=>Object.values(Object.values(this.modeSelectorMap[this.interactionMode]));#b=(e,t)=>re.#g(e,t,this.interactionMode);static#g=(e,t,s)=>{let n=null,a=Number.POSITIVE_INFINITY;switch(s){case 0:case 2:case 1:for(const r of t){const o=p.Distance(e.getAbsolutePosition(),r.getAbsolutePosition());o<a&&(n=r,a=o)}break}return n}}const nt=.15;class oe{mesh;spawnPosition=p.Zero();spawnRotation=p.Zero();#e;#t;#r;#o=null;#i;#s;constructor(e=1.25){this.#e=e,this.#i=[{name:"Invisibility",startValue:1},{name:"Visibility",startValue:0}],this.#i.forEach(t=>{t.animation=new K(t.name,"visibility",60,K.ANIMATIONTYPE_FLOAT,K.ANIMATIONLOOPMODE_CONSTANT),t.animation.setKeys([{frame:0,value:t.startValue},{frame:30,value:t.startValue?0:1}])})}init(){}get name(){return"FadeAndRespawn"}attach(e){if(this.mesh=e,this.#t=this.mesh.getBehaviorByName("Interactable"),!this.#t)throw new Error(`${this.name} behavior must be attached to a mesh with an Interactable behavior.`);this.#s=this.mesh.getScene(),this.#r=this.#t.onGrabStateChangedObservable.add(({state:t})=>{t===S.DROP&&this.#n()})}detach(){this.#r.remove(),this.#o&&this.#o.remove()}#n(){if(Math.abs(p.Distance(this.mesh.getAbsolutePosition(),this.spawnPosition))<=nt){this.#a();return}this.#s.beginDirectHierarchyAnimation(this.mesh,!1,[this.#i.find(t=>t.name==="Invisibility").animation],0,60,!1,this.#e,()=>{this.#a(),this.#l()})}#l(){this.#s.beginDirectHierarchyAnimation(this.mesh,!1,[this.#i.find(e=>e.name==="Visibility").animation],0,60,!1,this.#e)}#a=()=>{this.mesh.position.copyFrom(this.spawnPosition),this.mesh.rotation.copyFrom(this.spawnRotation)};setSpawnPoint=(e,t)=>{this.spawnPosition.copyFrom(e),this.spawnRotation.copyFrom(t)}}function at(i){const e=i.meshes.map(t=>t.getBehaviorByName("FadeAndRespawn")).filter(t=>!!t);for(const t of e)t.setSpawnPoint(t.mesh.position,t.mesh.rotation)}const rt=["room","placard","cylinder","clipboard","fire-extinguisher"];function Ie(i=rt){return Promise.all(i.map(e=>Fe.ImportMeshAsync("","./models/",`${e}.glb`).then(t=>{const s=t.meshes.find(n=>n.id==="__root__");return s.id=e,s.name=e,t})))}function Pe(i){const t=i.getScene().meshes.find(s=>s.name==="Table");if(i.rotation=p.Zero(),t){const s=t.getBoundingInfo().boundingBox;i.position.x=s.center.x-.5,i.position.y=s.center.y*2+.46,i.position.z=-3}else i.position=p.Zero()}function fe(i,e){return i.id<e.id?-1:i.id>e.id?1:0}function ot(i){const e=i.filter(r=>r.id.split("-").length===2&&r.id.split("-")[0]==="cylinder").sort(fe),t=i.filter(r=>r.name.split("-")[0]==="placard"&&!r.name.includes("placard-base")).sort(fe),s=i.find(r=>r.id==="clipboard"),n=i.find(r=>r.name==="Table"),a=i.find(r=>r.id==="fire-extinguisher");if(n){const r=n.getBoundingInfo().boundingBox;e.forEach((o,h)=>{const l=o.getBoundingInfo().boundingBox,d=o.position.y-l.minimum.y;o.position.copyFromFloats(r.minimum.x+(h+1)*(r.maximum.x-r.minimum.x)/(e.length+2),r.maximum.y+d,(2*r.minimum.z+r.center.z)/3),o.rotationQuaternion=null,o.rotation.copyFromFloats(Math.PI,0,0)}),t.forEach((o,h)=>{const d=o.getChildMeshes().find(b=>b.name==="placard-base").getBoundingInfo().boundingBox,c=o.position.y-d.minimum.y;o.position.y=r.maximum.y+c,o.position.x=r.minimum.x+(h+1)*(r.maximum.x-r.minimum.x)/(t.length+2)+.2,o.position.z=(2*r.minimum.z+r.center.z)/3+.2,o.rotationQuaternion=null,o.rotation.copyFromFloats(0,Math.PI/2,0)}),s.position.copyFromFloats(e[0].position.x+.5,r.maximum.y,e[0].position.z+.3),s.rotationQuaternion=null,s.rotation.copyFromFloats(0,-Math.PI/2,Math.PI),a.position.copyFromFloats(3.73,1.77,-2.51),a.rotationQuaternion=null,a.rotation.copyFromFloats(0,0,Math.PI)}}const Me="./",lt=`${Me}images/sopTemplate.svg`,ht=`${Me}json/HUDhints.json`;var P=(i=>(i[i.SUCCESSFUL=0]="SUCCESSFUL",i[i.FAILURE=1]="FAILURE",i[i.RESET=2]="RESET",i))(P||{});class ee{name;description;#e;optional;subtasks;subtaskObservers;onTaskStateChangeObservable;constructor(e,t,s,n=!1){if(this.name=e,this.description=t,this.#e=2,this.optional=n,s.some(a=>a.length===0))throw new Error(`Task ${this.name}: subtask partition must not be empty.`);this.subtasks=s,this.onTaskStateChangeObservable=new T,this.subtaskObservers=this.subtasks.map(a=>a.map((r,o)=>{const h=r.onTaskStateChangeObservable.add((l,d)=>{switch(l){case 1:r.optional||this.fail();break;case 0:if(o!==0&&a[o-1].status!==0){d.skipNextObservers=!0;break}this.subtasks.every(b=>b.at(-1).status===0)&&this.#t();break}});return r.onTaskStateChangeObservable.makeObserverTopPriority(h),h}))}fail=()=>{if(this.#e!==2)throw new Error(`Attempted to fail a Task (${this.name}) which has already succeeded or failed.`);if(this.onTaskStateChangeObservable.notifyObservers(1))W(`Failing Task ${this.name}`),this.#e=1;else throw new Error(`Task ${this.name}: An observer skipped following observers.`)};succeed=()=>{if(this.subtasks.length)throw new Error(`Task ${this.name} has subtasks and cannot be manually succeeded.`);this.#t()};#t=()=>{if(this.#e!==2)throw new Error(`Attempted to succeed a Task (${this.name}) which has already succeeded or failed.`);this.#e=0,this.onTaskStateChangeObservable.notifyObservers(this.#e)?W(`Succeeding Task ${this.name}`):(this.#e=2,this.fail())};reset=()=>{this.subtasks.forEach(e=>{e.forEach(t=>t.reset())}),this.#e=2,this.onTaskStateChangeObservable.notifyObservers(this.#e)};get failed(){return this.#e===1}get successful(){return this.#e===0}get status(){return this.#e}}class ct{mesh;extinguished=!1;onFireObservable=new T;constructor(){}get name(){return"Fire"}init(){}attach=e=>{this.mesh=e};extinguish=()=>{this.extinguished=!0,this.onFireObservable.notifyObservers(!1),this.mesh.isVisible=!1};detach=()=>{}}function dt(){const i=new _e("fire");i.diffuseTexture=new k("images/fire.png"),i.distortionTexture=new k("images/distortion.png"),i.opacityTexture=new k("images/candleopacity.png"),i.speed=5;const e=new De("spotlight",new p(2,2,2),new p(-1,-2,-1),3,1),t=new Ge(10240,e);t.usePercentageCloserFiltering=!0,t.bias=100,t.transparencyShadow=!0;const s=$.CreatePlane("fire-plane",{width:4,height:3});s.receiveShadows=!0,s.position.copyFromFloats(-4.1,0,-1.6),s.rotationQuaternion=null,s.rotation.copyFromFloats(0,-Math.PI/2,0),s.material=i,s.material.shadowDepthWrapper=new He(s.material),t.getShadowMap().renderList.push(s);const n=new ct;return s.addBehavior(n),s}class ut{rect;text;button;constructor(e,t,s){this.rect=e,this.text=t,this.button=s}setVisible(e=!0){this.rect.isVisible=e,this.text.isVisible=e,this.button.isVisible=e,document.exitPointerLock(),Wt()}}class Z{advancedTexture;welcomePrompt;gameFinishPrompt;camera;screen;scene;constructor(e){this.scene=e,this.camera=e.activeCamera}createPromptWithButton(e,t=null,...s){this.screen=$.CreatePlane("Start",{size:1}),this.screen.parent=this.camera,this.screen.position=new p(0,0,.5),this.advancedTexture=X.CreateForMesh(this.screen);let n=new Ue("container");var a=new Ve;a.width=.5,a.height=.2,a.color="cyan",a.thickness=4,a.background="white",n.addControl(a);var r=new Ce;r.text=e,r.color="black",r.fontSize="17px",r.resizeToFit=!0,r.textWrapping=!0,r.paddingBottomInPixels=40,r.paddingLeftInPixels=15,r.paddingRightInPixels=15,a.addControl(r);var o=ze.CreateSimpleButton("but1","Click to dismiss");o.width="150px",o.height="40px",o.color="black",o.cornerRadius=20,o.background="white",o.topInPixels=40;let h=new ut(a,r,o),l=this.scene.getMeshByName("Start");function d(){n.dispose(),l.dispose(),t&&t(...s)}return h.button.onPointerUpObservable.add(function(){d()}),h.button.onPointerEnterObservable.add(()=>{o.background="grey"}),h.button.onPointerOutObservable.add(()=>{o.background="white"}),n.addControl(h.button),n.addControl(o),this.advancedTexture.addControl(n),h}}class be{static createWelcomeScreen(e){new Z(e).createPromptWithButton("Welcome to the game. Please click on the clipboard on the table to get started.").setVisible(!0)}static createSuccessScreen(e,t=null,...s){new Z(e).createPromptWithButton("Congratulations! You have completed the SOP",t,...s).setVisible(!0)}static createFailureScreen(e,t=null,...s){new Z(e).createPromptWithButton("Oops! You mixed the wrong chemicals which resulted in a fire",t,...s).setVisible(!0)}}const g={sop:null,taskList:null,json:null,sounds:{},hudHints:{}};class H{#e;interactionManager;#t=null;#r=null;onGrabStateChangedObservable=new T;onActivationStateChangedObservable=new T;defaults={};hideGrabber=!0;#o;#i=!1;#s;#n=!1;#l=null;#a=null;#h=null;#c=!0;constructor(e,t){this.interactionManager=e,this.#s=!!t?.activatable,this.#o=t?.moveAttached!==!1;for(const s of[w.DESKTOP,w.MOBILE,w.XR,w.LOADING])this.defaults[s]={defaultPosition:t?.modeDefaults?.[s]?.defaultPosition||t?.defaultPosition||p.Zero(),defaultRotation:t?.modeDefaults?.[s]?.defaultRotation||t?.defaultRotation||p.Zero()}}get name(){return"Interactable"}set activatable(e){!e&&this.#n&&this.#f(),this.#s=e}get grabbing(){return!!this.#l&&!!this.#a}get grabStateObserver(){return this.#t}get activationStateObserver(){return this.#r}#u=()=>{this.#h=this.onGrabStateChangedObservable.add(({anchor:e,state:t})=>{if(t===S.GRAB){this.#e.setParent(e);const{defaultPosition:s,defaultRotation:n}=this.defaults[this.interactionManager.interactionMode];this.#e.position.copyFrom(s),this.#e.rotation.copyFrom(n)}else t===S.DROP&&this.#e.setParent(null)})};#d=()=>{this.#h.remove(),this.#h=null,this.grabbing&&this.#e.setParent(null)};set moveAttached(e){e&&!this.#o&&this.#e?this.#u():!e&&this.#o&&this.#e&&this.#d(),this.#o=e}set enabled(e){e&&!this.#c&&!this.#y&&this.#p?this.#g():!e&&this.#c&&this.#y&&this.#S(),this.#c=e}get enabled(){return this.#c}get#p(){return!!this.#e}#m=()=>{this.#n=!0,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#a,state:R.ACTIVE})};#f=()=>{this.#n=!1,this.onActivationStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#a,state:R.INACTIVE})};#v=(e,t)=>{this.onGrabStateChangedObservable.notifyObservers({anchor:e,grabber:t,state:S.GRAB}),this.#l=e,this.#a=t,this.hideGrabber&&this.#i&&(t.isVisible=!1)};#b=()=>{this.#n&&this.#f(),this.hideGrabber&&this.#i&&(this.#a.isVisible=!0),this.onGrabStateChangedObservable.notifyObservers({anchor:this.#l,grabber:this.#a,state:S.DROP}),this.#l=null,this.#a=null};init(){}attach=e=>{this.#e=e,this.enabled&&this.#g(),this.#o&&this.#u(),this.interactionManager.interactableMeshes.push(this.#e)};#g=()=>{this.#t=this.interactionManager.onMeshGrabStateChangedObservable.add(({anchor:e,grabber:t,state:s})=>{s===S.GRAB&&!this.grabbing?(this.#i=t.isVisible,this.#v(e,t)):s===S.DROP&&this.grabbing&&this.#b()},this.#e.uniqueId),this.#r=this.interactionManager.onMeshActivationStateChangedObservable.add(({anchor:e,grabber:t,state:s})=>{this.#s&&this.grabbing&&(s===R.ACTIVE&&!this.#n?this.#m():s===R.INACTIVE&&this.#n&&this.#f())},this.#e.uniqueId)};enable=()=>{this.enabled=!0};disable=()=>{this.enabled=!1};#S=()=>{this.#t.remove(),this.#r.remove(),this.#t=null,this.#r=null};get#y(){return!!this.#t&&!!this.#r}detach=()=>{this.#o&&this.#d(),this.grabbing&&this.#b(),this.#y&&this.#S(),this.onGrabStateChangedObservable.clear(),this.onActivationStateChangedObservable.clear();const e=this.interactionManager.interactableMeshes.findIndex(t=>t===this.#e);e!==-1&&this.interactionManager.interactableMeshes.splice(e,1),this.#e=null}}class ft{highlightLayer;mesh;otherMesh;color;constructor(e){this.highlightLayer=new Te("highlight-layer"),this.highlightLayer.innerGlow=!0,this.highlightLayer.outerGlow=!1,this.color=e}get name(){return"Highlight"}init(){}attach=e=>{this.mesh=e};detach=()=>{this.unhighlightAll()};highlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)||this.highlightLayer.addMesh(this.mesh,this.color)};highlightOther=e=>{this.highlightLayer.hasMesh(e)||(this.otherMesh=e,this.highlightLayer.addMesh(this.otherMesh,this.color))};unhighlightSelf=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh)};unhighlightOther=()=>{this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)};unhighlightAll=()=>{this.highlightLayer.hasMesh(this.mesh)&&this.highlightLayer.removeMesh(this.mesh),this.otherMesh&&this.highlightLayer.hasMesh(this.otherMesh)&&this.highlightLayer.removeMesh(this.otherMesh)}}class bt{mesh;#e;#t;#r;#o=null;#i;#s;onBeforePourObservable;onMidPourObservable;onAfterPourObservable;liquidMesh;#n=!1;pourDelay=1e3;animating=!1;onAnimationChangeObservable;constructor(){this.#t=new ft(E.Green()),this.onBeforePourObservable=new T,this.onMidPourObservable=new T,this.onAfterPourObservable=new T,this.onAnimationChangeObservable=new T}get name(){return"Pouring"}init(){}attach=e=>{if(this.mesh=e,this.#e=this.mesh.getBehaviorByName("Interactable"),!this.#e)throw new Error(`${this.name} behavior must have Interactable present on the same mesh.`);this.mesh.addBehavior(this.#t);const t=e.getScene();t.activeCamera;const s=this.#e.interactionManager.interactableMeshes;this.#r=this.#e.onGrabStateChangedObservable.add(({state:a})=>{a===S.GRAB?this.#i=t.onBeforeRenderObservable.add(()=>{const r=this.#l(s);this.#a(r)}):a===S.DROP&&(this.#a(null),this.#i&&(this.#i.remove(),this.#i=null))});let n=!1;this.#o=this.#e.onActivationStateChangedObservable.add(({state:a})=>{if(a===R.ACTIVE&&!this.#n&&this.#s){const r=this.#e.interactionManager.interactionMode;(r===w.DESKTOP||r===w.MOBILE)&&(this.mesh.rotation.z+=Math.PI/3,n=!0),this.pour()}else a===R.INACTIVE&&n&&(this.mesh.rotation.z-=Math.PI/3,n=!1)})};detach=()=>{this.#r.remove(),this.#o.remove(),this.#i&&this.#i.remove()};get empty(){return this.#n}set empty(e){this.#n&&!e?(this.liquidMesh&&(this.liquidMesh.isVisible=!0),this.#n=e):!this.#n&&e&&(this.liquidMesh&&(this.liquidMesh.isVisible=!1),this.#n=e)}#l(e){const t=e.filter(a=>{const r=this.mesh.absolutePosition.y>a.absolutePosition.y,o=!!a.getBehaviorByName("Pouring"),h=!a.getBehaviorByName("Interactable").grabbing,l=this.mesh.intersectsMesh(a);return r&&o&&h&&l});let s=null,n=Number.POSITIVE_INFINITY;for(const a of t){const r=p.Distance(this.mesh.absolutePosition,a.absolutePosition);r<n&&(s=a,n=r)}return s}#a(e){this.#s!==e&&(this.#s&&this.#s instanceof q&&this.#t.unhighlightAll(),this.#s=e,this.#s&&this.#s instanceof q&&(this.#t.highlightSelf(),this.#t.highlightOther(this.#s)))}pour=()=>{if(!this.#s)throw new Error("PouringBehavior: attempted pour with no current target.");const e=this.#s.getBehaviorByName("Pouring");if(!e)throw new Error("PouringBehavior: target is not pourable.");e.empty=!1;const t=this.#s;this.onBeforePourObservable.notifyObservers(t),this.onMidPourObservable.notifyObservers(t),this.onAfterPourObservable.notifyObservers(t),this.empty=!0}}function Ee(i,e){const t=i.getChildMeshes().find(n=>n.id.split("-").pop()==="liquid"),s=new G("liquid-material");s.diffuseColor=e,t.material=s}function j(i,e){Ee(i,e);const t=new ae("dynamic-texture",256,null,!0,k.LINEAR_LINEAR_MIPNEAREST);t.uAng=Math.PI;const s=new G("cylinder-label-material");s.diffuseTexture=t;const n="bold 250px monospace",a=i.getChildMeshes().filter(l=>{const d=l.id.split("-").pop();return d==="label"||d==="labelback"});for(const l of a)l.material=s,t.drawText(i.id.split("-").pop().toUpperCase(),0,225,n,"black","white");const r=new H(x,{activatable:!0,defaultRotation:new p(0,Math.PI/2,Math.PI)}),o=new bt,h=new oe;i.addBehavior(r),i.addBehavior(o),o.liquidMesh=i.getChildMeshes().find(l=>l.id.split("-").pop()==="liquid"),i.addBehavior(h)}const D=new T,gt=(i,e)=>{let t=[],s=[],n={};e.forEach(a=>{a.logic&&a.logic.taskType==="pouring"&&pt(i,a,t,s,n)}),mt(i,s),t.forEach(a=>{a.onTaskStateChangeObservable.add(r=>{r===P.SUCCESSFUL&&!g.sounds.success.isPlaying&&!g.sounds.explosion.isPlaying&&(g.sounds.ding.stop(),g.sounds.ding.play())})}),g.taskList=t},ge=(i,e,t,s)=>{i===e?t.succeed():t.fail()},pt=(i,e,t,s,n)=>{let a=e.taskName,r=e.text,o=e.logic,h=[];o.subtasks.forEach(b=>{let u=n[b];u&&h.push(u)});let l;h.length?l=new ee(a,r,[[...h]]):l=new ee(a,r,[]),t.push(l),s.push(l),n[a]=l;let c=i.getMeshByName(o.from).getBehaviorByName("Pouring");c.onMidPourObservable.add(b=>{W(`Pouring mesh name: ${c.mesh.name}`),W(`Poured mesh name: ${b.name}`);const u=b.getChildMeshes().find(f=>f.id.split("-").pop()==="liquid").material.diffuseColor,A=c.mesh.getChildMeshes().find(f=>f.id.split("-").pop()==="liquid").material.diffuseColor,M=new E((u.r+A.r)/2,(u.g+A.g)/2,(u.b+A.b)/2);Ee(b,M),c.animating?c.onAnimationChangeObservable.addOnce(()=>{ge(b.name,o.to,l)}):ge(b.name,o.to,l)})},mt=(i,e)=>{g.sop=new ee("SOP","Standard operating procedure for lab safety.",[e]),g.sop.onTaskStateChangeObservable.add(t=>{switch(t){case P.SUCCESSFUL:i.activeCamera,be.createSuccessScreen(i,()=>{Se(),se(i)}),g.sounds.success.stop(),g.sounds.success.play(),D.notifyObservers(P.SUCCESSFUL);break;case P.FAILURE:g.sounds.explosion.stop(),g.sounds.explosion.play();const n=dt().getBehaviorByName("Fire");n&&n.onFireObservable.add(a=>{a||(be.createFailureScreen(i,()=>{Se(),se(i)}),g.sounds.success.stop(),g.sounds.success.play())}),D.notifyObservers(P.FAILURE);break;case P.RESET:D.notifyObservers(P.RESET);break}})},vt={[P.SUCCESSFUL]:"correct",[P.FAILURE]:"incorrect",[P.RESET]:"empty"};class yt{templateString;data;basicTasks;rootTask;#e;mesh;#t;#r;constructor(e,t,s,n){this.templateString=e,this.#t=qe.compile(this.templateString),this.data=t,this.rootTask=s,this.basicTasks=n,this.#e=[],this.#r=0}get name(){return"UpdateClipboard"}init(){}#o=e=>this.#i.find(t=>t.taskName===e)||null;get#i(){return this.data.items[1].sublist}attach=e=>{this.mesh=e,this.#s(),this.#e.push(...this.basicTasks.map(t=>t.onTaskStateChangeObservable.add(s=>{const n=this.#o(t.name);n.indicator=vt[s],this.#s()}))),this.#e.push(this.rootTask.onTaskStateChangeObservable.add(t=>{}))};detach=()=>{for(let e of this.#e)e.remove()};#s=()=>{const e=document.createElement("template"),t=this.#t(this.data);e.innerHTML=t;const n=new XMLSerializer().serializeToString(e.content),a="data:image/svg+xml;utf8,"+encodeURIComponent(n),r=k.LoadFromDataString(`clipboard-texture-${this.#r++}`,a,this.mesh.getScene(),void 0,void 0,void 0,k.LINEAR_LINEAR_MIPNEAREST,()=>{r.uScale=1,r.vScale=-1,r.hasAlpha=!0,this.#n(r)})};#n=e=>{const t=this.mesh.material;t.diffuseTexture!==e&&(t.diffuseTexture&&t.diffuseTexture.dispose(),t.diffuseTexture=e)}}function St(i){const e=i.getScene(),t=new G("clipboard-material",e);t.emissiveColor.copyFrom(E.White()),t.useAlphaFromDiffuseTexture=!0;const s=i.getChildMeshes().find(r=>r.name===`${i.id}-plane`);s.material=t,fetch(lt).then(r=>r.text()).then(r=>{fetch("./json/sopData.json").then(o=>o.json()).then(o=>{let h=o.items[1].sublist;gt(e,h);const l=new yt(r,o,g.sop,g.taskList);s.addBehavior(l)})});const n=new H(x,{defaultRotation:new p(Math.PI,Math.PI/2,Math.PI/2),modeDefaults:{[w.DESKTOP]:{defaultPosition:new p(0,0,-.5)},[w.MOBILE]:{defaultPosition:new p(0,0,-.5)}}});s instanceof q&&n.interactionManager.highlightLayer.addExcludedMesh(s);const a=new oe;i.addBehavior(n),i.addBehavior(a)}function Q(i){const e=i.getScene(),t=i.name.split("-")[1],s=i.getChildMeshes().find(h=>h.name==="Placard"),n=i.getChildMeshes().find(h=>h.name==="Label");s.id="placard-base",s.name="placard-base";const a=new ae("dynamic texture",256,e);a.wAng=-Math.PI/2,a.uAng=Math.PI;const r=new G("Mat",e);r.diffuseTexture=a,n.material=r,a.drawText(t.toUpperCase(),65,185,"bold 220px monospace","black","white"),s.addChild(n)}function Tt(i){i.keysUp.push(87),i.keysDown.push(83),i.keysLeft.push(65),i.keysRight.push(68)}const Ct=["WallsandFloor","Floor","Table","Roof","Countertop","Walls","FumehoodBase_LP","FumehoodInner_LP","FumehoodInnerHook_LP"];function Ot(i){i.getChildMeshes().forEach(e=>{Ct.includes(e.name)&&(e.checkCollisions=!0)})}function wt(i){const e=i.getScene().activeCamera;Ot(i),Pe(e),Tt(e)}class It{particleSystem;#e;constructor(e){this.#e=e,this.#t()}#t(){let e=this.#e.getScene(),t;de.IsSupported?(t=new de("particles",{capacity:15e3},e),t.activeParticleCount=2e3):t=new ue("particles",2e3,e),t.particleTexture=new k("https://raw.githubusercontent.com/PatrickRyanMS/BabylonJStextures/master/FFV/smokeParticleTexture.png",e),t.emitRate=150,t.createPointEmitter(new p(-3.5,-3.5,0),new p(3.5,3.5,0)),t.gravity=new p(0,0,20),t.isLocal=!0,t.minLifeTime=.3,t.maxLifeTime=.3,t.minEmitPower=.7,t.maxEmitPower=.5,t.minSize=.01,t.maxSize=.02;let s=.3;t.addSizeGradient(s,s,s),t.blendMode=ue.BLENDMODE_STANDARD,t.emitter=this.#e,this.particleSystem=t}start(){this.particleSystem.start()}stop(){this.particleSystem.stop()}}const Pt=2;function Mt(i){const e=new H(x,{activatable:!0,defaultRotation:new p(0,0,Math.PI)}),t=new oe;i.addBehavior(e),i.addBehavior(t);let s=new It(i),n=null;const a=i.getScene(),r=$.CreateSphere("debug-sphere-1",{diameter:.1}),o=$.CreateSphere("debug-sphere-2",{diameter:.1});r.isVisible=!1,o.isVisible=!1,e.onActivationStateChangedObservable.add(({state:h})=>{h===R.ACTIVE?(s.start(),n=a.onBeforeRenderObservable.add(()=>{const l=new $e(i.absolutePosition,i.getDirection(Oe.Z).normalize(),Pt);r.setAbsolutePosition(l.origin),o.setAbsolutePosition(l.origin.add(l.direction.scale(l.length)));const d=a.pickWithRay(l,c=>{const b=c.getBehaviorByName("Fire");return!!(b&&!b.extinguished)});if(d.hit){const c=d.pickedMesh.getBehaviorByName("Fire");c.extinguished||c.extinguish()}})):h===R.INACTIVE&&(s.stop(),n&&(n.remove(),n=null))})}function Et(i){const e=i.getChildMeshes(!0)[0];e.rotationQuaternion=null;const t=new H(x,{moveAttached:!1});let s=null;const n=i.getScene();t.onGrabStateChangedObservable.add(({anchor:a,state:r})=>{r===S.GRAB?s=n.onBeforeRenderObservable.add(()=>{const o=a.getAbsolutePosition().subtract(e.getAbsolutePosition());if(o.y=0,o.x>0)return;const h=o.z<0?0:Math.PI,l=-Math.atan(o.x/o.z);e.rotation.copyFromFloats(0,l+h,0)}):r===S.DROP&&s&&(s.remove(),s=null)}),e.addBehavior(t)}const At=1.93,Bt=1.3,pe=(i,e)=>{let t=Math.floor(i.position.y*100)/100;t+e>=Bt&&t+e<=At&&(i.position.y+=e)},xt=i=>{const e=i.getScene();let t=null,s=null;const n=new H(x,{moveAttached:!1});i.addBehavior(n),n.onGrabStateChangedObservable.add(({anchor:a,state:r})=>{if(r==S.GRAB){const o=i.getBehaviorByName("PointerDrag");if(o&&(s=o.onDragObservable.add(h=>{let l=h.delta.y;pe(i,l)})),a){let h=p.Zero();h.copyFrom(a.getAbsolutePosition()),t=e.onBeforeRenderObservable.add(()=>{const l=a.getAbsolutePosition().subtract(h);let d=Math.floor(l.y*100)/100;pe(i,d),h.copyFrom(a.getAbsolutePosition())})}}else r==S.DROP&&(s&&s.remove(),t&&t.remove())})};function Rt(i){const e=i.find(m=>m.name==="room"),t=i.find(m=>m.name==="placard"),s=i.find(m=>m.name==="cylinder").getChildMeshes(!0)[0],n=i.find(m=>m.name==="clipboard").getChildMeshes(!0)[0],a=i.find(m=>m.name==="fire-extinguisher").getChildMeshes(!0)[0],r=i.find(m=>m.name==="FireCabinet"),o=i.find(m=>m.name==="Glass Divider");wt(e),xt(o);const h=n.parent;h.id="clipboard-root",h.name=h.id,n.setParent(null),h.dispose(!0),kt(n),St(n);const l=t.clone(`${t.name}-c`,t.parent),d=t.clone(`${t.name}-b`,t.parent),c=t;l.id=l.name,d.id=d.name,c.name+="-a",c.id=c.name,l.getChildMeshes().forEach(m=>m.name=m.name.split(".")[1]),d.getChildMeshes().forEach(m=>m.name=m.name.split(".")[1]),Q(l),Q(d),Q(c),i.push(l,d);const b=s.parent;s.setParent(null),b.dispose(!0);const u=s.clone(`${s.id}-c`,null),A=s.clone(`${s.id}-b`,null),M=s;Lt([M,A,u],["a","b","c"]),j(u,E.Blue()),j(A,E.Green()),j(M,E.Red());const f=a.parent;f.id="fire-extinguisher-root",f.name=f.id,a.setParent(null),f.dispose(),a.id="fire-extinguisher",a.name=a.id,Mt(a),Et(r),i.push(u,A)}function Lt(i,e){i.forEach((t,s)=>{t.id=`cylinder-${e[s]}`,t.name=t.id,t.getChildMeshes().forEach(n=>{switch(n.id.split(".").pop()){case"BeakerLiquid":n.id=`${t.id}-liquid`,n.name=n.id;break;case"Label":n.id=`${t.id}-label`;break;case"LabelBack":n.id=`${t.id}-labelback`;break}})})}function kt(i){i.id="clipboard",i.name=i.id,i.getChildMeshes().forEach(e=>{switch(e.id){case"Plane":e.id=`${i.id}-plane`,e.name=e.id;break;case"Clipper":e.id=`${i.id}-clip`,e.name=e.id;break;case"horizontalScrew":e.id=`${i.id}-screw`,e.name=e.id;break;case"metalThingy":e.id=`${i.id}-metal`,e.name=e.id;break}})}const Ae=64,Y=Ae/2,Nt=.005;function Ft(i,e){const t=new ae(i,Ae),s=t.getContext();s.beginPath(),s.arc(Y,Y,Y,0,2*Math.PI),s.fill(),t.update();const n=new G(i);n.diffuseTexture=t,n.opacityTexture=t;const a=we(i,{size:Nt},e);return a.material=n,a}async function _t(i,e){const t=await Ie([i,e]);let s=null,n=null;for(const a of t){const r=a.meshes.find(h=>h.id===i||h.id===e);for(const h of a.animationGroups)h.name+=`-${r.name}`,h.pause();const[o]=r.getChildMeshes();if(!o)throw new Error(`Cannot collapse the root mesh of ${r.name}`);if(o.id=r.id,o.name=r.name,o.setParent(null),r.dispose(!0),o.name===i)s=o;else if(o.name===e)n=o;else throw new Error("Base mesh name is invalid. This shouldn't be possible.")}if(!s)throw new Error("No left hand mesh found.");if(!n)throw new Error("No right hand mesh found.");return{left:s,right:n}}const Dt={inputOptions:{doNotLoadControllerMeshes:!0},pointerSelectionOptions:{enablePointerSelectionOnAllControllers:!0},uiOptions:{onError:i=>console.error(i)}};async function Gt(i){let e=!1;i.pointerSelection.laserPointerDefaultColor=E.Green(),i.pointerSelection.laserPointerPickedColor=E.Green(),i.pointerSelection.selectionMeshDefaultColor=E.Green(),i.pointerSelection.selectionMeshPickedColor=E.Green(),i.pointerSelection.displayLaserPointer=e,i.pointerSelection.displaySelectionMesh=e,window.addEventListener("keydown",a=>{a.keyCode===73&&(e=!e,i.pointerSelection.displayLaserPointer=e,i.pointerSelection.displaySelectionMesh=e)}),i.baseExperience.onStateChangedObservable.add(a=>{F.IN_XR}),i.baseExperience.camera.onAfterCameraTeleport.add(()=>{i.baseExperience.camera.position.y=i.baseExperience.camera.realWorldHeight});const n=await _t("left","right");for(const a of i.input.controllers)me(a,n[`${a.inputSource.handedness}`]);i.input.onControllerAddedObservable.add(a=>{me(a,n[`${a.inputSource.handedness}`])}),i.input.onControllerRemovedObservable.add(a=>{let r=y.findIndex(o=>o===a.pointer.name);r!==-1&&y.splice(r,1),a.grip&&(r=y.findIndex(o=>o===a.grip.name),r!==-1&&y.splice(r,1))})}function me(i,e){y.push(i.pointer.name),i.grip&&y.push(i.grip.name),e.isPickable=!1,Ht(i,e,i.inputSource.handedness)}function Ht(i,e,t){e.setParent(i.pointer),e.rotationQuaternion=null,t!=="none"?e.rotation.copyFromFloats(Math.PI,0,Math.PI/2):e.rotation.copyFromFloats(0,0,0),i.motionController&&ve(i.motionController,e),i.onMotionControllerInitObservable.add(s=>{ve(s,e)}),x.addSelector(i.pointer,e,[w.XR]),y.push(e.name)}function ve(i,e){const t=i.getComponentOfType("squeeze"),s=e.getScene().animationGroups.find(n=>n.name===`Fist-${e.name}`);t.onButtonStateChangedObservable.add(n=>{const a=s.from+(s.to-s.from)*n.value;s.goToFrame(a)})}async function Ut(i){function e(t){for(const{name:s,path:n}of t)g.sounds[s]=new We(s,n,void 0)}return fetch(i).then(t=>t.json()).then(e)}class _{text;advancedTexture;textBlock;rectangle;#e;_platform;currentState;set platform(e){this._platform=e,this.#t()}get platform(){return this._platform}#t=()=>{this.#e.setParent(N.originalScene.activeCamera),this.#e.position.copyFromFloats(0,-.5,2),this.#e.rotation.setAll(0)};constructor(e,t,s){e&&(this.text=e),t&&(this._platform=t),this.#e=we("plane_text",{size:2},N.utilityLayerScene),this.#e.isPickable=!1,this.#t(),this.advancedTexture=X.CreateForMesh(this.#e),this.textBlock=new Ce("textblock"),this.currentState=s}handleStateChange(e,t,...s){return this._platform=t,e===C.START?(this.hideHUD(),new Vt(g.hudHints.GAME_STATE_START[this._platform],this._platform)):null}displayHUD(){this.textBlock.text=this.text,this.textBlock.textWrapping=!0,this.textBlock.fontSize=20,this._platform==="mobile"&&(this.textBlock.fontSize=12),this.textBlock.paddingBottomInPixels=200,this.textBlock.alpha=1,this.textBlock.color="white",this.textBlock.isVisible=!0,this.advancedTexture.addControl(this.textBlock)}hideHUD(){this.textBlock.isVisible=!1}}class Vt extends _{constructor(e,t){super(e,t,C.START),this.displayHUD()}handleStateChange(e,t,...s){return this.hideHUD(),this.platform=t,new le(g.hudHints.GAME_STATE_BASE[this.platform],this.platform)}displayHUD(){let e=this.textBlock,t=this.advancedTexture;e.text=this.text,e.fontSize=30,e.fontWeight="bold",e.color="white",t.addControl(e),e.isVisible=!0}}class le extends _{constructor(e,t){super(e,t,C.BASE),this.displayHUD()}handleStateChange(e,t,...s){return this.platform=t,e===C.GRAB?(this.hideHUD(),new te(g.hudHints.GAME_STATE_PICK_SOP[this.platform],this.platform)):e===C.PICK?(this.hideHUD(),new Be(g.hudHints.GAME_STATE_PICK[this.platform],this.platform)):null}}class te extends _{constructor(e,t){super(e,t,C.GRAB),this.displayHUD()}handleStateChange(e,t,...s){return this.platform=t,this.hideHUD(),e===C.LOSE?new zt(g.hudHints.GAME_STATE_FAIL[this.platform],this.platform):new le(g.hudHints.GAME_STATE_BASE[this.platform],this.platform)}}class Be extends _{constructor(e,t){super(e,t,C.PICK),this.displayHUD()}handleStateChange(e,t,...s){return this.platform=t,e===C.GRAB?(this.hideHUD(),s.length>0&&s[0].name==="fire-extinguisher"?new te(g.hudHints.GAME_STATE_PICK_FIREEXTINGUISHER[this.platform],this.platform):new te(g.hudHints.GAME_STATE_PICK_CYLINDER[this.platform],this.platform)):e===C.BASE?(this.hideHUD(),new le(g.hudHints.GAME_STATE_BASE[this.platform],this.platform)):null}}class zt extends _{constructor(e,t){super(e,t,C.PICK),this.displayHUD()}handleStateChange(e,t,...s){return e===C.PICK?(this.hideHUD(),new Be(g.hudHints.GAME_STATE_PICK[this.platform],this.platform)):this}}var C=(i=>(i[i.START=0]="START",i[i.BASE=1]="BASE",i[i.HIGHLIGHT=2]="HIGHLIGHT",i[i.GRAB=3]="GRAB",i[i.ACTIVATE=4]="ACTIVATE",i[i.PICK=5]="PICK",i[i.WIN=6]="WIN",i[i.LOSE=7]="LOSE",i))(C||{});class qt{onStateChangeObervable=new T;currentGameState;platform;constructor(){this.currentGameState=new _(null,"desktop",0),this.onStateChangeObervable.add(e=>{this.#e(e)}),this.platform="desktop",x.onHasAnyTargetsObservable.add(e=>{e?this.#e(5):this.currentGameState.currentState===5&&this.#e(1)}),x.onModeChangeObservable.add(e=>{this.platform=this.#t(e),this.platform!=="loading"&&this.platform!=="null"&&this.#e(1)}),x.onGrabStateChangedObservable.add(e=>{e.state===S.GRAB?this.#e(3,e.mesh):this.#e(1)}),D.add(e=>{e===P.FAILURE&&this.#e(7)})}#e(e,...t){let s=this.currentGameState.handleStateChange(e,this.platform,...t);s!==null&&(this.currentGameState=s)}#t(e){switch(e){case w.DESKTOP:return"desktop";case w.MOBILE:return"mobile";case w.XR:return"xr";case w.LOADING:return"loading";default:return"null"}}}let ie;const $t=()=>{ie=new qt,fetch(ht).then(i=>i.json()).then(i=>{g.hudHints=Object.assign({},i)})},ye=(i=!0)=>{let e=X.CreateFullscreenUI("UI"),t=L("action",0,"blue","white");t.height="60px",t.width="60px",t.isPointerBlocker=!0,i?t.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_RIGHT:t.horizontalAlignment=O.HORIZONTAL_ALIGNMENT_LEFT,t.isVisible=!0,t.alpha=.4;let s=150,n=-50;return i?t.leftInPixels-=s:t.leftInPixels-=-s,t.top=n,e.addControl(t),t};let B,x;const y=[];let V,z,he=!0;function Wt(){he=!1;const i=N?.utilityLayerScene.getMeshByName("reticle");i&&(i.isVisible=!1)}function Se(){he=!0;const i=N?.utilityLayerScene.getMeshByName("reticle");i&&(i.isVisible=!0)}let N;async function Xt(i){const e=new Xe(i),t=new Ke("light1",new p(1,1,0),e),s=new Ze("camera",Ye),n=document.getElementById("canvas");let a=!1;("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.maxTouchPoints>0)&&(a=!0),a?(Qe(e),V=ye(),z=ye(!1)):n.addEventListener("click",()=>{he&&n.requestPointerLock()}),Zt(e,!0),tt(s),e.activeCamera=s,e.activeCamera.attachControl(n,!0),t.intensity=0,J.audioEngine.useCustomUnlockedButton=!0,N=new je(e);const r=Ft("reticle",N.utilityLayerScene);if(r.setParent(s),r.position.copyFrom(Oe.Z),y.push(r.name),"xr"in window.navigator){B=await e.createDefaultXRExperienceAsync(Dt),x=new re(e,B),await Gt(B),y.push(...e.meshes.map(d=>d.name));for(const d of B.input.controllers)y.push(d.pointer.name),d.grip&&y.push(d.grip.name);B.input.onControllerAddedObservable.add(d=>{y.push(d.pointer.name),d.grip&&y.push(d.grip.name)}),B.input.onControllerRemovedObservable.add(d=>{let c=y.findIndex(b=>b===d.pointer.name);c!==-1&&y.splice(c,1),d.grip&&(c=y.findIndex(b=>b===d.grip.name),c!==-1&&y.splice(c,1))}),y.push("laserPointer"),r.isVisible=B.baseExperience.state!==F.IN_XR,B.baseExperience.onStateChangedObservable.add(d=>{r.isVisible=d!==F.IN_XR})}$t(),await Ut("./json/sounds.json"),await se(e);const o=document.querySelector("div.splash");let l=await(await fetch("./images/Notebook.svg")).text();return o.style.opacity=0,o.innerHTML=l,setTimeout(()=>o.style.opacity=1,1e3),o.addEventListener("click",()=>{o.classList.add("hide"),J.audioEngine.audioContext.resume()},!1),e}function Kt(i){let e=setInterval(()=>{i.intensity>=1?clearInterval(e):i.intensity+=.1},60)}async function se(i){const e=i.getLightByName("light1");e.intensity=0;const t=i.activeCamera,s=i.meshes.filter(h=>!y.includes(h.name)).concat(N.utilityLayerScene.meshes.filter(h=>!y.includes(h.name)));for(const h of s)h.dispose();const a=(await Ie()).map(h=>h.meshes).flat();Rt(a),ot(a),at(i),Pe(t),"xr"in window.navigator&&(B.teleportation.removeFloorMeshByName("Floor"),B.teleportation.addFloorMesh(i.getMeshByName("Floor"))),document.exitPointerLock(),ie.onStateChangeObervable.notifyObservers(C.START);const r=document.getElementById("canvas"),o=h=>{ie.onStateChangeObervable.notifyObservers(C.BASE),r.removeEventListener("click",o)};return r.addEventListener("click",o),Kt(e),D.notifyObservers(P.RESET),i}function Zt(i,e){i.collisionsEnabled=!0}function jt(i){window.addEventListener("resize",function(){i.resize()})}const Qt=document.getElementById("canvas"),ne=new J(Qt,!0,{stencil:!0});jt(ne);Xt(ne).then(i=>{ne.runRenderLoop(()=>i.render())});
